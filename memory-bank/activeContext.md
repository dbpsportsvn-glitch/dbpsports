# Bối Cảnh Hiện Tại

- **Công việc đang tập trung:**
  - **Hoàn thành Organization Shop System:** Đã hoàn thành hệ thống shop riêng cho từng ban tổ chức (BTC) với đầy đủ tính năng frontend và backend. Bao gồm: Database Models, Views & URLs, Templates, Management Interface, Sample Data, và Bug Fixes. Hệ thống đã sẵn sàng để sử dụng với 3 danh mục và 3 sản phẩm mẫu.

- **Các thay đổi gần đây:**
  - **Hoàn thành Organization Shop Templates & Management:** Tạo đầy đủ 7 templates cho Organization Shop frontend và 4 templates quản lý với giao diện đẹp mắt và responsive. Bao gồm: shop_home, product_list, product_detail, cart, checkout, order_detail, manage_shop, manage_products, manage_orders, manage_categories, shop_settings. Tích hợp breadcrumb navigation, stats cards, và modern UI design.
  - **Tạo dữ liệu mẫu cho Organization Shop:** Tạo thành công management command và script để tạo dữ liệu mẫu bao gồm 3 danh mục (Sports Shirts, Sports Pants, Sports Shoes), 3 sản phẩm (Nike Dri-FIT Shirt, Nike Dri-FIT Shorts, Nike Air Zoom Shoes), shop settings, và product sizes. Dữ liệu đã được populate thành công vào database.
  - **Sửa các lỗi Organization Shop:** Khắc phục thành công 5 lỗi chính: NoReverseMatch namespace URLs, TemplateSyntaxError với current_category, FieldError với organization.members query, ValueError với main_image, và NoReverseMatch với cart URLs. Tất cả templates đã được cập nhật để xử lý trường hợp không có hình ảnh và URL patterns đúng cách.
  - **Hoàn thành Organization Shop Database Models:** Tạo thành công 9 models mới cho Organization Shop bao gồm OrganizationCategory, OrganizationProduct, OrganizationProductVariant, OrganizationProductImage, OrganizationCart, OrganizationCartItem, OrganizationOrder, OrganizationOrderItem, OrganizationShopSettings. Tích hợp vào Django Admin với giao diện quản lý chuyên nghiệp. Tạo migration thành công và chạy migration database.
  - **Cập nhật Tournament Model cho Organization Shop:** Thêm method `calculate_organization_shop_discount()` để tính khuyến mãi từ shop của BTC tổ chức giải đấu. Cập nhật `get_final_registration_fee()` hỗ trợ cả Global Shop và Organization Shop. Thêm methods `has_organization_shop()` và `get_organization_shop_settings()` để kiểm tra và lấy cài đặt shop.
  - **Tạo Organization Shop Views & URLs:** Tạo đầy đủ 12 views cho Organization Shop bao gồm shop_home, product_list, product_detail, cart management, checkout, order management. Tạo URL structure `/shop/org/<org_slug>/` với routing hoàn chỉnh. Thêm slug field vào Organization model với auto-generation và migration thành công.
  - **Hoàn thành nâng cấp hệ thống quản lý tài chính cho BTC:** Đã thêm đầy đủ tính năng quản lý tiền công nhân viên bao gồm model StaffPayment, forms với validation, views cho CRUD operations, templates responsive, URLs routing, Django admin integration, và tích hợp vào budget system. Đã khắc phục vấn đề tiền công chưa được tính vào tổng chi bằng cách cập nhật method get_total_expenses() để chỉ tính staff payments có status='PAID'. Thêm trường trạng thái thanh toán vào form tạo mới với JavaScript validation để BTC có thể chọn ngay trạng thái "Đã thanh toán" hoặc "Chờ thanh toán". Hỗ trợ cả chế độ thêm đơn lẻ và hàng loạt trong một form tích hợp. Khắc phục các lỗi form validation, TypeError với data type conversion, và NoReverseMatch với URL namespace.
  - **Sửa lỗi checkbox khuyến mãi trong form thanh toán:** Da xac dinh va huong dan khac phuc loi checkbox khuyen mai khong hien thi cho cac doi thu 2, 3. Nguyen nhan la cac giai dau co shop_discount_percentage = 0, can cap nhat trong Django admin de hien thi checkbox.
  - **Cập nhật template tìm huấn luyện viên:** Da thiet ke lai template recruit_coach_list.html dong bo voi trang luu tru giai dau, bao gom gradient styling, coach cards hien dai, filter section dep mat, responsive design, va empty state chuyen nghiep.
  - **Tối ưu trang thị trường chuyển nhượng:** Da cap nhat layout trang thi truong chuyen nhuong voi nut "Lich su" mau trang dat o goc duoi ben phai banner, xoa khoi tim kiem thua, di chuyen khoi tim kiem xuong duoi bang thong ke, va cap nhat template form moi voi layout 2 cot gon gang dong bo voi cac template form khac trong he thong.
  - **Nâng cấp trang live stream:** Hoan thanh nang cap trang live stream dong bo voi giao dien he thong voi gradient tim (#667eea → #764ba2), responsive design, animation effects, va hover states. Cap nhat layout header voi logo doi bong, can giua ten doi, di chuyen nut LIVE va Chia se ve tabbar, thiet ke lai phan tran dau sap dien ra voi layout 3 cot dep mat va de nhin hon. Them CSS variables, backdrop-filter, box-shadow, va loading states de tao ra trai nghiem nguoi dung chuyen nghiep.
  - **Nâng cấp giao diện hồ sơ đội bóng:** Hoàn thành việc nâng cấp giao diện hồ sơ đội bóng để có giao diện hiện đại giống với hồ sơ cầu thủ. Thiết kế lại banner header với gradient overlay và layout đẹp mắt, thêm modern profile navigation với 4 tabs (Tổng quan, Thành tích, Lịch sử thi đấu, Thống kê), thiết kế lại các professional cards với styling đồng nhất, và cải thiện responsive design với animation effects. Giao diện mới có gradient tím (#667eea → #764ba2), backdrop blur, và hover states chuyên nghiệp.
  - **Đồng bộ layout banner hồ sơ cầu thủ:** Hoàn thành việc cập nhật layout banner của hồ sơ cầu thủ để đồng bộ với hồ sơ đội bóng. Chuyển đổi từ layout cũ sang layout mới với 2 cột (trái/phải), đặt giá trị chuyển nhượng ở trên badges thông tin, và các nút hành động ở góc dưới bên phải. Thêm trường huấn luyện viên vào card thông tin đội bóng và tối ưu hóa responsive design cho cả hai loại hồ sơ.

- **Các quyết định gần đây:**
  - **Quyết định về Organization Shop Architecture:** Thiết kế hệ thống shop riêng cho từng BTC với tính độc lập hoàn toàn. Mỗi BTC có models riêng (OrganizationCategory, OrganizationProduct, OrganizationOrder) với unique constraints trong cùng organization. Sử dụng slug-based URL routing `/shop/org/<org_slug>/` để truy cập shop của từng BTC. Tích hợp logic khuyến mãi thông minh chỉ tính từ shop của BTC tổ chức giải đấu.
  - **Quyết định về Tournament Discount Logic:** Cập nhật Tournament model để hỗ trợ cả Global Shop và Organization Shop. Method `get_final_registration_fee()` nhận cả `cart_items` và `org_cart_items` để tính khuyến mãi từ cả hai loại shop. Logic khuyến mãi chỉ áp dụng cho sản phẩm từ shop của BTC tổ chức giải đấu để đảm bảo tính nhất quán và logic kinh doanh.
  - **Quyết định về Database Migration Strategy:** Sử dụng migration data để populate slug cho Organization model hiện có. Tạo migration với null=True trước, sau đó populate data, cuối cùng remove null constraint. Đảm bảo slug unique với auto-generation từ tên organization và fallback numbering cho trường hợp trùng tên.
  - **Quyết định về Staff Payment System Integration:** Tích hợp hệ thống quản lý tiền công nhân viên vào budget system với model StaffPayment có các trường rate_per_unit, payment_unit, number_of_units, total_amount, status (PENDING/PAID/CANCELLED), payment_date, notes. Chỉ tính staff payments có status='PAID' vào tổng chi để đảm bảo tính chính xác của budget. Hỗ trợ cả chế độ thêm đơn lẻ và hàng loạt trong một form tích hợp với JavaScript validation.
  - **Quyết định về Navigation Structure:** Thiết lập navigation hierarchy với nút "Tài chính" đứng trước "Quản lý giải đấu" để ưu tiên truy cập budget dashboard. Sử dụng URL namespace `organizations:manage_tournament` để dẫn về Khu vực Quản lý BTC từ các trang quản lý tài chính. Tất cả các trang con đều có navigation buttons dẫn về trang chủ BTC.
  - **Quyết định về Form Validation:** Sử dụng CSS class `hidden-field` thay vì `display: none` để ẩn các trường không cần thiết trong form, tránh lỗi browser validation "not focusable". Kết hợp client-side JavaScript validation với server-side Django form validation để đảm bảo data integrity và user experience tốt.
  - **Quyết định về Memory Bank Management:** Giới hạn file activeContext.md để tránh quá dài, chỉ giữ lại 10 mục gần đây nhất trong "Các thay đổi gần đây" và 7 quyết định quan trọng nhất trong "Các quyết định gần đây". Di chuyển thông tin cũ sang progress.md để duy trì tính gọn gàng và dễ quản lý.