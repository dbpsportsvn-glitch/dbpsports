# Bối Cảnh Hiện Tại

- **Công việc đang tập trung:**
  - (Không có công việc đang tập trung - sẵn sàng nhận nhiệm vụ mới)

- **Các thay đổi gần đây:**
  - **Hoàn thành nâng cấp hệ thống quản lý tài chính cho BTC:** Đã thêm đầy đủ tính năng quản lý tiền công nhân viên bao gồm model StaffPayment, forms với validation, views cho CRUD operations, templates responsive, URLs routing, Django admin integration, và tích hợp vào budget system. Đã khắc phục vấn đề tiền công chưa được tính vào tổng chi bằng cách cập nhật method get_total_expenses() để chỉ tính staff payments có status='PAID'. Thêm trường trạng thái thanh toán vào form tạo mới với JavaScript validation để BTC có thể chọn ngay trạng thái "Đã thanh toán" hoặc "Chờ thanh toán". Hỗ trợ cả chế độ thêm đơn lẻ và hàng loạt trong một form tích hợp. Khắc phục các lỗi form validation, TypeError với data type conversion, và NoReverseMatch với URL namespace.
  - **Sửa lỗi checkbox khuyến mãi trong form thanh toán:** Da xac dinh va huong dan khac phuc loi checkbox khuyen mai khong hien thi cho cac doi thu 2, 3. Nguyen nhan la cac giai dau co shop_discount_percentage = 0, can cap nhat trong Django admin de hien thi checkbox.
  - **Cập nhật template tìm huấn luyện viên:** Da thiet ke lai template recruit_coach_list.html dong bo voi trang luu tru giai dau, bao gom gradient styling, coach cards hien dai, filter section dep mat, responsive design, va empty state chuyen nghiep.
  - **Tối ưu trang thị trường chuyển nhượng:** Da cap nhat layout trang thi truong chuyen nhuong voi nut "Lich su" mau trang dat o goc duoi ben phai banner, xoa khoi tim kiem thua, di chuyen khoi tim kiem xuong duoi bang thong ke, va cap nhat template form moi voi layout 2 cot gon gang dong bo voi cac template form khac trong he thong.
  - **Nâng cấp trang live stream:** Hoan thanh nang cap trang live stream dong bo voi giao dien he thong voi gradient tim (#667eea → #764ba2), responsive design, animation effects, va hover states. Cap nhat layout header voi logo doi bong, can giua ten doi, di chuyen nut LIVE va Chia se ve tabbar, thiet ke lai phan tran dau sap dien ra voi layout 3 cot dep mat va de nhin hon. Them CSS variables, backdrop-filter, box-shadow, va loading states de tao ra trai nghiem nguoi dung chuyen nghiep.
  - **Nâng cấp giao diện hồ sơ đội bóng:** Hoàn thành việc nâng cấp giao diện hồ sơ đội bóng để có giao diện hiện đại giống với hồ sơ cầu thủ. Thiết kế lại banner header với gradient overlay và layout đẹp mắt, thêm modern profile navigation với 4 tabs (Tổng quan, Thành tích, Lịch sử thi đấu, Thống kê), thiết kế lại các professional cards với styling đồng nhất, và cải thiện responsive design với animation effects. Giao diện mới có gradient tím (#667eea → #764ba2), backdrop blur, và hover states chuyên nghiệp.
  - **Đồng bộ layout banner hồ sơ cầu thủ:** Hoàn thành việc cập nhật layout banner của hồ sơ cầu thủ để đồng bộ với hồ sơ đội bóng. Chuyển đổi từ layout cũ sang layout mới với 2 cột (trái/phải), đặt giá trị chuyển nhượng ở trên badges thông tin, và các nút hành động ở góc dưới bên phải. Thêm trường huấn luyện viên vào card thông tin đội bóng và tối ưu hóa responsive design cho cả hai loại hồ sơ.
  - **Hoàn thành tính năng thay ảnh bìa cho tất cả hồ sơ:** Đã thêm nút "Đổi ảnh bìa" vào góc trên bên phải banner cho tất cả 4 loại hồ sơ: hồ sơ người dùng, hồ sơ cầu thủ, hồ sơ đội bóng, và hồ sơ sân bóng. Mỗi hồ sơ có nút riêng với modal upload và logic quyền hạn phù hợp. Tích hợp tính năng tự động nén ảnh xuống dưới 2MB để tránh lỗi kích thước file, hỗ trợ format JPG/PNG/WebP với quality 85% → 75% → 65% adaptive.
  - **Tạo hệ thống ảnh bìa riêng cho cầu thủ:** Đã thêm trường `banner_image` vào model Player, tạo view `upload_player_banner` riêng, và cập nhật template `player_detail.html` để mỗi cầu thủ có thể đổi ảnh bìa của chính mình. Logic hiển thị ưu tiên: `player.banner_image` → `team.banner_image` → `team.main_photo` → ảnh mặc định. Chỉ cầu thủ sở hữu (`player.user`) mới có quyền thay ảnh, hoàn toàn độc lập với đội bóng.
  - **Thêm logic ảnh mặc định cho giải đấu:** Đã cập nhật tất cả 4 templates chính (tournament_detail.html, home.html, active_list.html, archive.html) để tự động hiển thị ảnh `Backgroud-1.jpg` khi admin/BTC chưa upload banner giải đấu. Logic ưu tiên: `tournament.image` → `Backgroud-1.jpg`. Cập nhật cả Structured Data JSON-LD trong archive.html để đảm bảo SEO và trải nghiệm người dùng nhất quán trên tất cả các trang hiển thị giải đấu.

- **Các quyết định gần đây:**
  - **Quyết định về Staff Payment System Integration:** Tích hợp hệ thống quản lý tiền công nhân viên vào budget system với model StaffPayment có các trường rate_per_unit, payment_unit, number_of_units, total_amount, status (PENDING/PAID/CANCELLED), payment_date, notes. Chỉ tính staff payments có status='PAID' vào tổng chi để đảm bảo tính chính xác của budget. Hỗ trợ cả chế độ thêm đơn lẻ và hàng loạt trong một form tích hợp với JavaScript validation.
  - **Quyết định về Navigation Structure:** Thiết lập navigation hierarchy với nút "Tài chính" đứng trước "Quản lý giải đấu" để ưu tiên truy cập budget dashboard. Sử dụng URL namespace `organizations:manage_tournament` để dẫn về Khu vực Quản lý BTC từ các trang quản lý tài chính. Tất cả các trang con đều có navigation buttons dẫn về trang chủ BTC.
  - **Quyết định về Form Validation:** Sử dụng CSS class `hidden-field` thay vì `display: none` để ẩn các trường không cần thiết trong form, tránh lỗi browser validation "not focusable". Kết hợp client-side JavaScript validation với server-side Django form validation để đảm bảo data integrity và user experience tốt.
  - **Quyết định về Data Type Conversion:** Thực hiện explicit conversion từ string sang float/int trong view khi xử lý POST data để tránh TypeError khi tính toán. Thêm error handling với try-catch để bắt lỗi conversion và hiển thị thông báo lỗi rõ ràng cho người dùng.
  - **Quyết định về Profile Layout Synchronization:** Đồng bộ hóa layout banner giữa hồ sơ cầu thủ và hồ sơ đội bóng để tạo ra trải nghiệm người dùng nhất quán. Sử dụng layout 2 cột (trái/phải) với thông tin chính ở bên trái và nút hành động ở bên phải. Thêm trường huấn luyện viên vào hồ sơ đội bóng và tối ưu hóa responsive design.
  - **Quyết định về Banner Upload System:** Tạo hệ thống upload ảnh bìa thống nhất cho tất cả 4 loại hồ sơ với tính năng tự động nén ảnh. Sử dụng function `compress_banner_image()` chung với logic nén adaptive (85% → 75% → 65%) để đảm bảo file dưới 2MB. Mỗi hồ sơ có view riêng: `upload_profile_banner`, `upload_player_banner`, `upload_team_banner`, `upload_stadium_banner` với logic quyền hạn phù hợp.
  - **Quyết định về Memory Bank Management:** Giới hạn file activeContext.md để tránh quá dài, chỉ giữ lại 10 mục gần đây nhất trong "Các thay đổi gần đây" và 7 quyết định quan trọng nhất trong "Các quyết định gần đây". Di chuyển thông tin cũ sang progress.md để duy trì tính gọn gàng và dễ quản lý.