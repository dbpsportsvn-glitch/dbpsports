# Bối Cảnh Hiện Tại

- **Công việc đang tập trung:**
  - (Không có công việc đang tập trung cụ thể)

- **Các thay đổi gần đây:**
  - **Hoàn thành tối ưu hóa toàn diện Music Player với Auto-Play và Keyboard Shortcuts:** Đã thực hiện tối ưu chuyên nghiệp cho music player với 3 phần chính. PHẦN 1 - Sửa 8 vấn đề kỹ thuật quan trọng: (1) Fix sai sót isSameTrack - thay đổi từ so sánh track.file_path sang track.file_url để nhất quán với audio.src, tránh load lại file không cần thiết; (2) Fix logic previousTrack() - sửa điều kiện từ !this.repeatMode (luôn truthy vì string) sang this.repeatMode === 'none' để logic repeat hoạt động đúng; (3) Fix nguy cơ XSS - thêm utility function escapeHtml() để escape HTML entities, áp dụng cho tất cả user-generated content (playlist.name, track.title, track.artist), dùng textContent thay vì innerHTML khi có thể; (4) Thêm null-guard cho DOM elements - check required elements (toggle, closeBtn, popup, audio) trước addEventListener để tránh crashes; (5) Tối ưu global click listeners - hợp nhất 2 document click listeners thành 1 để xử lý cả close player và sleep timer menu, tránh conflict; (6) Event delegation cho track-items - thay thế hàng trăm individual listeners bằng 1 listener duy nhất trên trackList container với closest('.track-item'), giảm memory footprint và improve garbage collection; (7) Thay alert() bằng toast notifications - tạo toast system với animations slideInUp/slideOutDown, tự động biến mất sau 3 giây, không chặn UI thread, UX mượt mà hơn nhiều; (8) Deploy changes với collectstatic (2 files copied). PHẦN 2 - Auto-play khi toggle lần đầu: Implement tính năng tự động phát nhạc khi user mở player lần đầu tiên, sử dụng flag hasOpenedPlayer để track, delay 300ms đảm bảo playlists đã load, check điều kiện chưa phát + có playlist + có tracks, chỉ trigger lần đầu duy nhất. PHẦN 3 - Hệ thống Keyboard Shortcuts mạnh mẽ: (1) 13+ phím tắt: Space (play/pause), Arrow keys (prev/next/volume/seek), M (mute), S (shuffle), R (repeat), P/Esc (toggle player), 0-9 (seek to percentage), Shift+? (show shortcuts help); (2) Modifier keys support với Shift + Arrow keys để seek ±10s; (3) Visual feedback system: keyboard hint popup giữa màn hình với emoji + text, fade animation 1s; keyboard shortcuts modal đẹp mắt với gradient tím hồng, staggered animations, kbd styling, responsive mobile; (4) UI integration: thêm keyboard icon button (⌨️) vào header, tooltip "Phím tắt (Shift+?)", click để show modal; (5) Helper methods: adjustVolume(delta), showKeyboardHint(text), showKeyboardShortcuts(); (6) CSS animations: keyboardHintFade với scale + opacity, fadeIn cho modal, slideInUp staggered cho shortcuts list, responsive breakpoints; (7) Smart logic: không xử lý phím tắt khi đang typing trong input/textarea, escape handler để đóng modal. Collectstatic thành công (2 files copied). Kết quả: Music player giờ professional như Spotify với performance cao (event delegation, null guards), security tốt (XSS protection), UX mượt mà (toast notifications thay vì alert, auto-play on first open, visual feedback cho mọi action), power-user friendly (full keyboard control không cần chuột), discoverable (keyboard button + modal help). Code quality cao với clean separation of concerns, reusable utility functions, comprehensive error handling.
  - **Hoàn thành sửa lỗi Cache và Auto-Refresh cho tất cả Personal Music Events:** Đã khắc phục hoàn toàn vấn đề cache và các sự kiện không cập nhật ngay lập tức. Vấn đề chính: Các operations như upload nhạc, xóa nhạc, xóa playlist, thêm bài vào playlist không tự động refresh UI mà phải F5. Nguyên nhân: (1) Thiếu `await` trong các async calls - deleteUserTrack() và deletePlaylist() gọi loadUserTracks() và loadUserPlaylists() mà không có await, dẫn đến race condition; (2) Browser cache - các API calls không có cache-busting parameters, browser cache response cũ; (3) Server không chạy - virtual environment chưa được activate đúng cách. Giải pháp: (1) Thêm `await` vào tất cả reload calls: `await this.loadUserTracks()` trong deleteUserTrack(), `await this.loadUserPlaylists()` trong deletePlaylist(), đảm bảo UI update sau khi API call hoàn thành; (2) Thêm cache-busting parameters: `fetch('/music/user/tracks/?t=${Date.now()}')` và `fetch('/music/user/playlists/?t=${Date.now()}')` để force fresh data từ server; (3) Fix server startup: Sử dụng `backend\venv\Scripts\python.exe backend\manage.py runserver` để activate virtual environment đúng cách. Chạy collectstatic thành công (1 file copied). Kết quả: Upload nhạc → danh sách tự động reload ngay, xóa nhạc → bài hát biến mất ngay lập tức, xóa playlist → playlist biến mất ngay, thêm bài vào playlist → số tracks update ngay, không cần F5 cho bất kỳ operation nào, UX mượt mà và responsive hoàn hảo.
  - **Hoàn thành sửa lỗi UX và auto-refresh cho Personal Music features:** Đã khắc phục 2 vấn đề UX quan trọng. Vấn đề 1: Khi thêm bài hát vào playlist, số lượng tracks không cập nhật ngay mà phải F5 refresh. Giải pháp: Sau khi addTrackToPlaylist() thành công, tự động gọi loadUserPlaylists() để reload danh sách playlists trong Settings modal, đồng thời check nếu đang hiển thị user-playlist-grid trong main player thì gọi loadUserPlaylistsInMainPlayer() để cập nhật luôn, đảm bảo tracks_count được update ngay lập tức ở cả 2 nơi. Vấn đề 2: Khi đóng Settings modal (click X hoặc overlay), Music Player popup cũng bị đóng theo, user muốn chỉ đóng settings mà giữ player mở để nghe nhạc. Giải pháp: Thêm e.stopPropagation() vào overlay click event để prevent event bubbling lên document click listener (listener này đóng music player khi click outside), thêm settingsModal.addEventListener('click', e.stopPropagation()) để prevent mọi clicks trong settings modal không bubble ra ngoài, closeSettings() chỉ đóng settings modal bằng classList.add('hidden') mà không touch vào music player popup. Lỗi bổ sung: Fix method name sai renderTrackList() → populateTrackList() ở 2 chỗ trong music_player.js và user_music.js khi load user playlist. Chạy collectstatic thành công (2 files copied). Kết quả: Thêm bài vào playlist cập nhật ngay số lượng tracks không cần F5, đóng Settings modal không đóng Music Player popup nữa, user có thể mở settings config trong khi vẫn nghe nhạc, UX mượt mà và intuitive hơn nhiều.
  - **Hoàn thành tích hợp User Playlists vào Main Player và Add to Playlist feature:** Đã hoàn thiện tính năng quản lý playlist cá nhân với đầy đủ chức năng. Backend: (1) API endpoints mới: add_track_to_playlist (POST thêm track vào playlist với check duplicate, auto-increment order), delete_user_playlist (POST xóa playlist); (2) Import django.db.models để dùng models.Max() aggregate; (3) Exception handling với traceback logging. Frontend: (1) Main Player Integration: Thêm playlist type toggle với 2 buttons "Admin Playlists" và "Playlist Của Tôi" ở tab Playlists, toggle buttons với gradient pink active state, 2 grids riêng biệt cho admin và user playlists, click "Playlist Của Tôi" auto-load user playlists, click vào user playlist card sẽ load tracks và play ngay; (2) Settings Modal Updates: Track cards thêm nút "Add to Playlist" (icon plus-circle, green hover), click hiển thị prompt chọn playlist theo số thứ tự, Playlist cards redesign với layout mới: user-playlist-card flex layout, user-playlist-info clickable để play, user-playlist-icon gradient tím với vinyl icon, user-playlist-details với name và count, playlist-delete-btn màu đỏ ở góc phải; (3) JavaScript Methods: showAddToPlaylistMenu() - hiển thị prompt chọn playlist, addTrackToPlaylist() - call API thêm track, deletePlaylist() - xóa playlist với confirm, openPlaylist() - mở và play playlist, loadAndPlayUserPlaylist() - load tracks và convert sang player format, loadUserPlaylistsInMainPlayer() - populate user playlists vào main player grid, loadUserPlaylist() - play user playlist trong main player, initPlaylistTypeToggle() - handle toggle giữa admin và personal playlists. CSS: 150+ dòng mới với playlist-type-toggle buttons, user-playlist-card layout, playlist-delete-btn styling, add-playlist button hover green. Chạn collectstatic thành công (3 files copied). Kết quả: User có thể tạo playlist, thêm bài hát vào playlist bằng nút plus, xóa playlist bằng nút trash, chuyển đổi giữa Admin Playlists và Personal Playlists trong main player, click playlist để play ngay, workflow hoàn chỉnh từ upload → add to playlist → play trong main player.
  - **Hoàn thành sửa lỗi 500 và nâng cấp Quota System sang MB cho Personal Music:** Đã khắc phục lỗi 500 Internal Server Error và nâng cấp hệ thống quota. Lỗi 500: Conflict tên biến `settings` trong user_music_views.py - đã import `from django.conf import settings` nhưng dùng `settings` làm tên biến cho MusicPlayerSettings instance, gây name conflict khi truy cập `settings.MEDIA_ROOT`. Giải pháp: Rename import thành `django_settings`, rename tất cả biến local thành `user_settings`. Nâng cấp Quota System: (1) Thay đổi từ giới hạn "69 bài" sang "500MB tổng dung lượng"; (2) Thêm field `storage_quota_mb = 500` vào MusicPlayerSettings; (3) Update method `get_upload_usage()` để tính total_bytes và convert sang MB với tracks_count; (4) Update method `can_upload(file_size_bytes)` để check dung lượng thay vì count; (5) Tăng file size limit từ 10MB lên 50MB/file; (6) Update UI: hiển thị "123.5 / 500 MB (45 MB còn lại)" + "23 bài hát" ở dòng phụ; (7) Update admin: `storage_usage_display` hiển thị "123.5/500 MB (24%)" + tracks count, editable `storage_quota_mb` inline; (8) Update validation error messages với MB; (9) Upload hint: "Tối đa 50MB/file. Tổng quota: 500MB". Tạo và chạy migration thành công. Collectstatic thành công (1 file copied). Kết quả: Hệ thống quota linh hoạt hơn nhiều, user có thể upload files lớn (đến 50MB), tổng quota 500MB (~100-150 bài tùy chất lượng), admin điều chỉnh quota theo MB cho từng user (VIP có thể 1GB+), quota bar hiển thị chính xác dung lượng đã dùng, không còn lỗi 500.
  - **Hoàn thành tính năng Personal Music - Upload & Manage User Music (MEGA FEATURE!):** Đã triển khai hoàn chỉnh tính năng cho phép user upload và quản lý nhạc cá nhân với quota 69 bài/user. Backend: (1) Models mới: UserPlaylist (playlist cá nhân), UserTrack (bài hát upload), UserPlaylistTrack (track trong playlist), thêm upload_quota vào MusicPlayerSettings với methods get_upload_usage() và can_upload(); (2) 9 API endpoints: user_settings (GET settings), update_music_settings (POST update), get_user_tracks (GET tracks list), upload_user_track (POST upload với validation format/size/quota, extract metadata từ ID3 tags bằng mutagen), delete_user_track (POST xóa track và file), update_user_track (POST update info), get_user_playlists (GET playlists), create_user_playlist (POST tạo playlist), get_playlist_tracks (GET tracks in playlist); (3) Admin interface đẹp mắt: MusicPlayerSettingsAdmin hiển thị quota usage với color-coded percentage, UserPlaylistAdmin với inline tracks, UserTrackAdmin với audio preview player, file size formatted, delete action tự động xóa files. Frontend: (1) Settings Modal với 3 tabs: Tab "Cài Đặt Player" (auto-play toggle, volume slider 0-100%, repeat mode select, shuffle toggle, save button), Tab "Nhạc Của Tôi" (quota bar với color-coded levels green<70% yellow<90% red>=90%, upload button disabled khi full, hint text cho formats/size, my tracks list với track cards có icon/title/artist/duration/size, play và delete buttons), Tab "Playlist Của Tôi" (create playlist button, playlists grid); (2) Settings button cạnh sleep timer với icon gear; (3) Upload Progress Overlay với real-time progress bars cho multiple files, success/error states; (4) Track cards đẹp mắt với gradient icon, hover effects, action buttons. CSS: 600+ dòng với gradient backgrounds, animations modalSlideIn, toggle switches với gradient pink, sliders với gradient thumbs, quota bar với dynamic colors, track cards với hover translateX, upload progress overlay. JavaScript: UserMusicManager class 550+ dòng với methods: openSettings/closeSettings, switchTab, loadUserSettings/saveSettings, loadUserTracks/renderUserTracks, handleFileUpload với multiple files support, uploadFile với FormData và progress tracking, deleteUserTrack với confirm dialog, playUserTrack integrate vào music player, loadUserPlaylists/createPlaylist, getCSRFToken, showNotification với auto-hide. Chạy migrations và collectstatic thành công (3 files copied). Kết quả: Tính năng hoàn chỉnh cho phép user upload nhạc riêng (max 10MB/file, formats MP3/M4A/AAC/OGG/WAV), auto-extract metadata từ ID3 tags hoặc filename, quản lý quota 69 bài với visual progress bar, play tracks trong music player, tạo playlists cá nhân, admin có thể xem/quản lý/xóa user uploads, điều chỉnh quota cho từng user. Đây là tính năng KHÁC BIỆT giúp giữ chân user cực mạnh!
  - **Hoàn thành thêm tính năng Sleep Timer cho Music Player:** Đã thêm tính năng hẹn giờ tắt nhạc vào music player với giao diện đẹp mắt và nhiều tùy chọn. UI: (1) Thêm nút hẹn giờ (icon alarm) vào header controls; (2) Dropdown menu với 4 tùy chọn: 15 phút, 30 phút, 1 giờ, 2 giờ; (3) Hiển thị thời gian còn lại với màu vàng gold và text-shadow đẹp; (4) Nút hủy timer màu đỏ; (5) Active state cho nút timer với animation ring lắc lắc khi đang bật. CSS: Gradient background tím hồng cho menu, backdrop-filter blur, hover effects translateX slide, animation ring cho icon, pulse animation khi còn dưới 10 giây. JavaScript: (1) Các thuộc tính sleepTimerActive, sleepTimerEndTime, sleepTimerInterval trong constructor; (2) Methods: setSleepTimer(minutes) - set timer và bắt đầu countdown, updateTimerDisplay() - cập nhật UI mỗi giây với format MM:SS, fadeOutAndStop() - fade out volume từ từ trong 3 giây rồi pause nhạc, cancelSleepTimer() - hủy timer và reset UI; (3) Events: Click nút timer toggle menu, click options set timer, click cancel button hủy timer, click outside đóng menu; (4) Cleanup interval trong destroy(). Chạy collectstatic thành công (2 files copied). Kết quả: Music player giờ có tính năng hẹn giờ tắt nhạc chuyên nghiệp, fade out mượt mà, hiển thị countdown đẹp mắt, animation sinh động, giúp người dùng nghe nhạc trước khi ngủ.
  - **Hoàn thành sửa lỗi scrolling music player không cuộn hết bài cuối cùng:** Đã khắc phục vấn đề danh sách bài hát và playlist không cuộn hết xuống được, bài cuối cùng bị che mất chỉ hiển thị một chút. Vấn đề: `.track-list` và `.playlist-grid` không có padding-bottom, dẫn đến bài cuối cùng bị sát với đáy của container, không thể cuộn xuống xem hết. Giải pháp: (1) Thêm `padding-bottom: 16px` cho `.track-list` để tạo khoảng trống phía dưới; (2) Thêm `padding-bottom: 16px` cho `.playlist-grid` để nhất quán; (3) Thêm `.playlist-grid` vào custom scrollbar styling cùng với `.track-list` và `.player-content` để có scrollbar đẹp và nhất quán (width 6px, track background rgba, thumb background rgba với hover effect). Chạy collectstatic để áp dụng CSS mới (1 file copied). Kết quả: Thanh cuộn giờ có thể cuộn hết xuống dưới, bài cuối cùng hiển thị đầy đủ và rõ ràng, không còn bị che hoặc cắt mất, scrollbar đẹp mắt và nhất quán trên cả track list và playlist grid.
  - **Hoàn thành sửa lỗi bulk actions không hoạt động cho Tournament Registration và Shop Settings:** Đã khắc phục vấn đề duyệt hàng loạt hóa đơn lệ phí giải của các đội và các actions shop settings phải thao tác từng item một. Vấn đề: Sử dụng `queryset.update()` để cập nhật nhiều bản ghi nhưng sau đó loop qua queryset gốc mà không refresh, dẫn đến logic gửi email và xử lý dữ liệu bị sai. Trong `TeamRegistrationAdmin.approve_payments()`, code update tất cả PENDING records thành PAID bằng `.update()` nhưng sau đó loop qua toàn bộ queryset (bao gồm cả records không phải PENDING), gây ra việc gửi email sai. Trong `approve_unlock_requests()`, code update các shop có `shop_unlock_requested=True` nhưng sau đó filter `shop_unlock_requested=False` trên queryset cũ không được refresh, không tìm thấy records vừa update. Giải pháp: (1) Trong tournaments/admin.py: Sửa `approve_payments()` và `reject_payments()` để filter ra pending_registrations trước, count số lượng, sau đó loop qua từng record để update và gửi email; (2) Trong shop/admin.py: Sửa `lock_shops()`, `unlock_shops()`, `approve_unlock_requests()` để convert queryset thành list hoặc filter trước, sau đó loop qua từng object để update và gửi email. Kết quả: Bulk actions giờ hoạt động chính xác, có thể chọn nhiều items và duyệt/cập nhật hàng loạt, email được gửi đúng cho từng item được xử lý.
  - **Hoàn thành thêm bulk actions vào Organization Order Admin:** Đã khắc phục vấn đề không thể duyệt hàng loạt đơn hàng Organization Shop trong admin bằng actions, trước đây phải duyệt từng đơn ở dropdown. Vấn đề: OrganizationOrderAdmin thiếu dòng khai báo `actions` và các action methods tương ứng. Giải pháp: (1) Thêm dòng `actions = ['mark_as_processing', 'mark_as_shipped', 'mark_as_delivered', 'mark_as_cancelled', 'mark_payment_paid']` vào OrganizationOrderAdmin (line 930); (2) Implement 5 action methods: mark_as_processing (đánh dấu đang xử lý), mark_as_shipped (đánh dấu đã giao hàng), mark_as_delivered (đánh dấu đã nhận hàng), mark_as_cancelled (hủy đơn hàng), mark_payment_paid (đánh dấu đã thanh toán). Mỗi method có filter điều kiện hợp lý (pending→processing, processing→shipped, shipped→delivered, pending/processing→cancelled, pending→paid) và message thông báo số lượng đơn đã cập nhật. Kết quả: Admin giờ có thể chọn nhiều đơn hàng Organization Shop và duyệt hàng loạt bằng dropdown actions, cải thiện đáng kể workflow quản lý đơn hàng.
  - **Hoàn thành sửa lỗi CSS tab-content ảnh hưởng đến trang chi tiết giải đấu:** Đã khắc phục vấn đề Music Player CSS ảnh hưởng global đến tất cả .tab-content trên website, làm trang chi tiết giải đấu không hiển thị thông tin. Nguyên nhân: File music_player.css có các selector tab-related (.tabs-section, .tab-headers, .tab-header, .tab-contents, .tab-content) không được scope đúng, ảnh hưởng đến tất cả các trang có dùng tab-content. Giải pháp: Thêm scope .music-player-popup vào TẤT CẢ 11 selector tab-related trong music_player.css: .tabs-section → .music-player-popup .tabs-section, .tab-headers → .music-player-popup .tab-headers, .tab-header → .music-player-popup .tab-header (và các pseudo-classes/elements), .tab-contents → .music-player-popup .tab-contents, .tab-content → .music-player-popup .tab-content (quan trọng nhất!), .tab-content.active → .music-player-popup .tab-content.active. Chạy collectstatic để cập nhật staticfiles (2 files copied). Kết quả: CSS Music Player giờ chỉ áp dụng trong phạm vi .music-player-popup, không còn ảnh hưởng global, trang chi tiết giải đấu hiển thị thông tin bình thường trở lại.
  - **Hoàn thành sửa lỗi đường dẫn file nhạc 404 trên production:** Đã khắc phục lỗi 404 khi load file nhạc trên production. Vấn đề: JavaScript đang build URL sai bằng cách dùng `track.file_path` (chỉ chứa tên file) để ghép với `/media/music/playlist/`, dẫn đến URL thiếu phần đường dẫn đầy đủ. URL sai: `https://dbpsports.com/media/001%20-%20GIẤC%20MƠ%20KHÔNG%20VỀ.mp3` (thiếu `music/playlist/`). Giải pháp: API đã trả về `file_url` đầy đủ từ model method `get_file_url()`, chỉ cần sử dụng `track.file_url` thay vì build lại URL. Sửa 2 chỗ trong music_player.js (playTrack và restorePlayerState) từ `const fileUrl = \`/media/music/playlist/${track.file_path}\`;` thành `const fileUrl = track.file_url;`. Chạy collectstatic để cập nhật. Kết quả: File nhạc load đúng URL trên production, không còn lỗi 404.
  - **Hoàn thành sửa lỗi NoReverseMatch trong Organization Shop:** Đã khắc phục lỗi NoReverseMatch khi deploy lên production do redirect call sai. Vấn đề: Code redirect với `redirect('organizations:dashboard', org_slug=org_slug)` nhưng URL pattern 'dashboard/' không nhận parameter org_slug. URL pattern được định nghĩa là `path('dashboard/', organization_dashboard, name='dashboard')` không có parameter. View organization_dashboard tự lấy organization từ user hiện tại nên không cần org_slug. Giải pháp: Tìm và loại bỏ parameter `org_slug=org_slug` khỏi tất cả 3 redirect call trong shop/organization_views.py (lines 143, 149, 154). Sửa thành `redirect('organizations:dashboard')` không cần parameter. Kết quả: Redirect hoạt động chính xác trên production, không còn lỗi NoReverseMatch.
  - **Hoàn thành loại bỏ tính năng auto-play khi user click lần đầu trong Music Player:** Đã bỏ tính năng tự động mở player và phát nhạc khi người dùng click bất kỳ đâu trên web lần đầu theo yêu cầu của user. Xóa toàn bộ logic auto-open player và auto-play trong event listeners cho click và keydown. Loại bỏ logic kiểm tra `hasAutoPlayed` flag để trigger auto-play. Giữ lại logic đóng player khi click bên ngoài và tracking user interaction để cho phép phát nhạc khi user chủ động click nút play. Chạy collectstatic để áp dụng thay đổi JavaScript. Kết quả: Người dùng giờ phải chủ động click vào nút toggle hoặc nút play để mở player và phát nhạc, player không còn tự động mở và phát khi vào trang, UX theo đúng mong muốn của user.
  - **Hoàn thành hiệu ứng animation cho toggle button khi nhạc đang phát:** Đã thêm animation cực đỉnh cho nút toggle nhạc khi nhạc đang phát. Các hiệu ứng: (1) Pulse animation 2s infinite với 3-layer shadow glow (tím #667eea, tím đậm #764ba2, hồng #f093fb) nhấp nháy liên tục; (2) Rotate animation 3s infinite xoay nhẹ qua lại từ -5deg đến +5deg tạo hiệu ứng lắc lư; (3) Icon bounce animation 0.6s alternate scale từ 1.0 đến 1.2; (4) Hover state animation nhanh hơn (pulse 1.5s, rotate 2s) và scale 1.15; (5) Multi-layer glow với blur radius tăng dần 30px→40px→60px. JavaScript toggle class 'playing' trong onPlay() và onPause(). Kết quả: Toggle button cực kỳ bắt mắt và sống động khi nhạc chạy, user biết ngay nhạc đang phát hay không mà không cần mở player.
  - **Hoàn thành sửa lỗi restore position không nhất quán cho tất cả bài hát:** Đã khắc phục vấn đề một số bài hát restore đúng vị trí khi chuyển trang nhưng một số bài lại load lại từ đầu. Nguyên nhân: event 'loadeddata' fire trước khi audio.duration được set, dẫn đến không thể set currentTime. Giải pháp: (1) Listen cả 'loadedmetadata' và 'canplay' events thay vì chỉ 'loadeddata'; (2) Thêm checkAndResolve() để validate duration hợp lệ (không null, không NaN, > 0) trước khi resolve Promise; (3) Delay 50ms sau 'canplay' để chắc duration đã set; (4) Try-catch với retry logic sau 200ms nếu set currentTime fail lần đầu; (5) Tăng timeout từ 5s lên 8s; (6) Console logs với emoji để debug dễ dàng. Kết quả: Tất cả bài hát giờ đều restore chính xác vị trí phát khi chuyển trang, không còn load lại từ đầu.
  - **Hoàn thành tính năng Auto-Open Player và Auto-Play khi user click lần đầu:** Đã thêm tính năng tự động mở player và phát nhạc ngay khi user click bất kỳ đâu trên web lần đầu tiên. Logic: (1) Detect user interaction qua click hoặc keydown event; (2) Tự động remove class 'hidden' để mở player; (3) Tự động gọi playTrack() để phát nhạc; (4) Sử dụng flag hasAutoPlayed để chỉ trigger 1 lần duy nhất; (5) Logic close player chỉ hoạt động sau khi đã auto-play để tránh đóng ngay sau khi mở. Kết quả: User không cần nhấn toggle button hay play button nữa, chỉ cần click bất kỳ đâu là nhạc tự động mở và phát, UX cực kỳ mượt mà và thuận tiện.
  - **Hoàn thành cải tiến Music Player với Tab System + Playlist Grid - UX hoàn hảo:** Đã nâng cấp music player lên level mới với tab system và playlist grid đẹp mắt. Thiết kế 2 tabs: (1) "Danh sách bài hát" với max-height 280px, min-height 200px, overflow-y auto để scroll mượt mà; (2) "Playlist" với grid layout responsive. Playlist grid hiển thị dạng cards với icon vinyl, tên playlist, số bài hát, gradient background (#667eea → #764ba2), hover effect translateY(-4px) + shadow glow, active state với border tím và shadow. Click vào playlist card sẽ auto-switch về tracks tab. Tab headers có gradient underline với scaleX animation. Tab contents dùng display:flex/none với fadeIn animation 0.3s. Sửa lỗi track list không scroll được bằng cách set max-height cụ thể. JavaScript populate cả hidden select (backward compatibility) và playlist grid với cards đẹp. Kết quả: UX hoàn hảo với scroll mượt mà, playlist cards đẹp như Spotify, tab switching mượt mà, giao diện cực kỳ hiện đại và professional.
  - **Hoàn thành redesign giao diện Music Player - modern & beautiful UI:** Đã thiết kế lại hoàn toàn giao diện music player với layout mới và hiệu ứng đẹp mắt. Cấu trúc mới: (1) Player controls & progress bar ở trên cùng với background tối, (2) Danh sách bài hát ở giữa với flex layout, (3) Playlist selector ở dưới cùng; Volume control được thu nhỏ và đặt cùng hàng với control buttons ở bên phải. Progress bar được nâng cấp với gradient tím hồng (#667eea → #764ba2 → #f093fb), glow effect, shimmer animation 2s chạy liên tục, hover effect phóng to, progress handle với gradient và shadow đẹp. Track items có hover effect với border trái gradient, active state với background gradient và highlight màu hồng. Volume bar cũng có gradient tím hồng matching. Responsive design tối ưu cho mobile với controls dọc. Kết quả: Giao diện hiện đại, mượt mà, với nhiều hiệu ứng visual đẹp mắt.
  - **Hoàn thành refactor toàn bộ Music Player - persistence và stability:** Đã viết lại hoàn toàn logic persistence của music player để khắc phục vấn đề chuyển trang không tiếp tục phát từ đúng vị trí. Các thay đổi chính: (1) Viết lại restorePlayerState() với Promise-based approach và timeout 5s, sử dụng 'loadeddata' event thay vì 'canplay' để tránh event fire nhiều lần, thêm cleanup function để remove event listeners đúng cách; (2) Thêm flag restoreAttempted để đảm bảo chỉ restore 1 lần duy nhất khi load page; (3) Cải thiện savePlayerState() với validation đầy đủ, chỉ lưu khi không restore và có playlist, tăng interval lên 3 giây để giảm overhead; (4) Refactor playTrack() đơn giản hơn, loại bỏ fetch HEAD request, sử dụng canplaythrough event với { once: true } để tránh duplicate listeners; (5) Loại bỏ tất cả debug logs không cần thiết trong audio events. Kết quả: Music player giờ hoạt động ổn định với khả năng restore chính xác vị trí phát, tua nhạc mượt mà trên mọi thiết bị, và không còn lỗi event fire nhiều lần.
  - **Hoàn thành sửa lỗi CSS music player ảnh hưởng toàn cục:** Đã khắc phục thành công vấn đề CSS của giao diện phát nhạc mini đang ảnh hưởng đến các phần khác của trang web như tiêu đề trang chủ, menu việc làm, và dropdown. Phát hiện 3 selector CSS quá chung (.form-select, .section-title, .empty-state) đang áp dụng cho toàn bộ 69 file trong website. Giải pháp: scope lại các selector bằng cách thêm prefix .music-player-popup để chỉ áp dụng trong phạm vi music player. Chạy collectstatic để cập nhật file CSS vào staticfiles. CSS giờ chỉ ảnh hưởng đến music player, không còn gây xung đột với các phần khác của trang web.
  - **Hoàn thành tính năng Music Player với autoplay:** Đã tạo thành công hệ thống trình phát nhạc popup với đầy đủ tính năng bao gồm: Django app music_player với models Playlist, Track, MusicPlayerSettings, API endpoints để fetch playlists và tracks, frontend JavaScript với Audio API để phát nhạc, giao diện popup mini player và full player với Bootstrap 5 styling, tính năng autoplay với user interaction detection (click, keydown, hover), hệ thống admin để quản lý playlists và tracks với drag & drop upload, tự động refresh playlists khi có thay đổi, và khắc phục các lỗi autoplay policy của trình duyệt. Trình phát nhạc hoạt động hoàn hảo với khả năng tự động phát khi user tương tác và luôn hiển thị trên tất cả các trang.
  - **Hoàn thành tính năng discount tournament registration payment:** Đã hoàn thiện tính năng tích hợp shop discount vào thanh toán lệ phí giải đấu. Bao gồm: Logic tự động tạo đơn hàng shop khi đội trưởng check discount checkbox, tính toán discount dựa trên profit từ cart items, hỗ trợ cả Main Shop và Organization Shop, tự động xóa cart sau khi tạo đơn hàng thành công, gửi email thông báo cho khách hàng và admin, sửa lỗi form field BooleanField với HiddenInput không xử lý đúng multiple values, cải thiện UI team management để không hiển thị nút cập nhật thanh toán cho status PENDING, và dọn dẹp toàn bộ debug logs để code production-ready. Workflow hoạt động hoàn hảo: đội trưởng check discount → submit payment → đơn hàng shop được tạo tự động → cart được xóa → email được gửi.
  - **Hoàn thành trang tìm kiếm shop BTC:** Đã tạo thành công trang tìm kiếm shop BTC với giao diện hiện đại đồng bộ với trang tìm việc. Bao gồm: Hero section với gradient tím (#667eea → #764ba2) và thống kê tổng quan, bộ lọc thông minh (tìm kiếm theo tên, khu vực, giải đấu), shop cards đẹp mắt với thông tin chi tiết, sidebar "Shop Nổi Bật" hiển thị top shops có nhiều sản phẩm nhất, logic tìm kiếm thông minh với tối ưu database queries, responsive design cho mọi thiết bị. Cập nhật menu Shop thành dropdown với 2 mục: "Shop Chính" (highlight với gradient tím và màu vàng khi hover) và "Shop BTC". Sửa lỗi template organization shop khi không có logo bằng cách thêm placeholder đẹp mắt với icon shop và styling đồng nhất.
  - **Hoàn thành tối ưu hóa chức năng upload banner Organization Shop:** Đã hoàn thiện toàn bộ hệ thống upload banner cho ban tổ chức với các cải tiến lớn: (1) Dọn dẹp code debug không cần thiết - xóa views debug_banner_upload, test_csrf và templates tương ứng, loại bỏ @csrf_exempt không an toàn; (2) Thêm chức năng tự động resize và nén ảnh với thuật toán Cover thông minh - resize về 1200x300px, crop từ center, nén xuống dưới 2MB với quality adaptive 85%→75%→65%; (3) Cải thiện UX với gợi ý kích thước rõ ràng, preview ảnh, validation file type và size; (4) Sửa lỗi góc banner không có border-radius và ảnh bị repeat/tile - thêm border-radius 15px, box-shadow đẹp, CSS !important để ngăn chặn override; (5) Khắc phục hoàn toàn vấn đề ảnh bị cắt và nối sai phần - thuật toán Cover đảm bảo fill đầy banner, không bị repeat hay tile. Hệ thống banner giờ hoạt động hoàn hảo với giao diện đẹp và tính năng chuyên nghiệp.
  - **Hoàn thành sửa lỗi layout price badge trong checkout:** Đã khắc phục thành công vấn đề price badge bị cắt xuống dòng trong phần tóm tắt đơn hàng checkout. Cải thiện CSS với `white-space: nowrap`, `display: inline-block`, `min-width: fit-content` cho price-tag. Cập nhật summary-row với `flex-wrap: wrap` và responsive layout. Thêm mobile responsive với layout dọc và font size nhỏ hơn. Price badge giờ hiển thị hoàn hảo trên mọi thiết bị.
  - **Hoàn thành loại bỏ logic thừa trong checkout upload:** Đã khắc phục thành công lỗi nút "Xác nhận upload" thừa trong trang checkout Organization Shop. Loại bỏ nút "Xác nhận upload" không cần thiết và function `confirmUpload()`, tích hợp nút "Xóa file" trực tiếp vào preview section. Cải thiện UX với flow đơn giản: chọn file → preview ngay → xóa nếu cần → đặt hàng. File upload giờ hoạt động mượt mà không còn lỗi.
  - **Hoàn thành sửa lỗi text contrast trong banner Organization Shop:** Đã khắc phục thành công vấn đề chữ bị trùng màu nền khó đọc trong tất cả banner của Organization Shop. Cập nhật styling cho 13 templates bao gồm management pages (manage_shop, manage_products, manage_categories, manage_orders, shop_settings, edit_product, edit_category) và shop pages (shop_home, checkout, cart, product_detail, product_list, order_detail, order_list). Thêm text-shadow đậm (rgba(0,0,0,0.8)), z-index positioning, và responsive design cho mobile. Tất cả banner giờ có text trắng với shadow đậm, dễ đọc trên background gradient tím.
  - **Hoàn thành cải thiện UX điều hướng trong Organization Shop và BTC Management:** Đã thực hiện thành công việc cải thiện trải nghiệm người dùng bằng cách loại bỏ `target="_blank"` khỏi tất cả các nút điều hướng chính trong cả Organization Shop và khu vực quản lý BTC. Các nút "Xem Shop", "Quay về BTC", "Tới trang Bốc thăm", "Xếp Lịch Thi Đấu", "Tải ảnh hàng loạt", và tất cả nút xem chi tiết (team, match, player, profile) giờ đây đều chuyển hướng trong cùng tab thay vì mở tab mới. Chỉ giữ lại `target="_blank"` cho các nút cần thiết như payment proof, sponsorship proposal, và preview website. Cải thiện này tạo ra trải nghiệm điều hướng mượt mà và nhất quán cho người dùng.

- **Các quyết định gần đây:**
  - **Quyết định về CSS Scoping Strategy cho Music Player:** Áp dụng CSS scoping pattern để tránh xung đột global styles. Tất cả selector của music player phải được prefix với `.music-player-popup` để chỉ áp dụng trong phạm vi component. Tránh sử dụng class names quá chung như `.form-select`, `.section-title`, `.empty-state` mà không có parent scope. Pattern này đảm bảo component-level CSS isolation và tránh ảnh hưởng đến các phần khác của website.
  - **Quyết định về Shop Search Architecture:** Thiết kế trang tìm kiếm shop BTC với giao diện đồng bộ với trang tìm việc để tạo trải nghiệm nhất quán. Sử dụng gradient tím (#667eea → #764ba2) cho hero section, bộ lọc thông minh với tìm kiếm theo tên/khu vực/giải đấu, shop cards với thông tin chi tiết và sidebar "Shop Nổi Bật". Tối ưu database queries với select_related và prefetch_related để tránh N+1 queries. Cập nhật menu Shop thành dropdown với highlight effect cho "Shop Chính" để thu hút sự chú ý.
  - **Quyết định về UX Navigation Strategy:** Thiết lập nguyên tắc điều hướng nhất quán trong toàn bộ hệ thống bằng cách loại bỏ `target="_blank"` khỏi tất cả các nút điều hướng chính. Chỉ giữ lại `target="_blank"` cho các nút cần thiết như payment proof (để xem ảnh), sponsorship proposal (có thể cần tab mới), và preview website (để xem website). Quyết định này tạo ra trải nghiệm người dùng mượt mà và nhất quán, tránh việc mở quá nhiều tab không cần thiết.
  - **Quyết định về Organization Shop Architecture:** Thiết kế hệ thống shop riêng cho từng BTC với tính độc lập hoàn toàn. Mỗi BTC có models riêng (OrganizationCategory, OrganizationProduct, OrganizationOrder) với unique constraints trong cùng organization. Sử dụng slug-based URL routing `/shop/org/<org_slug>/` để truy cập shop của từng BTC. Tích hợp logic khuyến mãi thông minh chỉ tính từ shop của BTC tổ chức giải đấu.
  - **Quyết định về Tournament Discount Logic:** Cập nhật Tournament model để hỗ trợ cả Global Shop và Organization Shop. Method `get_final_registration_fee()` nhận cả `cart_items` và `org_cart_items` để tính khuyến mãi từ cả hai loại shop. Logic khuyến mãi chỉ áp dụng cho sản phẩm từ shop của BTC tổ chức giải đấu để đảm bảo tính nhất quán và logic kinh doanh.
  - **Quyết định về Database Migration Strategy:** Sử dụng migration data để populate slug cho Organization model hiện có. Tạo migration với null=True trước, sau đó populate data, cuối cùng remove null constraint. Đảm bảo slug unique với auto-generation từ tên organization và fallback numbering cho trường hợp trùng tên.
  - **Quyết định về Staff Payment System Integration:** Tích hợp hệ thống quản lý tiền công nhân viên vào budget system với model StaffPayment có các trường rate_per_unit, payment_unit, number_of_units, total_amount, status (PENDING/PAID/CANCELLED), payment_date, notes. Chỉ tính staff payments có status='PAID' vào tổng chi để đảm bảo tính chính xác của budget. Hỗ trợ cả chế độ thêm đơn lẻ và hàng loạt trong một form tích hợp với JavaScript validation.