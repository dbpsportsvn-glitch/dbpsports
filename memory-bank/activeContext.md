# Bối Cảnh Hiện Tại

- **Công việc đang tập trung:**
  - **Hoàn thành Organization Shop System:** Đã hoàn thành hệ thống shop riêng cho từng ban tổ chức (BTC) với đầy đủ tính năng frontend và backend. Bao gồm: Database Models, Views & URLs, Templates, Management Interface, Sample Data, Bug Fixes, Edit/Delete Functions, và Shop Settings Upgrade. Hệ thống đã sẵn sàng để sử dụng với đầy đủ tính năng quản lý và giao diện chuyên nghiệp.

- **Các thay đổi gần đây:**
  - **Nâng cấp giao diện cài đặt shop:** Hoàn thành việc nâng cấp giao diện cài đặt shop với đầy đủ các trường thông tin khoa học và chuyên nghiệp. Bao gồm: Thông tin cơ bản (tên shop, email, phone, logo, mô tả, địa chỉ), Cài đặt giao hàng (phí ship, ngưỡng miễn phí, chính sách), Cài đặt thanh toán (thông tin ngân hàng, QR code, phương thức), và Trạng thái shop. Thêm JavaScript features: auto-save localStorage, format tiền tệ/phone/bank account, preview ảnh, validation real-time, và responsive design với sidebar preview.
  - **Hoàn thành chức năng chỉnh sửa và xóa:** Implement đầy đủ chức năng edit/delete cho cả danh mục và sản phẩm với 4 templates mới (edit_product, delete_product, edit_category, delete_category), 4 view functions với validation đầy đủ, URL routing hoàn chỉnh, và giao diện xác nhận xóa chuyên nghiệp. Thêm tính năng bảo mật: kiểm tra quyền truy cập, validation dữ liệu, cảnh báo hậu quả xóa, và không cho xóa danh mục có sản phẩm. Cập nhật templates quản lý với nút edit/delete hoạt động thay vì placeholder.
  - **Sửa lỗi upload ảnh:** Khắc phục thành công lỗi upload ảnh cho danh mục và sản phẩm bằng cách sửa template từ `product.image` thành `product.main_image` để khớp với field name trong model. Cải thiện JavaScript error handling với chi tiết lỗi trong console, tối ưu CSRF token handling, tạo thư mục media cần thiết, và cải thiện error messages. Upload ảnh hiện hoạt động hoàn hảo cho cả danh mục và sản phẩm.
  - **Hoàn thành Organization Shop Templates & Management:** Tạo đầy đủ 7 templates cho Organization Shop frontend và 4 templates quản lý với giao diện đẹp mắt và responsive. Bao gồm: shop_home, product_list, product_detail, cart, checkout, order_detail, manage_shop, manage_products, manage_orders, manage_categories, shop_settings. Tích hợp breadcrumb navigation, stats cards, và modern UI design.
  - **Tạo dữ liệu mẫu cho Organization Shop:** Tạo thành công management command và script để tạo dữ liệu mẫu bao gồm 3 danh mục (Sports Shirts, Sports Pants, Sports Shoes), 3 sản phẩm (Nike Dri-FIT Shirt, Nike Dri-FIT Shorts, Nike Air Zoom Shoes), shop settings, và product sizes. Dữ liệu đã được populate thành công vào database.
  - **Sửa các lỗi Organization Shop:** Khắc phục thành công 5 lỗi chính: NoReverseMatch namespace URLs, TemplateSyntaxError với current_category, FieldError với organization.members query, ValueError với main_image, và NoReverseMatch với cart URLs. Tất cả templates đã được cập nhật để xử lý trường hợp không có hình ảnh và URL patterns đúng cách.
  - **Hoàn thành Organization Shop Database Models:** Tạo thành công 9 models mới cho Organization Shop bao gồm OrganizationCategory, OrganizationProduct, OrganizationProductVariant, OrganizationProductImage, OrganizationCart, OrganizationCartItem, OrganizationOrder, OrganizationOrderItem, OrganizationShopSettings. Tích hợp vào Django Admin với giao diện quản lý chuyên nghiệp. Tạo migration thành công và chạy migration database.
  - **Cập nhật Tournament Model cho Organization Shop:** Thêm method `calculate_organization_shop_discount()` để tính khuyến mãi từ shop của BTC tổ chức giải đấu. Cập nhật `get_final_registration_fee()` hỗ trợ cả Global Shop và Organization Shop. Thêm methods `has_organization_shop()` và `get_organization_shop_settings()` để kiểm tra và lấy cài đặt shop.
  - **Tạo Organization Shop Views & URLs:** Tạo đầy đủ 12 views cho Organization Shop bao gồm shop_home, product_list, product_detail, cart management, checkout, order management. Tạo URL structure `/shop/org/<org_slug>/` với routing hoàn chỉnh. Thêm slug field vào Organization model với auto-generation và migration thành công.
  - **Hoàn thành nâng cấp hệ thống quản lý tài chính cho BTC:** Đã thêm đầy đủ tính năng quản lý tiền công nhân viên bao gồm model StaffPayment, forms với validation, views cho CRUD operations, templates responsive, URLs routing, Django admin integration, và tích hợp vào budget system. Đã khắc phục vấn đề tiền công chưa được tính vào tổng chi bằng cách cập nhật method get_total_expenses() để chỉ tính staff payments có status='PAID'. Thêm trường trạng thái thanh toán vào form tạo mới với JavaScript validation để BTC có thể chọn ngay trạng thái "Đã thanh toán" hoặc "Chờ thanh toán". Hỗ trợ cả chế độ thêm đơn lẻ và hàng loạt trong một form tích hợp. Khắc phục các lỗi form validation, TypeError với data type conversion, và NoReverseMatch với URL namespace.

- **Các quyết định gần đây:**
  - **Quyết định về Organization Shop Architecture:** Thiết kế hệ thống shop riêng cho từng BTC với tính độc lập hoàn toàn. Mỗi BTC có models riêng (OrganizationCategory, OrganizationProduct, OrganizationOrder) với unique constraints trong cùng organization. Sử dụng slug-based URL routing `/shop/org/<org_slug>/` để truy cập shop của từng BTC. Tích hợp logic khuyến mãi thông minh chỉ tính từ shop của BTC tổ chức giải đấu.
  - **Quyết định về Tournament Discount Logic:** Cập nhật Tournament model để hỗ trợ cả Global Shop và Organization Shop. Method `get_final_registration_fee()` nhận cả `cart_items` và `org_cart_items` để tính khuyến mãi từ cả hai loại shop. Logic khuyến mãi chỉ áp dụng cho sản phẩm từ shop của BTC tổ chức giải đấu để đảm bảo tính nhất quán và logic kinh doanh.
  - **Quyết định về Database Migration Strategy:** Sử dụng migration data để populate slug cho Organization model hiện có. Tạo migration với null=True trước, sau đó populate data, cuối cùng remove null constraint. Đảm bảo slug unique với auto-generation từ tên organization và fallback numbering cho trường hợp trùng tên.
  - **Quyết định về Staff Payment System Integration:** Tích hợp hệ thống quản lý tiền công nhân viên vào budget system với model StaffPayment có các trường rate_per_unit, payment_unit, number_of_units, total_amount, status (PENDING/PAID/CANCELLED), payment_date, notes. Chỉ tính staff payments có status='PAID' vào tổng chi để đảm bảo tính chính xác của budget. Hỗ trợ cả chế độ thêm đơn lẻ và hàng loạt trong một form tích hợp với JavaScript validation.
  - **Quyết định về Navigation Structure:** Thiết lập navigation hierarchy với nút "Tài chính" đứng trước "Quản lý giải đấu" để ưu tiên truy cập budget dashboard. Sử dụng URL namespace `organizations:manage_tournament` để dẫn về Khu vực Quản lý BTC từ các trang quản lý tài chính. Tất cả các trang con đều có navigation buttons dẫn về trang chủ BTC.
  - **Quyết định về Form Validation:** Sử dụng CSS class `hidden-field` thay vì `display: none` để ẩn các trường không cần thiết trong form, tránh lỗi browser validation "not focusable". Kết hợp client-side JavaScript validation với server-side Django form validation để đảm bảo data integrity và user experience tốt.
  - **Quyết định về Memory Bank Management:** Giới hạn file activeContext.md để tránh quá dài, chỉ giữ lại 10 mục gần đây nhất trong "Các thay đổi gần đây" và 7 quyết định quan trọng nhất trong "Các quyết định gần đây". Di chuyển thông tin cũ sang progress.md để duy trì tính gọn gàng và dễ quản lý.