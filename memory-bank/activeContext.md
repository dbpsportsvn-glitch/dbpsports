# Bối Cảnh Hiện Tại

- **Công việc đang tập trung:**
  - (Không có công việc đang tập trung cụ thể)

- **Các thay đổi gần đây:**
  - **Hoàn thành tính năng Music Player với autoplay:** Đã tạo thành công hệ thống trình phát nhạc popup với đầy đủ tính năng bao gồm: Django app music_player với models Playlist, Track, MusicPlayerSettings, API endpoints để fetch playlists và tracks, frontend JavaScript với Audio API để phát nhạc, giao diện popup mini player và full player với Bootstrap 5 styling, tính năng autoplay với user interaction detection (click, keydown, hover), hệ thống admin để quản lý playlists và tracks với drag & drop upload, tự động refresh playlists khi có thay đổi, và khắc phục các lỗi autoplay policy của trình duyệt. Trình phát nhạc hoạt động hoàn hảo với khả năng tự động phát khi user tương tác và luôn hiển thị trên tất cả các trang.
  - **Hoàn thành tính năng discount tournament registration payment:** Đã hoàn thiện tính năng tích hợp shop discount vào thanh toán lệ phí giải đấu. Bao gồm: Logic tự động tạo đơn hàng shop khi đội trưởng check discount checkbox, tính toán discount dựa trên profit từ cart items, hỗ trợ cả Main Shop và Organization Shop, tự động xóa cart sau khi tạo đơn hàng thành công, gửi email thông báo cho khách hàng và admin, sửa lỗi form field BooleanField với HiddenInput không xử lý đúng multiple values, cải thiện UI team management để không hiển thị nút cập nhật thanh toán cho status PENDING, và dọn dẹp toàn bộ debug logs để code production-ready. Workflow hoạt động hoàn hảo: đội trưởng check discount → submit payment → đơn hàng shop được tạo tự động → cart được xóa → email được gửi.
  - **Hoàn thành trang tìm kiếm shop BTC:** Đã tạo thành công trang tìm kiếm shop BTC với giao diện hiện đại đồng bộ với trang tìm việc. Bao gồm: Hero section với gradient tím (#667eea → #764ba2) và thống kê tổng quan, bộ lọc thông minh (tìm kiếm theo tên, khu vực, giải đấu), shop cards đẹp mắt với thông tin chi tiết, sidebar "Shop Nổi Bật" hiển thị top shops có nhiều sản phẩm nhất, logic tìm kiếm thông minh với tối ưu database queries, responsive design cho mọi thiết bị. Cập nhật menu Shop thành dropdown với 2 mục: "Shop Chính" (highlight với gradient tím và màu vàng khi hover) và "Shop BTC". Sửa lỗi template organization shop khi không có logo bằng cách thêm placeholder đẹp mắt với icon shop và styling đồng nhất.
  - **Hoàn thành tối ưu hóa chức năng upload banner Organization Shop:** Đã hoàn thiện toàn bộ hệ thống upload banner cho ban tổ chức với các cải tiến lớn: (1) Dọn dẹp code debug không cần thiết - xóa views debug_banner_upload, test_csrf và templates tương ứng, loại bỏ @csrf_exempt không an toàn; (2) Thêm chức năng tự động resize và nén ảnh với thuật toán Cover thông minh - resize về 1200x300px, crop từ center, nén xuống dưới 2MB với quality adaptive 85%→75%→65%; (3) Cải thiện UX với gợi ý kích thước rõ ràng, preview ảnh, validation file type và size; (4) Sửa lỗi góc banner không có border-radius và ảnh bị repeat/tile - thêm border-radius 15px, box-shadow đẹp, CSS !important để ngăn chặn override; (5) Khắc phục hoàn toàn vấn đề ảnh bị cắt và nối sai phần - thuật toán Cover đảm bảo fill đầy banner, không bị repeat hay tile. Hệ thống banner giờ hoạt động hoàn hảo với giao diện đẹp và tính năng chuyên nghiệp.
  - **Hoàn thành sửa lỗi layout price badge trong checkout:** Đã khắc phục thành công vấn đề price badge bị cắt xuống dòng trong phần tóm tắt đơn hàng checkout. Cải thiện CSS với `white-space: nowrap`, `display: inline-block`, `min-width: fit-content` cho price-tag. Cập nhật summary-row với `flex-wrap: wrap` và responsive layout. Thêm mobile responsive với layout dọc và font size nhỏ hơn. Price badge giờ hiển thị hoàn hảo trên mọi thiết bị.
  - **Hoàn thành loại bỏ logic thừa trong checkout upload:** Đã khắc phục thành công lỗi nút "Xác nhận upload" thừa trong trang checkout Organization Shop. Loại bỏ nút "Xác nhận upload" không cần thiết và function `confirmUpload()`, tích hợp nút "Xóa file" trực tiếp vào preview section. Cải thiện UX với flow đơn giản: chọn file → preview ngay → xóa nếu cần → đặt hàng. File upload giờ hoạt động mượt mà không còn lỗi.
  - **Hoàn thành sửa lỗi text contrast trong banner Organization Shop:** Đã khắc phục thành công vấn đề chữ bị trùng màu nền khó đọc trong tất cả banner của Organization Shop. Cập nhật styling cho 13 templates bao gồm management pages (manage_shop, manage_products, manage_categories, manage_orders, shop_settings, edit_product, edit_category) và shop pages (shop_home, checkout, cart, product_detail, product_list, order_detail, order_list). Thêm text-shadow đậm (rgba(0,0,0,0.8)), z-index positioning, và responsive design cho mobile. Tất cả banner giờ có text trắng với shadow đậm, dễ đọc trên background gradient tím.
  - **Hoàn thành cải thiện UX điều hướng trong Organization Shop và BTC Management:** Đã thực hiện thành công việc cải thiện trải nghiệm người dùng bằng cách loại bỏ `target="_blank"` khỏi tất cả các nút điều hướng chính trong cả Organization Shop và khu vực quản lý BTC. Các nút "Xem Shop", "Quay về BTC", "Tới trang Bốc thăm", "Xếp Lịch Thi Đấu", "Tải ảnh hàng loạt", và tất cả nút xem chi tiết (team, match, player, profile) giờ đây đều chuyển hướng trong cùng tab thay vì mở tab mới. Chỉ giữ lại `target="_blank"` cho các nút cần thiết như payment proof, sponsorship proposal, và preview website. Cải thiện này tạo ra trải nghiệm điều hướng mượt mà và nhất quán cho người dùng.
  - **Hoàn thành nâng cấp nút "Quay về BTC" với màu sắc và vị trí mới:** Đã thành công nâng cấp nút "Quay về BTC" với gradient màu đẹp mắt (từ xanh tím #667eea đến tím #764ba2) và chuyển vị trí từ góc trên bên phải xuống góc dưới bên phải. Nút được thiết kế với shadow effects, hover animations, và responsive design cho cả desktop và mobile. Cập nhật tất cả 5 templates Organization Shop với styling đồng nhất và JavaScript force styling để đảm bảo hiển thị đúng.
  - **Hoàn thành sửa lỗi nút "Xem Shop" trên mobile trong Organization Shop Dashboard:** Đã khắc phục thành công lỗi không thể nhấn vào nút "Xem Shop" trên banner trong khu vực dashboard shop của ban tổ chức trên mobile. Nguyên nhân chính là pseudo-element `::before` với `position: absolute` đang che khuất nút. Giải pháp: đặt `z-index: 1` cho pseudo-element, `z-index: 5` cho title/subtitle, và `z-index: 10` cho container và nút. Cập nhật HTML structure với Bootstrap responsive classes và CSS responsive phù hợp cho mobile touch interface. Nút giờ đây hoạt động hoàn hảo trên mobile với styling bình thường.
  - **Hoàn thành sửa lỗi admin menu mobile và cập nhật footer templates:** Đã khắc phục thành công lỗi admin menu chỉ hiển thị "shopmanager" trên mobile bằng cách sửa template admin/index.html để bao gồm lại Django admin app list và thêm responsive CSS. Cập nhật và thiết kế lại toàn bộ footer templates (FAQ, Terms of Service, Privacy Policy, Data Deletion) với nội dung mới phản ánh tính năng hiện tại của DBP Sports và giao diện hiện đại với màu sắc DBP Sports (#dc2626, #b91c1c, #f59e0b). Sửa CSS override trong custom.css và thêm !important để đảm bảo màu sắc hiển thị đúng.
  - **Hoàn thành thiết kế lại trang chủ Organization Shop:** Đã thiết kế lại trang chủ shop BTC với giao diện hiện đại và chuyên nghiệp. Bao gồm: Modern Hero Section với background pattern và floating animations, BTC Management Button (fixed position), Shop Statistics (sản phẩm, đơn hàng, khách hàng), Enhanced Contact Section với hover effects, Modern Cards với improved spacing và typography, và Responsive Design cho mọi thiết bị. Cải thiện độ tương phản và màu sắc để dễ đọc hơn.
  - **Hoàn thành cải thiện Organization Shop Management:** Đã thêm đầy đủ tính năng quản lý đơn hàng cho BTC bao gồm: Payment Confirmation (xác nhận thanh toán), Order Status Updates (cập nhật trạng thái đơn hàng), Invoice Viewing (xem hóa đơn), Payment Proof Download (tải xuống chứng từ thanh toán), và Cancel Order với logic cập nhật payment_status thành 'failed'. Cải thiện navigation với conditional back buttons dựa trên user role, thêm success messages cho đơn hàng mới, và cập nhật templates để hiển thị đầy đủ thông tin thanh toán.
  - **Hoàn thành dọn dẹp và tối ưu codebase:** Đã xóa thành công các file test và debug không cần thiết bao gồm: create_sample_data.py, create_sample_shop_data.py, create_sample_products.py, create_ewallet_sample.py, create_sample_blog_data.py, và restart.txt. Dọn dẹp Python cache files (*.pyc) và __pycache__ directories. Codebase giờ đây sạch sẽ và chỉ chứa những file cần thiết cho production.
  - **Hoàn thành Organization Shop Dashboard & Payment Proof:** Tạo thành công Organization Shop Dashboard với đầy đủ thống kê và analytics như Global Shop. Bao gồm: Statistics cards (tổng đơn hàng, doanh thu, sản phẩm, doanh thu tháng), Order status overview (chờ xử lý, đang xử lý, hoàn thành, hết hàng), Charts integration (Chart.js cho monthly stats và payment status), Recent orders table, Bestseller products table. Thêm Payment Proof Upload cho checkout với file preview, remove function, và FormData integration. Cải thiện Copy System với fallback clipboard API và professional modal. Gộp 3 mục shop vào dropdown menu trong organization dashboard để gọn gàng hơn.
  - **Nâng cấp giao diện cài đặt shop:** Hoàn thành việc nâng cấp giao diện cài đặt shop với đầy đủ các trường thông tin khoa học và chuyên nghiệp. Bao gồm: Thông tin cơ bản (tên shop, email, phone, logo, mô tả, địa chỉ), Cài đặt giao hàng (phí ship, ngưỡng miễn phí, chính sách), Cài đặt thanh toán (thông tin ngân hàng, QR code, phương thức), và Trạng thái shop. Thêm JavaScript features: auto-save localStorage, format tiền tệ/phone/bank account, preview ảnh, validation real-time, và responsive design với sidebar preview.
  - **Hoàn thành chức năng chỉnh sửa và xóa:** Implement đầy đủ chức năng edit/delete cho cả danh mục và sản phẩm với 4 templates mới (edit_product, delete_product, edit_category, delete_category), 4 view functions với validation đầy đủ, URL routing hoàn chỉnh, và giao diện xác nhận xóa chuyên nghiệp. Thêm tính năng bảo mật: kiểm tra quyền truy cập, validation dữ liệu, cảnh báo hậu quả xóa, và không cho xóa danh mục có sản phẩm. Cập nhật templates quản lý với nút edit/delete hoạt động thay vì placeholder.
  - **Sửa lỗi upload ảnh:** Khắc phục thành công lỗi upload ảnh cho danh mục và sản phẩm bằng cách sửa template từ `product.image` thành `product.main_image` để khớp với field name trong model. Cải thiện JavaScript error handling với chi tiết lỗi trong console, tối ưu CSRF token handling, tạo thư mục media cần thiết, và cải thiện error messages. Upload ảnh hiện hoạt động hoàn hảo cho cả danh mục và sản phẩm.
  - **Hoàn thành Organization Shop Templates & Management:** Tạo đầy đủ 7 templates cho Organization Shop frontend và 4 templates quản lý với giao diện đẹp mắt và responsive. Bao gồm: shop_home, product_list, product_detail, cart, checkout, order_detail, manage_shop, manage_products, manage_orders, manage_categories, shop_settings. Tích hợp breadcrumb navigation, stats cards, và modern UI design.

- **Các quyết định gần đây:**
  - **Quyết định về Shop Search Architecture:** Thiết kế trang tìm kiếm shop BTC với giao diện đồng bộ với trang tìm việc để tạo trải nghiệm nhất quán. Sử dụng gradient tím (#667eea → #764ba2) cho hero section, bộ lọc thông minh với tìm kiếm theo tên/khu vực/giải đấu, shop cards với thông tin chi tiết và sidebar "Shop Nổi Bật". Tối ưu database queries với select_related và prefetch_related để tránh N+1 queries. Cập nhật menu Shop thành dropdown với highlight effect cho "Shop Chính" để thu hút sự chú ý.
  - **Quyết định về UX Navigation Strategy:** Thiết lập nguyên tắc điều hướng nhất quán trong toàn bộ hệ thống bằng cách loại bỏ `target="_blank"` khỏi tất cả các nút điều hướng chính. Chỉ giữ lại `target="_blank"` cho các nút cần thiết như payment proof (để xem ảnh), sponsorship proposal (có thể cần tab mới), và preview website (để xem website). Quyết định này tạo ra trải nghiệm người dùng mượt mà và nhất quán, tránh việc mở quá nhiều tab không cần thiết.
  - **Quyết định về Organization Shop Architecture:** Thiết kế hệ thống shop riêng cho từng BTC với tính độc lập hoàn toàn. Mỗi BTC có models riêng (OrganizationCategory, OrganizationProduct, OrganizationOrder) với unique constraints trong cùng organization. Sử dụng slug-based URL routing `/shop/org/<org_slug>/` để truy cập shop của từng BTC. Tích hợp logic khuyến mãi thông minh chỉ tính từ shop của BTC tổ chức giải đấu.
  - **Quyết định về Tournament Discount Logic:** Cập nhật Tournament model để hỗ trợ cả Global Shop và Organization Shop. Method `get_final_registration_fee()` nhận cả `cart_items` và `org_cart_items` để tính khuyến mãi từ cả hai loại shop. Logic khuyến mãi chỉ áp dụng cho sản phẩm từ shop của BTC tổ chức giải đấu để đảm bảo tính nhất quán và logic kinh doanh.
  - **Quyết định về Database Migration Strategy:** Sử dụng migration data để populate slug cho Organization model hiện có. Tạo migration với null=True trước, sau đó populate data, cuối cùng remove null constraint. Đảm bảo slug unique với auto-generation từ tên organization và fallback numbering cho trường hợp trùng tên.
  - **Quyết định về Staff Payment System Integration:** Tích hợp hệ thống quản lý tiền công nhân viên vào budget system với model StaffPayment có các trường rate_per_unit, payment_unit, number_of_units, total_amount, status (PENDING/PAID/CANCELLED), payment_date, notes. Chỉ tính staff payments có status='PAID' vào tổng chi để đảm bảo tính chính xác của budget. Hỗ trợ cả chế độ thêm đơn lẻ và hàng loạt trong một form tích hợp với JavaScript validation.
  - **Quyết định về Memory Bank Management:** Giới hạn file activeContext.md để tránh quá dài, chỉ giữ lại 10 mục gần đây nhất trong "Các thay đổi gần đây" và 7 quyết định quan trọng nhất trong "Các quyết định gần đây". Di chuyển thông tin cũ sang progress.md để duy trì tính gọn gàng và dễ quản lý.