{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}{{ team.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    {# === THAY ƒê·ªîI B·∫ÆT ƒê·∫¶U T·∫†I ƒê√ÇY === #}
    {% if team.tournament %}
        <a href="{% url 'tournament_detail' pk=team.tournament.pk %}?tab=teams#teams" class="btn btn-outline-secondary btn-sm mb-3">
            <i class="bi bi-arrow-left"></i> V·ªÅ gi·∫£i ƒë·∫•u
        </a>
    {% else %}
        <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary btn-sm mb-3">
            <i class="bi bi-arrow-left"></i> V·ªÅ trang c√° nh√¢n
        </a>
    {% endif %}
    {# === K·∫æT TH√öC THAY ƒê·ªîI === #}

    <div class="row">
        <div class="col-md-5">
            <div class="card mb-4">
                <div class="card-header">
                    <h4>Th√¥ng tin ƒê·ªôi b√≥ng</h4>
                </div>
                <div class="card-body d-flex align-items-start gap-3">
                    <div class="flex-grow-1">
                        <h5 class="card-title mb-1">{{ team.name }}</h5>
                        <div class="text-muted mb-2">
                            Gi·∫£i ƒë·∫•u: {{ team.tournament.name|default:"ƒê·ªôi t·ª± do" }}
                        </div>
                        <p class="mb-2">
                            {% if team.coach_name %}<strong>HLV:</strong> {{ team.coach_name }}<br>{% endif %}
                            <strong>ƒê·ªôi tr∆∞·ªüng:</strong> {{ team.captain.username }}
                        </p>
                        
                        {# Ch·ªâ hi·ªÉn th·ªã tr·∫°ng th√°i thanh to√°n cho c√°c ƒë·ªôi trong gi·∫£i #}
                        {% if team.tournament %}
                        <div class="mt-3 mb-3">
                            <strong>Tr·∫°ng th√°i:</strong>
                            {% if team.payment_status == 'UNPAID' %}
                                <span class="badge bg-danger">Ch∆∞a thanh to√°n</span>
                                <a href="{% url 'team_payment' pk=team.pk %}" class="btn btn-success btn-sm ms-2">Thanh to√°n L·ªá ph√≠</a>
                            {% elif team.payment_status == 'PENDING' %}
                                <span class="badge bg-warning text-dark">Ch·ªù x√°c nh·∫≠n</span>
                            {% elif team.payment_status == 'PAID' %}
                                <span class="badge bg-success">ƒê√£ thanh to√°n</span>
                            {% endif %}
                        </div>
                        {% endif %}

                        {% if user == team.captain %}
                        <div class="btn-group">
                            <a href="{% url 'update_team' pk=team.pk %}" class="btn btn-warning btn-sm">S·ª≠a th√¥ng tin ƒë·ªôi</a>
                            <a href="{% url 'team_hall_of_fame' pk=team.pk %}" class="btn btn-info btn-sm">üèÜ Ph√≤ng Truy·ªÅn th·ªëng</a>
                            {% if team.tournament %}
                            <a href="{% url 'tournament_detail' pk=team.tournament.pk %}?tab=schedule#schedule" class="btn btn-primary btn-sm">L·ªãch thi ƒë·∫•u</a>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    <div class="ms-auto d-flex align-items-center justify-content-center" 
                         style="width:96px;height:96px;border-radius:50%;overflow:hidden;background:#f8f9fa;border:1px solid var(--bs-border-color);flex-shrink: 0;">
                        {% if team.logo %}
                            <img src="{{ team.logo.url }}" alt="{{ team.name }}" style="width:100%;height:100%;object-fit:cover;">
                        {% else %}
                            <span class="text-muted small text-center px-1">Ch∆∞a c√≥ logo</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            {% if team.payment_status == 'PAID' and user == team.captain %}
              <div class="card mb-4">
                <div class="card-header"><h5>Th√™m c·∫ßu th·ªß m·ªõi</h5></div>
                <div class="card-body">
                  
                  <div class="alert alert-info small">
                      <i class="bi bi-info-circle-fill"></i> <strong>L∆∞u √Ω:</strong> H√£y nh·∫≠p th√¥ng tin ch√≠nh x√°c. C√°c th√¥ng tin n√†y s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng cho "Th·ªã tr∆∞·ªùng chuy·ªÉn nh∆∞·ª£ng" trong t∆∞∆°ng lai. M·ªói c·∫ßu th·ªß ch·ªâ c√≥ th·ªÉ ƒë∆∞·ª£c ch·ªânh s·ª≠a t·ªëi ƒëa <strong>3 l·∫ßn</strong> v√† s·∫Ω b·ªã kh√≥a khi ƒë√£ c√≥ phi·∫øu b·∫ßu.
                  </div>

                  <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6">{{ player_form.full_name|as_crispy_field }}</div>
                        <div class="col-md-6">{{ player_form.jersey_number|as_crispy_field }}</div>
                        <div class="col-md-6">{{ player_form.position|as_crispy_field }}</div>
                        <div class="col-md-6">{{ player_form.specialty_position|as_crispy_field }}</div>
                        <div class="col-md-6">{{ player_form.date_of_birth|as_crispy_field }}</div>
                        <div class="col-md-6">{{ player_form.preferred_foot|as_crispy_field }}</div>
                        <div class="col-md-6">{{ player_form.height|as_crispy_field }}</div>
                        <div class="col-md-6">{{ player_form.weight|as_crispy_field }}</div>
                        <div class="col-12">{{ player_form.agent_contact|as_crispy_field }}</div>
                        <div class="col-12">{{ player_form.avatar|as_crispy_field }}</div>
                    </div>

                    <button type="submit" class="btn btn-primary mt-3 w-100">Th√™m v√†o ƒë·ªôi h√¨nh</button>
                  </form>
                </div>
              </div>
            {% elif team.payment_status != 'PAID' and team.tournament %}
                <div class="alert alert-warning" role="alert">
                  <h4 class="alert-heading">T√≠nh nƒÉng b·ªã kh√≥a!</h4>
                  <p>C√°c ch·ª©c nƒÉng qu·∫£n l√Ω ƒë·ªôi h√¨nh s·∫Ω ƒë∆∞·ª£c m·ªü sau khi Ban t·ªï ch·ª©c x√°c nh·∫≠n thanh to√°n l·ªá ph√≠ th√†nh c√¥ng.</p>
                </div>
            {% endif %}
        </div>

        <div class="col-md-7">
            <div class="card">
                <div class="card-header"><h4>ƒê·ªôi h√¨nh hi·ªán t·∫°i</h4></div>
                <ul class="list-group list-group-flush">
                    {% for player in team.players.all %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>
                                <strong>#{{ player.jersey_number }}</strong> - 
                                <a href="{% url 'player_detail' pk=player.pk %}">{{ player.full_name }}</a>
                                {% if player.user and team.captain == player.user %}
                                    <span class="captain-indicator">(C)</span>
                                {% endif %}
                                ({{ player.get_position_display }})
                            </span>
                            {% if user == team.captain %}
                                <div>
                                    <a href="{% url 'update_player' pk=player.pk %}" class="btn btn-warning btn-sm">S·ª≠a</a>
                                    <a href="{% url 'delete_player' pk=player.pk %}" class="btn btn-danger btn-sm">X√≥a</a>
                                </div>
                            {% endif %}
                        </li>
                    {% empty %}
                        <li class="list-group-item">Ch∆∞a c√≥ c·∫ßu th·ªß n√†o trong ƒë·ªôi h√¨nh.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}