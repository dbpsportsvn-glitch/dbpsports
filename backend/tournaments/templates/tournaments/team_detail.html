{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}{{ team.name }}{% endblock %}

{% block extra_css %}
<style>
:root {
  --primary: #dc2626;
  --primary-dark: #b91c1c;
  --secondary: #6b7280;
  --success: #16a34a;
  --danger: #dc2626;
  --warning: #f59e0b;
  --info: #0ea5e9;
  --light: #f8fafc;
  --dark: #1f2937;
  --gradient-primary: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
  --gradient-hero: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
  --border-radius: 0.5rem;
  --border-radius-lg: 1rem;
}

/* Team Detail Styles - Enhanced */
.hero-section {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.form-check-input:checked {
  background-color: #667eea;
  border-color: #667eea;
}

.form-check-input:focus {
  box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
}

.form-section {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
}

.section-title {
  color: #495057;
  font-weight: 600;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.btn-lg {
  padding: 0.75rem 1.5rem;
  font-size: 1.1rem;
  border-radius: 8px;
}

.alert {
  border-radius: 8px;
  border: none;
}

.card {
  border: none;
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  border-radius: 12px;
}

.card:hover {
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
  transition: box-shadow 0.15s ease-in-out;
}

.player-card {
    transition: transform .2s ease, box-shadow .2s ease;
    border-left-width: 4px;
}

.player-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
}

.player-avatar {
    width: 64px;
    height: 64px;
    object-fit: cover;
    border-radius: 50%;
    border: 2px solid #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,.1);
}

.jersey-number-lg {
    font-size: 1.5rem;
    font-weight: 700;
    color: #0d6efd;
}

.nav-pills .nav-link {
    color: #495057;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    font-weight: 500;
}

.nav-pills .nav-link.active {
    font-weight: 600;
}

.nav-pills .nav-link:not(.active):hover {
    background-color: #e9ecef;
}

/* Team Info Card */
.team-info-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border-radius: 12px;
}

.team-info-card:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    transition: box-shadow 0.15s ease-in-out;
}

/* Coach Section */
.coach-section {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border-radius: 12px;
    padding: 1rem;
    margin-top: 1rem;
}

/* Recruit Guide Styles - Modern Design */
.recruit-guide-section {
    padding: 1.5rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    border: 1px solid #dee2e6;
}

.guide-header {
    margin-bottom: 2rem;
}

.guide-icon .icon-wrapper {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    margin: 0 auto;
}

.guide-icon .icon-wrapper i {
    font-size: 2rem;
    color: white;
}

.guide-title {
    color: #495057;
    font-weight: 700;
    font-size: 1.5rem;
}

.guide-subtitle {
    font-size: 1rem;
    line-height: 1.5;
}

.guide-card {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 12px;
    padding: 1.25rem;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.guide-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    border-color: #667eea;
}

.guide-card-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
}

.guide-card-header i {
    font-size: 1.25rem;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(102, 126, 234, 0.1);
    border-radius: 8px;
}

.guide-card-header h6 {
    color: #495057;
    font-weight: 600;
    margin: 0;
}

.guide-steps {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    border: 1px solid #dee2e6;
}

.steps-title {
    color: #495057;
    font-weight: 600;
    display: flex;
    align-items: center;
}

.steps-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.step-item {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}

.step-number {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.1rem;
    flex-shrink: 0;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.step-content strong {
    color: #495057;
    font-weight: 600;
    display: block;
    margin-bottom: 0.25rem;
}

.guide-actions .btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 8px;
    font-weight: 600;
    padding: 0.75rem 2rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.guide-actions .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
}

.guide-actions .btn:focus {
    box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
}

/* Responsive */
@media (max-width: 991px) {
    .hero-section {
        padding: 1rem !important;
    }
    
    .form-section {
        padding: 1rem;
    }
    
    .recruit-guide-section {
        padding: 1rem;
    }
    
    .guide-icon .icon-wrapper {
        width: 60px;
        height: 60px;
    }
    
    .guide-icon .icon-wrapper i {
        font-size: 1.5rem;
    }
    
    .guide-title {
        font-size: 1.25rem;
    }
    
    .steps-list {
        gap: 1rem;
    }
    
    .step-item {
        gap: 0.75rem;
    }
    
    .step-number {
        width: 32px;
        height: 32px;
        font-size: 0.9rem;
    }
}
</style>
{% endblock %}


{% block content %}
<!-- Hero Section -->
<div class="hero-section text-white py-5 mb-4 position-relative">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <div class="d-flex align-items-center mb-3">
                    {% if team.logo %}
                        <img src="{{ team.logo.url }}" alt="{{ team.name }}" class="me-4 ms-4" style="width: 120px; height: 120px; object-fit: contain; border-radius: 12px; background: rgba(255,255,255,0.1); padding: 8px;">
                    {% else %}
                        <div class="me-4 ms-4 bg-light rounded d-flex align-items-center justify-content-center" style="width: 120px; height: 120px;">
                            <i class="bi bi-shield-fill text-muted" style="font-size: 3rem;"></i>
                        </div>
                    {% endif %}
                    <div class="flex-grow-1">
                        <h1 class="display-4 fw-bold mb-1 text-start">Quản lý Đội bóng</h1>
                        <h2 class="display-6 fw-semibold mb-1 text-start text-break">Đội: {{ team.name }}</h2>
                        <p class="h5 mb-0 opacity-75 text-start text-break">Đội trưởng: {{ team.captain.username }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Action Buttons - Bottom Right -->
    <div class="position-absolute bottom-0 end-0 p-3">
        <div class="d-flex gap-2">
            {% if registrations.first.tournament %}
                <a href="{% url 'tournament_detail' pk=registrations.first.tournament.pk %}?tab=teams#teams" class="btn btn-light btn-sm">
                    <i class="bi bi-arrow-left"></i> Về giải đấu
                </a>
            {% else %}
                <a href="{% url 'dashboard' %}" class="btn btn-light btn-sm">
                    <i class="bi bi-arrow-left"></i> Về trang cá nhân
                </a>
            {% endif %}
            {% if request.user == team.captain %}
                <a href="{% url 'update_team' pk=team.pk %}" class="btn btn-light btn-sm">
                    <i class="bi bi-pencil-fill"></i> Chỉnh sửa
                </a>
            {% endif %}
        </div>
    </div>
</div>

<div class="container">
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags|default:'info' }} mt-3" role="alert">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <div class="row g-4 align-items-start">
        {# --- CỘT BÊN TRÁI: THÔNG TIN & HÀNH ĐỘNG --- #}
        <div class="col-lg-4">
            <div class="card team-info-card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle-fill me-2"></i>Thông tin Đội</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        {% if team.logo %}
                            <img src="{{ team.logo.url }}" alt="{{ team.name }}" class="mb-3" style="width: 100px; height: 100px; object-fit: contain; border-radius: 12px; background: #f8f9fa; padding: 8px;">
                        {% else %}
                            <div class="mb-3 bg-light rounded d-flex align-items-center justify-content-center mx-auto" style="width: 100px; height: 100px;">
                                <i class="bi bi-shield-fill text-muted" style="font-size: 3rem;"></i>
                            </div>
                        {% endif %}
                        <h4 class="card-title">{{ team.name }}</h4>
                    </div>
                    <div class="form-section">
                        <h6 class="section-title">
                            <i class="bi bi-person-badge text-primary"></i>
                            Thông tin cơ bản
                        </h6>
                        <p class="text-muted mb-2">
                            <strong>Đội trưởng:</strong> {{ team.captain.username }}
                        </p>
                    
                    </div>
                    
                    {# Section HLV mới #}
                    <div class="coach-section">
                        <h6 class="section-title">
                            <i class="bi bi-clipboard-check text-info"></i> Huấn luyện viên
                        </h6>
                        {% if team.coach %}
                            <div class="d-flex align-items-center gap-2">
                                {% if team.coach.avatar %}
                                <img src="{{ team.coach.avatar.url }}" class="rounded-circle" width="50" height="50" style="object-fit: cover;">
                                {% else %}
                                <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                    <i class="bi bi-person-badge text-white"></i>
                                </div>
                                {% endif %}
                                
                                <div class="flex-grow-1">
                                    <a href="{% url 'coach_profile_detail' team.coach.pk %}" class="fw-bold text-decoration-none">
                                        {{ team.coach.full_name }}
                                    </a>
                                    {% if team.coach.coaching_license %}
                                    <br><small class="text-muted">{{ team.coach.coaching_license }}</small>
                                    {% endif %}
                                </div>
                                
                                {% if user == team.captain %}
                                <button class="btn btn-sm btn-outline-danger" onclick="removeCoach()" title="Loại bỏ HLV">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                                {% endif %}
                            </div>
                        {% else %}
                            <p class="text-muted mb-2 small">Đội chưa có HLV</p>
                            {% if user == team.captain %}
                            <a href="{% url 'recruit_coach_list' team.pk %}" class="btn btn-sm btn-success w-100">
                                <i class="bi bi-search"></i> Tìm & Chiêu mộ HLV
                            </a>
                            {% endif %}
                            {% if team.coach_name %}
                            <small class="text-muted d-block mt-2">(Dữ liệu cũ: {{ team.coach_name }})</small>
                            {% endif %}
                        {% endif %}
                    </div>

                    <h6 class="mt-3">Các giải đấu đã đăng ký:</h6>
                    <!-- Debug info -->
                    <small class="text-muted">(Cập nhật lần cuối: {{ "now"|date:"H:i:s" }})</small>
                    {% if registrations %}
                        <div class="list-group list-group-flush">
                        {% for reg in registrations %}
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-center">
                                    <a href="{% url 'tournament_detail' pk=reg.tournament.pk %}"><strong>{{ reg.tournament.name }}</strong></a>
                                    {% if reg.payment_status == 'UNPAID' %}
                                        <span class="badge bg-danger">Chưa thanh toán</span>
                                    {% elif reg.payment_status == 'PENDING' %}
                                        <span class="badge bg-warning text-dark">Chờ xác nhận</span>
                                    {% elif reg.payment_status == 'PAID' %}
                                        <span class="badge bg-success">Đã duyệt</span>
                                    {% elif reg.payment_status == 'REJECTED' %}
                                        <span class="badge bg-danger">Từ chối</span>
                                    {% endif %}
                                </div>
                                {% if reg.payment_status == 'UNPAID' and user == team.captain %}
                                    <a href="{% url 'team_payment' pk=reg.pk %}" class="btn btn-sm btn-success mt-2 w-100">
                                        <i class="bi bi-credit-card-fill"></i> Thanh toán lệ phí giải này
                                    </a>
                                {% elif reg.payment_status == 'REJECTED' and user == team.captain %}
                                    <a href="{% url 'team_payment' pk=reg.pk %}" class="btn btn-sm btn-warning mt-2 w-100">
                                        <i class="bi bi-arrow-clockwise"></i> Tải lại hóa đơn
                                    </a>
                                {% endif %}
                            </div>
                        {% endfor %}
                        </div>
                    {% else %}
                        <span class="badge bg-secondary">Đội tự do</span>
                    {% endif %}

                    <div class="d-grid gap-2 mt-3">
                        {# === THÊM NÚT NÀY VÀO ĐÂY === #}
                        <a href="{% url 'public_team_detail' pk=team.pk %}" class="btn btn-info" target="_blank"><i class="bi bi-eye-fill"></i> Xem Hồ sơ công khai</a>

                        {% if user == team.captain %}
                            <a href="{% url 'update_team' pk=team.pk %}" class="btn btn-warning"><i class="bi bi-pencil-fill"></i> Sửa thông tin đội</a>
                            <a href="{% url 'team_hall_of_fame' pk=team.pk %}" class="btn btn-info"><i class="bi bi-trophy-fill"></i> Phòng Truyền thống</a>
                        {% endif %}
                    </div>
                </div>
            </div>

            {% if user == team.captain %}
                {% if can_manage_players %}
                    <div class="card shadow-sm mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-person-plus-fill"></i> Quản lý Cầu thủ</h5>
                        </div>
                        <div class="card-body">
                            <ul class="nav nav-pills nav-fill mb-3" id="pills-tab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link {% if active_tab == 'new' or not active_tab %}active{% endif %}" id="pills-new-tab" data-bs-toggle="pill" data-bs-target="#pills-new" type="button">
                                        <i class="bi bi-plus-circle"></i> Tạo mới
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link {% if active_tab == 'recruit' %}active{% endif %}" id="pills-recruit-tab" data-bs-toggle="pill" data-bs-target="#pills-recruit" type="button">
                                        <i class="bi bi-person-plus-fill"></i> Chiêu mộ
                                    </button>
                                </li>
                            </ul>
                            <div class="tab-content" id="pills-tabContent">
                                <div class="tab-pane fade {% if active_tab == 'new' or not active_tab %}show active{% endif %}" id="pills-new" role="tabpanel">
                                    <form method="post" enctype="multipart/form-data">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="create_new_player">
                                        {% if player_form.non_field_errors %}
                                            <div class="alert alert-danger">
                                                {% for error in player_form.non_field_errors %}
                                                    <p class="mb-0">{{ error }}</p>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        {{ player_form|crispy }}
                                        <button type="submit" class="btn btn-primary mt-3 w-100">Thêm vào đội hình</button>
                                    </form>
                                </div>
                                <div class="tab-pane fade {% if active_tab == 'recruit' %}show active{% endif %}" id="pills-recruit" role="tabpanel">
                                    <div class="recruit-guide-section">
                                        <div class="guide-header text-center mb-4">
                                            <div class="guide-icon mb-3">
                                                <div class="icon-wrapper">
                                                    <i class="bi bi-person-plus-fill"></i>
                                                </div>
                                            </div>
                                            <h4 class="guide-title mb-3">Chiêu mộ Cầu thủ</h4>
                                            <p class="guide-subtitle text-muted">
                                                Tìm kiếm và mời gọi những tài năng mới về đội bóng của bạn
                                            </p>
                                        </div>

                                        <div class="guide-content">
                                            <div class="row g-4 mb-4">
                                                <div class="col-md-6">
                                                    <div class="guide-card h-100">
                                                        <div class="guide-card-header">
                                                            <i class="bi bi-search text-primary"></i>
                                                            <h6 class="mb-0">Tìm kiếm</h6>
                                                        </div>
                                                        <div class="guide-card-body">
                                                            <p class="mb-0 small text-muted">
                                                                Duyệt qua danh sách cầu thủ tự do hoặc đang chơi ở đội khác trên thị trường chuyển nhượng
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="guide-card h-100">
                                                        <div class="guide-card-header">
                                                            <i class="bi bi-envelope text-success"></i>
                                                            <h6 class="mb-0">Gửi lời mời</h6>
                                                        </div>
                                                        <div class="guide-card-body">
                                                            <p class="mb-0 small text-muted">
                                                                Gửi lời mời với điều kiện cụ thể về lương, vai trò và cam kết
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="guide-steps mb-4">
                                                <h6 class="steps-title mb-3">
                                                    <i class="bi bi-list-ol text-info me-2"></i>Quy trình chiêu mộ
                                                </h6>
                                                <div class="steps-list">
                                                    <div class="step-item">
                                                        <div class="step-number">1</div>
                                                        <div class="step-content">
                                                            <strong>Tìm cầu thủ phù hợp</strong>
                                                            <p class="mb-0 small text-muted">Sử dụng bộ lọc để tìm cầu thủ theo vị trí, kinh nghiệm và giá trị</p>
                                                        </div>
                                                    </div>
                                                    <div class="step-item">
                                                        <div class="step-number">2</div>
                                                        <div class="step-content">
                                                            <strong>Gửi lời mời</strong>
                                                            <p class="mb-0 small text-muted">Đề xuất điều kiện hợp đồng và lý do tại sao họ nên gia nhập đội</p>
                                                        </div>
                                                    </div>
                                                    <div class="step-item">
                                                        <div class="step-number">3</div>
                                                        <div class="step-content">
                                                            <strong>Chờ phản hồi</strong>
                                                            <p class="mb-0 small text-muted">Cầu thủ sẽ xem xét và quyết định có gia nhập đội hay không</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="guide-actions text-center">
                                                <a href="{% url 'transfer_market' %}" class="btn btn-primary btn-lg px-4">
                                                    <i class="bi bi-arrow-right-circle me-2"></i>
                                                    Đến Thị trường Chuyển nhượng
                                                </a>
                                                <p class="mt-2 mb-0 small text-muted">
                                                    <i class="bi bi-lightbulb me-1"></i>
                                                    Tip: Cầu thủ sẽ quan tâm đến thành tích và triển vọng của đội bóng
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-warning">
                            <h5 class="mb-0"><i class="bi bi-lock-fill"></i> Tính năng quản lý cầu thủ bị khóa</h5>
                        </div>
                        <div class="card-body text-center">
                            <p>Chức năng này sẽ được mở sau khi bạn hoàn tất thanh toán lệ phí cho ít nhất một giải đấu.</p>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        </div>

        {# --- CỘT BÊN PHẢI: DANH SÁCH CẦU THỦ --- #}
        <div class="col-lg-8">
            <div class="card shadow-sm h-100">
                <div class="card-header">
                    <h5 class="mb-0">Đội hình hiện tại ({{ team.players.all.count }})</h5>
                </div>
                <div class="card-body">
                    <div class="row row-cols-1 row-cols-md-2 g-3">
                        {% for player in team.players.all %}
                        <div class="col">
                            <div class="card h-100 shadow-sm player-card" style="border-left-color: {% cycle '#0d6efd' '#198754' '#ffc107' '#dc3545' %};">
                                <a href="{% url 'player_detail' pk=player.pk %}" class="text-decoration-none text-dark">
                                    <div class="card-body d-flex align-items-center gap-3">
                                        <img src="{% if player.avatar %}{{ player.avatar.url }}{% else %}/static/images/placeholder_avatar.png{% endif %}" alt="{{ player.full_name }}" class="player-avatar">
                                        <div class="flex-grow-1">
                                            <div class="d-flex justify-content-between">
                                                <h6 class="mb-0">
                                                    {{ player.full_name }}
                                                    {% if player.user and team.captain == player.user %}
                                                        <span class="captain-indicator" title="Đội trưởng">(C)</span>
                                                    {% endif %}
                                                </h6>
                                                <span class="jersey-number-lg">#{{ player.jersey_number }}</span>
                                            </div>
                                            <small class="text-muted">{{ player.get_position_display }}</small>
                                        </div>
                                    </div>
                                </a>
                                {% if user == team.captain %}
                                <div class="card-footer bg-light d-flex justify-content-end gap-2">
                                    <a href="{% url 'update_player' pk=player.pk %}" class="btn btn-warning btn-sm">Sửa</a>
                                    <a href="{% url 'delete_player' pk=player.pk %}" class="btn btn-danger btn-sm">Xóa</a>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12">
                            <p class="text-muted p-3">Chưa có cầu thủ nào trong đội hình.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            {# --- CARD YÊU CẦU RỜI ĐỘI CHO ĐỘI TRƯỞNG --- #}
            {% if user == team.captain %}
                {% load player_exit_extras %}
                {% get_team_exit_requests team 'PENDING' as pending_exit_requests %}
                {% if pending_exit_requests %}
                <div class="card shadow-sm mt-4">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0">
                            <i class="bi bi-door-open"></i>
                            Yêu cầu rời đội ({{ pending_exit_requests.count }})
                        </h5>
                    </div>
                    <div class="card-body">
                        {% for exit_request in pending_exit_requests %}
                        <div class="border rounded p-3 mb-3">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <div class="d-flex align-items-center gap-3">
                                        <img src="{% if exit_request.player.avatar %}{{ exit_request.player.avatar.url }}{% else %}/static/images/placeholder_avatar.png{% endif %}" 
                                             alt="{{ exit_request.player.full_name }}" 
                                             class="rounded-circle" 
                                             style="width: 50px; height: 50px; object-fit: cover;">
                                        <div>
                                            <h6 class="mb-1">{{ exit_request.player.full_name }}</h6>
                                            <small class="text-muted">
                                                <i class="bi bi-{{ exit_request.exit_type|get_exit_status_icon }}"></i>
                                                {{ exit_request.get_exit_type_display }}
                                                <span class="mx-2">•</span>
                                                {{ exit_request.created_at|date:"d/m/Y H:i" }}
                                            </small>
                                        </div>
                                    </div>
                                    {% if exit_request.reason %}
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            <strong>Lý do:</strong> {{ exit_request.reason }}
                                        </small>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="btn-group" role="group">
                                        <form method="post" action="{% url 'approve_team_exit' exit_request.pk %}" class="d-inline">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-success btn-sm" 
                                                    onclick="return confirm('Bạn có chắc muốn duyệt yêu cầu rời đội của {{ exit_request.player.full_name }}?')">
                                                <i class="bi bi-check"></i> Duyệt
                                            </button>
                                        </form>
                                        <button type="button" class="btn btn-danger btn-sm" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#rejectModal{{ exit_request.pk }}">
                                            <i class="bi bi-x"></i> Từ chối
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {# Modal từ chối yêu cầu #}
                        <div class="modal fade" id="rejectModal{{ exit_request.pk }}" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Từ chối yêu cầu rời đội</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <form method="post" action="{% url 'reject_team_exit' exit_request.pk %}">
                                        {% csrf_token %}
                                        <div class="modal-body">
                                            <p>Bạn có chắc muốn từ chối yêu cầu rời đội của <strong>{{ exit_request.player.full_name }}</strong>?</p>
                                            <div class="mb-3">
                                                <label for="admin_notes_{{ exit_request.pk }}" class="form-label">Ghi chú (không bắt buộc)</label>
                                                <textarea name="admin_notes" id="admin_notes_{{ exit_request.pk }}" 
                                                          class="form-control" rows="3" 
                                                          placeholder="Lý do từ chối yêu cầu..."></textarea>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                                            <button type="submit" class="btn btn-danger">Từ chối yêu cầu</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>

<script>
function removeCoach() {
    if (confirm('Bạn có chắc muốn loại bỏ HLV khỏi đội? HLV sẽ nhận được thông báo về việc này.')) {
        fetch('/team/{{ team.pk }}/remove-coach/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Đã loại bỏ HLV khỏi đội thành công!');
                location.reload();
            } else {
                alert(data.error || 'Có lỗi xảy ra');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Có lỗi xảy ra. Vui lòng thử lại.');
        });
    }
}
</script>
{% endblock %}