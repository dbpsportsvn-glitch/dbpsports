{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Xếp lịch thi đấu - {{ tournament.name }}{% endblock %}

{% block content %}
<style>
    /* --- CÀI ĐẶT GIAO DIỆN MỚI (PHIÊN BẢN SỬA LỖI CUỐI CÙNG) --- */
    :root {
        --bg-dark: #0f172a;
        --panel-dark: #1e2b3b;
        --border-color: #334155;
        --text-light: #f1f5f9;
        --text-muted: #94a3b8;
        --gold: #f59e0b;
        --blue-accent: #3b82f6;
        --font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    .schedule-page { font-family: var(--font-family); background-color: var(--bg-dark); color: var(--text-light); padding: 2rem; border-radius: 12px; }
    .schedule-header { text-align: center; margin-bottom: 2.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1.5rem; }
    .schedule-header h2 { font-size: 2.5rem; font-weight: 800; color: var(--gold); text-shadow: 0 0 10px rgba(245, 158, 11, 0.3); }
    .schedule-header p { color: var(--text-muted); }
    .schedule-header p strong { color: var(--text-light); }


    .schedule-form-container { max-width: 800px; margin: 0 auto; background: var(--panel-dark); padding: 2rem; border-radius: 10px; border: 1px solid var(--border-color); }
    .schedule-form-container label { color: var(--text-muted); font-weight: 600; }
    .schedule-form-container .form-control, .schedule-form-container .form-select { background-color: var(--bg-dark); border-color: var(--border-color); color: var(--text-light); }
    .schedule-form-container .form-control:focus, .schedule-form-container .form-select:focus { background-color: var(--bg-dark); border-color: var(--blue-accent); color: var(--text-light); box-shadow: 0 0 0 0.25rem rgba(59, 130, 246, 0.25); }
    .schedule-form-container .form-text { color: var(--text-muted); }
    .schedule-form-container input[type="date"]::-webkit-calendar-picker-indicator {
        filter: invert(1);
    }    
    /* === BẮT ĐẦU THÊM CSS MỚI === */
    #div_id_weekdays .form-check {
        display: inline-block;
        margin-right: 1rem;
    }
    #div_id_scheduling_strategy .form-check {
        margin-bottom: 0.5rem;
    }
    /* === KẾT THÚC THÊM CSS MỚI === */

    .preview-container { max-width: 1000px; margin: 3rem auto 0 auto; }
    .preview-container h3, .preview-container h4 { color: #f59e0b; }
    .preview-container .preview-intro-text { color: var(--text-muted); }

    .preview-table-wrapper { background-color: var(--panel-dark); border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
    .custom-table { width: 100%; border-collapse: collapse; }
    .custom-table thead { background-color: var(--border-color); }
    .custom-table th, .custom-table td {
        padding: 0.75rem 1rem;
        text-align: center; 
        vertical-align: middle; 
        border-bottom: 1px solid var(--border-color);
    }
    .custom-table th { color: var(--text-light); font-weight: 600; }
    .custom-table tbody tr:last-child td { border-bottom: none; }
    .custom-table tbody tr:hover { background-color: #334155; }
    .custom-table td span { color: #cbd5e1; }
    .custom-table td strong { color: #ffffff; font-weight: 600; }
</style>

<div class="schedule-page">
    <div class="schedule-header">
        <h2><i class="bi bi-calendar2-week"></i> Trình Xếp Lịch Thi Đấu</h2>
        <p>Giải đấu: <strong>{{ tournament.name }}</strong></p>
    </div>

    <div class="schedule-form-container" {% if schedule_by_group is not None %}style="display:none;"{% endif %}>
        <div class="alert alert-primary" style="background-color: #1e2b3b; border-color: #3b82f6; color: #bfdbfe;">
            <h5 class="alert-heading"><i class="bi bi-info-circle-fill"></i> Hướng dẫn</h5>
            <p>Nhập các thông số để hệ thống tự động tạo lịch thi đấu vòng bảng. Lịch sẽ được ưu tiên xếp dàn đều và đảm bảo ngày nghỉ tối thiểu cho các đội.</p>
        </div>
        <form method="post" class="mt-4">
            {% csrf_token %}
            {{ form|crispy }}
            <div class="d-grid mt-4">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-gear-fill"></i> Tạo Lịch (Xem trước)
                </button>
            </div>
        </form>
    </div>

    {% if schedule_by_group is not None %}
    <div class="preview-container">
        <h3 class="text-center mb-3">Lịch thi đấu (Xem trước)</h3>
        {% if unscheduled_matches %}<div class="alert alert-danger"><strong>Cảnh báo!</strong> Không thể xếp lịch cho {{ unscheduled_matches|length }} trận đấu. Vui lòng thử lại với các thông số khác (tăng số ngày hoặc khung giờ).</div>{% endif %}
        {% if schedule_by_group %}
        <p class="text-center preview-intro-text mb-4">Hệ thống đã tạo ra lịch thi đấu. Vui lòng kiểm tra kỹ lịch bên dưới trước khi xác nhận.</p>
        
        {% for group_name, matches_in_group in schedule_by_group.items %}
            <h4 class="mt-4">{{ group_name }}</h4>
            <div class="preview-table-wrapper">
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>Ngày</th>
                            <th>Giờ</th>
                            <th>Cặp đấu</th>
                            <th>Sân</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for match in matches_in_group %}
                        <tr>
                            <td><span>{{ match.match_time|date:"d/m/Y" }}</span></td>
                            <td><span>{{ match.match_time|date:"H:i" }}</span></td>
                            <td><strong>{{ match.team1_name }}</strong> <span>vs</span> <strong>{{ match.team2_name }}</strong></td>
                            <td><span>{{ match.location }}</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endfor %}
        <form method="post" class="mt-4" onsubmit="return confirm('Bạn có chắc chắn muốn lưu lịch thi đấu này không? Hành động này sẽ xóa mọi lịch thi đấu vòng bảng đã có trước đó.');">
            {% csrf_token %}
            <div class="d-grid gap-2">
                <button type="submit" name="confirm_schedule" class="btn btn-success btn-lg"><i class="bi bi-check-circle-fill"></i> Tôi đồng ý, Xác nhận & Lưu Lịch</button>
                <a href="{% url 'generate_schedule' tournament_pk=tournament.pk %}" class="btn btn-secondary"><i class="bi bi-arrow-counterclockwise"></i> Tạo lại với thông số khác</a>
            </div>
        </form>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}