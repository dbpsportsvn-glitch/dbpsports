{% extends 'base.html' %}
{% load static %}
{% load video %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'tournaments/live.css' %}">
{% endblock %}

{% block content %}
<div class="live-page">
<div class="container mt-4">

{# ======= HEADER / SCOREBOARD ======= #}
  <div class="live-hero">
    {# --- Hàng trên: Tỉ số & Nút --- #}
    <div class="live-hero-main">
      <div class="live-hero-teams">
        <div class="team">
          <div class="logo">{{ live_match.team1.name|slice:":2" }}</div>
          <strong class="h5 mb-0">{{ live_match.team1.name }}</strong>
        </div>
        <span class="vsep">vs</span>
        <div class="team">
          <div class="logo">{{ live_match.team2.name|slice:":2" }}</div>
          <strong class="h5 mb-0">{{ live_match.team2.name }}</strong>
        </div>
      </div>
      <div class="live-hero-actions">
        <span class="badge-live">LIVE</span>
        <button id="shareBtn" class="small-btn" type="button">
          <i class="bi bi-share"></i> Chia sẻ
        </button>
      </div>
    </div>

    {# --- Hàng dưới: Dòng chữ chạy --- #}
    <div class="ticker-wrapper">
      <div class="ticker-inline" aria-label="Thông báo">
      <div class="track">
          <span class="item">{{ ticker_text|default:"Chào mừng tới DBP Sports • Liên hệ quảng cáo: 09xx xxx xxx" }}</span>
          <span class="item">{{ ticker_text|default:"Chào mừng tới DBP Sports • Liên hệ quảng cáo: 09xx xxx xxx" }}</span>
          <span class="item">{{ ticker_text|default:"Chào mừng tới DBP Sports • Liên hệ quảng cáo: 09xx xxx xxx" }}</span>
          <span class="item">{{ ticker_text|default:"Chào mừng tới DBP Sports • Liên hệ quảng cáo: 09xx xxx xxx" }}</span>
      </div>
      </div>
    </div>
  </div>

  <div class="row gx-4 gy-4">
    <div class="col-xl-8">

      {# ======= PLAYER ======= #}
      <div class="video-wrap">
        {% with src=live_match.livestream_url|yt_embed_clean %}
          {% if src %}
            <div class="ratio ratio-16x9">
              <iframe
                src="{{ src }}?playsinline=1&rel=0&modestbranding=1"
                title="YouTube"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share"
                referrerpolicy="strict-origin-when-cross-origin"
                allowfullscreen></iframe>
            </div>
          {% else %}
            <div class="p-5 text-center text-muted">Link YouTube không hợp lệ.</div>
          {% endif %}
        {% endwith %}
      </div>

      {# ======= TABS ======= #}
      <div class="tabbar">
        <button class="tab active" data-tab="info" type="button"><i class="bi bi-info-circle"></i> Thông tin</button>
        <button class="tab" data-tab="comments" type="button"><i class="bi bi-chat-dots"></i> Bình luận</button>
        <button class="tab" data-tab="schedule" type="button"><i class="bi bi-calendar2-week"></i> Lịch</button>
      </div>

      {# ======= PANELS ======= #}
      <div id="tab-info" class="tab-panel mt-3" style="display:block">
        <div class="stat-grid">
          <div class="stat">
            <div class="kv">Giải đấu</div>
            <div><strong>{{ live_match.tournament.name }}</strong></div>
          </div>
          <div class="stat">
            <div class="kv">Vòng</div>
            <div><strong>{{ live_match.get_match_round_display }}</strong></div>
          </div>
          <div class="stat">
            <div class="kv">Thời gian</div>
            <div><strong>{{ live_match.match_time|date:"H:i d/m/Y" }}</strong></div>
          </div>
        </div>
      </div>

      <div id="tab-comments" class="tab-panel mt-3" style="display:none">
        <div class="card shadow-sm">
          <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-chat-left-text"></i> Bình luận</h6>
          </div>
          <div class="card-body">
            <div class="comment-list mb-3" style="max-height: 400px; overflow-y: auto; padding-right: 10px;">
              {% for comment in comments %}
                <div class="d-flex mb-3">
                  <div class="flex-shrink-0">
                    <span class="avatar-ph">{{ comment.user.username|first|upper }}</span>
                  </div>
                  <div class="flex-grow-1 ms-3">
                    <strong class="d-block">{{ comment.user.username }}</strong>
                    <div style="white-space: pre-wrap; word-wrap: break-word;">{{ comment.text }}</div>
                    <small class="text-muted">{{ comment.created_at|timesince }} trước</small>
                  </div>
                </div>
              {% empty %}
                <p class="text-muted text-center">Chưa có bình luận nào. Hãy là người đầu tiên!</p>
              {% endfor %}
            </div>

            <hr>

            {% if user.is_authenticated %}
              <form method="post" action="">
                {% csrf_token %}
                {{ comment_form.text }}
                <div class="text-end">
                    <button type="submit" class="btn btn-primary btn-sm mt-2">Gửi</button>
                </div>
              </form>
            {% else %}
              <p class="text-muted text-center">
                Vui lòng <a href="{% url 'account_login' %}?next={{ request.path }}">đăng nhập</a> để bình luận.
              </p>
            {% endif %}
          </div>
        </div>
      </div>

    </div>

    {# ======= SIDEBAR ======= #}
    <div class="col-xl-4">
      <div class="sticky-col">
        <div class="card shadow-sm">
          <div class="card-header d-flex align-items-center">
            <h6 class="mb-0"><i class="bi bi-hourglass-split"></i> Sắp diễn ra</h6>
            {% if live_match %}
              <a class="small text-muted ms-auto" href="{% url 'tournament_detail' pk=live_match.tournament.pk %}?tab=schedule#schedule">
                Xem tất cả
              </a>
            {% endif %}
          </div>
          <div class="list-group list-group-flush">
            {% for match in upcoming_matches %}
              <a class="match-item" href="{% url 'livestream_match' pk=match.pk %}">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <strong>{{ match.team1.name }}</strong>
                    <span class="text-muted"> vs </span>
                    <strong>{{ match.team2.name }}</strong>
                  </div>
                  <span class="badge bg-dark border">{{ match.get_match_round_display }}</span>
                </div>
                <div class="kv mt-1"><i class="bi bi-clock"></i> {{ match.match_time|date:"H:i, d/m/Y" }}</div>
              </a>
            {% empty %}
              <div class="list-group-item"><small class="text-muted">Không có trận đấu nào.</small></div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

</div>
</div>

<script>
(function(){
  const root = document.querySelector('.live-page');
  if(!root) return;

  // --- Logic xử lý Tabs ---
  const tabs = root.querySelectorAll('.tabbar .tab');
  const panels = {
    info: root.querySelector('#tab-info'),
    comments: root.querySelector('#tab-comments'),
    schedule: root.querySelector('#tab-schedule'),
  };
  function activate(key){
    tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === key));
    Object.entries(panels).forEach(([k, p]) => { if(p){ p.style.display = (k === key ? 'block' : 'none'); }});
    try { history.replaceState(null, '', '#' + key); } catch(e) {}
  }
  tabs.forEach(t => t.addEventListener('click', () => activate(t.dataset.tab)));
  const init = location.hash.replace('#', '');
  activate(panels[init] ? init : 'info');

  // --- Logic xử lý nút Share ---
  const shareBtn = root.querySelector('#shareBtn');
  if (shareBtn) {
    shareBtn.addEventListener('click', async () => {
      const url = location.href;
      try {
        if (navigator.share) {
          await navigator.share({ title: document.title, url });
          return;
        }
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(url);
          shareBtn.innerHTML = '<i class="bi bi-check2"></i> Đã copy';
          shareBtn.disabled = true;
          setTimeout(() => {
            shareBtn.innerHTML = '<i class="bi bi-share"></i> Chia sẻ';
            shareBtn.disabled = false;
          }, 1200);
        } else {
          prompt('Copy URL:', url);
        }
      } catch(e) { /* bỏ qua */ }
    });
  }

  // --- Logic tự động điều chỉnh tốc độ ticker ---
  const tickerTrack = root.querySelector('.live-hero .ticker-inline .track');
  if (tickerTrack) {
    // Tốc độ mong muốn (pixel mỗi giây). Số càng lớn, chữ chạy càng nhanh.
    const desiredSpeed = 60;

    const contentWidth = tickerTrack.scrollWidth;
    // Animation di chuyển 50% chiều rộng của track, nên ta lấy khoảng cách là một nửa
    const distanceToTravel = contentWidth / 2;

    // Tính toán thời gian cần thiết: duration = distance / speed
    const durationInSeconds = distanceToTravel / desiredSpeed;

    // Áp dụng thời gian đã tính vào animation
    if (durationInSeconds > 1) { // Đảm bảo thời gian hợp lệ
      tickerTrack.style.animationDuration = `${durationInSeconds}s`;
    }
  }

})();
</script>

{% endblock %}