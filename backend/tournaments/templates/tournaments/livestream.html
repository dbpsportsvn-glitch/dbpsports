{% extends 'base.html' %}
{% load static %}
{% load video %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'tournaments/live.css' %}">
{% endblock %}

{% block content %}
<div class="live-page">
<div class="container mt-4">

{# ======= HEADER / SCOREBOARD (ĐÃ TÁI CẤU TRÚC) ======= #}
  <div class="live-hero">
    {# --- Hàng trên: Chỉ còn Tên đội và Tỉ số --- #}
    <div class="live-hero-main">
      <div class="live-hero-teams">
        <div class="team">
          {% if live_match.team1.logo %}
            <img src="{{ live_match.team1.logo.url }}" alt="{{ live_match.team1.name }}" class="team-logo">
          {% else %}
            <div class="logo">{{ live_match.team1.name|slice:":2" }}</div>
          {% endif %}
          <strong class="h5 mb-0">{{ live_match.team1.name }}</strong>
        </div>
        <span class="vsep">vs</span>
        <div class="team">
          <strong class="h5 mb-0">{{ live_match.team2.name }}</strong>
          {% if live_match.team2.logo %}
            <img src="{{ live_match.team2.logo.url }}" alt="{{ live_match.team2.name }}" class="team-logo">
          {% else %}
            <div class="logo">{{ live_match.team2.name|slice:":2" }}</div>
          {% endif %}
        </div>
      </div>
    </div>

    {# --- Hàng dưới: Dòng chữ chạy (giữ nguyên) --- #}
    <div class="ticker-wrapper">
      <div class="ticker-inline" aria-label="Thông báo">
        <div class="track">
            <span class="item">{{ ticker_text|default:"Chào mừng tới DBP Sports • Liên hệ quảng cáo: 0708 666 369" }}</span>
            <span class="item">{{ ticker_text|default:"Chào mừng tới DBP Sports • Liên hệ quảng cáo: 0708 666 369" }}</span>
            <span class="item">{{ ticker_text|default:"Chào mừng tới DBP Sports • Liên hệ quảng cáo: 0708 666 369" }}</span>
            <span class="item">{{ ticker_text|default:"Chào mừng tới DBP Sports • Liên hệ quảng cáo: 0708 666 369" }}</span>
        </div>
      </div>
    </div>
  </div>

  <div class="row gx-4 gy-4">
    <div class="col-xl-8">

      {# ======= PLAYER (giữ nguyên) ======= #}
      <div class="video-wrap">
        {% with src=live_match.livestream_url|yt_embed_clean %}
          {% if src %}
            <div class="ratio ratio-16x9">
              <iframe
                src="{{ src }}?playsinline=1&rel=0&modestbranding=1&autoplay=1&mute=1"
                title="YouTube"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share"
                referrerpolicy="strict-origin-when-cross-origin"
                allowfullscreen></iframe>
            </div>
          {% else %}
            <div class="p-5 text-center text-muted">Link YouTube không hợp lệ.</div>
          {% endif %}
        {% endwith %}
      </div>

      {# ======= TABS & ACTIONS (ĐÃ TÁI CẤU TRÚC) ======= #}
      <div class="tabbar mt-4">
        <div class="tabbar-left">
          <button class="tab active" data-tab="info" type="button">
            <i class="bi bi-info-circle"></i> Thông tin
          </button>
          <button class="tab" data-tab="comments" type="button">
            <i class="bi bi-chat-dots"></i> Bình luận
          </button>
          <button class="tab" data-tab="schedule" type="button">
            <i class="bi bi-calendar2-week"></i> Lịch
          </button>
        </div>
        
        <div class="tabbar-right">
          <span class="badge-live">LIVE</span>
          <button id="shareBtn" class="small-btn" type="button">
            <i class="bi bi-share"></i> Chia sẻ
          </button>
        </div>
      </div>

      {# ======= PANELS (giữ nguyên) ======= #}
      <div id="tab-info" class="tab-panel mt-4" style="display:block">
        <div class="stat-grid">
          <div class="stat">
            <div class="kv">Giải đấu</div>
            <div><strong>{{ live_match.tournament.name }}</strong></div>
          </div>
          <div class="stat">
            <div class="kv">Vòng</div>
            <div><strong>{{ live_match.get_match_round_display }}</strong></div>
          </div>
          <div class="stat">
            <div class="kv">Thời gian</div>
            <div><strong>{{ live_match.match_time|date:"H:i d/m/Y" }}</strong></div>
          </div>
        </div>
      </div>

      <div id="tab-comments" class="tab-panel mt-4" style="display:none">
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-chat-left-text"></i> Bình luận</h6>
          </div>
          <div class="card-body">
            <div class="comment-list mb-4">
              {% for comment in comments %}
                <div class="d-flex mb-4">
                  <div class="flex-shrink-0">
                    <span class="avatar-ph">{{ comment.user.username|first|upper }}</span>
                  </div>
                  <div class="flex-grow-1 ms-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <strong class="text-white">{{ comment.user.username }}</strong>
                      <small class="text-muted">{{ comment.created_at|timesince }} trước</small>
                    </div>
                    <div class="comment-text" style="white-space: pre-wrap; word-wrap: break-word; color: var(--text);">{{ comment.text }}</div>
                  </div>
                </div>
              {% empty %}
                <div class="text-center py-4">
                  <i class="bi bi-chat-dots text-muted" style="font-size: 3rem;"></i>
                  <p class="text-muted mt-3">Chưa có bình luận nào. Hãy là người đầu tiên!</p>
                </div>
              {% endfor %}
            </div>

            <hr class="border-secondary">

            {% if user.is_authenticated %}
              <form method="post" action="" class="comment-form">
                {% csrf_token %}
                <div class="mb-3">
                  {{ comment_form.text }}
                </div>
                <div class="text-end">
                    <button type="submit" class="btn btn-primary">
                      <i class="bi bi-send me-2"></i>Gửi bình luận
                    </button>
                </div>
              </form>
            {% else %}
              <div class="text-center py-3">
                <p class="text-muted mb-3">
                  Vui lòng <a href="{% url 'account_login' %}?next={{ request.path }}" class="text-primary">đăng nhập</a> để bình luận.
                </p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      {# Thêm một tab-panel trống cho 'schedule' nếu cần, hoặc để JS xử lý #}
      <div id="tab-schedule" class="tab-panel mt-4" style="display:none">
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-calendar2-week"></i> Lịch thi đấu</h6>
          </div>
          <div class="card-body">
            <div class="text-center py-4">
              <i class="bi bi-calendar-check text-muted" style="font-size: 3rem;"></i>
              <p class="text-muted mt-3">Vui lòng xem lịch thi đấu chi tiết ở cột bên phải.</p>
              {% if live_match %}
                <a href="{% url 'tournament_detail' pk=live_match.tournament.pk %}?tab=schedule#schedule" class="btn btn-primary">
                  <i class="bi bi-calendar-event me-2"></i>Xem lịch đầy đủ
                </a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

    </div>

    {# ======= SIDEBAR (giữ nguyên) ======= #}
    <div class="col-xl-4">
      <div class="sticky-col">
        <div class="card">
          <div class="card-header d-flex align-items-center">
            <h6 class="mb-0"><i class="bi bi-hourglass-split"></i> Sắp diễn ra</h6>
            {% if live_match %}
              <a class="small text-white ms-auto" href="{% url 'tournament_detail' pk=live_match.tournament.pk %}?tab=schedule#schedule">
                Xem tất cả
              </a>
            {% endif %}
          </div>
          <div class="card-body p-0">
            {% for match in upcoming_matches %}
              <a class="upcoming-match-item" href="{% url 'livestream_match' pk=match.pk %}">
                <div class="match-teams">
                  <div class="team-info">
                    {% if match.team1.logo %}
                      <img src="{{ match.team1.logo.url }}" alt="{{ match.team1.name }}" class="team-logo-small">
                    {% else %}
                      <div class="team-logo-placeholder">{{ match.team1.name|slice:":2" }}</div>
                    {% endif %}
                    <span class="team-name">{{ match.team1.name }}</span>
                  </div>
                  
                  <div class="match-vs">
                    <span class="vs-text">VS</span>
                    <div class="match-time">
                      <i class="bi bi-clock"></i>
                      <span>{{ match.match_time|date:"H:i" }}</span>
                    </div>
                  </div>
                  
                  <div class="team-info">
                    <span class="team-name">{{ match.team2.name }}</span>
                    {% if match.team2.logo %}
                      <img src="{{ match.team2.logo.url }}" alt="{{ match.team2.name }}" class="team-logo-small">
                    {% else %}
                      <div class="team-logo-placeholder">{{ match.team2.name|slice:":2" }}</div>
                    {% endif %}
                  </div>
                </div>
                
                <div class="match-meta">
                  <span class="match-round">{{ match.get_match_round_display }}</span>
                  <span class="match-date">{{ match.match_time|date:"d/m/Y" }}</span>
                </div>
              </a>
            {% empty %}
              <div class="empty-upcoming-matches">
                <i class="bi bi-calendar-x"></i>
                <p>Không có trận đấu nào sắp diễn ra</p>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

</div>
</div>

<script>
(function(){
  const root = document.querySelector('.live-page');
  if(!root) return;

  const tabs = root.querySelectorAll('.tabbar .tab');
  const panels = {
    info: root.querySelector('#tab-info'),
    comments: root.querySelector('#tab-comments'),
    schedule: root.querySelector('#tab-schedule'),
  };
  function activate(key){
    tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === key));
    Object.entries(panels).forEach(([k, p]) => { if(p){ p.style.display = (k === key ? 'block' : 'none'); }});
    try { history.replaceState(null, '', '#' + key); } catch(e) {}
  }
  tabs.forEach(t => t.addEventListener('click', () => activate(t.dataset.tab)));
  const init = location.hash.replace('#', '');
  activate(panels[init] ? init : 'info');

  const shareBtn = root.querySelector('#shareBtn');
  if (shareBtn) {
    shareBtn.addEventListener('click', async () => {
      const url = location.href;
      try {
        if (navigator.share) {
          await navigator.share({ title: document.title, url });
          return;
        }
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(url);
          shareBtn.innerHTML = '<i class="bi bi-check2"></i> Đã copy';
          shareBtn.disabled = true;
          setTimeout(() => {
            shareBtn.innerHTML = '<i class="bi bi-share"></i> Chia sẻ';
            shareBtn.disabled = false;
          }, 1200);
        } else {
          prompt('Copy URL:', url);
        }
      } catch(e) { /* bỏ qua */ }
    });
  }

  const tickerTrack = root.querySelector('.live-hero .ticker-inline .track');
  if (tickerTrack) {
    const desiredSpeed = 60;
    const contentWidth = tickerTrack.scrollWidth;
    const distanceToTravel = contentWidth / 2;
    const durationInSeconds = distanceToTravel / desiredSpeed;
    if (durationInSeconds > 1) {
      tickerTrack.style.animationDuration = `${durationInSeconds}s`;
    }
  }

})();
</script>

{% endblock %}