{% extends 'base.html' %}
{% load static %}

{% block title %}Bốc thăm chia bảng - {{ tournament.name }}{% endblock %}

{% block content %}
<style>
    /* --- CÀI ĐẶT GIAO DIỆN MỚI --- */
    :root {
        --bg-dark: #0f172a;
        --panel-dark: #1e293b;
        --border-color: #334155;
        --text-light: #f1f5f9;
        --text-muted: #94a3b8;
        --gold: #f59e0b;
        --blue-accent: #3b82f6;
        --font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    .draw-page {
        font-family: var(--font-family);
        background-color: var(--bg-dark);
        color: var(--text-light);
        padding: 2rem;
        border-radius: 12px;
        min-height: 80vh;
    }

    .draw-header {
        text-align: center;
        margin-bottom: 2.5rem;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 1.5rem;
    }
    .draw-header h1 {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--gold);
        text-shadow: 0 0 10px rgba(245, 158, 11, 0.3);
    }

    .draw-layout {
        display: grid;
        grid-template-columns: 280px 1fr 280px;
        gap: 2rem;
        align-items: start;
    }

    /* --- CÁC KHU VỰC CHÍNH --- */
    .draw-pot, .draw-controls {
        background: var(--panel-dark);
        border-radius: 10px;
        padding: 1.5rem;
        border: 1px solid var(--border-color);
        position: sticky;
        top: 80px;
    }
    .draw-stage {
        min-height: 400px;
    }

    .area-title {
        font-weight: 700;
        font-size: 1.25rem;
        margin-top: 0;
        margin-bottom: 1.5rem;
        color: var(--text-light);
    }

    /* --- BÌNH BỐC THĂM & CÁC ĐỘI --- */
    .pot-list {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
    }
    .team-ball {
        background: #334155;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        position: relative;
        border: 2px solid transparent;
    }
    .team-ball:hover {
        transform: scale(1.1);
        box-shadow: 0 0 15px var(--blue-accent);
    }
    /* === CSS MỚI: Style cho đội đang được bốc thăm === */
    .team-ball.is-drawing {
        border-color: var(--gold);
        box-shadow: 0 0 20px var(--gold);
        transform: scale(1.15);
    }
    .team-ball .logo {
        width: 32px;
        height: 32px;
        object-fit: contain;
        border-radius: 50%;
    }
    /* Tooltip tên đội */
    .team-ball::after {
        content: attr(data-name);
        position: absolute;
        bottom: 110%;
        left: 50%;
        transform: translateX(-50%);
        background: var(--bg-dark);
        color: var(--text-light);
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s, visibility 0.2s;
    }
    .team-ball:hover::after {
        opacity: 1;
        visibility: visible;
    }

    /* --- SÂN KHẤU CHÍNH --- */
    .groups-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1.5rem;
    }
    .group-card {
        background: var(--panel-dark);
        border-radius: 10px;
        border: 1px solid var(--border-color);
        transition: box-shadow 0.2s, border-color 0.2s;
    }
    /* === CSS MỚI: Style cho bảng đấu là ứng viên === */
    .group-card.is-candidate {
        border-color: var(--gold);
        box-shadow: 0 0 20px var(--gold);
    }
    .group-card h5 {
        background: var(--border-color);
        color: var(--text-light);
        margin: 0;
        padding: 0.75rem 1rem;
        border-radius: 10px 10px 0 0;
    }
    .group-card .team-list {
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        min-height: 100px;
    }
    .team-slot {
        background: #0f172a;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 600;
        opacity: 0;
        transform: scale(0.8);
        transition: opacity 0.5s ease, transform 0.5s ease;
    }
    .team-slot.filled {
        opacity: 1;
        transform: scale(1);
    }
    .team-slot .logo {
        width: 24px;
        height: 24px;
        object-fit: contain;
    }

    /* --- HIỆU ỨNG BỐC THĂM --- */
    .draw-animation-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 9999;
    }
    .flying-ball {
        position: absolute;
        background: var(--gold);
        border: 2px solid white;
        box-shadow: 0 0 20px var(--gold);
        z-index: 10000;
        transition: all 0.8s cubic-bezier(0.5, 0, 0.5, 1);
    }
</style>

<div class="draw-page">
    <div class="draw-header">
        <h1><i class="bi bi-trophy-fill"></i> Lễ Bốc thăm Chia bảng</h1>
        <p>Giải đấu: <strong>{{ tournament.name }}</strong></p>
    </div>

    <div class="draw-layout">
        <div class="draw-pot">
            <h4 class="area-title">Bình Bốc thăm (<span id="unassigned-count">0</span>)</h4>
            <div class="pot-list" id="pot-list">
                <p class="text-muted placeholder-text" style="grid-column: 1 / -1;">Không có đội nào.</p>
            </div>
        </div>

        <div class="draw-stage">
            <div class="groups-grid" id="groups-container">
                </div>
        </div>

        <div class="draw-controls">
            <h4 class="area-title">Bảng điều khiển</h4>
            <div class="d-grid gap-2">
                <button class="btn btn-primary btn-lg" id="draw-btn"><i class="bi bi-dice-5"></i> Bốc thăm Kế tiếp</button>
                <button class="btn btn-info" id="auto-draw-btn"><i class="bi bi-robot"></i> Bốc thăm Tự động</button>
                <button class="btn btn-secondary" id="reset-btn"><i class="bi bi-arrow-counterclockwise"></i> Làm lại từ đầu</button>
                <button class="btn btn-success" id="save-btn" disabled><i class="bi bi-check-circle"></i> Xác nhận & Lưu</button>
            </div>
        </div>
    </div>
</div>

<form method="post" id="draw-result-form" class="d-none">
    {% csrf_token %}
    <input type="hidden" name="draw_results" id="draw-results-input">
</form>

<div class="draw-animation-container"></div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- LẤY DỮ LIỆU TỪ DJANGO ---
    const unassignedTeams = JSON.parse('{{ teams_json|escapejs }}');
    const groups = JSON.parse('{{ groups_json|escapejs }}');
    const noImageUrl = '{% static "images/no-image.png" %}';
    
    // --- LẤY CÁC THÀNH PHẦN HTML ---
    const potListEl = document.getElementById('pot-list');
    const groupsContainerEl = document.getElementById('groups-container');
    const unassignedCountEl = document.getElementById('unassigned-count');
    const drawBtn = document.getElementById('draw-btn');
    const autoDrawBtn = document.getElementById('auto-draw-btn');
    const resetBtn = document.getElementById('reset-btn');
    const saveBtn = document.getElementById('save-btn');
    const animContainer = document.querySelector('.draw-animation-container');
    const placeholderText = potListEl.querySelector('.placeholder-text');

    let currentTeams = [];
    let groupAssignments = {};

    // --- CÁC HÀM XỬ LÝ ---

    function createTeamBall(team) {
        const div = document.createElement('div');
        div.className = 'team-ball';
        div.dataset.id = team.id;
        div.dataset.name = team.name;
        div.innerHTML = `<img src="${team.logo || noImageUrl}" alt="${team.name}" class="logo">`;
        return div;
    }
    
    function initialize() {
        potListEl.innerHTML = '';
        if (placeholderText) potListEl.appendChild(placeholderText);
        groupsContainerEl.innerHTML = '';
        currentTeams = [...unassignedTeams];
        groupAssignments = {};

        if (currentTeams.length > 0) {
            placeholderText.style.display = 'none';
            currentTeams.forEach(team => potListEl.appendChild(createTeamBall(team)));
        } else {
            placeholderText.style.display = 'block';
        }
        
        groups.forEach(group => {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'group-card';
            groupDiv.dataset.groupId = group.id;
            groupDiv.innerHTML = `
                <h5>${group.name}</h5>
                <div class="team-list"></div>
            `;
            groupsContainerEl.appendChild(groupDiv);
            groupAssignments[group.id] = [];
        });

        updateUIState();
    }
    
    function updateUIState() {
        unassignedCountEl.textContent = currentTeams.length;
        const isDrawingFinished = currentTeams.length === 0;
        drawBtn.disabled = isDrawingFinished;
        autoDrawBtn.disabled = isDrawingFinished;
        resetBtn.disabled = false;
        saveBtn.disabled = !(unassignedTeams.length > 0 && isDrawingFinished);
    }
    
    const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));

    async function animateFly(startEl, endEl) {
        const flyingBall = startEl.cloneNode(true);
        flyingBall.classList.add('flying-ball');
        const startRect = startEl.getBoundingClientRect();
        
        flyingBall.style.left = `${startRect.left}px`;
        flyingBall.style.top = `${startRect.top}px`;
        animContainer.appendChild(flyingBall);
        startEl.style.opacity = '0';

        await sleep(50);

        const endRect = endEl.getBoundingClientRect();
        flyingBall.style.left = `${endRect.left + 16}px`;
        flyingBall.style.top = `${endRect.top + 16}px`;

        await sleep(800);
        animContainer.removeChild(flyingBall);
        endEl.classList.add('filled');
    }
    
    async function performDraw(teamToDraw = null) {
        if (currentTeams.length === 0) return;
        
        drawBtn.disabled = true;
        autoDrawBtn.disabled = true;

        const selectedTeam = teamToDraw || currentTeams[Math.floor(Math.random() * currentTeams.length)];
        const teamIndex = currentTeams.findIndex(t => t.id === selectedTeam.id);
        const teamBallEl = potListEl.querySelector(`.team-ball[data-id='${selectedTeam.id}']`);
        
        if (teamIndex === -1 || !teamBallEl) {
            updateUIState();
            return;
        }

        // === LOGIC RANDOM BẢNG ĐẤU ĐÃ CẢI TIẾN ===
        let minTeams = Infinity;
        let candidateGroups = [];

        groupsContainerEl.querySelectorAll('.group-card').forEach(card => {
            const count = groupAssignments[card.dataset.groupId].length;
            if (count < minTeams) {
                minTeams = count;
                candidateGroups = [card]; 
            } else if (count === minTeams) {
                candidateGroups.push(card);
            }
        });

        const targetGroupCard = candidateGroups.length > 0 
            ? candidateGroups[Math.floor(Math.random() * candidateGroups.length)]
            : null;
        
        // === THÊM HIỆU ỨNG VÀNG TRƯỚC KHI BAY ===
        if (targetGroupCard) {
            teamBallEl.classList.add('is-drawing');
            candidateGroups.forEach(g => g.classList.add('is-candidate'));
            await sleep(300); // Chờ một chút để người dùng thấy hiệu ứng

            const teamSlotEl = document.createElement('div');
            teamSlotEl.className = 'team-slot';
            teamSlotEl.innerHTML = `<img src="${teamBallEl.querySelector('img').src}" class="logo"> <span>${selectedTeam.name}</span>`;
            targetGroupCard.querySelector('.team-list').appendChild(teamSlotEl);

            await animateFly(teamBallEl, teamSlotEl);
            
            currentTeams.splice(teamIndex, 1);
            groupAssignments[targetGroupCard.dataset.groupId].push(selectedTeam.id);
            
            // Xóa hiệu ứng sau khi hoàn tất
            teamBallEl.classList.remove('is-drawing');
            candidateGroups.forEach(g => g.classList.remove('is-candidate'));
        }
        
        updateUIState();
    }

    async function performAutoDraw() {
        drawBtn.disabled = true;
        autoDrawBtn.disabled = true;
        resetBtn.disabled = true;

        while (currentTeams.length > 0) {
            await performDraw();
            await sleep(500);
        }
        resetBtn.disabled = false;
    }

    function saveResults() {
        const form = document.getElementById('draw-result-form');
        const drawResultsInput = document.getElementById('draw-results-input');
        drawResultsInput.value = JSON.stringify(groupAssignments);

        if (confirm('Bạn có chắc chắn muốn lưu kết quả bốc thăm này?')) {
            form.submit();
        }
    }

    potListEl.addEventListener('click', (e) => {
        const clickedBall = e.target.closest('.team-ball');
        if (!clickedBall || drawBtn.disabled) return;

        const teamId = parseInt(clickedBall.dataset.id, 10);
        const teamToDraw = currentTeams.find(t => t.id === teamId);

        if (teamToDraw) {
            performDraw(teamToDraw);
        }
    });

    drawBtn.addEventListener('click', () => performDraw());
    autoDrawBtn.addEventListener('click', performAutoDraw);
    resetBtn.addEventListener('click', initialize);
    saveBtn.addEventListener('click', saveResults);
    initialize();
});
</script>
{% endblock %}