{% extends "base.html" %}
{% load static custom_filters %}

{% block title %}Ghi chú BLV: {{ match }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<link rel="stylesheet" href="{% static 'css/management.css' %}">
<style>
  /* ===== Layout 2 cột (trái nội dung, phải sidebar) ===== */
  .notes-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 1.25rem; align-items: start; }
  @media (max-width: 1199.98px) { .notes-grid { grid-template-columns: 1fr; } }

  /* ===== Header ===== */
  .page-header { display:flex; align-items:flex-start; justify-content:space-between; gap: 1rem; }
  .page-header h1 { margin: 0; font-weight: 800; letter-spacing: .2px; }
  .action-stack { display:flex; flex-direction: column; gap: .5rem; }
  @media (min-width: 576px) { .action-stack { flex-direction: row; } }

  /* ===== Cards & Elements ===== */
  .card { border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,.06); }
  .card-header h5 { margin:0; font-weight:700; }
  textarea.form-control { min-height: 260px; }

  /* Captain note glass */
  .alert-glass { background: rgba(25,135,84,.08) !important; border-color: rgba(25,135,84,.25) !important; backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); }

  /* Sidebar widgets */
  .sidebar-widget { background-color: #f8f9fa; padding: 1rem; border-radius: 12px; border: 1px solid #e9ecef; box-shadow: 0 6px 18px rgba(0,0,0,.05); }
  .sidebar-widget + .sidebar-widget { margin-top: 1rem; }
  .sidebar-widget h5 { margin: 0 0 .6rem; border-bottom: 2px solid #0d6efd; padding-bottom: .4rem; font-weight:800; font-size: 1rem; }
  .stat-list, .player-list, .sponsor-list { list-style: none; padding:0; margin:0; }
  .stat-list li, .player-list li, .sponsor-list li { display:flex; align-items:center; justify-content:space-between; gap:.75rem; padding:.5rem 0; border-bottom: 1px dashed #dee2e6; }
  .stat-list li:last-child, .player-list li:last-child, .sponsor-list li:last-child { border-bottom: 0; }
  .value { font-weight: 800; color: #0d6efd; }
  .value-warn { color:#ffc107; }
  .value-danger { color:#dc3545; }

  /* Sponsor logos: hộp đồng nhất để logo không méo/lệch */
  .sponsor-row { display:flex; align-items:center; gap:.75rem; }

  /* ===== SPONSOR FIX: cố định khung + chặn ảnh phóng to ===== */
  .sponsor-row .sponsor-name {
    flex: 1 1 auto;
    min-width: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .sidebar .sponsor-list {
    --logo-w: 96px;   /* đổi nhanh kích thước ở đây nếu cần */
    --logo-h: 48px;
  }

  .sponsor-logo-box {
    flex: 0 0 var(--logo-w);
    width: var(--logo-w);
    height: var(--logo-h);
    display: grid;
    place-items: center;
    background: #fff;
    border: 1px dashed #e9ecef;
    border-radius: 8px;
    overflow: hidden;
    padding: 6px;
  }

  .sponsor-logo-box .sponsor-logo {
    width: 100% !important;
    height: 100% !important;
    max-width: 100% !important;
    max-height: 100% !important;
    object-fit: contain;
    display: block;
    image-rendering: -webkit-optimize-contrast;
  }

  .sponsor-logo[width], .sponsor-logo[height] {
    width: 100% !important;
    height: 100% !important;
  }

  .sidebar img {
    max-width: 100% !important;
    height: auto;
  }

  @media (max-width: 575.98px) {
    .sidebar .sponsor-list {
      --logo-w: 80px;
      --logo-h: 40px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="page-header mb-3">
    <div>
      <h1><i class="bi bi-files text-primary me-1"></i> Sổ tay Bình luận viên</h1>
      <p class="lead mb-0">Trận đấu: <strong>{{ match.team1.name }} vs {{ match.team2.name }}</strong></p>
    </div>
    <div class="action-stack">
      <button type="submit" form="notes-form" class="btn btn-primary btn-sm">
        <i class="bi bi-save-fill me-1"></i> Lưu ghi chú
      </button>
      <button type="button" class="btn btn-outline-dark btn-sm" data-bs-toggle="modal" data-bs-target="#rulesModal">
        <i class="bi bi-book me-1"></i> Điều lệ
      </button>
       <a href="{% url 'match_control' match.pk %}" class="btn btn-secondary btn-sm">
        <i class="bi bi-arrow-left me-1"></i> Quay lại
      </a>
    </div>
  </div>

  <div class="notes-grid">
    <div class="main-content">
      <form method="post" id="notes-form">
        {% csrf_token %}
        <div class="row g-4">
          <div class="col-lg-6">
            <div class="card h-100">
              <div class="card-header"><h5>{{ match.team1.name }}</h5></div>
              <div class="card-body">
                <textarea name="commentator_notes_team1" class="form-control" rows="15" placeholder="Ghi chú cho {{ match.team1.name }}">{{ note.commentator_notes_team1 }}</textarea>

                {% with team1_notes=captain_notes|filter_by_team:match.team1.id %}
                  {% if team1_notes %}
                    <hr>
                    <h6 class="mb-2"><i class="bi bi-chat-right-text-fill text-success me-1"></i> Ghi chú từ Đội trưởng</h6>
                    {% for c_note in team1_notes %}
                      <div class="alert alert-success alert-glass">{{ c_note.captain_note|linebreaksbr }}</div>
                    {% endfor %}
                  {% endif %}
                {% endwith %}
              </div>
            </div>
          </div>

          <div class="col-lg-6">
            <div class="card h-100">
              <div class="card-header"><h5>{{ match.team2.name }}</h5></div>
              <div class="card-body">
                <textarea name="commentator_notes_team2" class="form-control" rows="15" placeholder="Ghi chú cho {{ match.team2.name }}">{{ note.commentator_notes_team2 }}</textarea>
                
                {% with team2_notes=captain_notes|filter_by_team:match.team2.id %}
                  {% if team2_notes %}
                    <hr>
                    <h6 class="mb-2"><i class="bi bi-chat-right-text-fill text-success me-1"></i> Ghi chú từ Đội trưởng</h6>
                    {% for c_note in team2_notes %}
                      <div class="alert alert-success alert-glass">{{ c_note.captain_note|linebreaksbr }}</div>
                    {% endfor %}
                  {% endif %}
                {% endwith %}
              </div>
            </div>
          </div>
        </div>
      </form>
      
      <div class="mt-4">
        {% include 'tournaments/partials/standings_table.html' %}
      </div>

    </div>

    <aside class="sidebar">
       <div class="sidebar-widget">
        <h5><i class="bi bi-info-circle"></i> Thông tin trận đấu</h5>
        <ul class="stat-list">
          <li><span>Giải đấu:</span> <strong>{{ match.tournament.name }}</strong></li>
          <li><span>Vòng đấu:</span> <strong>{{ match.get_match_round_display }}</strong></li>
          <li><span>Điều lệ:</span> <a href="#" data-bs-toggle="modal" data-bs-target="#rulesModal">Xem quy định</a></li>
        </ul>
      </div>

      <div class="sidebar-widget">
        <h5><i class="bi bi-bar-chart-line-fill"></i> Thống kê nổi bật</h5>
        <ul class="stat-list">
          <li><span>Tổng bàn thắng:</span> <span class="value">{{ tournament_stats.total_goals }}</span></li>
          <li><span>Thẻ vàng:</span> <span class="value value-warn">{{ tournament_stats.yellow_cards }}</span></li>
          <li><span>Thẻ đỏ:</span> <span class="value value-danger">{{ tournament_stats.red_cards }}</span></li>
        </ul>
      </div>

      <div class="sidebar-widget">
        <h5><i class="bi bi-person-fill-up"></i> Top 5 Vua phá lưới</h5>
        <ul class="player-list">
          {% for player in top_scorers %}
            <li>
              <a href="{% url 'player_detail' pk=player.pk %}" target="_blank">{{ player.full_name }}</a>
              <span class="value">{{ player.num_goals }}</span>
            </li>
          {% empty %}
            <li>Chưa có dữ liệu.</li>
          {% endfor %}
        </ul>
      </div>

      <div class="sidebar-widget">
        <h5><i class="bi bi-star-fill"></i> Cầu thủ đáng chú ý</h5>
        <ul class="player-list">
          {% if team1_top_scorer %}
            <li>
              <span>{{ match.team1.name }}:</span>
              <a href="{% url 'player_detail' pk=team1_top_scorer.pk %}" target="_blank"><strong>{{ team1_top_scorer.full_name }}</strong> ({{ team1_top_scorer.num_goals }} bàn)</a>
            </li>
          {% endif %}
          {% if team2_top_scorer %}
            <li>
              <span>{{ match.team2.name }}:</span>
              <a href="{% url 'player_detail' pk=team2_top_scorer.pk %}" target="_blank"><strong>{{ team2_top_scorer.full_name }}</strong> ({{ team2_top_scorer.num_goals }} bàn)</a>
            </li>
          {% endif %}
          {% if not team1_top_scorer and not team2_top_scorer %}
            <li>Chưa có cầu thủ nào ghi bàn.</li>
          {% endif %}
        </ul>
      </div>

      {% if sponsors %}
      <div class="sidebar-widget">
        <h5><i class="bi bi-gem"></i> Nhà tài trợ</h5>
        <ul class="sponsor-list">
          {% for sponsorship in sponsors %}
            <li class="sponsor-row">
              <a href="{{ sponsorship.sponsor.sponsor_profile.website_url|default:sponsorship.website_url|default:'#' }}"
                 target="_blank" rel="noopener" class="text-decoration-none text-dark sponsor-name">
                {% if sponsorship.sponsor and sponsorship.sponsor.sponsor_profile %}
                    {{ sponsorship.sponsor.sponsor_profile.brand_name }}
                {% else %}
                    {{ sponsorship.sponsor_name }}
                {% endif %}
              </a>
              {% if sponsorship.logo or sponsorship.sponsor and sponsorship.sponsor.sponsor_profile.brand_logo %}
                <div class="sponsor-logo-box">
                    <img
                      src="{% if sponsorship.sponsor and sponsorship.sponsor.sponsor_profile.brand_logo %}{{ sponsorship.sponsor.sponsor_profile.brand_logo.url }}{% else %}{{ sponsorship.logo.url }}{% endif %}"
                      alt="Logo" class="sponsor-logo" width="192" height="96" loading="lazy" decoding="async">
                </div>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

    </aside>
  </div>
</div>

<div class="modal fade" id="rulesModal" tabindex="-1" aria-labelledby="rulesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="rulesModalLabel">Điều lệ & Thông báo - {{ match.tournament.name }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {% if match.tournament.rules %}
          {{ match.tournament.rules|safe|linebreaks }}
        {% else %}
          <p>Chưa có điều lệ nào được ban tổ chức cập nhật.</p>
        {% endif %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}