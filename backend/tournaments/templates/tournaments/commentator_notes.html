{% extends "base.html" %}
{% load static custom_filters %}

{% block title %}Ghi chú BLV: {{ match }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/management.css' %}">
<style>
  /* ===== Layout 2 cột (trái nội dung, phải sidebar) ===== */
  .notes-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 1.25rem; align-items: start; }
  @media (max-width: 1199.98px) { .notes-grid { grid-template-columns: 1fr; } }

  /* ===== Header ===== */
  .page-header { display:flex; align-items:flex-start; justify-content:space-between; gap: 1rem; }
  .page-header h1 { margin: 0; font-weight: 800; letter-spacing: .2px; }
  .action-stack { display:flex; flex-direction: column; gap: .5rem; }
  @media (min-width: 576px) { .action-stack { flex-direction: row; } }

  /* ===== Cards & Elements ===== */
  .card { border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,.06); }
  .card-header h5 { margin:0; font-weight:700; }
  textarea.form-control { min-height: 260px; }

  /* Captain note glass */
  .alert-glass { background: rgba(25,135,84,.08) !important; border-color: rgba(25,135,84,.25) !important; backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); }

  /* Sidebar widgets */
  .sidebar-widget { background-color: #f8f9fa; padding: 1rem; border-radius: 12px; border: 1px solid #e9ecef; box-shadow: 0 6px 18px rgba(0,0,0,.05); }
  .sidebar-widget + .sidebar-widget { margin-top: 1rem; }
  .sidebar-widget h5 { margin: 0 0 .6rem; border-bottom: 2px solid #0d6efd; padding-bottom: .4rem; font-weight:800; font-size: 1rem; }
  .stat-list, .player-list, .sponsor-list { list-style: none; padding:0; margin:0; }
  .stat-list li, .player-list li, .sponsor-list li { display:flex; align-items:center; justify-content:space-between; gap:.75rem; padding:.5rem 0; border-bottom: 1px dashed #dee2e6; }
  .stat-list li:last-child, .player-list li:last-child, .sponsor-list li:last-child { border-bottom: 0; }
  .value { font-weight: 800; color: #0d6efd; }
  .value-warn { color:#ffc107; }
  .value-danger { color:#dc3545; }

  /* Sponsor logos: hộp đồng nhất để logo không méo/lệch */
  .sponsor-row { display:flex; align-items:center; justify-content:space-between; gap:.75rem; }
  .sponsor-logo-box { width: 60px; height: 18px; flex: 0 0 60px; display:flex; align-items:center; justify-content:center; background:#fff; border:1px dashed #e9ecef; border-radius:10px; overflow:hidden; }
  .sponsor-logo { max-width:100%; max-height:100%; width:auto; height:auto; object-fit:contain; image-rendering: -webkit-optimize-contrast; }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- Header + Actions giống mẫu, nhưng giữ đủ biến => không lỗi -->
  <div class="page-header mb-3">
    <div>
      <h1><i class="fas fa-files-o text-primary me-1"></i> Sổ tay Bình luận viên</h1>
      <p class="lead mb-0">Trận đấu: <strong>{{ match.team1.name }} vs {{ match.team2.name }}</strong></p>
    </div>
    <div class="action-stack">
      <a href="{% url 'match_control' match.pk %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-1"></i> Phòng điều khiển
      </a>
      <button type="submit" form="notes-form" class="btn btn-primary">
        <i class="fas fa-save me-1"></i> Lưu ghi chú
      </button>
      <button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#rulesModal">
        <i class="fas fa-book me-1"></i> Điều lệ
      </button>
    </div>
  </div>

  <div class="notes-grid">
    <!-- MAIN CONTENT: 2 cột team như demo, nhưng dùng field gốc để tránh lỗi -->
    <div class="main-content">
      <form method="post" id="notes-form">
        {% csrf_token %}
        <div class="row g-4">
          <!-- Team 1 -->
          <div class="col-lg-6">
            <div class="card h-100">
              <div class="card-header"><h5>{{ match.team1.name }}</h5></div>
              <div class="card-body">
                <textarea name="commentator_notes_team1" class="form-control" rows="15" placeholder="Ghi chú cho {{ match.team1.name }}">{{ note.commentator_notes_team1 }}</textarea>

                {# Ghi chú đội trưởng của team1 nằm ngay bên dưới, nền mờ #}
                {% with has_note=False %}
                  {% for c_note in captain_notes %}
                    {% if c_note.team.id == match.team1.id %}
                      {% if not has_note %}
                        <hr>
                        <h6 class="mb-2"><i class="fas fa-comment-dots text-success me-1"></i> Ghi chú từ Đội trưởng</h6>
                      {% endif %}
                      <div class="alert alert-success alert-glass">{{ c_note.captain_note|linebreaksbr }}</div>
                      {% with True as has_note %}{% endwith %}
                    {% endif %}
                  {% endfor %}
                  {% if not has_note %}
                    {# Không hiện gì nếu không có ghi chú cho team này #}
                  {% endif %}
                {% endwith %}
              </div>
            </div>
          </div>

          <!-- Team 2 -->
          <div class="col-lg-6">
            <div class="card h-100">
              <div class="card-header"><h5>{{ match.team2.name }}</h5></div>
              <div class="card-body">
                <textarea name="commentator_notes_team2" class="form-control" rows="15" placeholder="Ghi chú cho {{ match.team2.name }}">{{ note.commentator_notes_team2 }}</textarea>

                {# Ghi chú đội trưởng của team2 nằm ngay bên dưới, nền mờ #}
                {% with has_note=False %}
                  {% for c_note in captain_notes %}
                    {% if c_note.team.id == match.team2.id %}
                      {% if not has_note %}
                        <hr>
                        <h6 class="mb-2"><i class="fas fa-comment-dots text-success me-1"></i> Ghi chú từ Đội trưởng</h6>
                      {% endif %}
                      <div class="alert alert-success alert-glass">{{ c_note.captain_note|linebreaksbr }}</div>
                      {% with True as has_note %}{% endwith %}
                    {% endif %}
                  {% endfor %}
                {% endwith %}
              </div>
            </div>
          </div>
        </div>

              </form>
    </div>

    <!-- SIDEBAR giữ đủ như code ban đầu -->
    <aside class="sidebar">
      <div class="sidebar-widget">
        <h5><i class="fas fa-info-circle"></i> Thông tin trận đấu</h5>
        <ul class="stat-list">
          <li><span>Giải đấu:</span> <strong>{{ match.tournament.name }}</strong></li>
          <li><span>Vòng đấu:</span> <strong>{{ match.get_match_round_display }}</strong></li>
          <li><span>Điều lệ:</span> <a href="#" data-bs-toggle="modal" data-bs-target="#rulesModal">Xem quy định</a></li>
        </ul>
      </div>

      <div class="sidebar-widget">
        <h5><i class="fas fa-chart-bar"></i> Thống kê nổi bật</h5>
        <ul class="stat-list">
          <li><span>Tổng bàn thắng:</span> <span class="value">{{ tournament_stats.total_goals }}</span></li>
          <li><span>Thẻ vàng:</span> <span class="value value-warn">{{ tournament_stats.yellow_cards }}</span></li>
          <li><span>Thẻ đỏ:</span> <span class="value value-danger">{{ tournament_stats.red_cards }}</span></li>
        </ul>
      </div>

      <div class="sidebar-widget">
        <h5><i class="fas fa-crown"></i> Top 5 Vua phá lưới</h5>
        <ul class="player-list">
          {% for player in top_scorers %}
            <li>
              <a href="{{ player.get_absolute_url }}" target="_blank">{{ player.full_name }}</a>
              <span class="value">{{ player.num_goals }}</span>
            </li>
          {% empty %}
            <li>Chưa có dữ liệu.</li>
          {% endfor %}
        </ul>
      </div>

      <div class="sidebar-widget">
        <h5><i class="fas fa-star"></i> Cầu thủ đáng chú ý</h5>
        <ul class="player-list">
          {% if team1_top_scorer %}
            <li>
              <span>{{ match.team1.name }}:</span>
              <a href="{{ team1_top_scorer.get_absolute_url }}" target="_blank"><strong>{{ team1_top_scorer.full_name }}</strong> ({{ team1_top_scorer.num_goals }} bàn)</a>
            </li>
          {% endif %}
          {% if team2_top_scorer %}
            <li>
              <span>{{ match.team2.name }}:</span>
              <a href="{{ team2_top_scorer.get_absolute_url }}" target="_blank"><strong>{{ team2_top_scorer.full_name }}</strong> ({{ team2_top_scorer.num_goals }} bàn)</a>
            </li>
          {% endif %}
          {% if not team1_top_scorer and not team2_top_scorer %}
            <li>Chưa có cầu thủ nào ghi bàn.</li>
          {% endif %}
        </ul>
      </div>

      <div class="sidebar-widget">
        <h5><i class="fas fa-handshake"></i> Nhà tài trợ</h5>
        <ul class="sponsor-list">
          {% for sponsorship in sponsors %}
            <li class="sponsor-row">
              <span>
                {% if sponsorship.sponsor %}
                  {{ sponsorship.sponsor.username }}
                {% else %}
                  {{ sponsorship.sponsor_name }}
                {% endif %}
              </span>
              {% if sponsorship.logo %}
                <div class="sponsor-logo-box">
                  <img src="{{ sponsorship.logo.url }}" alt="{% if sponsorship.sponsor %}{{ sponsorship.sponsor.username }}{% else %}{{ sponsorship.sponsor_name }}{% endif %}" class="sponsor-logo">
                </div>
              {% endif %}
            </li>
          {% empty %}
            <li>Chưa có thông tin nhà tài trợ.</li>
          {% endfor %}
        </ul>
      </div>
    </aside>
  </div>
</div>

<!-- Modal Điều lệ giữ nguyên -->
<div class="modal fade" id="rulesModal" tabindex="-1" aria-labelledby="rulesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="rulesModalLabel">Điều lệ & Thông báo - {{ match.tournament.name }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {% if match.tournament.rules %}
          {{ match.tournament.rules|safe }}
        {% else %}
          <p>Chưa có điều lệ nào được ban tổ chức cập nhật.</p>
        {% endif %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
