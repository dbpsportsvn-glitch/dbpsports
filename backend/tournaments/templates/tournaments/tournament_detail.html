{% extends 'base.html' %}

{% block title %}{{ tournament.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="pb-3 mb-4 border-bottom">
    <h1>{{ tournament.name }}</h1>
  </div>

  <style>
    .sticky-tabs{position:sticky;top:56px;z-index:1020;background:var(--bs-body-bg);padding:.5rem 0 .25rem}
    .tour-tabs .nav-link{border-radius:9999px;font-weight:600;padding:.5rem 1rem}
    .tour-tabs .nav-link:hover{background:var(--bs-light)}
    .tour-tabs .nav-link.active{color:#fff;background:linear-gradient(90deg,#0d6efd,#20c997);box-shadow:0 .25rem .75rem rgba(13,110,253,.25)}
    .tab-pane.card-pane{border:1px solid var(--bs-border-color);border-top:0;border-radius:0 0 .5rem .5rem;padding:1rem}
    .section-title{font-weight:700}
    .table thead th{position:sticky;top:0;background:var(--bs-body-bg);z-index:1}
    .table-hover tbody tr:hover{background:var(--bs-light)}
    .chip{display:inline-block;padding:.15rem .5rem;border-radius:9999px;background:var(--bs-light);font-size:.75rem;margin-right:.4rem}
  </style>

<div class="sticky-tabs d-flex justify-content-between align-items-center flex-wrap gap-2">
  <ul class="nav nav-pills gap-2 tour-tabs" id="tournamentTab" role="tablist">
    <li class="nav-item"><button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button">üèÅ T·ªïng quan</button></li>
    <li class="nav-item"><button class="nav-link" id="teams-tab"    data-bs-toggle="tab" data-bs-target="#teams"    type="button">üë• C√°c ƒë·ªôi</button></li>
    <li class="nav-item"><button class="nav-link" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule" type="button">üìÖ L·ªãch thi ƒë·∫•u</button></li>
    <li class="nav-item"><button class="nav-link" id="standings-tab"data-bs-toggle="tab" data-bs-target="#standings"type="button">üèÜ B·∫£ng x·∫øp h·∫°ng</button></li>
  </ul>

  <button id="print-all-btn"
          class="btn btn-outline-secondary btn-sm no-print d-none"
          onclick="printTab('schedule-all', '{{ tournament.name }} - L·ªãch thi ƒë·∫•u')">
    üñ®Ô∏è In
  </button>

</div>
<script>
(function () {
  const btn = document.getElementById('print-all-btn');
  function updatePrintBtn(e){
    const target = e ? e.target.getAttribute('data-bs-target') : (document.querySelector('#tournamentTab .nav-link.active')?.getAttribute('data-bs-target') || '');
    btn.classList.toggle('d-none', target !== '#schedule');
  }
  document.querySelectorAll('#tournamentTab [data-bs-toggle="tab"]').forEach(el=>{
    el.addEventListener('shown.bs.tab', updatePrintBtn);
  });
  updatePrintBtn(); // ch·∫°y l√∫c t·∫£i trang
})();
</script>


  <div class="tab-content" id="tournamentTabContent">
    <!-- T·ªïng quan -->
    <div class="tab-pane fade show active card-pane" id="overview" role="tabpanel">
      <p>
        <span class="chip">Tr·∫°ng th√°i: {{ tournament.get_status_display }}</span>
        <span class="chip">B·∫Øt ƒë·∫ßu: {{ tournament.start_date|date:"d/m/Y" }}</span>
        <span class="chip">K·∫øt th√∫c: {{ tournament.end_date|date:"d/m/Y" }}</span>
      </p>
      {% if tournament.status == 'REGISTRATION_OPEN' %}
        <a href="{% url 'create_team' tournament_pk=tournament.pk %}" class="btn btn-success btn-lg mt-2">ƒêƒÉng k√Ω tham gia gi·∫£i ƒë·∫•u</a>
      {% else %}
        <p class="text-muted mt-2">Giai ƒëo·∫°n ƒëƒÉng k√Ω ƒë√£ k·∫øt th√∫c.</p>
      {% endif %}
    </div>

    <!-- C√°c ƒë·ªôi -->
    <div class="tab-pane fade card-pane" id="teams" role="tabpanel">
      {% for group in tournament.groups.all %}
        <h5 class="section-title mt-2">{{ group.name }}</h5>
        <div class="row row-cols-1 row-cols-md-3 g-3">
          {% for team in group.teams.all %}
            <div class="col">
              <div class="card h-100 shadow-sm">
                <div class="card-body">
                  <h6 class="card-title mb-1">{{ team.name }}</h6>
                  <a href="{% url 'team_detail' pk=team.pk %}" class="btn btn-outline-primary btn-sm">Xem ƒë·ªôi</a>
                </div>
              </div>
            </div>
          {% empty %}
            <div class="col"><p class="text-muted">Ch∆∞a c√≥ ƒë·ªôi.</p></div>
          {% endfor %}
        </div>
      {% empty %}
        <p class="text-muted">Ch∆∞a c√≥ b·∫£ng ƒë·∫•u n√†o ƒë∆∞·ª£c t·∫°o cho gi·∫£i n√†y.</p>
      {% endfor %}
    </div>

    <!-- L·ªãch thi ƒë·∫•u -->
    <div class="tab-pane fade card-pane" id="schedule" role="tabpanel">
    <div id="schedule-all">
        {% with all_matches=tournament.matches.all %}

        {# --- V√≤ng b·∫£ng theo t·ª´ng B·∫£ng --- #}
        {% for g in tournament.groups.all %}
            <h5 class="section-title mt-3">{{ g.name }}</h5>
            <div class="row row-cols-1 g-3">
            {% for m in all_matches %}
                {% if m.match_round == 'GROUP' and m.team1.group_id == g.id and m.team2.group_id == g.id %}
                <div class="col">
                    <a href="{% url 'match_detail' pk=m.pk %}" class="text-decoration-none text-reset">
                    <div class="card match-card">
                        <div class="card-body mc">
                        <div class="mc-left">{{ m.match_time|date:"H:i d/m" }}</div>

                        <div class="mc-center">
                            <div class="d-flex align-items-center">
                            {% if m.team1.logo %}
                                <img class="mc-logo" src="{{ m.team1.logo.url }}" alt="">
                                <span style="display:inline-block;width:1px;height:18px;background:currentColor;opacity:.3;margin:0 .5rem;"></span>
                            {% endif %}
                            <span class="mc-name">{{ m.team1.name }}</span>
                            </div>

                            <span class="fw-bold px-2">vs</span>

                            <div class="d-flex align-items-center">
                            <span class="mc-name">{{ m.team2.name }}</span>
                            <span style="display:inline-block;width:1px;height:18px;background:currentColor;opacity:.3;margin:0 .5rem;"></span>
                            {% if m.team2.logo %}
                                <img class="mc-logo" src="{{ m.team2.logo.url }}" alt="">
                            {% endif %}
                            </div>
                        </div>

                        <div class="mc-right">
                            <span class="mc-score">{{ m.team1_score|default:"-" }} : {{ m.team2_score|default:"-" }}</span>
                            <span class="chip">{{ m.get_match_round_display|default:m.match_round }}</span>
                            {% if m.location %}<span class="chip">S√¢n {{ m.location }}</span>{% endif %}
                        </div>
                        </div>
                    </div>
                    </a>
                </div>
                {% endif %}
            {% empty %}
                <div class="col"><p class="text-muted">Ch∆∞a c√≥ tr·∫≠n.</p></div>
            {% endfor %}
            </div>
        {% empty %}
            <p class="text-muted">Ch∆∞a c√≥ b·∫£ng ƒë·∫•u.</p>
        {% endfor %}

        {# --- V√≤ng lo·∫°i tr·ª±c ti·∫øp --- #}
        <h5 class="section-title mt-4">V√≤ng Lo·∫°i tr·ª±c ti·∫øp</h5>
        <div class="row row-cols-1 g-3">
            {% for m in all_matches %}
            {% if m.match_round == 'KNOCKOUT' %}
                <div class="col">
                <a href="{% url 'match_detail' pk=m.pk %}" class="text-decoration-none text-reset">
                    <div class="card match-card">
                    <div class="card-body mc">
                        <div class="mc-left">{{ m.match_time|date:"H:i d/m" }}</div>

                        <div class="mc-center">
                        <div class="d-flex align-items-center">
                            {% if m.team1.logo %}
                            <img class="mc-logo" src="{{ m.team1.logo.url }}" alt="">
                            <span style="display:inline-block;width:1px;height:18px;background:currentColor;opacity:.3;margin:0 .5rem;"></span>
                            {% endif %}
                            <span class="mc-name">{{ m.team1.name }}</span>
                        </div>

                        <span class="fw-bold px-2">vs</span>

                        <div class="d-flex align-items-center">
                            <span class="mc-name">{{ m.team2.name }}</span>
                            <span style="display:inline-block;width:1px;height:18px;background:currentColor;opacity:.3;margin:0 .5rem;"></span>
                            {% if m.team2.logo %}
                            <img class="mc-logo" src="{{ m.team2.logo.url }}" alt="">
                            {% endif %}
                        </div>
                        </div>

                        <div class="mc-right">
                        <span class="mc-score">{{ m.team1_score|default:"-" }} : {{ m.team2_score|default:"-" }}</span>
                        <span class="chip">{{ m.get_match_round_display|default:m.match_round }}</span>
                        {% if m.location %}<span class="chip">S√¢n {{ m.location }}</span>{% endif %}
                        </div>
                    </div>
                    </div>
                </a>
                </div>
            {% endif %}
            {% empty %}
            <div class="col"><p class="text-muted">Ch∆∞a c√≥ tr·∫≠n.</p></div>
            {% endfor %}
        </div>

        {% endwith %}
    </div>
    </div>

    <!-- BXH -->
    <div class="tab-pane fade card-pane" id="standings" role="tabpanel">
      {% include 'tournaments/partials/standings_table.html' %}
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const tabEls = document.querySelectorAll('#tournamentTab [data-bs-toggle="tab"]');
  tabEls.forEach(function (el) {
    el.addEventListener('shown.bs.tab', function (e) {
      const target = e.target.getAttribute('data-bs-target');
      history.replaceState(null, '', target);
    });
  });
  const hash = window.location.hash;
  if (hash) {
    const trigger = document.querySelector('#tournamentTab [data-bs-target="' + hash + '"]');
    if (trigger) new bootstrap.Tab(trigger).show();
  }
});
</script>

<script>
function printTab(contentId, title){
  const node = document.getElementById(contentId);
  if(!node) return;

  const iframe = document.createElement('iframe');
  iframe.style.position='fixed';
  iframe.style.right='0';
  iframe.style.bottom='0';
  iframe.style.width='0';
  iframe.style.height='0';
  iframe.style.border='0';
  document.body.appendChild(iframe);

  const w = iframe.contentWindow;
  const d = w.document;
  const styles = Array.from(document.querySelectorAll('link[rel="stylesheet"],style'))
                      .map(el => el.outerHTML).join('');

  d.open();
  d.write(`<!doctype html><html><head><meta charset="utf-8">
    <title>${title}</title>${styles}
    <style>@media print {.no-print{display:none!important}} body{padding:16px}</style>
  </head><body>
    <h3 style="margin-bottom:12px;">${title}</h3>
    ${node.innerHTML}
  </body></html>`);
  d.close();

  // ch·ªù DOM trong iframe render r·ªìi in
  setTimeout(function(){
    w.focus();
    w.print();
    document.body.removeChild(iframe);
  }, 100);
}
</script>


{% endblock %}
