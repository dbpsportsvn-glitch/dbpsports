{% extends 'base.html' %}

{% block title %}{{ tournament.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="pb-3 mb-4 border-bottom">
        <h1>{{ tournament.name }}</h1>
    </div>

    <ul class="nav nav-tabs" id="tournamentTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">Tổng quan</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="teams-tab" data-bs-toggle="tab" data-bs-target="#teams" type="button" role="tab">Các đội tham gia</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule" type="button" role="tab">Lịch thi đấu</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="standings-tab" data-bs-toggle="tab" data-bs-target="#standings" type="button" role="tab">Bảng xếp hạng</button>
        </li>
    </ul>

    <div class="tab-content" id="tournamentTabContent">
        <div class="tab-pane fade show active p-3 border border-top-0 rounded-bottom" id="overview" role="tabpanel">
            <p><strong>Trạng thái:</strong> {{ tournament.get_status_display }}</p>
            <p><strong>Ngày bắt đầu:</strong> {{ tournament.start_date|date:"d/m/Y" }}</p>
            <p><strong>Ngày kết thúc:</strong> {{ tournament.end_date|date:"d/m/Y" }}</p>

            {% if tournament.status == 'REGISTRATION_OPEN' %}
                <a href="{% url 'create_team' tournament_pk=tournament.pk %}" class="btn btn-success btn-lg my-4">Đăng ký tham gia giải đấu</a>
            {% else %}
                <p class="text-muted my-4">Giai đoạn đăng ký đã kết thúc.</p>
            {% endif %}
        </div>

        <div class="tab-pane fade p-3 border border-top-0 rounded-bottom" id="teams" role="tabpanel">
            {% for group in tournament.groups.all %}
                <h4 class="mt-3">{{ group.name }}</h4>
                <div class="row">
                    {% for team in group.teams.all %}
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">{{ team.name }}</h5>
                                    <a href="{% url 'team_detail' pk=team.pk %}" class="btn btn-secondary btn-sm">Xem chi tiết đội</a>
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        <div class="col"><p>Chưa có đội nào trong bảng này.</p></div>
                    {% endfor %}
                </div>
            {% empty %}
                <p>Chưa có bảng đấu nào được tạo cho giải này.</p>
            {% endfor %}
        </div>

        <div class="tab-pane fade p-3 border border-top-0 rounded-bottom" id="schedule" role="tabpanel">
            {% with all_matches=tournament.matches.all %}
            {# --- Vòng Bảng: tách theo từng bảng --- #}
            {% for g in tournament.groups.all %}
                <h5 class="mt-3">{{ g.name }}</h5>
                <div class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead>
                    <tr>
                        <th style="width:16%">Thời gian</th>
                        <th style="width:24%">Đội 1</th>
                        <th style="width:24%">Đội 2</th>
                        <th style="width:12%">Tỷ số</th>
                        <th style="width:12%">Vòng</th>
                        <th style="width:12%">Sân</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for m in all_matches %}
                        {% if m.match_round == 'GROUP' and m.team1.group_id == g.id and m.team2.group_id == g.id %}
                        <tr>
                            <td><a href="{% url 'match_detail' pk=m.pk %}">{{ m.match_time|date:"H:i d/m/Y" }}</a></td>
                            <td><a href="{% url 'team_detail' pk=m.team1.pk %}">{{ m.team1.name }}</a></td>
                            <td><a href="{% url 'team_detail' pk=m.team2.pk %}">{{ m.team2.name }}</a></td>
                            <td>{{ m.team1_score|default:"-" }} : {{ m.team2_score|default:"-" }}</td>
                            <td>{{ m.get_match_round_display|default:m.match_round }}</td>
                            <td>{{ m.location|default:"-" }}</td>
                        </tr>
                        {% endif %}
                    {% empty %}
                        <tr><td colspan="6">Chưa có trận.</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
                </div>
            {% empty %}
                <p>Chưa có bảng đấu nào.</p>
            {% endfor %}

            {# --- Vòng loại trực tiếp --- #}
            <h5 class="mt-4">Vòng Loại trực tiếp</h5>
            <div class="table-responsive">
                <table class="table table-striped align-middle">
                <thead>
                    <tr>
                    <th style="width:16%">Thời gian</th>
                    <th style="width:24%">Đội 1</th>
                    <th style="width:24%">Đội 2</th>
                    <th style="width:12%">Tỷ số</th>
                    <th style="width:12%">Vòng</th>
                    <th style="width:12%">Sân</th>
                    </tr>
                </thead>
                <tbody>
                    {% with ko=all_matches|dictsort:"match_time" %}
                    {% for m in all_matches %}
                        {% if m.match_round == 'KNOCKOUT' %}
                        <tr>
                            <td><a href="{% url 'match_detail' pk=m.pk %}">{{ m.match_time|date:"H:i d/m/Y" }}</a></td>
                            <td><a href="{% url 'team_detail' pk=m.team1.pk %}">{{ m.team1.name }}</a></td>
                            <td><a href="{% url 'team_detail' pk=m.team2.pk %}">{{ m.team2.name }}</a></td>
                            <td>{{ m.team1_score|default:"-" }} : {{ m.team2_score|default:"-" }}</td>
                            <td>{{ m.get_match_round_display|default:m.match_round }}</td>
                            <td>{{ m.location|default:"-" }}</td>
                        </tr>
                        {% endif %}
                    {% empty %}
                        <tr><td colspan="6">Chưa có trận.</td></tr>
                    {% endfor %}
                    {% endwith %}
                </tbody>
                </table>
            </div>
            {% endwith %}
        </div>

        <div class="tab-pane fade p-3 border border-top-0 rounded-bottom" id="standings" role="tabpanel">
            {% include 'tournaments/partials/standings_table.html' %}
        </div>
    </div>
</div>
{% endblock %}
