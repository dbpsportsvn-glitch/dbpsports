{% extends 'base.html' %}

{% block title %}{{ tournament.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="pb-3 mb-4 border-bottom">
    <h1 class="text-start">{{ tournament.name }}</h1>
  </div>

  <style>
    .sticky-tabs{position:sticky;top:56px;z-index:1020;background:var(--bs-body-bg);padding:.5rem 0 .25rem}
    /* Fix: luôn căn trái cụm tab, tránh CSS global đẩy .nav ra giữa/phải */
    .sticky-tabs .nav{margin:0 !important;justify-content:flex-start}
    /* Đẩy nút In sang phải khi hiển thị */
    #print-all-btn{margin-left:auto}

    .tour-tabs .nav-link{border-radius:9999px;font-weight:600;padding:.5rem 1rem}
    .tour-tabs .nav-link:hover{background:var(--bs-light)}
    .tour-tabs .nav-link.active{color:#fff;background:linear-gradient(90deg,#0d6efd,#20c997);box-shadow:0 .25rem .75rem rgba(13,110,253,.25)}
    .tab-pane.card-pane{border:1px solid var(--bs-border-color);border-top:0;border-radius:0 0 .5rem .5rem;padding:1rem}
    .section-title{font-weight:700}
    .table thead th{position:sticky;top:0;background:var(--bs-body-bg);z-index:1}
    .table-hover tbody tr:hover{background:var(--bs-light)}
    .chip{display:inline-block;padding:.15rem .5rem;border-radius:9999px;background:var(--bs-light);font-size:.75rem;margin-right:.4rem}
  </style>

  <div class="sticky-tabs d-flex align-items-center flex-wrap gap-2">
    <ul class="nav nav-pills gap-2 tour-tabs mb-0" id="tournamentTab" role="tablist">
      <li class="nav-item"><button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button">🏁 Tổng quan</button></li>

      <li class="nav-item"><button class="nav-link" id="rules-tab" data-bs-toggle="tab" data-bs-target="#rules" type="button">📜 Điều lệ</button></li>

      <li class="nav-item"><button class="nav-link" id="teams-tab"    data-bs-toggle="tab" data-bs-target="#teams"    type="button">👥 Các đội</button></li>
      <li class="nav-item"><button class="nav-link" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule" type="button">📅 Lịch thi đấu</button></li>
      <li class="nav-item"><button class="nav-link" id="standings-tab"data-bs-toggle="tab" data-bs-target="#standings"type="button">🏆 Bảng xếp hạng</button></li>
      <li class="nav-item"><button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats" type="button">📊 Thống kê</button></li>
    </ul>
    
    <button id="print-all-btn"
            class="btn btn-outline-secondary btn-sm no-print d-none"
            onclick="printTab('schedule-all', '{{ tournament.name }} - Lịch thi đấu')" type="button">
      🖨️ In
    </button>
  </div>

  <script>
  (function () {
    const btn = document.getElementById('print-all-btn');
    function updatePrintBtn(e){
      const target = e ? e.target.getAttribute('data-bs-target') : (document.querySelector('#tournamentTab .nav-link.active')?.getAttribute('data-bs-target') || '');
      btn.classList.toggle('d-none', target !== '#schedule');
    }
    document.querySelectorAll('#tournamentTab [data-bs-toggle="tab"]').forEach(el=>{
      el.addEventListener('shown.bs.tab', updatePrintBtn);
    });
    updatePrintBtn();
  })();
  </script>

  <div class="tab-content" id="tournamentTabContent">
    <!-- Tổng quan -->
    <div class="tab-pane fade show active card-pane" id="overview" role="tabpanel">
      <p>
        <span class="chip">Trạng thái: {{ tournament.get_status_display }}</span>
        <span class="chip">Bắt đầu: {{ tournament.start_date|date:"d/m/Y" }}</span>
        <span class="chip">Kết thúc: {{ tournament.end_date|date:"d/m/Y" }}</span>
      </p>
      {% if tournament.status == 'REGISTRATION_OPEN' %}
        <a href="{% url 'create_team' tournament_pk=tournament.pk %}" class="btn btn-success btn-lg mt-2">Đăng ký tham gia giải đấu</a>
      {% else %}
        <p class="text-muted mt-2">Giai đoạn đăng ký đã kết thúc.</p>
      {% endif %}
    </div>

    <div class="tab-pane fade card-pane" id="rules" role="tabpanel">
      {% if tournament.rules %}
        {{ tournament.rules|safe|linebreaks }}
      {% else %}
        <p class="text-muted">Chưa có điều lệ hay thông báo nào được cập nhật cho giải đấu này.</p>
      {% endif %}
    </div>

    <!-- Các đội -->
    <div class="tab-pane fade card-pane" id="teams" role="tabpanel">

      {% if unassigned_teams %}
        <h5 class="section-title mt-2">Đội chờ xếp bảng</h5>
        <p class="text-muted">Đây là danh sách các đội đã hoàn tất đăng ký và đang chờ ban tổ chức bốc thăm chia bảng.</p>
        <div class="row row-cols-1 row-cols-md-3 g-3 mb-4">
          {% for team in unassigned_teams %}
            <div class="col">
              <div class="card h-100 shadow-sm bg-light">
                <div class="card-body d-flex align-items-center">
                  <div class="flex-grow-1">
                    <h6 class="card-title mb-1">{{ team.name }}</h6>
                    <a href="{% url 'team_detail' pk=team.pk %}" class="btn btn-outline-secondary btn-sm">Xem đội</a>
                  </div>
                  {% if team.logo %}
                    <img src="{{ team.logo.url }}" alt="Logo {{ team.name }}" class="ms-auto" style="width: 56px; height: 56px; object-fit: contain; border-radius: .25rem;">
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
        <hr>
      {% endif %}
      {% for group in tournament.groups.all %}
        <h5 class="section-title mt-2">{{ group.name }}</h5>
        <div class="row row-cols-1 row-cols-md-3 g-3">
          {% for team in group.teams.all %}
            <div class="col">
              <div class="card h-100 shadow-sm">
                <div class="card-body">
                  <h6 class="card-title mb-1">{{ team.name }}</h6>
                  <a href="{% url 'team_detail' pk=team.pk %}?tab=teams#teams" class="btn btn-outline-primary btn-sm">Xem đội</a>
                </div>
              </div>
            </div>
          {% empty %}
            <div class="col"><p class="text-muted">Chưa có đội.</p></div>
          {% endfor %}
        </div>
      {% empty %}
        <p class="text-muted">Chưa có bảng đấu nào được tạo cho giải này.</p>
      {% endfor %}
    </div>

    <!-- Lịch thi đấu -->
    <div class="tab-pane fade card-pane" id="schedule" role="tabpanel">
      <div id="schedule-all">
        {% for g in tournament.groups.all %}
          <h5 class="section-title mt-3">{{ g.name }}</h5>
          <div class="row row-cols-1 g-2">
            {% for m in group_matches %}
              {% if m.team1.group_id == g.id %}
                <div class="col">
                  {% include 'tournaments/partials/match_card.html' with match=m %}
                </div>
              {% endif %}
            {% endfor %}
          </div>
        {% endfor %}

        {% if knockout_matches %}
          <h5 class="section-title mt-4">Vòng Loại trực tiếp</h5>
          <div class="row row-cols-1 g-2">
            {% for m in knockout_matches %}
              <div class="col">
                {% include 'tournaments/partials/match_card.html' with match=m %}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>

    <!-- BXH -->
    <div class="tab-pane fade card-pane" id="standings" role="tabpanel">
      {% include 'tournaments/partials/standings_table.html' %}
    </div>

    <!-- Thống kê -->
    <div class="tab-pane fade card-pane" id="stats" role="tabpanel">
      {% include 'tournaments/partials/tournament_stats.html' %}
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const tabs = document.querySelectorAll('#tournamentTab [data-bs-toggle="tab"]');

  function setUrl(target){
    const id = target.replace('#','');
    history.replaceState(null, '', `?tab=${id}${target}`);
  }

  tabs.forEach(el => {
    el.addEventListener('shown.bs.tab', e => setUrl(e.target.getAttribute('data-bs-target')));
  });

  const params = new URLSearchParams(location.search);
  const from = params.get('tab');
  const hash = location.hash;
  const target = from ? `#${from}` : (hash || '#overview');
  const trigger = document.querySelector(`#tournamentTab [data-bs-target="${target}"]`);
  if (trigger) new bootstrap.Tab(trigger).show();
  setUrl(target);
});
</script>

<script>
function printTab(contentId, title){
  const node = document.getElementById(contentId);
  if(!node) return;

  const iframe = document.createElement('iframe');
  iframe.style.position='fixed';
  iframe.style.right='0';
  iframe.style.bottom='0';
  iframe.style.width='0';
  iframe.style.height='0';
  iframe.style.border='0';
  document.body.appendChild(iframe);

  const w = iframe.contentWindow;
  const d = w.document;
  const styles = Array.from(document.querySelectorAll('link[rel="stylesheet"],style'))
                      .map(el => el.outerHTML).join('');

  d.open();
  d.write(`<!doctype html><html><head><meta charset="utf-8">
    <title>${title}</title>${styles}
    <style>@media print {.no-print{display:none!important}} body{padding:16px}</style>
  </head><body>
    <h3 style="margin-bottom:12px;">${title}</h3>
    ${node.innerHTML}
  </body></html>`);
  d.close();

  setTimeout(function(){
    w.focus();
    w.print();
    document.body.removeChild(iframe);
  }, 100);
}
</script>

{% endblock %}

{% comment %} Them vao cuoi file tournament_detail.html {% endcomment %}
