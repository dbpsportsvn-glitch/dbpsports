{% extends 'base.html' %}
{% load static %}

{% block title %}Live Control: {{ match.team1.name }} vs {{ match.team2.name }}{% endblock %}

{% block extra_css %}
<style>
    body { background-color: #f0f2f5; }
    .control-room-header {
        background: linear-gradient(rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.9)), url("{% static 'images/hero-1.jpg' %}");
        background-size: cover;
        background-position: center;
        color: white;
        padding: 1.5rem;
        border-radius: 0.75rem;
        margin-bottom: 1.5rem;
    }
    .team-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
    }
    .team-logo-lg {
        width: 60px;
        height: 60px;
        object-fit: contain;
    }
    .team-name-lg { font-size: 1.5rem; font-weight: 700; }
    .score-input {
        font-size: 4rem;
        text-align: center;
        font-weight: 800;
        width: 120px;
        border: none;
        background: rgba(0,0,0,0.3);
        color: white;
        border-radius: 0.5rem;
    }
    .control-grid {
        display: grid;
        grid-template-columns: 1.5fr 1fr 1fr;
        gap: 1.5rem;
        align-items: flex-start;
    }
    .control-card {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        height: 100%;
    }
    .control-card .card-header { font-weight: 600; background-color: #f8f9fa; }
    .player-list, .timeline {
        max-height: 65vh;
        overflow-y: auto;
    }
    .player-control-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .player-info { flex-grow: 1; }
    .player-actions { display: flex; gap: 0.5rem; }
    .jersey-number { font-weight: bold; color: #0d6efd; }
    .event-item { border-left: 3px solid #e9ecef; }
    .event-item.team1 { border-color: #0d6efd; }
    .event-item.team2 { border-color: #dc3545; }
    .list-sub-header {
        font-weight: bold;
        background-color: #e9ecef;
        padding: 0.5rem 1.25rem;
        font-size: 0.9rem;
    }

    @media (max-width: 991px) {
        .control-grid { grid-template-columns: 1fr; }
        .timeline-col { order: 3; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5><i class="bi bi-sliders"></i> Ph√≤ng ƒêi·ªÅu Khi·ªÉn</h5>
        <a href="{% url 'match_detail' pk=match.pk %}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-eye-fill"></i> Xem trang tr·∫≠n ƒë·∫•u</a>
    </div>

    <div class="control-room-header shadow">
        <form id="score-form" method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="update_score">
            <div class="row align-items-center justify-content-center">
                <div class="col-md-4">
                    <div class="team-header text-md-end">
                        {% if match.team1.logo %}<img src="{{ match.team1.logo.url }}" class="team-logo-lg">{% endif %}
                        <span class="team-name-lg">{{ match.team1.name }}</span>
                    </div>
                </div>
                <div class="col-md-4 d-flex justify-content-center align-items-center gap-2 my-3 my-md-0">
                    <input type="number" class="form-control score-input" name="team1_score" value="{{ match.team1_score|default:0 }}">
                    <span class="fs-1">-</span>
                    <input type="number" class="form-control score-input" name="team2_score" value="{{ match.team2_score|default:0 }}">
                </div>
                <div class="col-md-4">
                     <div class="team-header text-md-start">
                        {% if match.team2.logo %}<img src="{{ match.team2.logo.url }}" class="team-logo-lg">{% endif %}
                        <span class="team-name-lg">{{ match.team2.name }}</span>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div class="control-grid">
        <div class="control-card timeline-col">
            <div class="card-header text-center">Di·ªÖn bi·∫øn</div>
            <div class="card-body">
                <div class="timeline">
                    {% for event in events %}
                    <div class="event-item ps-3 mb-3 {% if event.team == match.team1 %}team1{% else %}team2{% endif %}">
                        <div class="d-flex justify-content-between">
                            <div class="fw-bold">
                                {% if event.is_own_goal %} ‚öΩ (OG) {{ event.player.full_name }}
                                {% elif event.card_type == 'YELLOW' %} üü® {{ event.player.full_name }}
                                {% elif event.card_type == 'RED' %} üü• {{ event.player.full_name }}
                                {% elif event.player_in %}
                                    üîÑ {{ event.player_in.full_name }} <small>thay</small> {{ event.player_out.full_name }}
                                {% else %} ‚öΩ {{ event.player.full_name }}
                                {% endif %}
                            </div>
                            <small class="text-muted">{{ event.minute|default:'-' }}'</small>
                        </div>
                        <div class="small">{{ event.team.name }}</div>
                    </div>
                    {% empty %}
                    <p class="text-muted text-center pt-3">Ch∆∞a c√≥ s·ª± ki·ªán n√†o.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="control-card">
            <div class="card-header text-center">{{ match.team1.name }}</div>
            <div class="player-list list-group list-group-flush">
                {% if lineup_is_set %}
                    <div class="list-sub-header">ƒê√° ch√≠nh</div>
                    {% for p in starters_team1 %}
                    <div class="list-group-item player-control-item" data-player-id="{{ p.pk }}" data-player-name="{{ p.full_name }}">
                        <div class="player-info"><span class="jersey-number">#{{ p.jersey_number }}</span> {{ p.full_name }}</div>
                        <div class="player-actions">
                            <button class="btn btn-sm btn-success" data-action="add_goal" title="Ghi b√†n">‚öΩ</button>
                            <button class="btn btn-sm btn-warning" data-action="add_card" title="Nh·∫≠n th·∫ª">üü®</button>
                            <button class="btn btn-sm btn-info" data-action="add_sub" title="Thay ng∆∞·ªùi">üîÑ</button>
                        </div>
                    </div>
                    {% endfor %}
                    <div class="list-sub-header">D·ª± b·ªã</div>
                    {% for p in substitutes_team1 %}
                    <div class="list-group-item player-control-item" data-player-id="{{ p.pk }}" data-player-name="{{ p.full_name }}">
                        <div class="player-info"><span class="jersey-number">#{{ p.jersey_number }}</span> {{ p.full_name }}</div>
                        <div class="player-actions">
                            <button class="btn btn-sm btn-success" data-action="add_goal" title="Ghi b√†n">‚öΩ</button>
                            <button class="btn btn-sm btn-warning" data-action="add_card" title="Nh·∫≠n th·∫ª">üü®</button>
                            <button class="btn btn-sm btn-info" data-action="add_sub" title="Thay ng∆∞·ªùi">üîÑ</button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="list-group-item text-muted small">Ch∆∞a ƒëƒÉng k√Ω ƒë·ªôi h√¨nh. Hi·ªÉn th·ªã t·∫•t c·∫£ c·∫ßu th·ªß.</div>
                    {% for p in players_team1 %}
                    <div class="list-group-item player-control-item" data-player-id="{{ p.pk }}" data-player-name="{{ p.full_name }}">
                        <div class="player-info"><span class="jersey-number">#{{ p.jersey_number }}</span> {{ p.full_name }}</div>
                        <div class="player-actions">
                            <button class="btn btn-sm btn-success" data-action="add_goal" title="Ghi b√†n">‚öΩ</button>
                            <button class="btn btn-sm btn-warning" data-action="add_card" title="Nh·∫≠n th·∫ª">üü®</button>
                            <button class="btn btn-sm btn-info" data-action="add_sub" title="Thay ng∆∞·ªùi">üîÑ</button>
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>

        <div class="control-card">
            <div class="card-header text-center">{{ match.team2.name }}</div>
            <div class="player-list list-group list-group-flush">
                {% if lineup_is_set %}
                    <div class="list-sub-header">ƒê√° ch√≠nh</div>
                    {% for p in starters_team2 %}
                    <div class="list-group-item player-control-item" data-player-id="{{ p.pk }}" data-player-name="{{ p.full_name }}">
                        <div class="player-info"><span class="jersey-number">#{{ p.jersey_number }}</span> {{ p.full_name }}</div>
                        <div class="player-actions">
                            <button class="btn btn-sm btn-success" data-action="add_goal" title="Ghi b√†n">‚öΩ</button>
                            <button class="btn btn-sm btn-warning" data-action="add_card" title="Nh·∫≠n th·∫ª">üü®</button>
                            <button class="btn btn-sm btn-info" data-action="add_sub" title="Thay ng∆∞·ªùi">üîÑ</button>
                        </div>
                    </div>
                    {% endfor %}
                    <div class="list-sub-header">D·ª± b·ªã</div>
                    {% for p in substitutes_team2 %}
                    <div class="list-group-item player-control-item" data-player-id="{{ p.pk }}" data-player-name="{{ p.full_name }}">
                        <div class="player-info"><span class="jersey-number">#{{ p.jersey_number }}</span> {{ p.full_name }}</div>
                        <div class="player-actions">
                            <button class="btn btn-sm btn-success" data-action="add_goal" title="Ghi b√†n">‚öΩ</button>
                            <button class="btn btn-sm btn-warning" data-action="add_card" title="Nh·∫≠n th·∫ª">üü®</button>
                            <button class="btn btn-sm btn-info" data-action="add_sub" title="Thay ng∆∞·ªùi">üîÑ</button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="list-group-item text-muted small">Ch∆∞a ƒëƒÉng k√Ω ƒë·ªôi h√¨nh. Hi·ªÉn th·ªã t·∫•t c·∫£ c·∫ßu th·ªß.</div>
                     {% for p in players_team2 %}
                    <div class="list-group-item player-control-item" data-player-id="{{ p.pk }}" data-player-name="{{ p.full_name }}">
                        <div class="player-info"><span class="jersey-number">#{{ p.jersey_number }}</span> {{ p.full_name }}</div>
                        <div class="player-actions">
                            <button class="btn btn-sm btn-success" data-action="add_goal" title="Ghi b√†n">‚öΩ</button>
                            <button class="btn btn-sm btn-warning" data-action="add_card" title="Nh·∫≠n th·∫ª">üü®</button>
                            <button class="btn btn-sm btn-info" data-action="add_sub" title="Thay ng∆∞·ªùi">üîÑ</button>
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="substitutionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Th·ª±c hi·ªán Thay ng∆∞·ªùi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>ƒê·ªôi: <strong id="subTeamName"></strong></p>
                <form method="post" id="sub-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="add_substitution">
                    <div class="mb-3">
                        <label class="form-label">C·∫ßu th·ªß ra s√¢n</label>
                        <select name="player_out" id="playerOutSelect" class="form-select" required></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">C·∫ßu th·ªß v√†o s√¢n</label>
                        <select name="player_in" id="playerInSelect" class="form-select" required></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ph√∫t di·ªÖn ra</label>
                        <input type="number" name="minute" class="form-control" placeholder="ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng x√°c ƒë·ªãnh">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="submit" form="sub-form" class="btn btn-primary">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalLabel">Th√™m s·ª± ki·ªán</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>C·∫ßu th·ªß: <strong id="playerName"></strong></p>
                <form method="post" id="event-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" id="eventAction">
                    <input type="hidden" name="player" id="eventPlayerId">
                    <div class="mb-3">
                        <label class="form-label">Ph√∫t di·ªÖn ra</label>
                        <input type="number" name="minute" class="form-control" placeholder="ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng x√°c ƒë·ªãnh">
                    </div>
                    <div id="goal-options">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_own_goal" id="is_own_goal_modal">
                            <label class="form-check-label" for="is_own_goal_modal">ƒê√¢y l√† b√†n ph·∫£n l∆∞·ªõi nh√†?</label>
                        </div>
                    </div>
                    <div id="card-options" style="display: none;">
                         <label class="form-label">Lo·∫°i th·∫ª</label>
                         <select name="card_type" class="form-select">
                            <option value="YELLOW">Th·∫ª V√†ng</option>
                            <option value="RED">Th·∫ª ƒê·ªè</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="submit" form="event-form" class="btn btn-primary">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // T·ª∞ ƒê·ªòNG L∆ØU T·ªà S·ªê
    let scoreUpdateTimeout;
    const scoreForm = document.getElementById('score-form');
    scoreForm.querySelectorAll('.score-input').forEach(input => {
        input.addEventListener('input', () => {
            clearTimeout(scoreUpdateTimeout);
            scoreUpdateTimeout = setTimeout(() => {
                const formData = new FormData(scoreForm);
                fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken') }
                });
            }, 2000);
        });
    });

    // KH·ªûI T·∫†O C√ÅC MODAL
    const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
    const substitutionModal = new bootstrap.Modal(document.getElementById('substitutionModal'));
    
    // L·∫§Y C√ÅC TH√ÄNH PH·∫¶N DOM C·ª¶A MODAL
    const playerNameEl = document.getElementById('playerName');
    const eventActionInput = document.getElementById('eventAction');
    const eventPlayerIdInput = document.getElementById('eventPlayerId');
    const goalOptions = document.getElementById('goal-options');
    const cardOptions = document.getElementById('card-options');
    const eventForm = document.getElementById('event-form');
    
    const subTeamNameEl = document.getElementById('subTeamName');
    const playerOutSelect = document.getElementById('playerOutSelect');
    const playerInSelect = document.getElementById('playerInSelect');

    // H√ÄM H·ªñ TR·ª¢ ƒê·ªÇ ƒêI·ªÄN C·∫¶U TH·ª¶ V√ÄO SELECT
    function populatePlayers(selectElement, players) {
        selectElement.innerHTML = '<option value="">-- Ch·ªçn c·∫ßu th·ªß --</option>';
        players.forEach(player => {
            const option = document.createElement('option');
            option.value = player.id;
            option.textContent = `#${player.jersey} - ${player.name}`;
            selectElement.appendChild(option);
        });
    }

    // H√ÄM X·ª¨ L√ù S·ª∞ KI·ªÜN CLICK CHUNG CHO T·∫§T C·∫¢ C√ÅC N√öT
    document.querySelectorAll('.player-actions button').forEach(button => {
        button.addEventListener('click', function() {
            const action = this.dataset.action;
            const playerItem = this.closest('.player-control-item');
            const playerId = playerItem.dataset.playerId;
            const playerName = playerItem.dataset.playerName;

            if (action === 'add_goal' || action === 'add_card') {
                playerNameEl.textContent = playerName;
                eventPlayerIdInput.value = playerId;
                eventActionInput.value = action;
                eventForm.reset();
                goalOptions.style.display = (action === 'add_goal') ? 'block' : 'none';
                cardOptions.style.display = (action === 'add_card') ? 'block' : 'none';
                eventModal.show();
            } else if (action === 'add_sub') {
                const teamCard = this.closest('.control-card');
                const teamName = teamCard.querySelector('.card-header').textContent;
                
                subTeamNameEl.textContent = teamName;
                
                const starters = [];
                const substitutes = [];

                // H√†m ki·ªÉm tra m·ªôt c·∫ßu th·ªß thu·ªôc nh√≥m n√†o (ƒë√° ch√≠nh/d·ª± b·ªã)
                const getPlayerGroup = (item) => {
                    let currentElement = item;
                    while (currentElement && currentElement.previousElementSibling) {
                        currentElement = currentElement.previousElementSibling;
                        if (currentElement.classList.contains('list-sub-header')) {
                            return currentElement.textContent;
                        }
                    }
                    return null;
                };

                teamCard.querySelectorAll('.list-group-item.player-control-item').forEach(item => {
                    const playerInfo = {
                         id: item.dataset.playerId,
                         name: item.dataset.playerName,
                         jersey: item.querySelector('.jersey-number').textContent.replace('#', '')
                    };
                    const groupName = getPlayerGroup(item);
                    if (groupName && groupName.includes('ƒê√° ch√≠nh')) {
                        starters.push(playerInfo);
                    } else if (groupName && groupName.includes('D·ª± b·ªã')) {
                        substitutes.push(playerInfo);
                    } else { // Fallback n·∫øu kh√¥ng c√≥ ƒë·ªôi h√¨nh ƒëƒÉng k√Ω
                        starters.push(playerInfo);
                    }
                });

                populatePlayers(playerOutSelect, starters);
                populatePlayers(playerInSelect, substitutes);
                
                // === LOGIC M·ªöI: T·ª∞ ƒê·ªòNG CH·ªåN C·∫¶U TH·ª¶ ===
                const clickedPlayerGroup = getPlayerGroup(playerItem);
                if (clickedPlayerGroup && clickedPlayerGroup.includes('ƒê√° ch√≠nh')) {
                    playerOutSelect.value = playerId;
                } else if (clickedPlayerGroup && clickedPlayerGroup.includes('D·ª± b·ªã')) {
                    playerInSelect.value = playerId;
                }
                
                substitutionModal.show();
            }
        });
    });
});
</script>
{% endblock %}