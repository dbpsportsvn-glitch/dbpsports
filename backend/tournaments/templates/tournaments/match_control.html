{% extends 'base.html' %}
{% load static %}

{% block title %}Live Control: {{ match.team1.name }} vs {{ match.team2.name }}{% endblock %}

{% block extra_css %}
<style>
    body { background-color: #f0f2f5; }
    .control-room-header {
        background: linear-gradient(rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.9)), url("{% static 'images/hero-1.jpg' %}");
        background-size: cover;
        background-position: center;
        color: white;
        padding: 1.5rem;
        border-radius: 0.75rem;
        margin-bottom: 1.5rem;
    }
    .team-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
    }
    .team-logo-lg {
        width: 60px;
        height: 60px;
        object-fit: contain;
    }
    .team-name-lg { font-size: 1.5rem; font-weight: 700; }
    .score-input {
        font-size: 4rem;
        text-align: center;
        font-weight: 800;
        width: 120px;
        border: none;
        background: rgba(0,0,0,0.3);
        color: white;
        border-radius: 0.5rem;
    }
    .control-grid {
        display: grid;
        grid-template-columns: 1.5fr 1fr 1fr;
        gap: 1.5rem;
        align-items: flex-start;
    }
    .control-card {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        height: 100%;
    }
    .control-card .card-header { font-weight: 600; background-color: #f8f9fa; }
    .player-list, .timeline {
        max-height: 65vh;
        overflow-y: auto;
    }
    .player-control-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: opacity 0.3s, background-color 0.3s;
    }
    .player-info { flex-grow: 1; }
    .player-actions { display: flex; gap: 0.5rem; }
    .jersey-number { font-weight: bold; color: #0d6efd; }
    .event-item { border-left: 3px solid #e9ecef; }
    .event-item.team1 { border-color: #0d6efd; }
    .event-item.team2 { border-color: #dc3545; }
    .list-sub-header {
        font-weight: bold;
        background-color: #e9ecef;
        padding: 0.5rem 1.25rem;
        font-size: 0.9rem;
    }
    .player-substituted-out {
        opacity: 0.5;
        background-color: #e9ecef;
    }
    .player-substituted-out .player-actions button {
        pointer-events: none;
        filter: grayscale(100%);
    }

    @media (max-width: 991px) {
        .control-grid { grid-template-columns: 1fr; }
        .timeline-col { order: 3; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5><i class="bi bi-sliders"></i> Ph√≤ng ƒêi·ªÅu Khi·ªÉn</h5>
        <a href="{% url 'match_detail' pk=match.pk %}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-eye-fill"></i> Xem trang tr·∫≠n ƒë·∫•u</a>
    </div>

    <div class="control-room-header shadow">
        <form id="score-form" method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="update_score">
            <div class="row align-items-center justify-content-center">
                <div class="col-md-4">
                    <div class="team-header text-md-end">
                        {% if match.team1.logo %}<img src="{{ match.team1.logo.url }}" class="team-logo-lg">{% endif %}
                        <span class="team-name-lg">{{ match.team1.name }}</span>
                    </div>
                </div>
                <div class="col-md-4 d-flex justify-content-center align-items-center gap-2 my-3 my-md-0">
                    <input type="number" class="form-control score-input" name="team1_score" value="{{ match.team1_score|default:0 }}">
                    <span class="fs-1">-</span>
                    <input type="number" class="form-control score-input" name="team2_score" value="{{ match.team2_score|default:0 }}">
                </div>
                <div class="col-md-4">
                     <div class="team-header text-md-start">
                        {% if match.team2.logo %}<img src="{{ match.team2.logo.url }}" class="team-logo-lg">{% endif %}
                        <span class="team-name-lg">{{ match.team2.name }}</span>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div id="timeline-controls" class="d-flex justify-content-center flex-wrap gap-2 mb-4">
        <button class="btn btn-primary" data-action="add_match_event" data-event-type="MATCH_START">
            <i class="bi bi-play-circle-fill"></i> B·∫Øt ƒë·∫ßu Tr·∫≠n ƒë·∫•u
        </button>
        <button class="btn btn-warning" data-action="add_match_event" data-event-type="HALF_TIME">
            <i class="bi bi-pause-circle-fill"></i> H·∫øt Hi·ªáp 1
        </button>
        <button class="btn btn-danger" data-action="add_match_event" data-event-type="MATCH_END">
            <i class="bi bi-stop-circle-fill"></i> K·∫øt th√∫c Tr·∫≠n ƒë·∫•u
        </button>
    </div>

    <div class="control-grid">
        <div class="control-card timeline-col">
            <div class="card-header text-center">Di·ªÖn bi·∫øn</div>
            <div class="card-body">
                <div id="timeline-list" class="timeline">
                    {% for event in events %}
                        {% if event.event_type %}
                            <div class="event-item ps-3 mb-3 text-center border-0">
                                <div class="text-muted small">{{ event.created_at|date:"H:i" }}</div>
                                <div class="fw-bold my-1">
                                    {% if event.event_type == 'MATCH_START' %}<i class="bi bi-play-fill"></i>
                                    {% elif event.event_type == 'HALF_TIME' %}<i class="bi bi-pause-fill"></i>
                                    {% elif event.event_type == 'MATCH_END' %}<i class="bi bi-stop-fill"></i>
                                    {% else %}<i class="bi bi-info-circle-fill"></i>
                                    {% endif %}
                                    {{ event.text }}
                                </div>
                                <hr class="w-50 mx-auto">
                            </div>
                        {% else %}
                            <div class="event-item ps-3 mb-3 {% if event.team == match.team1 %}team1{% else %}team2{% endif %}">
                                <div class="d-flex justify-content-between">
                                    <div class="fw-bold">
                                        {% if event.is_own_goal %} ‚öΩ (OG) {{ event.player.full_name }}
                                        {% elif event.card_type == 'YELLOW' %} üü® {{ event.player.full_name }}
                                        {% elif event.card_type == 'RED' %} üü• {{ event.player.full_name }}
                                        {% elif event.player_in %}
                                            üîÑ {{ event.player_in.full_name }} <small>thay</small> {{ event.player_out.full_name }}
                                        {% else %} ‚öΩ {{ event.player.full_name }}
                                        {% endif %}
                                    </div>
                                    <small class="text-muted">{{ event.minute|default:'-' }}'</small>
                                </div>
                                <div class="small">{{ event.team.name }}</div>
                            </div>
                        {% endif %}
                    {% empty %}
                    <p id="no-events-message" class="text-muted text-center pt-3">Ch∆∞a c√≥ s·ª± ki·ªán n√†o.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="control-card" data-team-card-id="{{ match.team1.id }}">
            <div class="card-header text-center">{{ match.team1.name }}</div>
            <div class="player-list list-group list-group-flush">
                {% if lineup_is_set %}
                    <div class="list-sub-header">ƒê√° ch√≠nh</div>
                    <div id="starters-list-team{{ match.team1.id }}">
                        {% for p in starters_team1 %}
                        <div class="list-group-item player-control-item {% if p.pk in substituted_out_player_ids %}player-substituted-out{% endif %}" data-player-id="{{ p.pk }}" data-player-name="{{ p.full_name }}">
                            <div class="player-info"><span class="jersey-number">#{{ p.jersey_number }}</span> {{ p.full_name }} {% if p.pk in substituted_out_player_ids %}<i class="bi bi-box-arrow-left text-danger" title="ƒê√£ ra s√¢n"></i>{% endif %}</div>
                            <div class="player-actions"><button class="btn btn-sm btn-success" data-action="add_goal" title="Ghi b√†n">‚öΩ</button><button class="btn btn-sm btn-warning" data-action="add_card" title="Nh·∫≠n th·∫ª">üü®</button><button class="btn btn-sm btn-info" data-action="add_sub" title="Thay ng∆∞·ªùi">üîÑ</button></div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="list-sub-header">D·ª± b·ªã</div>
                    <div id="substitutes-list-team{{ match.team1.id }}">
                        {% for p in substitutes_team1 %}
                        <div class="list-group-item player-control-item" data-player-id="{{ p.pk }}" data-player-name="{{ p.full_name }}">
                            <div class="player-info"><span class="jersey-number">#{{ p.jersey_number }}</span> {{ p.full_name }}</div>
                            <div class="player-actions"><button class="btn btn-sm btn-success" data-action="add_goal" title="Ghi b√†n">‚öΩ</button><button class="btn btn-sm btn-warning" data-action="add_card" title="Nh·∫≠n th·∫ª">üü®</button><button class="btn btn-sm btn-info" data-action="add_sub" title="Thay ng∆∞·ªùi">üîÑ</button></div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div id="starters-list-team{{ match.team1.id }}">
                        <div class="list-group-item text-muted small">Ch∆∞a ƒëƒÉng k√Ω ƒë·ªôi h√¨nh. Hi·ªÉn th·ªã t·∫•t c·∫£ c·∫ßu th·ªß.</div>
                        {% for p in players_team1 %}
                        <div class="list-group-item player-control-item {% if p.pk in substituted_out_player_ids %}player-substituted-out{% endif %}" data-player-id="{{ p.pk }}" data-player-name="{{ p.full_name }}">
                            <div class="player-info"><span class="jersey-number">#{{ p.jersey_number }}</span> {{ p.full_name }} {% if p.pk in substituted_out_player_ids %}<i class="bi bi-box-arrow-left text-danger" title="ƒê√£ ra s√¢n"></i>{% endif %}</div>
                            <div class="player-actions"><button class="btn btn-sm btn-success" data-action="add_goal" title="Ghi b√†n">‚öΩ</button><button class="btn btn-sm btn-warning" data-action="add_card" title="Nh·∫≠n th·∫ª">üü®</button><button class="btn btn-sm btn-info" data-action="add_sub" title="Thay ng∆∞·ªùi">üîÑ</button></div>
                        </div>
                        {% endfor %}
                    </div>
                    <div id="substitutes-list-team{{ match.team1.id }}"></div>
                {% endif %}
            </div>
        </div>

        <div class="control-card" data-team-card-id="{{ match.team2.id }}">
            <div class="card-header text-center">{{ match.team2.name }}</div>
            <div class="player-list list-group list-group-flush">
                {% if lineup_is_set %}
                    <div class="list-sub-header">ƒê√° ch√≠nh</div>
                    <div id="starters-list-team{{ match.team2.id }}">
                        {% for p in starters_team2 %}
                        <div class="list-group-item player-control-item {% if p.pk in substituted_out_player_ids %}player-substituted-out{% endif %}" data-player-id="{{ p.pk }}" data-player-name="{{ p.full_name }}">
                            <div class="player-info"><span class="jersey-number">#{{ p.jersey_number }}</span> {{ p.full_name }} {% if p.pk in substituted_out_player_ids %}<i class="bi bi-box-arrow-left text-danger" title="ƒê√£ ra s√¢n"></i>{% endif %}</div>
                            <div class="player-actions"><button class="btn btn-sm btn-success" data-action="add_goal" title="Ghi b√†n">‚öΩ</button><button class="btn btn-sm btn-warning" data-action="add_card" title="Nh·∫≠n th·∫ª">üü®</button><button class="btn btn-sm btn-info" data-action="add_sub" title="Thay ng∆∞·ªùi">üîÑ</button></div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="list-sub-header">D·ª± b·ªã</div>
                    <div id="substitutes-list-team{{ match.team2.id }}">
                        {% for p in substitutes_team2 %}
                        <div class="list-group-item player-control-item" data-player-id="{{ p.pk }}" data-player-name="{{ p.full_name }}">
                            <div class="player-info"><span class="jersey-number">#{{ p.jersey_number }}</span> {{ p.full_name }}</div>
                            <div class="player-actions"><button class="btn btn-sm btn-success" data-action="add_goal" title="Ghi b√†n">‚öΩ</button><button class="btn btn-sm btn-warning" data-action="add_card" title="Nh·∫≠n th·∫ª">üü®</button><button class="btn btn-sm btn-info" data-action="add_sub" title="Thay ng∆∞·ªùi">üîÑ</button></div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div id="starters-list-team{{ match.team2.id }}">
                        <div class="list-group-item text-muted small">Ch∆∞a ƒëƒÉng k√Ω ƒë·ªôi h√¨nh. Hi·ªÉn th·ªã t·∫•t c·∫£ c·∫ßu th·ªß.</div>
                        {% for p in players_team2 %}
                        <div class="list-group-item player-control-item {% if p.pk in substituted_out_player_ids %}player-substituted-out{% endif %}" data-player-id="{{ p.pk }}" data-player-name="{{ p.full_name }}">
                            <div class="player-info"><span class="jersey-number">#{{ p.jersey_number }}</span> {{ p.full_name }} {% if p.pk in substituted_out_player_ids %}<i class="bi bi-box-arrow-left text-danger" title="ƒê√£ ra s√¢n"></i>{% endif %}</div>
                            <div class="player-actions"><button class="btn btn-sm btn-success" data-action="add_goal" title="Ghi b√†n">‚öΩ</button><button class="btn btn-sm btn-warning" data-action="add_card" title="Nh·∫≠n th·∫ª">üü®</button><button class="btn btn-sm btn-info" data-action="add_sub" title="Thay ng∆∞·ªùi">üîÑ</button></div>
                        </div>
                        {% endfor %}
                    </div>
                     <div id="substitutes-list-team{{ match.team2.id }}"></div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="substitutionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Th·ª±c hi·ªán Thay ng∆∞·ªùi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>ƒê·ªôi: <strong id="subTeamName"></strong></p>
                <form method="post" id="sub-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="add_substitution">
                    <input type="hidden" id="subTeamId" name="team_id">
                    <div class="mb-3">
                        <label class="form-label">C·∫ßu th·ªß ra s√¢n</label>
                        <select name="player_out" id="playerOutSelect" class="form-select" required></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">C·∫ßu th·ªß v√†o s√¢n</label>
                        <select name="player_in" id="playerInSelect" class="form-select" required></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ph√∫t di·ªÖn ra</label>
                        <input type="number" name="minute" class="form-control" placeholder="ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng x√°c ƒë·ªãnh">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="submit" form="sub-form" class="btn btn-primary">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalLabel">Th√™m s·ª± ki·ªán</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>C·∫ßu th·ªß: <strong id="playerName"></strong></p>
                <form method="post" id="event-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" id="eventAction">
                    <input type="hidden" name="player" id="eventPlayerId">
                    <div class="mb-3">
                        <label class="form-label">Ph√∫t di·ªÖn ra</label>
                        <input type="number" name="minute" class="form-control" placeholder="ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng x√°c ƒë·ªãnh">
                    </div>
                    <div id="goal-options">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_own_goal" id="is_own_goal_modal">
                            <label class="form-check-label" for="is_own_goal_modal">ƒê√¢y l√† b√†n ph·∫£n l∆∞·ªõi nh√†?</label>
                        </div>
                    </div>
                    <div id="card-options" style="display: none;">
                         <label class="form-label">Lo·∫°i th·∫ª</label>
                         <select name="card_type" class="form-select">
                            <option value="YELLOW">Th·∫ª V√†ng</option>
                            <option value="RED">Th·∫ª ƒê·ªè</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="submit" form="event-form" class="btn btn-primary">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // T·ª∞ ƒê·ªòNG L∆ØU T·ªà S·ªê
    const scoreForm = document.getElementById('score-form');
    let scoreUpdateTimeout;
    scoreForm.querySelectorAll('.score-input').forEach(input => {
        input.addEventListener('input', () => {
            clearTimeout(scoreUpdateTimeout);
            scoreUpdateTimeout = setTimeout(() => {
                const formData = new FormData(scoreForm);
                fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken') }
                });
            }, 2000);
        });
    });

    // KH·ªûI T·∫†O C√ÅC MODAL
    const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
    const substitutionModal = new bootstrap.Modal(document.getElementById('substitutionModal'));
    
    // L·∫§Y C√ÅC TH√ÄNH PH·∫¶N DOM C·ª¶A MODAL
    const playerNameEl = document.getElementById('playerName');
    const eventActionInput = document.getElementById('eventAction');
    const eventPlayerIdInput = document.getElementById('eventPlayerId');
    const goalOptions = document.getElementById('goal-options');
    const cardOptions = document.getElementById('card-options');
    const eventForm = document.getElementById('event-form');
    
    const subTeamNameEl = document.getElementById('subTeamName');
    const playerOutSelect = document.getElementById('playerOutSelect');
    const playerInSelect = document.getElementById('playerInSelect');
    const subForm = document.getElementById('sub-form');
    const subTeamIdInput = document.getElementById('subTeamId');

    // H√ÄM H·ªñ TR·ª¢ ƒê·ªÇ ƒêI·ªÄN C·∫¶U TH·ª¶ V√ÄO SELECT
    function populatePlayers(selectElement, players) {
        selectElement.innerHTML = '<option value="">-- Ch·ªçn c·∫ßu th·ªß --</option>';
        players.forEach(player => {
            const option = document.createElement('option');
            option.value = player.id;
            option.textContent = `#${player.jersey} - ${player.name}`;
            selectElement.appendChild(option);
        });
    }
    
    // === B·∫ÆT ƒê·∫¶U PHI√äN B·∫¢N HO√ÄN CH·ªàNH C·ª¶A LOGIC X·ª¨ L√ù FORM ===

    // H√†m chung ƒë·ªÉ g·ª≠i form AJAX v√† x·ª≠ l√Ω k·∫øt qu·∫£
    function handleFormSubmit(form, modalToHide) {
        const formData = new FormData(form);
        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken') }
        })
        .then(response => {
            if (response.ok) return response.json();
            return response.json().then(err => { throw new Error(err.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ server'); });
        })
        .then(data => {
            if (data.status === 'success') {
                if (modalToHide) modalToHide.hide();
                updateTimeline(data.event); // C·∫≠p nh·∫≠t timeline v·ªõi d·ªØ li·ªáu m·ªõi
                
                // X·ª≠ l√Ω ri√™ng cho vi·ªác ho√°n ƒë·ªïi c·∫ßu th·ªß
                if (data.event.type === 'substitution') {
                    const teamId = document.getElementById('subTeamId').value;
                    const playerOutId = formData.get('player_out');
                    const playerInId = formData.get('player_in');
                    swapPlayerElements(teamId, playerOutId, playerInId);
                }
            } else {
                alert('L·ªói: ' + data.message);
            }
        })
        .catch(error => {
            console.error('L·ªói khi g·ª≠i form:', error);
            alert('ƒê√£ c√≥ l·ªói x·∫£y ra: ' + error.message);
        });
    }

    // H√†m c·∫≠p nh·∫≠t d√≤ng th·ªùi gian
    function updateTimeline(eventData) {
        const timelineList = document.getElementById('timeline-list');
        const noEventsMessage = document.getElementById('no-events-message');
        if (noEventsMessage) noEventsMessage.style.display = 'none';

        let newEventHtml = '';
        if (eventData.type === 'match_event') {
            let icon = 'bi-info-circle-fill';
            if (eventData.event_type === 'MATCH_START') icon = 'bi-play-fill';
            if (eventData.event_type === 'HALF_TIME') icon = 'bi-pause-fill';
            if (eventData.event_type === 'MATCH_END') icon = 'bi-stop-fill';
            newEventHtml = `<div class="event-item ps-3 mb-3 text-center border-0"><div class="text-muted small">${eventData.created_at}</div><div class="fw-bold my-1"><i class="bi ${icon}"></i> ${eventData.text}</div><hr class="w-50 mx-auto"></div>`;
        } else {
            let eventIcon = '';
            let eventText = '';
            if (eventData.type === 'goal') {
                eventIcon = eventData.is_own_goal ? '‚öΩ (OG)' : '‚öΩ';
                eventText = `${eventData.player_name}`;
            } else if (eventData.type === 'card') {
                eventIcon = eventData.card_type === 'YELLOW' ? 'üü®' : 'üü•';
                eventText = `${eventData.player_name}`;
            } else if (eventData.type === 'substitution') {
                eventIcon = 'üîÑ';
                eventText = `${eventData.player_in_name} <small>thay</small> ${eventData.player_out_name}`;
            }
            
            newEventHtml = `<div class="event-item ps-3 mb-3 ${eventData.team_class}"><div class="d-flex justify-content-between"><div class="fw-bold">${eventIcon} ${eventText}</div><small class="text-muted">${eventData.minute}'</small></div><div class="small">${eventData.team_name}</div></div>`;
        }
        timelineList.insertAdjacentHTML('afterbegin', newEventHtml);
    }
    
    // H√†m ho√°n ƒë·ªïi v·ªã tr√≠ c·∫ßu th·ªß
    function swapPlayerElements(teamId, playerOutId, playerInId) {
        const playerOutEl = document.querySelector(`.player-control-item[data-player-id='${playerOutId}']`);
        const playerInEl = document.querySelector(`.player-control-item[data-player-id='${playerInId}']`);
        const startersList = document.getElementById(`starters-list-team${teamId}`);
        const substitutesList = document.getElementById(`substitutes-list-team${teamId}`);
        if (playerOutEl && playerInEl && startersList && substitutesList) {
            substitutesList.appendChild(playerOutEl);
            startersList.appendChild(playerInEl);
            playerOutEl.classList.add('player-substituted-out');
            const playerInfo = playerOutEl.querySelector('.player-info');
            if (!playerInfo.querySelector('.bi-box-arrow-left')) {
                playerInfo.insertAdjacentHTML('beforeend', ' <i class="bi bi-box-arrow-left text-danger" title="ƒê√£ ra s√¢n"></i>');
            }
        }
    }

    // G·∫Øn s·ª± ki·ªán submit cho c√°c form
    eventForm.addEventListener('submit', function(e) {
        e.preventDefault();
        handleFormSubmit(this, eventModal);
    });
    subForm.addEventListener('submit', function(e) {
        e.preventDefault();
        handleFormSubmit(this, substitutionModal);
    });

    // G·∫Øn s·ª± ki·ªán click cho c√°c n√∫t h√†nh ƒë·ªông c·ªßa c·∫ßu th·ªß
    document.querySelectorAll('.player-actions button').forEach(button => {
        button.addEventListener('click', function() {
            const action = this.dataset.action;
            const playerItem = this.closest('.player-control-item');
            
            if (action === 'add_goal' || action === 'add_card') {
                const playerId = playerItem.dataset.playerId;
                const playerName = playerItem.dataset.playerName;
                playerNameEl.textContent = playerName;
                eventPlayerIdInput.value = playerId;
                eventActionInput.value = action;
                eventForm.reset();
                goalOptions.style.display = (action === 'add_goal') ? 'block' : 'none';
                cardOptions.style.display = (action === 'add_card') ? 'block' : 'none';
                eventModal.show();
            } else if (action === 'add_sub') {
                const teamCard = this.closest('.control-card');
                const teamId = teamCard.dataset.teamCardId;
                const teamName = teamCard.querySelector('.card-header').textContent;
                
                subTeamNameEl.textContent = teamName;
                subTeamIdInput.value = teamId;

                const startersList = document.getElementById(`starters-list-team${teamId}`);
                const substitutesList = document.getElementById(`substitutes-list-team${teamId}`);

                const starters = Array.from(startersList.querySelectorAll('.player-control-item:not(.player-substituted-out)')).map(item => ({
                    id: item.dataset.playerId, name: item.dataset.playerName, jersey: item.querySelector('.jersey-number').textContent.replace('#', '')
                }));

                const substitutes = Array.from(substitutesList.querySelectorAll('.player-control-item:not(.player-substituted-out)')).map(item => ({
                    id: item.dataset.playerId, name: item.dataset.playerName, jersey: item.querySelector('.jersey-number').textContent.replace('#', '')
                }));

                populatePlayers(playerOutSelect, starters);
                populatePlayers(playerInSelect, substitutes);
                
                if (!playerItem.classList.contains('player-substituted-out')) {
                    const playerId = playerItem.dataset.playerId;
                    if (starters.some(p => p.id === playerId)) {
                        playerOutSelect.value = playerId;
                    } else if (substitutes.some(p => p.id === playerId)) {
                        playerInSelect.value = playerId;
                    }
                }
                substitutionModal.show();
            }
        });
    });

    // G·∫Øn s·ª± ki·ªán click cho c√°c n√∫t ƒëi·ªÅu khi·ªÉn timeline
    const timelineControls = document.getElementById('timeline-controls');
    timelineControls.addEventListener('click', function(e) {
        const button = e.target.closest('button[data-action="add_match_event"]');
        if (!button) return;

        button.disabled = true; // V√¥ hi·ªáu h√≥a t·∫°m th·ªùi
        const eventType = button.dataset.eventType;
        const score1 = document.querySelector('input[name="team1_score"]').value;
        const score2 = document.querySelector('input[name="team2_score"]').value;

        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        formData.append('action', 'add_match_event');
        formData.append('event_type', eventType);
        formData.append('current_score', `${score1} - ${score2}`);

        fetch(window.location.href, {
            method: 'POST',
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                updateTimeline(data.event);
            } else {
                alert('L·ªói: ' + data.message);
                button.disabled = false; // B·∫≠t l·∫°i n√∫t n·∫øu c√≥ l·ªói
            }
        }).catch(err => {
            console.error(err);
            button.disabled = false; // B·∫≠t l·∫°i n√∫t n·∫øu c√≥ l·ªói
        });
    });
});
</script>
{% endblock %}