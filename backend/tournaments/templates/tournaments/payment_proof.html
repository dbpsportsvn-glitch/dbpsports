{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Thanh to√°n l·ªá ph√≠ - {{ team.name }}{% endblock %}

{% block content %}
<style>
/* Payment Page Styles */
.hero-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

/* Payment page specific styles - c·ªë ƒë·ªãnh header v√† lo·∫°i b·ªè kho·∫£ng c√°ch */
/* C·ªë ƒë·ªãnh header v·ªõi fixed positioning ƒë·ªÉ tr√°nh threshold */
.site-header {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    z-index: 1020 !important;
    margin: 0 !important;
    padding: 0 !important;
    transition: all 0.2s ease !important;
    will-change: transform !important;
}

/* T·ªëi ∆∞u navbar cho smooth scrolling */
.site-header .navbar {
    min-height: 70px;
    transition: all 0.2s ease !important;
    will-change: transform !important;
}

/* T·ªëi ∆∞u backdrop-filter ƒë·ªÉ gi·∫£m lag */
.site-header .navbar {
    backdrop-filter: blur(10px) !important; /* Gi·∫£m t·ª´ 20px xu·ªëng 10px */
    -webkit-backdrop-filter: blur(10px) !important;
}

/* ƒê·∫£m b·∫£o sticky summary kh√¥ng ƒë√® l√™n header */
.payment-summary-sticky {
    top: calc(70px + 10px) !important; /* header height + margin */
    z-index: 1010 !important;
    transition: all 0.2s ease !important;
    will-change: transform !important;
}

/* Smooth scrolling cho to√†n b·ªô trang */
html {
    scroll-behavior: smooth !important;
}

body {
    scroll-behavior: smooth !important;
}

/* T·ªëi ∆∞u hi·ªáu nƒÉng cho sticky elements */
.sticky-top,
.payment-summary-sticky,
.site-header {
    transform: translateZ(0) !important; /* Force hardware acceleration */
    backface-visibility: hidden !important;
    perspective: 1000px !important;
}

/* Gi·∫£m lag khi scroll */
* {
    scroll-behavior: smooth;
}

/* T·ªëi ∆∞u cho mobile */
@media (max-width: 768px) {
    .site-header .navbar {
        backdrop-filter: blur(5px) !important; /* Gi·∫£m th√™m cho mobile */
        -webkit-backdrop-filter: blur(5px) !important;
    }
}

/* Lo·∫°i b·ªè ho√†n to√†n kho·∫£ng c√°ch t·ª´ body v√† container */
body {
    margin: 0 !important;
    padding: 0 !important;
    padding-top: 70px !important; /* B√π kho·∫£ng tr·ªëng cho fixed header */
}

.container-fluid {
    margin-top: 0 !important;
    padding-top: 0 !important;
}

/* Override base template margin */
.content-wrapper {
    margin-top: 0 !important;
    padding-top: 0 !important;
}

/* ƒê·∫£m b·∫£o kh√¥ng c√≥ kho·∫£ng c√°ch t·ª´ container ch√≠nh */
.container {
    margin-top: 0 !important;
    padding-top: 0 !important;
}

/* Responsive - ƒëi·ªÅu ch·ªânh padding cho mobile */
@media (max-width: 768px) {
    body {
        padding-top: 65px !important; /* Gi·∫£m padding cho mobile */
    }
    
    .site-header .navbar {
        min-height: 65px;
    }
    
    .payment-summary-sticky {
        top: calc(65px + 10px) !important;
    }
    
    .container-fluid {
        padding-top: 0 !important;
    }
}

@media (max-width: 576px) {
    body {
        padding-top: 60px !important; /* Gi·∫£m th√™m cho mobile nh·ªè */
    }
    
    .site-header .navbar {
        min-height: 60px;
    }
    
    .payment-summary-sticky {
        top: calc(60px + 10px) !important;
    }
    
    .container-fluid {
        padding-top: 0 !important;
    }
}

.form-check-input:checked {
    background-color: #667eea;
    border-color: #667eea;
}

.form-check-input:focus {
    box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
}

/* Smooth transitions */
.shop-cart-section, .discount-info {
    transition: all 0.3s ease;
}

/* Loading state */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

/* Checkbox animation */
.form-check-input {
    transition: transform 0.15s ease;
}

/* Toast animation */
.alert {
    animation: slideInRight 0.3s ease;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
</style>

<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="hero-section bg-gradient-primary text-white rounded-3 p-4 mb-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="display-6 fw-bold mb-3">
                            <i class="bi bi-credit-card-2-front me-3"></i>Thanh to√°n l·ªá ph√≠ gi·∫£i ƒë·∫•u
                        </h1>
                        <p class="lead mb-0">
                            ƒê·ªôi <strong>{{ team.name }}</strong> - Gi·∫£i ƒë·∫•u <strong>{{ registration.tournament.name }}</strong>
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="stats-box bg-white bg-opacity-10 rounded p-3">
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="h4 mb-1">{{ cart.items.count }}</div>
                                    <small>S·∫£n ph·∫©m</small>
                                </div>
                                <div class="col-6">
                                    <div class="h4 mb-1">{{ cart_total|floatformat:0 }}</div>
                                    <small>VNƒê</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Left Column: Payment Steps -->
        <div class="col-lg-8">
            <!-- Step 1: Shop Integration -->
            {% if registration.tournament.shop_discount_percentage > 0 %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-shop me-2"></i>B∆∞·ªõc 1: T√≠ch h·ª£p Shop (T√πy ch·ªçn)
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>∆Øu ƒë√£i ƒë·∫∑c bi·ªát:</strong> ƒê·∫∑t h√†ng t·ª´ shop ƒë·ªÉ ƒë∆∞·ª£c tr·ª´ 
                        <span class="badge bg-success fs-6">{{ registration.tournament.shop_discount_percentage }}%</span> 
                        ti·ªÅn l√£i v√†o l·ªá ph√≠ ƒëƒÉng k√Ω gi·∫£i ƒë·∫•u.
                        <br><small class="text-muted">
                            <i class="bi bi-lightbulb me-1"></i>
                            Shop s·∫Ω m·ªü trong tab m·ªõi ƒë·ªÉ b·∫°n kh√¥ng m·∫•t form thanh to√°n n√†y.
                        </small>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="use_shop_discount_checkbox" name="use_shop_discount_checkbox">
                        <label class="form-check-label fw-bold" for="use_shop_discount_checkbox">
                            <i class="bi bi-cart-plus me-2"></i>T√¥i mu·ªën ƒë·∫∑t h√†ng t·ª´ shop ƒë·ªÉ ƒë∆∞·ª£c tr·ª´ ti·ªÅn l√£i
                        </label>
                    </div>
                    
                    <div id="shop-cart-section" class="shop-cart-section" style="display: none;">
                        
                        {% if cart.items.exists %}
                        <div class="cart-summary mb-3 p-3 border rounded bg-light">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0"><i class="bi bi-cart-check me-2"></i>Gi·ªè h√†ng c·ªßa b·∫°n</h6>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="location.reload()" title="L√†m m·ªõi gi·ªè h√†ng">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                    <a href="{% url 'shop:home' %}" target="_blank" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-plus-circle me-1"></i>Th√™m s·∫£n ph·∫©m
                                    </a>
                                </div>
                            </div>
                            <div class="cart-items">
                                {% for item in cart.items.all %}
                                <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white rounded">
                                    <div>
                                        <small class="fw-bold">{{ item.product.name }}</small>
                                        {% if item.size %}<br><small class="text-muted">Size: {{ item.size.name }}</small>{% endif %}
                                        <br><small class="text-info">L√£i: {{ item.product.profit_amount|floatformat:0 }} VNƒê</small>
                                        <br><small class="text-warning">Gi√° v·ªën: {{ item.product.cost_price|floatformat:0|default:"Ch∆∞a c√≥" }} VNƒê</small>
                                    </div>
                                    <div class="text-end">
                                        <small>{{ item.quantity }}x {{ item.product.current_price|floatformat:0 }} VNƒê</small>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between">
                                <strong>T·ªïng gi·ªè h√†ng:</strong>
                                <strong class="text-primary">{{ cart_total|floatformat:0 }} VNƒê</strong>
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-warning">
                            <i class="bi bi-cart-x me-2"></i>
                            Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng. 
                            <a href="{% url 'shop:home' %}" target="_blank" class="btn btn-sm btn-warning ms-2">
                                <i class="bi bi-shop me-1"></i>V√†o shop ch·ªçn ƒë·ªì
                            </a>
                            <br><small class="text-muted mt-2 d-block">
                                <i class="bi bi-info-circle me-1"></i>
                                Sau khi th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng, quay l·∫°i tab n√†y v√† click n√∫t "L√†m m·ªõi" ƒë·ªÉ c·∫≠p nh·∫≠t.
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Step 2: Payment Information -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-bank me-2"></i>B∆∞·ªõc 2: Th√¥ng tin chuy·ªÉn kho·∫£n
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="payment-info-card p-3 border rounded bg-light">
                                <h6><i class="bi bi-building me-2"></i>Th√¥ng tin ng√¢n h√†ng</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Ng√¢n h√†ng:</strong> {{ registration.tournament.bank_name|default:"Ch∆∞a c·∫≠p nh·∫≠t" }}</li>
                                    <li><strong>S·ªë t√†i kho·∫£n:</strong> {{ registration.tournament.bank_account_number|default:"Ch∆∞a c·∫≠p nh·∫≠t" }}</li>
                                    <li><strong>Ch·ªß t√†i kho·∫£n:</strong> {{ registration.tournament.bank_account_name|default:"Ch∆∞a c·∫≠p nh·∫≠t" }}</li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="payment-info-card p-3 border rounded bg-light">
                                <h6><i class="bi bi-chat-text me-2"></i>N·ªôi dung chuy·ªÉn kho·∫£n</h6>
                                <div class="bg-white p-2 rounded border">
                                    <code>{{ team.name }} Nop Le Phi Giai {{ registration.tournament.name }}</code>
                                </div>
                                <small class="text-muted">Sao ch√©p n·ªôi dung n√†y khi chuy·ªÉn kho·∫£n</small>
                            </div>
                        </div>
                    </div>
                    
                    {% if registration.tournament.payment_qr_code %}
                    <div class="text-center mt-3">
                        <img src="{{ registration.tournament.payment_qr_code.url }}" alt="M√£ QR thanh to√°n" class="img-fluid" style="max-width: 200px;">
                        <p class="text-muted small mt-2">Qu√©t m√£ QR ƒë·ªÉ chuy·ªÉn kho·∫£n nhanh</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Step 3: Upload Proof -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="bi bi-upload me-2"></i>B∆∞·ªõc 3: T·∫£i l√™n b·∫±ng ch·ª©ng thanh to√°n
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        {{ form|crispy }}
                        <!-- Hidden field ƒë·ªÉ JavaScript c√≥ th·ªÉ tham chi·∫øu -->
                        <input type="hidden" id="id_use_shop_discount" name="use_shop_discount" value="">
                        <div class="d-grid gap-2 mt-3">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="bi bi-check-circle me-2"></i>G·ª≠i x√°c nh·∫≠n thanh to√°n
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Column: Payment Summary -->
        <div class="col-lg-4">
            <div class="card shadow-sm sticky-top payment-summary-sticky">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-calculator me-2"></i>T√≥m t·∫Øt thanh to√°n
                    </h5>
                </div>
                <div class="card-body">
                    <div class="payment-breakdown">
                        <div class="d-flex justify-content-between mb-2">
                            <span>L·ªá ph√≠ ƒëƒÉng k√Ω:</span>
                            <span>{{ registration.tournament.registration_fee|floatformat:0 }} VNƒê</span>
                        </div>
                        
                        <div id="discount-info" class="discount-info d-flex justify-content-between mb-2 text-success" style="display: none;">
                            <span><i class="bi bi-tag me-1"></i>Tr·ª´ ti·ªÅn l√£i t·ª´ shop:</span>
                            <span>-<span id="discount-amount">{{ discount_amount|floatformat:0 }}</span> VNƒê</span>
                        </div>
                        
                        <hr>
                        
                        <div class="d-flex justify-content-between fw-bold fs-5">
                            <span>T·ªïng c·∫ßn thanh to√°n:</span>
                            <span class="text-primary" id="final-amount">{{ registration.tournament.registration_fee|floatformat:0 }} VNƒê</span>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            <small>Sau khi g·ª≠i, tr·∫°ng th√°i thanh to√°n s·∫Ω chuy·ªÉn th√†nh "Ch·ªù x√°c nh·∫≠n".</small>
                        </div>
                        {% if registration.tournament.shop_discount_percentage > 0 %}
                        <div class="alert alert-success">
                            <i class="bi bi-shop me-2"></i>
                            <small>
                                <strong>M·∫πo:</strong> ƒê·∫∑t h√†ng t·ª´ shop ƒë·ªÉ ƒë∆∞·ª£c gi·∫£m gi√°! 
                                Shop s·∫Ω m·ªü trong tab m·ªõi ƒë·ªÉ b·∫°n kh√¥ng m·∫•t form n√†y.
                            </small>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="d-grid gap-2">
                        <a href="{% url 'team_detail' pk=team.pk %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-2"></i>Quay l·∫°i ƒë·ªôi b√≥ng
                        </a>
                        {% if registration.tournament.shop_discount_percentage > 0 %}
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-secondary" onclick="location.reload()" title="L√†m m·ªõi gi·ªè h√†ng">
                                <i class="bi bi-arrow-clockwise me-2"></i>L√†m m·ªõi
                            </button>
                            <a href="{% url 'shop:home' %}" target="_blank" class="btn btn-outline-primary">
                                <i class="bi bi-shop me-2"></i>V√†o shop ch·ªçn ƒë·ªì
                            </a>
                        </div>
                        {% endif %}
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
    
    <script>
    // Shop Discount Toggle - Simple & Clean Implementation
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üè™ Shop Discount Toggle initialized');
        
        // Elements
        const checkbox = document.getElementById('use_shop_discount_checkbox');
        const hiddenField = document.getElementById('id_use_shop_discount');
        const shopSection = document.getElementById('shop-cart-section');
        const discountInfo = document.getElementById('discount-info');
        const discountAmount = document.getElementById('discount-amount');
        const finalAmount = document.getElementById('final-amount');
        
        // Data
        const originalFee = parseFloat('{{ registration.tournament.registration_fee|default:0 }}') || 0;
        const currentDiscountAmount = parseFloat('{{ discount_amount|default:0 }}') || 0;
        const currentFinalFee = parseFloat('{{ final_fee|default:0 }}') || 0;
        
        console.log('üìä Data values:');
        console.log('Original fee:', originalFee);
        console.log('Discount amount:', currentDiscountAmount);
        console.log('Final fee:', currentFinalFee);
        console.log('Shop discount percentage:', parseFloat('{{ registration.tournament.shop_discount_percentage|default:0 }}') || 0);
        console.log('Cart total:', parseFloat('{{ cart_total|default:0 }}') || 0);
        
        // Storage key
        const storageKey = 'shop_discount_{{ registration.pk|default:0 }}';
        
        // Debug all elements
        console.log('üîç Debugging elements:');
        console.log('Checkbox:', checkbox);
        console.log('Hidden field:', hiddenField);
        console.log('Shop section:', shopSection);
        console.log('Discount info:', discountInfo);
        console.log('Discount amount:', discountAmount);
        console.log('Final amount:', finalAmount);
        
        // Check if elements exist
        if (!checkbox) {
            console.error('‚ùå Checkbox not found');
            console.log('Available checkboxes:', document.querySelectorAll('input[type="checkbox"]'));
            return;
        }
        
        if (!hiddenField) {
            console.error('‚ùå Hidden field not found');
            console.log('Available hidden fields:', document.querySelectorAll('input[type="hidden"]'));
            return;
        }
        
        console.log('‚úÖ All elements found');
        
        // Update display based on checkbox state
        function updateDisplay() {
            const isChecked = checkbox.checked;
            
            console.log(`üîÑ Updating display: ${isChecked ? 'ON' : 'OFF'}`);
            console.log('üîç Checkbox state in updateDisplay:', checkbox.checked);
            
            // Update hidden field
            hiddenField.value = isChecked ? 'on' : '';
            
            // Update UI
            if (isChecked) {
                // Check if cart has items
                if ((parseFloat('{{ cart_total|default:0 }}') || 0) > 0 && currentDiscountAmount > 0) {
                    // Show discount
                    if (shopSection) shopSection.style.display = 'block';
                    if (discountInfo) discountInfo.style.display = 'block';
                    if (discountAmount) discountAmount.textContent = currentDiscountAmount.toLocaleString();
                    if (finalAmount) finalAmount.textContent = currentFinalFee.toLocaleString();
                } else {
                    // Cart is empty, show warning
                    if (shopSection) shopSection.style.display = 'block';
                    if (discountInfo) discountInfo.style.display = 'none';
                    if (discountAmount) discountAmount.textContent = '0';
                    if (finalAmount) finalAmount.textContent = originalFee.toLocaleString();
                    
                    // Show warning message
                    showToast('Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng. Vui l√≤ng th√™m s·∫£n ph·∫©m ƒë·ªÉ ƒë∆∞·ª£c gi·∫£m gi√°!', 'warning');
                }
            } else {
                // Hide discount
                if (shopSection) shopSection.style.display = 'none';
                if (discountInfo) discountInfo.style.display = 'none';
                if (discountAmount) discountAmount.textContent = '0';
                if (finalAmount) finalAmount.textContent = originalFee.toLocaleString();
            }
            
            console.log('üîç Checkbox state after updateDisplay:', checkbox.checked);
        }
        
        // Restore state from localStorage
        const savedState = localStorage.getItem(storageKey);
        console.log('üîç localStorage savedState:', savedState);
        console.log('üîç Checkbox initial state:', checkbox.checked);
        
        if (savedState === 'true') {
            checkbox.checked = true;
            console.log('üì± Restored checkbox state from localStorage');
        }
        
        console.log('üîç Checkbox after restore:', checkbox.checked);
        
        // Apply initial state
        updateDisplay();
        
        // Verify checkbox state after initialization
        setTimeout(() => {
            console.log('üîç Final checkbox state after init:', checkbox.checked);
            console.log('üîç Final hidden field value:', hiddenField.value);
        }, 100);
        
        // Listen for checkbox changes
        checkbox.addEventListener('change', function() {
            console.log(`üéØ Checkbox changed: ${this.checked}`);
            console.log('Hidden field before update:', hiddenField.value);
            
            // Add visual feedback
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = 'scale(1)';
            }, 150);
            
            // Save to localStorage
            localStorage.setItem(storageKey, this.checked.toString());
            
            // Update display with animation
            updateDisplay();
            
            console.log('Hidden field after update:', hiddenField.value);
            
            // Show feedback message
            if (this.checked) {
                showToast('ƒê√£ b·∫≠t gi·∫£m gi√° t·ª´ shop!', 'success');
            } else {
                showToast('ƒê√£ t·∫Øt gi·∫£m gi√° t·ª´ shop', 'info');
            }
        });
        
        // Clear localStorage on form submit
        const form = document.querySelector('form[method="post"]');
        if (form) {
            form.addEventListener('submit', function(e) {
                console.log('üì§ Form submitted');
                console.log('Checkbox checked:', checkbox.checked);
                console.log('Hidden field value:', hiddenField.value);
                
                // Debug form data
                const formData = new FormData(form);
                console.log('Form data:');
                for (let [key, value] of formData.entries()) {
                    console.log(`${key}: ${value}`);
                }
                
                localStorage.removeItem(storageKey);
            });
        }
        
        // Refresh cart data when returning from shop
        function refreshCartData() {
            console.log('üîÑ Refreshing cart data...');
            console.log('üîç Checkbox state before refresh:', checkbox.checked);
            
            // Add loading state
            document.body.classList.add('loading');
            
            fetch('{% url "calculate_shop_discount" tournament_pk=registration.tournament.pk|default:0 %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('‚úÖ Cart data refreshed:', data);
                    console.log('üîç Checkbox state after refresh:', checkbox.checked);
                    
                    // Update display if checkbox is checked
                    if (checkbox.checked) {
                        updateDisplay();
                    }
                    
                    // Show success message
                    showToast('Gi·ªè h√†ng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!', 'success');
                } else {
                    console.error('‚ùå Failed to refresh cart data');
                    showToast('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t gi·ªè h√†ng', 'error');
                }
            })
            .catch(error => {
                console.error('‚ùå Error refreshing cart:', error);
                showToast('L·ªói khi c·∫≠p nh·∫≠t gi·ªè h√†ng', 'error');
            })
            .finally(() => {
                // Remove loading state
                document.body.classList.remove('loading');
                console.log('üîç Checkbox state after refresh complete:', checkbox.checked);
            });
        }
        
        // Simple toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'info'} position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
            `;
            
            document.body.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // Auto-refresh when returning from shop
        if (window.location.search.includes('shop_return=true')) {
            setTimeout(() => {
                console.log('üîÑ Auto-refreshing cart data...');
                refreshCartData();
            }, 1000);
        }
        
        // Refresh on focus (when returning from shop) - only if checkbox is checked
        let hasLeftPage = false;
        window.addEventListener('blur', () => hasLeftPage = true);
        window.addEventListener('focus', () => {
            if (hasLeftPage && checkbox.checked) {
                console.log('üîÑ User returned from shop, refreshing...');
                console.log('üîç Checkbox state before focus refresh:', checkbox.checked);
                refreshCartData();
            }
        });
        
        // Monitor checkbox state changes
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'attributes' && mutation.attributeName === 'checked') {
                    console.log('üîç Checkbox checked attribute changed:', checkbox.checked);
                }
            });
        });
        
        observer.observe(checkbox, { attributes: true, attributeFilter: ['checked'] });
        
        console.log('üéâ Shop Discount Toggle ready!');
    });
    </script>

    <style>
    .hero-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .payment-info-card {
        transition: transform 0.2s ease-in-out;
    }
    
    .payment-info-card:hover {
        transform: translateY(-2px);
    }
    
    .cart-items .bg-white {
        transition: background-color 0.2s ease-in-out;
    }
    
    .cart-items .bg-white:hover {
        background-color: #f8f9fa !important;
    }
    
    .sticky-top {
        position: sticky;
        top: 80px;
        z-index: 1010;
        transition: all 0.2s ease;
        will-change: transform;
    }
    
    @media (max-width: 768px) {
        .sticky-top {
            position: relative;
            top: auto;
            z-index: auto;
        }
        
        .payment-summary-sticky {
            position: relative !important;
            top: auto !important;
            z-index: auto !important;
        }
    }
    
    .payment-breakdown {
        font-size: 0.95rem;
    }
    
    .payment-breakdown hr {
        margin: 1rem 0;
    }
    
    .btn-lg {
        padding: 0.75rem 1.5rem;
        font-size: 1.1rem;
    }
    
    .stats-box {
        backdrop-filter: blur(10px);
    }
    
    .card {
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        transition: box-shadow 0.15s ease-in-out;
    }
    </style>
</div>


{% endblock %}