{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}
    {% if registration.payment_status == 'PENDING' %}
        C·∫≠p nh·∫≠t thanh to√°n - {{ team.name }}
    {% else %}
        Thanh to√°n l·ªá ph√≠ - {{ team.name }}
    {% endif %}
{% endblock %}

{% block content %}
<style>
/* Payment Page Styles */
.hero-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

/* Payment page specific styles - c·ªë ƒë·ªãnh header v√† lo·∫°i b·ªè kho·∫£ng c√°ch */
/* C·ªë ƒë·ªãnh header v·ªõi fixed positioning ƒë·ªÉ tr√°nh threshold */
.site-header {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    z-index: 1020 !important;
    margin: 0 !important;
    padding: 0 !important;
    transition: all 0.2s ease !important;
    will-change: transform !important;
}

/* T·ªëi ∆∞u navbar cho smooth scrolling */
.site-header .navbar {
    min-height: 70px;
    transition: all 0.2s ease !important;
    will-change: transform !important;
}

/* T·ªëi ∆∞u backdrop-filter ƒë·ªÉ gi·∫£m lag */
.site-header .navbar {
    backdrop-filter: blur(10px) !important; /* Gi·∫£m t·ª´ 20px xu·ªëng 10px */
    -webkit-backdrop-filter: blur(10px) !important;
}

/* ƒê·∫£m b·∫£o sticky summary kh√¥ng ƒë√® l√™n header */
.payment-summary-sticky {
    top: calc(70px + 10px) !important; /* header height + margin */
    z-index: 1010 !important;
    transition: all 0.2s ease !important;
    will-change: transform !important;
}

/* Smooth scrolling cho to√†n b·ªô trang */
html {
    scroll-behavior: smooth !important;
}

body {
    scroll-behavior: smooth !important;
}

/* T·ªëi ∆∞u hi·ªáu nƒÉng cho sticky elements */
.sticky-top,
.payment-summary-sticky,
.site-header {
    transform: translateZ(0) !important; /* Force hardware acceleration */
    backface-visibility: hidden !important;
    perspective: 1000px !important;
}

/* Gi·∫£m lag khi scroll */
* {
    scroll-behavior: smooth;
}

/* T·ªëi ∆∞u cho mobile */
@media (max-width: 768px) {
    .site-header .navbar {
        backdrop-filter: blur(5px) !important; /* Gi·∫£m th√™m cho mobile */
        -webkit-backdrop-filter: blur(5px) !important;
    }
}

/* Lo·∫°i b·ªè ho√†n to√†n kho·∫£ng c√°ch t·ª´ body v√† container */
body {
    margin: 0 !important;
    padding: 0 !important;
    padding-top: 70px !important; /* B√π kho·∫£ng tr·ªëng cho fixed header */
}

.container-fluid {
    margin-top: 0 !important;
    padding-top: 0 !important;
}

/* Override base template margin */
.content-wrapper {
    margin-top: 0 !important;
    padding-top: 0 !important;
}

/* ƒê·∫£m b·∫£o kh√¥ng c√≥ kho·∫£ng c√°ch t·ª´ container ch√≠nh */
.container {
    margin-top: 0 !important;
    padding-top: 0 !important;
}

/* Responsive - ƒëi·ªÅu ch·ªânh padding cho mobile */
@media (max-width: 768px) {
    body {
        padding-top: 65px !important; /* Gi·∫£m padding cho mobile */
    }
    
    .site-header .navbar {
        min-height: 65px;
    }
    
    .payment-summary-sticky {
        top: calc(65px + 10px) !important;
    }
    
    .container-fluid {
        padding-top: 0 !important;
    }
}

@media (max-width: 576px) {
    body {
        padding-top: 60px !important; /* Gi·∫£m th√™m cho mobile nh·ªè */
    }
    
    .site-header .navbar {
        min-height: 60px;
    }
    
    .payment-summary-sticky {
        top: calc(60px + 10px) !important;
    }
    
    .container-fluid {
        padding-top: 0 !important;
    }
}

.form-check-input:checked {
    background-color: #667eea;
    border-color: #667eea;
}

.form-check-input:focus {
    box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
}

/* Smooth transitions */
.shop-cart-section, .discount-info {
    transition: all 0.3s ease;
}

/* Loading state */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

/* Checkbox animation */
.form-check-input {
    transition: transform 0.15s ease;
}

/* Toast animation */
.alert {
    animation: slideInRight 0.3s ease;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}
</style>

<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="hero-section bg-gradient-primary text-white rounded-3 p-4 mb-4" style="margin-top: 2rem;">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="display-6 fw-bold mb-3">
                            <i class="bi bi-credit-card-2-front me-3"></i>Thanh to√°n l·ªá ph√≠ gi·∫£i ƒë·∫•u
                        </h1>
                        <p class="lead mb-0">
                            ƒê·ªôi <strong>{{ team.name }}</strong> - Gi·∫£i ƒë·∫•u <strong>{{ registration.tournament.name }}</strong>
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="stats-box bg-white bg-opacity-10 rounded p-3">
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="h4 mb-1" id="banner-product-count">
                                        {% if tournament.organization %}
                                            {# Gi·∫£i c·ªßa BTC: Ch·ªâ hi·ªÉn th·ªã Organization Shop #}
                                            {% if org_cart and org_cart.items.exists %}
                                                {{ org_cart.items.count }}
                                            {% else %}
                                                0
                                            {% endif %}
                                        {% else %}
                                            {# Gi·∫£i c·ªßa Admin: Ch·ªâ hi·ªÉn th·ªã Main Shop #}
                                            {% if cart and cart.items.exists %}
                                                {{ cart.items.count }}
                                            {% else %}
                                                0
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                    <small>S·∫£n ph·∫©m</small>
                                </div>
                                <div class="col-6">
                                    <div class="h4 mb-1" id="banner-total-amount">
                                        {% if tournament.organization %}
                                            {# Gi·∫£i c·ªßa BTC: Ch·ªâ hi·ªÉn th·ªã Organization Shop #}
                                            {% if org_cart and org_cart.items.exists %}
                                                {{ org_cart_total|floatformat:0 }}
                                            {% else %}
                                                0
                                            {% endif %}
                                        {% else %}
                                            {# Gi·∫£i c·ªßa Admin: Ch·ªâ hi·ªÉn th·ªã Main Shop #}
                                            {% if cart and cart.items.exists %}
                                                {{ cart_total|floatformat:0 }}
                                            {% else %}
                                                0
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                    <small>VNƒê</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Left Column: Payment Steps -->
        <div class="col-lg-8">
            <!-- Step 1: Shop Integration -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-shop me-2"></i>B∆∞·ªõc 1: T√≠ch h·ª£p Shop (T√πy ch·ªçn)
                    </h5>
                </div>
                <div class="card-body">
                    {% if registration.tournament.shop_discount_percentage > 0 %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>∆Øu ƒë√£i ƒë·∫∑c bi·ªát:</strong> ƒê·∫∑t h√†ng t·ª´ shop ƒë·ªÉ ƒë∆∞·ª£c tr·ª´ 
                        <span class="badge bg-success fs-6">{{ registration.tournament.shop_discount_percentage }}%</span> 
                        ti·ªÅn l√£i v√†o l·ªá ph√≠ ƒëƒÉng k√Ω gi·∫£i ƒë·∫•u.
                        <br><small class="text-muted">
                            <i class="bi bi-lightbulb me-1"></i>
                            Shop s·∫Ω m·ªü trong tab m·ªõi ƒë·ªÉ b·∫°n kh√¥ng m·∫•t form thanh to√°n n√†y.
                        </small>
                        {% if not registration.tournament.organization %}
                        <br><small class="text-warning">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            <strong>L∆∞u √Ω:</strong> Ch·ªâ s·ª≠ d·ª•ng gi·ªè h√†ng c·ªßa Shop Ch√≠nh, kh√¥ng t√≠nh v√†o gi·ªè h√†ng Shop BTC.
                        </small>
                        {% endif %}
                        {% if registration.tournament.organization %}
                        <br><small class="text-success">
                            <i class="bi bi-shop me-1"></i>
                            <strong>Shop BTC:</strong> B·∫°n c√≥ th·ªÉ mua t·ª´ shop c·ªßa {{ registration.tournament.organization.name }} ƒë·ªÉ ƒë∆∞·ª£c gi·∫£m gi√°!
                        </small>
                        <br><small class="text-warning">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            <strong>L∆∞u √Ω:</strong> Ch·ªâ s·ª≠ d·ª•ng gi·ªè h√†ng c·ªßa Shop BTC, kh√¥ng t√≠nh v√†o gi·ªè h√†ng Main Shop.
                        </small>
                        {% endif %}
                    </div>
                    
                    <!-- Checkbox ƒë·ªÉ t√≠ch h·ª£p shop - ch·ªâ hi·ªÉn th·ªã khi c√≥ discount -->
                    {% if registration.tournament.shop_discount_percentage > 0 %}
                    <div class="d-flex align-items-center justify-content-between mb-4 p-3 border rounded bg-light">
                        <label class="fw-bold fs-5 mb-0" for="use_shop_discount_checkbox">
                            <i class="bi bi-cart-plus me-2"></i>T√¥i mu·ªën ƒë·∫∑t h√†ng t·ª´ shop ƒë·ªÉ ƒë∆∞·ª£c tr·ª´ ti·ªÅn l√£i
                        </label>
                        <div class="badge bg-gradient-primary text-white p-3 rounded-pill" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); animation: pulse 2s infinite;">
                            <div class="d-flex align-items-center">
                                <input class="form-check-input me-2" type="checkbox" id="use_shop_discount_checkbox" style="transform: scale(1.3);">
                                <span class="fw-bold">GI·∫¢M {{ registration.tournament.shop_discount_percentage }}%</span>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div id="shop-cart-section" class="shop-cart-section" style="display: none;">
                        {% if registration.tournament.organization %}
                            {# Gi·∫£i c·ªßa BTC: Ch·ªâ hi·ªÉn th·ªã Organization Shop #}
                            {% if org_cart and org_cart.items.exists %}
                            <div class="cart-summary mb-3 p-3 border rounded bg-light">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0"><i class="bi bi-shop me-2"></i>Shop {{ registration.tournament.organization.name }}</h6>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="location.reload()" title="L√†m m·ªõi gi·ªè h√†ng">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                        <a href="{% url 'shop:organization_shop:shop_home' org_slug=registration.tournament.organization.slug %}" target="_blank" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-plus-circle me-1"></i>Th√™m s·∫£n ph·∫©m
                                        </a>
                                    </div>
                                </div>
                                
                                {% if unavailable_items %}
                                <div class="alert alert-danger mb-3">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <strong>C·∫£nh b√°o:</strong> M·ªôt s·ªë s·∫£n ph·∫©m trong gi·ªè h√†ng kh√¥ng ƒë·ªß s·ªë l∆∞·ª£ng:
                                    <ul class="mb-0 mt-2">
                                        {% for item in unavailable_items %}
                                        <li>
                                            <strong>{{ item.product.name }}</strong>: 
                                            B·∫°n ch·ªçn {{ item.requested }} s·∫£n ph·∫©m nh∆∞ng ch·ªâ c√≤n {{ item.available }} s·∫£n ph·∫©m trong kho.
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Vui l√≤ng gi·∫£m s·ªë l∆∞·ª£ng ho·∫∑c x√≥a s·∫£n ph·∫©m kh√¥ng ƒë·ªß h√†ng ƒë·ªÉ ƒë∆∞·ª£c t√≠nh gi·∫£m gi√°.
                                    </small>
                                </div>
                                {% endif %}
                                <div class="cart-items">
                                    {% for item in org_cart.items.all %}
                                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white rounded">
                                        <div>
                                            <small class="fw-bold">{{ item.product.name }}</small>
                                            {% if item.size %}<br><small class="text-muted">Size: {{ item.size.name }}</small>{% endif %}
                                        </div>
                                        <div class="text-end">
                                            <small>{{ item.quantity }}x {{ item.product.current_price|floatformat:0 }} VNƒê</small>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <strong>T·ªïng gi·ªè h√†ng:</strong>
                                    <strong class="text-primary">{{ org_cart_total|floatformat:0 }} VNƒê</strong>
                                </div>
                            </div>
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="bi bi-cart-x me-2"></i>
                                Gi·ªè h√†ng shop BTC ƒëang tr·ªëng. 
                                <a href="{% url 'shop:organization_shop:shop_home' org_slug=registration.tournament.organization.slug %}" target="_blank" class="btn btn-sm btn-warning ms-2">
                                    <i class="bi bi-shop me-1"></i>V√†o shop BTC
                                </a>
                                <br><small class="text-muted mt-2 d-block">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Sau khi th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng, quay l·∫°i tab n√†y v√† click n√∫t "L√†m m·ªõi" ƒë·ªÉ c·∫≠p nh·∫≠t.
                                </small>
                            </div>
                            {% endif %}
                            
                            {# Qu·∫£ng c√°o Main Shop cho gi·∫£i c·ªßa BTC #}
                            <div class="alert alert-secondary mt-3">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <i class="bi bi-info-circle me-2"></i>
                                        <strong>Shop Ch√≠nh:</strong> B·∫°n c≈©ng c√≥ th·ªÉ mua s·∫£n ph·∫©m t·ª´ shop ch√≠nh c·ªßa DBP Sports.
                                        <br><small class="text-muted">
                                            <i class="bi bi-exclamation-triangle me-1"></i>
                                            L∆∞u √Ω: S·∫£n ph·∫©m t·ª´ Shop Ch√≠nh kh√¥ng ƒë∆∞·ª£c t√≠nh v√†o gi·∫£m gi√° l·ªá ph√≠ ƒëƒÉng k√Ω.
                                        </small>
                                    </div>
                                    <a href="{% url 'shop:home' %}" target="_blank" class="btn btn-sm btn-outline-secondary ms-3">
                                        <i class="bi bi-shop me-1"></i>Xem Shop Ch√≠nh
                                    </a>
                                </div>
                            </div>
                        {% else %}
                            {# Gi·∫£i c·ªßa Admin: Ch·ªâ hi·ªÉn th·ªã Main Shop #}
                            {% if cart and cart.items.exists %}
                            <div class="cart-summary mb-3 p-3 border rounded bg-light">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0"><i class="bi bi-cart-check me-2"></i>Gi·ªè h√†ng c·ªßa b·∫°n</h6>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="location.reload()" title="L√†m m·ªõi gi·ªè h√†ng">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                        <a href="{% url 'shop:home' %}" target="_blank" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-plus-circle me-1"></i>Th√™m s·∫£n ph·∫©m
                                        </a>
                                    </div>
                                </div>
                                
                                {% if unavailable_items %}
                                <div class="alert alert-danger mb-3">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <strong>C·∫£nh b√°o:</strong> M·ªôt s·ªë s·∫£n ph·∫©m trong gi·ªè h√†ng kh√¥ng ƒë·ªß s·ªë l∆∞·ª£ng:
                                    <ul class="mb-0 mt-2">
                                        {% for item in unavailable_items %}
                                        <li>
                                            <strong>{{ item.product.name }}</strong>: 
                                            B·∫°n ch·ªçn {{ item.requested }} s·∫£n ph·∫©m nh∆∞ng ch·ªâ c√≤n {{ item.available }} s·∫£n ph·∫©m trong kho.
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Vui l√≤ng gi·∫£m s·ªë l∆∞·ª£ng ho·∫∑c x√≥a s·∫£n ph·∫©m kh√¥ng ƒë·ªß h√†ng ƒë·ªÉ ƒë∆∞·ª£c t√≠nh gi·∫£m gi√°.
                                    </small>
                                </div>
                                {% endif %}
                                <div class="cart-items">
                                    {% for item in cart.items.all %}
                                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white rounded">
                                        <div>
                                            <small class="fw-bold">{{ item.product.name }}</small>
                                            {% if item.size %}<br><small class="text-muted">Size: {{ item.size.name }}</small>{% endif %}
                                        </div>
                                        <div class="text-end">
                                            <small>{{ item.quantity }}x {{ item.product.current_price|floatformat:0 }} VNƒê</small>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <strong>T·ªïng gi·ªè h√†ng:</strong>
                                    <strong class="text-primary">{{ cart_total|floatformat:0 }} VNƒê</strong>
                                </div>
                            </div>
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="bi bi-cart-x me-2"></i>
                                Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng. 
                                <a href="{% url 'shop:home' %}" target="_blank" class="btn btn-sm btn-warning ms-2">
                                    <i class="bi bi-shop me-1"></i>V√†o shop ch·ªçn ƒë·ªì
                                </a>
                                <br><small class="text-muted mt-2 d-block">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Sau khi th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng, quay l·∫°i tab n√†y v√† click n√∫t "L√†m m·ªõi" ƒë·ªÉ c·∫≠p nh·∫≠t.
                                </small>
                            </div>
                            {% endif %}
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="alert alert-secondary">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Th√¥ng b√°o:</strong> Gi·∫£i ƒë·∫•u n√†y hi·ªán t·∫°i ch∆∞a c√≥ ch∆∞∆°ng tr√¨nh gi·∫£m gi√° t·ª´ shop.
                        {% if registration.tournament.organization %}
                        <br><small class="text-muted">
                            <i class="bi bi-shop me-1"></i>
                            Tuy nhi√™n, b·∫°n v·∫´n c√≥ th·ªÉ mua s·∫£n ph·∫©m t·ª´ shop c·ªßa {{ registration.tournament.organization.name }} ƒë·ªÉ ·ªßng h·ªô BTC.
                        </small>
                        {% endif %}
                    </div>
                    
                    <div class="d-flex gap-2">
                        <a href="{% url 'shop:home' %}" target="_blank" class="btn btn-outline-primary">
                            <i class="bi bi-shop me-2"></i>V√†o Shop Ch√≠nh
                        </a>
                        {% if registration.tournament.organization %}
                        <a href="{% url 'shop:organization_shop:shop_home' org_slug=registration.tournament.organization.slug %}" target="_blank" class="btn btn-outline-success">
                            <i class="bi bi-shop me-2"></i>V√†o Shop BTC
                        </a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Step 2: Payment Information -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-bank me-2"></i>B∆∞·ªõc 2: Th√¥ng tin chuy·ªÉn kho·∫£n
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="payment-info-card p-3 border rounded bg-light">
                                <h6><i class="bi bi-building me-2"></i>Th√¥ng tin ng√¢n h√†ng</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Ng√¢n h√†ng:</strong> {{ registration.tournament.bank_name|default:"Ch∆∞a c·∫≠p nh·∫≠t" }}</li>
                                    <li><strong>S·ªë t√†i kho·∫£n:</strong> {{ registration.tournament.bank_account_number|default:"Ch∆∞a c·∫≠p nh·∫≠t" }}</li>
                                    <li><strong>Ch·ªß t√†i kho·∫£n:</strong> {{ registration.tournament.bank_account_name|default:"Ch∆∞a c·∫≠p nh·∫≠t" }}</li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="payment-info-card p-3 border rounded bg-light">
                                <h6><i class="bi bi-chat-text me-2"></i>N·ªôi dung chuy·ªÉn kho·∫£n</h6>
                                <div class="bg-white p-2 rounded border">
                                    <code>{{ team.name }} Nop Le Phi Giai {{ registration.tournament.name }}</code>
                                </div>
                                <small class="text-muted">Sao ch√©p n·ªôi dung n√†y khi chuy·ªÉn kho·∫£n</small>
                            </div>
                        </div>
                    </div>
                    
                    {% if registration.tournament.payment_qr_code %}
                    <div class="text-center mt-3">
                        <img src="{{ registration.tournament.payment_qr_code.url }}" alt="M√£ QR thanh to√°n" class="img-fluid" style="max-width: 200px;">
                        <p class="text-muted small mt-2">Qu√©t m√£ QR ƒë·ªÉ chuy·ªÉn kho·∫£n nhanh</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Step 3: Upload Proof -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="bi bi-upload me-2"></i>B∆∞·ªõc 3: T·∫£i l√™n b·∫±ng ch·ª©ng thanh to√°n
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        {{ form|crispy }}
                        <!-- Hidden field ƒë·ªÉ JavaScript c√≥ th·ªÉ tham chi·∫øu -->
                        <input type="hidden" id="id_use_shop_discount" name="use_shop_discount" value="">
                        
                        <div class="d-grid gap-2 mt-3">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="bi bi-check-circle me-2"></i>G·ª≠i x√°c nh·∫≠n thanh to√°n
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Column: Payment Summary -->
        <div class="col-lg-4">
            <div class="card shadow-sm sticky-top payment-summary-sticky">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-calculator me-2"></i>T√≥m t·∫Øt thanh to√°n
                    </h5>
                </div>
                <div class="card-body">
                    <div class="payment-breakdown">
                        <div class="d-flex justify-content-between mb-2">
                            <span>L·ªá ph√≠ ƒëƒÉng k√Ω:</span>
                            <span class="fw-bold text-primary">{{ registration.tournament.registration_fee|floatformat:0 }} VNƒê</span>
                        </div>
                        
                        <div id="discount-info" class="discount-info" style="display: none;">
                            {% if registration.tournament.organization %}
                                {# Gi·∫£i c·ªßa BTC: Ch·ªâ hi·ªÉn th·ªã Organization Shop discount #}
                                {% if org_discount > 0 %}
                                <div class="d-flex justify-content-between mb-1 text-success">
                                    <span><i class="bi bi-shop me-1"></i>Tr·ª´ ti·ªÅn l√£i t·ª´ Shop BTC:</span>
                                    <span>-{{ org_discount|floatformat:0 }} VNƒê</span>
                                </div>
                                {% endif %}
                            {% else %}
                                {# Gi·∫£i c·ªßa Admin: Ch·ªâ hi·ªÉn th·ªã Main Shop discount #}
                                {% if main_discount > 0 %}
                                <div class="d-flex justify-content-between mb-1 text-success">
                                    <span><i class="bi bi-shop me-1"></i>Tr·ª´ ti·ªÅn l√£i t·ª´ Shop Ch√≠nh:</span>
                                    <span>-{{ main_discount|floatformat:0 }} VNƒê</span>
                                </div>
                                {% endif %}
                            {% endif %}
                            <div class="d-flex justify-content-between mb-2 text-success fw-bold">
                                <span><i class="bi bi-tag me-1"></i>T·ªïng gi·∫£m gi√°:</span>
                                <span>-<span id="discount-amount">{{ discount_amount|floatformat:0 }}</span> VNƒê</span>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <div class="d-flex justify-content-between fw-bold fs-5">
                            <span>T·ªïng c·∫ßn thanh to√°n:</span>
                            <span class="text-primary" id="final-amount">{{ registration.tournament.registration_fee|floatformat:0 }} VNƒê</span>
                        </div>
                        
                        <div class="alert alert-success mt-3">
                            <i class="bi bi-check-circle me-2"></i>
                            <small>
                                <strong>Th√¥ng tin c·∫≠p nh·∫≠t:</strong> L·ªá ph√≠ ƒëƒÉng k√Ω hi·ªán t·∫°i l√† 
                                <strong>{{ registration.tournament.registration_fee|floatformat:0 }} VNƒê</strong> 
                                (ƒë√£ ƒë∆∞·ª£c BTC c·∫≠p nh·∫≠t m·ªõi nh·∫•t).
                            </small>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            <small>
                                {% if registration.payment_status == 'PENDING' %}
                                    B·∫°n c√≥ th·ªÉ c·∫≠p nh·∫≠t h√≥a ƒë∆°n thanh to√°n. Tr·∫°ng th√°i s·∫Ω v·∫´n l√† "Ch·ªù x√°c nh·∫≠n".
                                {% else %}
                                    Sau khi g·ª≠i, tr·∫°ng th√°i thanh to√°n s·∫Ω chuy·ªÉn th√†nh "Ch·ªù x√°c nh·∫≠n".
                                {% endif %}
                            </small>
                        </div>
                        {% if registration.tournament.shop_discount_percentage > 0 %}
                        <div class="alert alert-success">
                            <i class="bi bi-shop me-2"></i>
                            <small>
                                <strong>M·∫πo:</strong> ƒê·∫∑t h√†ng t·ª´ shop ƒë·ªÉ ƒë∆∞·ª£c gi·∫£m gi√°! 
                                Shop s·∫Ω m·ªü trong tab m·ªõi ƒë·ªÉ b·∫°n kh√¥ng m·∫•t form n√†y.
                            </small>
                        </div>
                        {% else %}
                        <div class="alert alert-secondary">
                            <i class="bi bi-shop me-2"></i>
                            <small>
                                <strong>Th√¥ng b√°o:</strong> Gi·∫£i ƒë·∫•u n√†y ch∆∞a c√≥ ch∆∞∆°ng tr√¨nh gi·∫£m gi√° t·ª´ shop.
                                {% if registration.tournament.organization %}
                                Tuy nhi√™n, b·∫°n v·∫´n c√≥ th·ªÉ mua s·∫£n ph·∫©m t·ª´ shop BTC ƒë·ªÉ ·ªßng h·ªô ban t·ªï ch·ª©c.
                                {% endif %}
                            </small>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="d-grid gap-2">
                        <a href="{% url 'team_detail' pk=team.pk %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-2"></i>Quay l·∫°i ƒë·ªôi b√≥ng
                        </a>
                        {% if registration.tournament.shop_discount_percentage > 0 %}
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-secondary" onclick="location.reload()" title="L√†m m·ªõi trang v√† gi·ªè h√†ng">
                                <i class="bi bi-arrow-clockwise me-2"></i>L√†m m·ªõi
                            </button>
                            {% if registration.tournament.organization %}
                                {# Gi·∫£i c·ªßa BTC: D·∫´n ƒë·∫øn Organization Shop #}
                                <a href="{% url 'shop:organization_shop:shop_home' org_slug=registration.tournament.organization.slug %}" target="_blank" class="btn btn-outline-primary">
                                    <i class="bi bi-shop me-2"></i>V√†o shop BTC
                                </a>
                            {% else %}
                                {# Gi·∫£i c·ªßa Admin: D·∫´n ƒë·∫øn Main Shop #}
                                <a href="{% url 'shop:home' %}" target="_blank" class="btn btn-outline-primary">
                                    <i class="bi bi-shop me-2"></i>V√†o shop ch·ªçn ƒë·ªì
                                </a>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-secondary" onclick="location.reload()" title="L√†m m·ªõi trang v√† gi·ªè h√†ng">
                                <i class="bi bi-arrow-clockwise me-2"></i>L√†m m·ªõi
                            </button>
                            {% if registration.tournament.organization %}
                                {# Gi·∫£i c·ªßa BTC: D·∫´n ƒë·∫øn Organization Shop #}
                                <a href="{% url 'shop:organization_shop:shop_home' org_slug=registration.tournament.organization.slug %}" target="_blank" class="btn btn-outline-success">
                                    <i class="bi bi-shop me-2"></i>V√†o shop BTC
                                </a>
                            {% else %}
                                {# Gi·∫£i c·ªßa Admin: D·∫´n ƒë·∫øn Main Shop #}
                                <a href="{% url 'shop:home' %}" target="_blank" class="btn btn-outline-primary">
                                    <i class="bi bi-shop me-2"></i>V√†o Shop Ch√≠nh
                                </a>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
    
    <script>
    // Shop Discount Toggle - Simple & Clean Implementation
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üè™ Shop Discount Toggle initialized');
        
        // Elements
        const checkbox = document.getElementById('use_shop_discount_checkbox');
        const hiddenField = document.getElementById('id_use_shop_discount');
        const shopSection = document.getElementById('shop-cart-section');
        const discountInfo = document.getElementById('discount-info');
        const discountAmount = document.getElementById('discount-amount');
        const finalAmount = document.getElementById('final-amount');
        
        // Data - Force refresh from server
        const originalFee = parseFloat('{{ registration.tournament.registration_fee|default:0 }}') || 0;
        const currentDiscountAmount = parseFloat('{{ discount_amount|default:0 }}') || 0;
        const currentFinalFee = parseFloat('{{ final_fee|default:0 }}') || 0;
        const mainDiscount = parseFloat('{{ main_discount|default:0 }}') || 0;
        const orgDiscount = parseFloat('{{ org_discount|default:0 }}') || 0;
        const cartTotal = parseFloat('{{ cart_total|default:0 }}') || 0;
        const orgCartTotal = parseFloat('{{ org_cart_total|default:0 }}') || 0;
        
        // Debug: Log current values
        console.log('üîÑ Payment page loaded with fresh data:');
        console.log('Tournament ID:', '{{ registration.tournament.pk }}');
        console.log('Registration fee:', originalFee);
        console.log('Discount amount:', currentDiscountAmount);
        console.log('Final fee:', currentFinalFee);
        
        // Check for unavailable items
        const unavailableItems = {{ unavailable_items|length|default:0 }};
        if (unavailableItems > 0) {
            console.log('‚ö†Ô∏è Warning: Some items in cart have insufficient stock');
            console.log('Unavailable items count:', unavailableItems);
        }
        
        console.log('üìä Data values:');
        console.log('Original fee:', originalFee);
        console.log('Main discount:', mainDiscount);
        console.log('Org discount:', orgDiscount);
        console.log('Total discount amount:', currentDiscountAmount);
        console.log('Final fee:', currentFinalFee);
        console.log('Shop discount percentage:', parseFloat('{{ registration.tournament.shop_discount_percentage|default:0 }}') || 0);
        console.log('Main cart total:', cartTotal);
        console.log('Org cart total:', orgCartTotal);
        
        // Storage key
        const storageKey = 'shop_discount_{{ registration.pk|default:0 }}';
        
        // Debug all elements
        console.log('üîç Debugging elements:');
        console.log('Checkbox:', checkbox);
        console.log('Hidden field:', hiddenField);
        console.log('Shop section:', shopSection);
        console.log('Discount info:', discountInfo);
        console.log('Discount amount:', discountAmount);
        console.log('Final amount:', finalAmount);
        
        // Check if elements exist
        if (!checkbox) {
            console.log('‚ÑπÔ∏è Checkbox not found - tournament has no shop discount');
            console.log('Shop discount percentage:', parseFloat('{{ registration.tournament.shop_discount_percentage|default:0 }}') || 0);
            // Kh√¥ng return, ti·∫øp t·ª•c v·ªõi logic kh√°c
        }
        
        if (!hiddenField) {
            console.error('‚ùå Hidden field not found');
            console.log('Available hidden fields:', document.querySelectorAll('input[type="hidden"]'));
            return;
        }
        
        console.log('‚úÖ All elements found');
        
        // Update banner with cart totals
        function updateBanner() {
            const bannerProductCount = document.getElementById('banner-product-count');
            const bannerTotalAmount = document.getElementById('banner-total-amount');
            
            if (bannerProductCount && bannerTotalAmount) {
                {% if registration.tournament.organization %}
                    {# Gi·∫£i c·ªßa BTC: Ch·ªâ hi·ªÉn th·ªã Organization Shop #}
                    const orgCartCount = parseFloat('{{ org_cart.items.count|default:0 }}') || 0;
                    const totalProducts = orgCartCount;
                    const totalAmount = orgCartTotal;
                {% else %}
                    {# Gi·∫£i c·ªßa Admin: Ch·ªâ hi·ªÉn th·ªã Main Shop #}
                    const mainCartCount = parseFloat('{{ cart.items.count|default:0 }}') || 0;
                    const totalProducts = mainCartCount;
                    const totalAmount = cartTotal;
                {% endif %}
                
                bannerProductCount.textContent = totalProducts;
                bannerTotalAmount.textContent = totalAmount.toLocaleString();
                
                console.log('üìä Banner updated:', { 
                    totalProducts, 
                    totalAmount 
                });
            }
        }
        
        // Update display based on checkbox state
        function updateDisplay() {
            const isChecked = checkbox.checked;
            
            console.log(`üîÑ Updating display: ${isChecked ? 'ON' : 'OFF'}`);
            console.log('üîç Checkbox state in updateDisplay:', checkbox.checked);
            
            // Update hidden field
            hiddenField.value = isChecked ? 'on' : '';
            
            // Update UI
            if (isChecked) {
                // Always show shop section when checkbox is checked
                if (shopSection) shopSection.style.display = 'block';
                
                // Update banner with cart totals
                updateBanner();
                
                // Check if there's any discount available
                const hasAnyDiscount = currentDiscountAmount > 0;
                
                if (hasAnyDiscount) {
                    // Show discount info
                    if (discountInfo) discountInfo.style.display = 'block';
                    if (discountAmount) discountAmount.textContent = currentDiscountAmount.toLocaleString();
                    if (finalAmount) finalAmount.textContent = currentFinalFee.toLocaleString();
                    
                    console.log('‚úÖ Showing discount:', currentDiscountAmount);
                } else {
                    // Hide discount info but keep shop section visible
                    if (discountInfo) discountInfo.style.display = 'none';
                    if (discountAmount) discountAmount.textContent = '0';
                    if (finalAmount) finalAmount.textContent = originalFee.toLocaleString();
                    
                    console.log('‚ö†Ô∏è No discount available');
                }
            } else {
                // Hide everything when checkbox is unchecked
                if (shopSection) shopSection.style.display = 'none';
                if (discountInfo) discountInfo.style.display = 'none';
                if (discountAmount) discountAmount.textContent = '0';
                if (finalAmount) finalAmount.textContent = originalFee.toLocaleString();
                
                console.log('‚ùå Checkbox unchecked, hiding all');
            }
            
            console.log('üîç Checkbox state after updateDisplay:', checkbox.checked);
        }
        
        // Restore state from localStorage
        const savedState = localStorage.getItem(storageKey);
        console.log('üîç localStorage savedState:', savedState);
        console.log('üîç Checkbox initial state:', checkbox.checked);
        
        if (savedState === 'true') {
            checkbox.checked = true;
            console.log('üì± Restored checkbox state from localStorage');
        }
        
        console.log('üîç Checkbox after restore:', checkbox.checked);
        
        // Apply initial state
        updateDisplay();
        
        // Verify checkbox state after initialization
        setTimeout(() => {
            console.log('üîç Final checkbox state after init:', checkbox.checked);
            console.log('üîç Final hidden field value:', hiddenField.value);
        }, 100);
        
        // Listen for checkbox changes - ch·ªâ khi checkbox t·ªìn t·∫°i
        if (checkbox) {
            checkbox.addEventListener('change', function() {
            console.log(`üéØ Checkbox changed: ${this.checked}`);
            console.log('Hidden field before update:', hiddenField.value);
            
            // Force update hidden field immediately
            hiddenField.value = this.checked ? 'on' : '';
            console.log('Hidden field after immediate update:', hiddenField.value);
            
            // Add visual feedback
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = 'scale(1)';
            }, 150);
            
            // Save to localStorage
            localStorage.setItem(storageKey, this.checked.toString());
            
            // Update display with animation
            updateDisplay();
            
            console.log('Hidden field after update:', hiddenField.value);
            
            // Show feedback message
            if (this.checked) {
                if (unavailableItems > 0) {
                    showToast('C·∫£nh b√°o: M·ªôt s·ªë s·∫£n ph·∫©m kh√¥ng ƒë·ªß h√†ng! Gi·∫£m gi√° c√≥ th·ªÉ kh√¥ng ƒë∆∞·ª£c √°p d·ª•ng.', 'warning');
                } else {
                    showToast('ƒê√£ b·∫≠t gi·∫£m gi√° t·ª´ shop!', 'success');
                }
            } else {
                showToast('ƒê√£ t·∫Øt gi·∫£m gi√° t·ª´ shop', 'info');
            }
            });
        }
        
        // Clear localStorage on form submit
        const form = document.querySelector('form[method="post"]');
        if (form) {
            form.addEventListener('submit', function(e) {
                console.log('üì§ Form submitted');
                console.log('Checkbox checked:', checkbox.checked);
                console.log('Hidden field value:', hiddenField.value);
                
                // Debug form data
                const formData = new FormData(form);
                console.log('Form data:');
                for (let [key, value] of formData.entries()) {
                    console.log(`  ${key}: ${value}`);
                }
                
                // Ensure hidden field is set before submit
                if (checkbox.checked && hiddenField.value !== 'on') {
                    console.log('‚ö†Ô∏è Fixing hidden field value before submit');
                    hiddenField.value = 'on';
                }
                
                localStorage.removeItem(storageKey);
            });
        }
        
        // Refresh cart data when returning from shop
        function refreshCartData() {
            console.log('üîÑ Refreshing cart data...');
            console.log('üîç Checkbox state before refresh:', checkbox.checked);
            
            // Add loading state
            document.body.classList.add('loading');
            
            fetch('{% url "calculate_shop_discount" tournament_pk=registration.tournament.pk|default:0 %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('‚úÖ Cart data refreshed:', data);
                    console.log('üîç Checkbox state after refresh:', checkbox.checked);
                    
                    // Update display if checkbox is checked
                    if (checkbox.checked) {
                        updateDisplay();
                    }
                    
                    // Show success message
                    showToast('Gi·ªè h√†ng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!', 'success');
                } else {
                    console.error('‚ùå Failed to refresh cart data');
                    showToast('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t gi·ªè h√†ng', 'error');
                }
            })
            .catch(error => {
                console.error('‚ùå Error refreshing cart:', error);
                showToast('L·ªói khi c·∫≠p nh·∫≠t gi·ªè h√†ng', 'error');
            })
            .finally(() => {
                // Remove loading state
                document.body.classList.remove('loading');
                console.log('üîç Checkbox state after refresh complete:', checkbox.checked);
            });
        }
        
        // Simple toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'info'} position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
            `;
            
            document.body.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // Auto-refresh when returning from shop
        if (window.location.search.includes('shop_return=true')) {
            setTimeout(() => {
                console.log('üîÑ Auto-refreshing cart data...');
                refreshCartData();
            }, 1000);
        }
        
        // Refresh on focus (when returning from shop) - only if checkbox is checked
        let hasLeftPage = false;
        window.addEventListener('blur', () => hasLeftPage = true);
        window.addEventListener('focus', () => {
            if (hasLeftPage && checkbox.checked) {
                console.log('üîÑ User returned from shop, refreshing...');
                console.log('üîç Checkbox state before focus refresh:', checkbox.checked);
                refreshCartData();
            }
        });
        
        // Monitor checkbox state changes
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'attributes' && mutation.attributeName === 'checked') {
                    console.log('üîç Checkbox checked attribute changed:', checkbox.checked);
                }
            });
        });
        
        observer.observe(checkbox, { attributes: true, attributeFilter: ['checked'] });
        
        console.log('üéâ Shop Discount Toggle ready!');
    });
    </script>

    <style>
    .hero-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .payment-info-card {
        transition: transform 0.2s ease-in-out;
    }
    
    .payment-info-card:hover {
        transform: translateY(-2px);
    }
    
    .cart-items .bg-white {
        transition: background-color 0.2s ease-in-out;
    }
    
    .cart-items .bg-white:hover {
        background-color: #f8f9fa !important;
    }
    
    .sticky-top {
        position: sticky;
        top: 80px;
        z-index: 1010;
        transition: all 0.2s ease;
        will-change: transform;
    }
    
    @media (max-width: 768px) {
        .sticky-top {
            position: relative;
            top: auto;
            z-index: auto;
        }
        
        .payment-summary-sticky {
            position: relative !important;
            top: auto !important;
            z-index: auto !important;
        }
    }
    
    .payment-breakdown {
        font-size: 0.95rem;
    }
    
    .payment-breakdown hr {
        margin: 1rem 0;
    }
    
    .btn-lg {
        padding: 0.75rem 1.5rem;
        font-size: 1.1rem;
    }
    
    .stats-box {
        backdrop-filter: blur(10px);
    }
    
    .card {
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        transition: box-shadow 0.15s ease-in-out;
    }
    </style>
</div>


{% endblock %}