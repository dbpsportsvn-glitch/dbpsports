{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}
    {% if registration.payment_status == 'PENDING' %}
        Cập nhật thanh toán - {{ team.name }}
    {% else %}
        Thanh toán lệ phí - {{ team.name }}
    {% endif %}
{% endblock %}

{% block content %}
<style>
/* Payment Page Styles */
.hero-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

/* Payment page specific styles - cố định header và loại bỏ khoảng cách */
/* Cố định header với fixed positioning để tránh threshold */
.site-header {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    z-index: 1020 !important;
    margin: 0 !important;
    padding: 0 !important;
    transition: all 0.2s ease !important;
    will-change: transform !important;
}

/* Tối ưu navbar cho smooth scrolling */
.site-header .navbar {
    min-height: 70px;
    transition: all 0.2s ease !important;
    will-change: transform !important;
}

/* Tối ưu backdrop-filter để giảm lag */
.site-header .navbar {
    backdrop-filter: blur(10px) !important; /* Giảm từ 20px xuống 10px */
    -webkit-backdrop-filter: blur(10px) !important;
}

/* Đảm bảo sticky summary không đè lên header */
.payment-summary-sticky {
    top: calc(70px + 10px) !important; /* header height + margin */
    z-index: 1010 !important;
    transition: all 0.2s ease !important;
    will-change: transform !important;
}

/* Smooth scrolling cho toàn bộ trang */
html {
    scroll-behavior: smooth !important;
}

body {
    scroll-behavior: smooth !important;
}

/* Tối ưu hiệu năng cho sticky elements */
.sticky-top,
.payment-summary-sticky,
.site-header {
    transform: translateZ(0) !important; /* Force hardware acceleration */
    backface-visibility: hidden !important;
    perspective: 1000px !important;
}

/* Giảm lag khi scroll */
* {
    scroll-behavior: smooth;
}

/* Tối ưu cho mobile */
@media (max-width: 768px) {
    .site-header .navbar {
        backdrop-filter: blur(5px) !important; /* Giảm thêm cho mobile */
        -webkit-backdrop-filter: blur(5px) !important;
    }
}

/* Loại bỏ hoàn toàn khoảng cách từ body và container */
body {
    margin: 0 !important;
    padding: 0 !important;
    padding-top: 70px !important; /* Bù khoảng trống cho fixed header */
}

.container-fluid {
    margin-top: 0 !important;
    padding-top: 0 !important;
}

/* Override base template margin */
.content-wrapper {
    margin-top: 0 !important;
    padding-top: 0 !important;
}

/* Đảm bảo không có khoảng cách từ container chính */
.container {
    margin-top: 0 !important;
    padding-top: 0 !important;
}

/* Responsive - điều chỉnh padding cho mobile */
@media (max-width: 768px) {
    body {
        padding-top: 65px !important; /* Giảm padding cho mobile */
    }
    
    .site-header .navbar {
        min-height: 65px;
    }
    
    .payment-summary-sticky {
        top: calc(65px + 10px) !important;
    }
    
    .container-fluid {
        padding-top: 0 !important;
    }
}

@media (max-width: 576px) {
    body {
        padding-top: 60px !important; /* Giảm thêm cho mobile nhỏ */
    }
    
    .site-header .navbar {
        min-height: 60px;
    }
    
    .payment-summary-sticky {
        top: calc(60px + 10px) !important;
    }
    
    .container-fluid {
        padding-top: 0 !important;
    }
}

.form-check-input:checked {
    background-color: #667eea;
    border-color: #667eea;
}

.form-check-input:focus {
    box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
}

/* Smooth transitions */
.shop-cart-section, .discount-info {
    transition: all 0.3s ease;
}

/* Loading state */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

/* Checkbox animation */
.form-check-input {
    transition: transform 0.15s ease;
}

/* Toast animation */
.alert {
    animation: slideInRight 0.3s ease;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}
</style>

<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="hero-section bg-gradient-primary text-white rounded-3 p-4 mb-4" style="margin-top: 2rem;">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="display-6 fw-bold mb-3">
                            <i class="bi bi-credit-card-2-front me-3"></i>Thanh toán lệ phí giải đấu
                        </h1>
                        <p class="lead mb-0">
                            Đội <strong>{{ team.name }}</strong> - Giải đấu <strong>{{ registration.tournament.name }}</strong>
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="stats-box bg-white bg-opacity-10 rounded p-3">
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="h4 mb-1" id="banner-product-count">
                                        {% if tournament.organization %}
                                            {# Giải của BTC: Chỉ hiển thị Organization Shop #}
                                            {% if org_cart and org_cart.items.exists %}
                                                {{ org_cart.items.count }}
                                            {% else %}
                                                0
                                            {% endif %}
                                        {% else %}
                                            {# Giải của Admin: Chỉ hiển thị Main Shop #}
                                            {% if cart and cart.items.exists %}
                                                {{ cart.items.count }}
                                            {% else %}
                                                0
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                    <small>Sản phẩm</small>
                                </div>
                                <div class="col-6">
                                    <div class="h4 mb-1" id="banner-total-amount">
                                        {% if tournament.organization %}
                                            {# Giải của BTC: Chỉ hiển thị Organization Shop #}
                                            {% if org_cart and org_cart.items.exists %}
                                                {{ org_cart_total|floatformat:0 }}
                                            {% else %}
                                                0
                                            {% endif %}
                                        {% else %}
                                            {# Giải của Admin: Chỉ hiển thị Main Shop #}
                                            {% if cart and cart.items.exists %}
                                                {{ cart_total|floatformat:0 }}
                                            {% else %}
                                                0
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                    <small>VNĐ</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Left Column: Payment Steps -->
        <div class="col-lg-8">
            <!-- Step 1: Shop Integration -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-shop me-2"></i>Bước 1: Tích hợp Shop (Tùy chọn)
                    </h5>
                </div>
                <div class="card-body">
                    {% if registration.tournament.shop_discount_percentage > 0 %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Ưu đãi đặc biệt:</strong> Đặt hàng từ shop để được trừ 
                        <span class="badge bg-success fs-6">{{ registration.tournament.shop_discount_percentage }}%</span> 
                        tiền lãi vào lệ phí đăng ký giải đấu.
                        <br><small class="text-muted">
                            <i class="bi bi-lightbulb me-1"></i>
                            Shop sẽ mở trong tab mới để bạn không mất form thanh toán này.
                        </small>
                        {% if not registration.tournament.organization %}
                        <br><small class="text-warning">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            <strong>Lưu ý:</strong> Chỉ sử dụng giỏ hàng của Shop Chính, không tính vào giỏ hàng Shop BTC.
                        </small>
                        {% endif %}
                        {% if registration.tournament.organization %}
                        <br><small class="text-success">
                            <i class="bi bi-shop me-1"></i>
                            <strong>Shop BTC:</strong> Bạn có thể mua từ shop của {{ registration.tournament.organization.name }} để được giảm giá!
                        </small>
                        <br><small class="text-warning">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            <strong>Lưu ý:</strong> Chỉ sử dụng giỏ hàng của Shop BTC, không tính vào giỏ hàng Main Shop.
                        </small>
                        {% endif %}
                    </div>
                    
                    <!-- Checkbox để tích hợp shop - chỉ hiển thị khi có discount -->
                    {% if registration.tournament.shop_discount_percentage > 0 %}
                    <div class="d-flex align-items-center justify-content-between mb-4 p-3 border rounded bg-light">
                        <label class="fw-bold fs-5 mb-0" for="use_shop_discount_checkbox">
                            <i class="bi bi-cart-plus me-2"></i>Tôi muốn đặt hàng từ shop để được trừ tiền lãi
                        </label>
                        <div class="badge bg-gradient-primary text-white p-3 rounded-pill" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); animation: pulse 2s infinite;">
                            <div class="d-flex align-items-center">
                                <input class="form-check-input me-2" type="checkbox" id="use_shop_discount_checkbox" style="transform: scale(1.3);">
                                <span class="fw-bold">GIẢM {{ registration.tournament.shop_discount_percentage }}%</span>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div id="shop-cart-section" class="shop-cart-section" style="display: none;">
                        {% if registration.tournament.organization %}
                            {# Giải của BTC: Chỉ hiển thị Organization Shop #}
                            {% if org_cart and org_cart.items.exists %}
                            <div class="cart-summary mb-3 p-3 border rounded bg-light">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0"><i class="bi bi-shop me-2"></i>Shop {{ registration.tournament.organization.name }}</h6>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="location.reload()" title="Làm mới giỏ hàng">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                        <a href="{% url 'shop:organization_shop:shop_home' org_slug=registration.tournament.organization.slug %}" target="_blank" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-plus-circle me-1"></i>Thêm sản phẩm
                                        </a>
                                    </div>
                                </div>
                                
                                {% if unavailable_items %}
                                <div class="alert alert-danger mb-3">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <strong>Cảnh báo:</strong> Một số sản phẩm trong giỏ hàng không đủ số lượng:
                                    <ul class="mb-0 mt-2">
                                        {% for item in unavailable_items %}
                                        <li>
                                            <strong>{{ item.product.name }}</strong>: 
                                            Bạn chọn {{ item.requested }} sản phẩm nhưng chỉ còn {{ item.available }} sản phẩm trong kho.
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Vui lòng giảm số lượng hoặc xóa sản phẩm không đủ hàng để được tính giảm giá.
                                    </small>
                                </div>
                                {% endif %}
                                <div class="cart-items">
                                    {% for item in org_cart.items.all %}
                                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white rounded">
                                        <div>
                                            <small class="fw-bold">{{ item.product.name }}</small>
                                            {% if item.size %}<br><small class="text-muted">Size: {{ item.size.name }}</small>{% endif %}
                                        </div>
                                        <div class="text-end">
                                            <small>{{ item.quantity }}x {{ item.product.current_price|floatformat:0 }} VNĐ</small>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <strong>Tổng giỏ hàng:</strong>
                                    <strong class="text-primary">{{ org_cart_total|floatformat:0 }} VNĐ</strong>
                                </div>
                            </div>
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="bi bi-cart-x me-2"></i>
                                Giỏ hàng shop BTC đang trống. 
                                <a href="{% url 'shop:organization_shop:shop_home' org_slug=registration.tournament.organization.slug %}" target="_blank" class="btn btn-sm btn-warning ms-2">
                                    <i class="bi bi-shop me-1"></i>Vào shop BTC
                                </a>
                                <br><small class="text-muted mt-2 d-block">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Sau khi thêm sản phẩm vào giỏ hàng, quay lại tab này và click nút "Làm mới" để cập nhật.
                                </small>
                            </div>
                            {% endif %}
                            
                            {# Quảng cáo Main Shop cho giải của BTC #}
                            <div class="alert alert-secondary mt-3">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <i class="bi bi-info-circle me-2"></i>
                                        <strong>Shop Chính:</strong> Bạn cũng có thể mua sản phẩm từ shop chính của DBP Sports.
                                        <br><small class="text-muted">
                                            <i class="bi bi-exclamation-triangle me-1"></i>
                                            Lưu ý: Sản phẩm từ Shop Chính không được tính vào giảm giá lệ phí đăng ký.
                                        </small>
                                    </div>
                                    <a href="{% url 'shop:home' %}" target="_blank" class="btn btn-sm btn-outline-secondary ms-3">
                                        <i class="bi bi-shop me-1"></i>Xem Shop Chính
                                    </a>
                                </div>
                            </div>
                        {% else %}
                            {# Giải của Admin: Chỉ hiển thị Main Shop #}
                            {% if cart and cart.items.exists %}
                            <div class="cart-summary mb-3 p-3 border rounded bg-light">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0"><i class="bi bi-cart-check me-2"></i>Giỏ hàng của bạn</h6>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="location.reload()" title="Làm mới giỏ hàng">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                        <a href="{% url 'shop:home' %}" target="_blank" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-plus-circle me-1"></i>Thêm sản phẩm
                                        </a>
                                    </div>
                                </div>
                                
                                {% if unavailable_items %}
                                <div class="alert alert-danger mb-3">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <strong>Cảnh báo:</strong> Một số sản phẩm trong giỏ hàng không đủ số lượng:
                                    <ul class="mb-0 mt-2">
                                        {% for item in unavailable_items %}
                                        <li>
                                            <strong>{{ item.product.name }}</strong>: 
                                            Bạn chọn {{ item.requested }} sản phẩm nhưng chỉ còn {{ item.available }} sản phẩm trong kho.
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Vui lòng giảm số lượng hoặc xóa sản phẩm không đủ hàng để được tính giảm giá.
                                    </small>
                                </div>
                                {% endif %}
                                <div class="cart-items">
                                    {% for item in cart.items.all %}
                                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white rounded">
                                        <div>
                                            <small class="fw-bold">{{ item.product.name }}</small>
                                            {% if item.size %}<br><small class="text-muted">Size: {{ item.size.name }}</small>{% endif %}
                                        </div>
                                        <div class="text-end">
                                            <small>{{ item.quantity }}x {{ item.product.current_price|floatformat:0 }} VNĐ</small>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <strong>Tổng giỏ hàng:</strong>
                                    <strong class="text-primary">{{ cart_total|floatformat:0 }} VNĐ</strong>
                                </div>
                            </div>
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="bi bi-cart-x me-2"></i>
                                Giỏ hàng của bạn đang trống. 
                                <a href="{% url 'shop:home' %}" target="_blank" class="btn btn-sm btn-warning ms-2">
                                    <i class="bi bi-shop me-1"></i>Vào shop chọn đồ
                                </a>
                                <br><small class="text-muted mt-2 d-block">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Sau khi thêm sản phẩm vào giỏ hàng, quay lại tab này và click nút "Làm mới" để cập nhật.
                                </small>
                            </div>
                            {% endif %}
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="alert alert-secondary">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Thông báo:</strong> Giải đấu này hiện tại chưa có chương trình giảm giá từ shop.
                        {% if registration.tournament.organization %}
                        <br><small class="text-muted">
                            <i class="bi bi-shop me-1"></i>
                            Tuy nhiên, bạn vẫn có thể mua sản phẩm từ shop của {{ registration.tournament.organization.name }} để ủng hộ BTC.
                        </small>
                        {% endif %}
                    </div>
                    
                    <div class="d-flex gap-2">
                        <a href="{% url 'shop:home' %}" target="_blank" class="btn btn-outline-primary">
                            <i class="bi bi-shop me-2"></i>Vào Shop Chính
                        </a>
                        {% if registration.tournament.organization %}
                        <a href="{% url 'shop:organization_shop:shop_home' org_slug=registration.tournament.organization.slug %}" target="_blank" class="btn btn-outline-success">
                            <i class="bi bi-shop me-2"></i>Vào Shop BTC
                        </a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Step 2: Payment Information -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-bank me-2"></i>Bước 2: Thông tin chuyển khoản
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="payment-info-card p-3 border rounded bg-light">
                                <h6><i class="bi bi-building me-2"></i>Thông tin ngân hàng</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Ngân hàng:</strong> {{ registration.tournament.bank_name|default:"Chưa cập nhật" }}</li>
                                    <li><strong>Số tài khoản:</strong> {{ registration.tournament.bank_account_number|default:"Chưa cập nhật" }}</li>
                                    <li><strong>Chủ tài khoản:</strong> {{ registration.tournament.bank_account_name|default:"Chưa cập nhật" }}</li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="payment-info-card p-3 border rounded bg-light">
                                <h6><i class="bi bi-chat-text me-2"></i>Nội dung chuyển khoản</h6>
                                <div class="bg-white p-2 rounded border">
                                    <code>{{ team.name }} Nop Le Phi Giai {{ registration.tournament.name }}</code>
                                </div>
                                <small class="text-muted">Sao chép nội dung này khi chuyển khoản</small>
                            </div>
                        </div>
                    </div>
                    
                    {% if registration.tournament.payment_qr_code %}
                    <div class="text-center mt-3">
                        <img src="{{ registration.tournament.payment_qr_code.url }}" alt="Mã QR thanh toán" class="img-fluid" style="max-width: 200px;">
                        <p class="text-muted small mt-2">Quét mã QR để chuyển khoản nhanh</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Step 3: Upload Proof -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="bi bi-upload me-2"></i>Bước 3: Tải lên bằng chứng thanh toán
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        {{ form|crispy }}
                        <!-- Hidden field để JavaScript có thể tham chiếu -->
                        <input type="hidden" id="id_use_shop_discount" name="use_shop_discount" value="">
                        
                        <div class="d-grid gap-2 mt-3">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="bi bi-check-circle me-2"></i>Gửi xác nhận thanh toán
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Column: Payment Summary -->
        <div class="col-lg-4">
            <div class="card shadow-sm sticky-top payment-summary-sticky">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-calculator me-2"></i>Tóm tắt thanh toán
                    </h5>
                </div>
                <div class="card-body">
                    <div class="payment-breakdown">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Lệ phí đăng ký:</span>
                            <span class="fw-bold text-primary">{{ registration.tournament.registration_fee|floatformat:0 }} VNĐ</span>
                        </div>
                        
                        <div id="discount-info" class="discount-info" style="display: none;">
                            {% if registration.tournament.organization %}
                                {# Giải của BTC: Chỉ hiển thị Organization Shop discount #}
                                {% if org_discount > 0 %}
                                <div class="d-flex justify-content-between mb-1 text-success">
                                    <span><i class="bi bi-shop me-1"></i>Trừ tiền lãi từ Shop BTC:</span>
                                    <span>-{{ org_discount|floatformat:0 }} VNĐ</span>
                                </div>
                                {% endif %}
                            {% else %}
                                {# Giải của Admin: Chỉ hiển thị Main Shop discount #}
                                {% if main_discount > 0 %}
                                <div class="d-flex justify-content-between mb-1 text-success">
                                    <span><i class="bi bi-shop me-1"></i>Trừ tiền lãi từ Shop Chính:</span>
                                    <span>-{{ main_discount|floatformat:0 }} VNĐ</span>
                                </div>
                                {% endif %}
                            {% endif %}
                            <div class="d-flex justify-content-between mb-2 text-success fw-bold">
                                <span><i class="bi bi-tag me-1"></i>Tổng giảm giá:</span>
                                <span>-<span id="discount-amount">{{ discount_amount|floatformat:0 }}</span> VNĐ</span>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <div class="d-flex justify-content-between fw-bold fs-5">
                            <span>Tổng cần thanh toán:</span>
                            <span class="text-primary" id="final-amount">{{ registration.tournament.registration_fee|floatformat:0 }} VNĐ</span>
                        </div>
                        
                        <div class="alert alert-success mt-3">
                            <i class="bi bi-check-circle me-2"></i>
                            <small>
                                <strong>Thông tin cập nhật:</strong> Lệ phí đăng ký hiện tại là 
                                <strong>{{ registration.tournament.registration_fee|floatformat:0 }} VNĐ</strong> 
                                (đã được BTC cập nhật mới nhất).
                            </small>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            <small>
                                {% if registration.payment_status == 'PENDING' %}
                                    Bạn có thể cập nhật hóa đơn thanh toán. Trạng thái sẽ vẫn là "Chờ xác nhận".
                                {% else %}
                                    Sau khi gửi, trạng thái thanh toán sẽ chuyển thành "Chờ xác nhận".
                                {% endif %}
                            </small>
                        </div>
                        {% if registration.tournament.shop_discount_percentage > 0 %}
                        <div class="alert alert-success">
                            <i class="bi bi-shop me-2"></i>
                            <small>
                                <strong>Mẹo:</strong> Đặt hàng từ shop để được giảm giá! 
                                Shop sẽ mở trong tab mới để bạn không mất form này.
                            </small>
                        </div>
                        {% else %}
                        <div class="alert alert-secondary">
                            <i class="bi bi-shop me-2"></i>
                            <small>
                                <strong>Thông báo:</strong> Giải đấu này chưa có chương trình giảm giá từ shop.
                                {% if registration.tournament.organization %}
                                Tuy nhiên, bạn vẫn có thể mua sản phẩm từ shop BTC để ủng hộ ban tổ chức.
                                {% endif %}
                            </small>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="d-grid gap-2">
                        <a href="{% url 'team_detail' pk=team.pk %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-2"></i>Quay lại đội bóng
                        </a>
                        {% if registration.tournament.shop_discount_percentage > 0 %}
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-secondary" onclick="location.reload()" title="Làm mới trang và giỏ hàng">
                                <i class="bi bi-arrow-clockwise me-2"></i>Làm mới
                            </button>
                            {% if registration.tournament.organization %}
                                {# Giải của BTC: Dẫn đến Organization Shop #}
                                <a href="{% url 'shop:organization_shop:shop_home' org_slug=registration.tournament.organization.slug %}" target="_blank" class="btn btn-outline-primary">
                                    <i class="bi bi-shop me-2"></i>Vào shop BTC
                                </a>
                            {% else %}
                                {# Giải của Admin: Dẫn đến Main Shop #}
                                <a href="{% url 'shop:home' %}" target="_blank" class="btn btn-outline-primary">
                                    <i class="bi bi-shop me-2"></i>Vào shop chọn đồ
                                </a>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-secondary" onclick="location.reload()" title="Làm mới trang và giỏ hàng">
                                <i class="bi bi-arrow-clockwise me-2"></i>Làm mới
                            </button>
                            {% if registration.tournament.organization %}
                                {# Giải của BTC: Dẫn đến Organization Shop #}
                                <a href="{% url 'shop:organization_shop:shop_home' org_slug=registration.tournament.organization.slug %}" target="_blank" class="btn btn-outline-success">
                                    <i class="bi bi-shop me-2"></i>Vào shop BTC
                                </a>
                            {% else %}
                                {# Giải của Admin: Dẫn đến Main Shop #}
                                <a href="{% url 'shop:home' %}" target="_blank" class="btn btn-outline-primary">
                                    <i class="bi bi-shop me-2"></i>Vào Shop Chính
                                </a>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
    
    <script>
    // Shop Discount Toggle - Simple & Clean Implementation
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🏪 Shop Discount Toggle initialized');
        
        // Elements
        const checkbox = document.getElementById('use_shop_discount_checkbox');
        const hiddenField = document.getElementById('id_use_shop_discount');
        const shopSection = document.getElementById('shop-cart-section');
        const discountInfo = document.getElementById('discount-info');
        const discountAmount = document.getElementById('discount-amount');
        const finalAmount = document.getElementById('final-amount');
        
        // Data - Force refresh from server
        const originalFee = parseFloat('{{ registration.tournament.registration_fee|default:0 }}') || 0;
        const currentDiscountAmount = parseFloat('{{ discount_amount|default:0 }}') || 0;
        const currentFinalFee = parseFloat('{{ final_fee|default:0 }}') || 0;
        const mainDiscount = parseFloat('{{ main_discount|default:0 }}') || 0;
        const orgDiscount = parseFloat('{{ org_discount|default:0 }}') || 0;
        const cartTotal = parseFloat('{{ cart_total|default:0 }}') || 0;
        const orgCartTotal = parseFloat('{{ org_cart_total|default:0 }}') || 0;
        
        // Debug: Log current values
        console.log('🔄 Payment page loaded with fresh data:');
        console.log('Tournament ID:', '{{ registration.tournament.pk }}');
        console.log('Registration fee:', originalFee);
        console.log('Discount amount:', currentDiscountAmount);
        console.log('Final fee:', currentFinalFee);
        
        // Check for unavailable items
        const unavailableItems = {{ unavailable_items|length|default:0 }};
        if (unavailableItems > 0) {
            console.log('⚠️ Warning: Some items in cart have insufficient stock');
            console.log('Unavailable items count:', unavailableItems);
        }
        
        console.log('📊 Data values:');
        console.log('Original fee:', originalFee);
        console.log('Main discount:', mainDiscount);
        console.log('Org discount:', orgDiscount);
        console.log('Total discount amount:', currentDiscountAmount);
        console.log('Final fee:', currentFinalFee);
        console.log('Shop discount percentage:', parseFloat('{{ registration.tournament.shop_discount_percentage|default:0 }}') || 0);
        console.log('Main cart total:', cartTotal);
        console.log('Org cart total:', orgCartTotal);
        
        // Storage key
        const storageKey = 'shop_discount_{{ registration.pk|default:0 }}';
        
        // Debug all elements
        console.log('🔍 Debugging elements:');
        console.log('Checkbox:', checkbox);
        console.log('Hidden field:', hiddenField);
        console.log('Shop section:', shopSection);
        console.log('Discount info:', discountInfo);
        console.log('Discount amount:', discountAmount);
        console.log('Final amount:', finalAmount);
        
        // Check if elements exist
        if (!checkbox) {
            console.log('ℹ️ Checkbox not found - tournament has no shop discount');
            console.log('Shop discount percentage:', parseFloat('{{ registration.tournament.shop_discount_percentage|default:0 }}') || 0);
            // Không return, tiếp tục với logic khác
        }
        
        if (!hiddenField) {
            console.error('❌ Hidden field not found');
            console.log('Available hidden fields:', document.querySelectorAll('input[type="hidden"]'));
            return;
        }
        
        console.log('✅ All elements found');
        
        // Update banner with cart totals
        function updateBanner() {
            const bannerProductCount = document.getElementById('banner-product-count');
            const bannerTotalAmount = document.getElementById('banner-total-amount');
            
            if (bannerProductCount && bannerTotalAmount) {
                {% if registration.tournament.organization %}
                    {# Giải của BTC: Chỉ hiển thị Organization Shop #}
                    const orgCartCount = parseFloat('{{ org_cart.items.count|default:0 }}') || 0;
                    const totalProducts = orgCartCount;
                    const totalAmount = orgCartTotal;
                {% else %}
                    {# Giải của Admin: Chỉ hiển thị Main Shop #}
                    const mainCartCount = parseFloat('{{ cart.items.count|default:0 }}') || 0;
                    const totalProducts = mainCartCount;
                    const totalAmount = cartTotal;
                {% endif %}
                
                bannerProductCount.textContent = totalProducts;
                bannerTotalAmount.textContent = totalAmount.toLocaleString();
                
                console.log('📊 Banner updated:', { 
                    totalProducts, 
                    totalAmount 
                });
            }
        }
        
        // Update display based on checkbox state
        function updateDisplay() {
            const isChecked = checkbox.checked;
            
            console.log(`🔄 Updating display: ${isChecked ? 'ON' : 'OFF'}`);
            console.log('🔍 Checkbox state in updateDisplay:', checkbox.checked);
            
            // Update hidden field
            hiddenField.value = isChecked ? 'on' : '';
            
            // Update UI
            if (isChecked) {
                // Always show shop section when checkbox is checked
                if (shopSection) shopSection.style.display = 'block';
                
                // Update banner with cart totals
                updateBanner();
                
                // Check if there's any discount available
                const hasAnyDiscount = currentDiscountAmount > 0;
                
                if (hasAnyDiscount) {
                    // Show discount info
                    if (discountInfo) discountInfo.style.display = 'block';
                    if (discountAmount) discountAmount.textContent = currentDiscountAmount.toLocaleString();
                    if (finalAmount) finalAmount.textContent = currentFinalFee.toLocaleString();
                    
                    console.log('✅ Showing discount:', currentDiscountAmount);
                } else {
                    // Hide discount info but keep shop section visible
                    if (discountInfo) discountInfo.style.display = 'none';
                    if (discountAmount) discountAmount.textContent = '0';
                    if (finalAmount) finalAmount.textContent = originalFee.toLocaleString();
                    
                    console.log('⚠️ No discount available');
                }
            } else {
                // Hide everything when checkbox is unchecked
                if (shopSection) shopSection.style.display = 'none';
                if (discountInfo) discountInfo.style.display = 'none';
                if (discountAmount) discountAmount.textContent = '0';
                if (finalAmount) finalAmount.textContent = originalFee.toLocaleString();
                
                console.log('❌ Checkbox unchecked, hiding all');
            }
            
            console.log('🔍 Checkbox state after updateDisplay:', checkbox.checked);
        }
        
        // Restore state from localStorage
        const savedState = localStorage.getItem(storageKey);
        console.log('🔍 localStorage savedState:', savedState);
        console.log('🔍 Checkbox initial state:', checkbox.checked);
        
        if (savedState === 'true') {
            checkbox.checked = true;
            console.log('📱 Restored checkbox state from localStorage');
        }
        
        console.log('🔍 Checkbox after restore:', checkbox.checked);
        
        // Apply initial state
        updateDisplay();
        
        // Verify checkbox state after initialization
        setTimeout(() => {
            console.log('🔍 Final checkbox state after init:', checkbox.checked);
            console.log('🔍 Final hidden field value:', hiddenField.value);
        }, 100);
        
        // Listen for checkbox changes - chỉ khi checkbox tồn tại
        if (checkbox) {
            checkbox.addEventListener('change', function() {
            console.log(`🎯 Checkbox changed: ${this.checked}`);
            console.log('Hidden field before update:', hiddenField.value);
            
            // Force update hidden field immediately
            hiddenField.value = this.checked ? 'on' : '';
            console.log('Hidden field after immediate update:', hiddenField.value);
            
            // Add visual feedback
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = 'scale(1)';
            }, 150);
            
            // Save to localStorage
            localStorage.setItem(storageKey, this.checked.toString());
            
            // Update display with animation
            updateDisplay();
            
            console.log('Hidden field after update:', hiddenField.value);
            
            // Show feedback message
            if (this.checked) {
                if (unavailableItems > 0) {
                    showToast('Cảnh báo: Một số sản phẩm không đủ hàng! Giảm giá có thể không được áp dụng.', 'warning');
                } else {
                    showToast('Đã bật giảm giá từ shop!', 'success');
                }
            } else {
                showToast('Đã tắt giảm giá từ shop', 'info');
            }
            });
        }
        
        // Clear localStorage on form submit
        const form = document.querySelector('form[method="post"]');
        if (form) {
            form.addEventListener('submit', function(e) {
                console.log('📤 Form submitted');
                console.log('Checkbox checked:', checkbox.checked);
                console.log('Hidden field value:', hiddenField.value);
                
                // Debug form data
                const formData = new FormData(form);
                console.log('Form data:');
                for (let [key, value] of formData.entries()) {
                    console.log(`  ${key}: ${value}`);
                }
                
                // Ensure hidden field is set before submit
                if (checkbox.checked && hiddenField.value !== 'on') {
                    console.log('⚠️ Fixing hidden field value before submit');
                    hiddenField.value = 'on';
                }
                
                localStorage.removeItem(storageKey);
            });
        }
        
        // Refresh cart data when returning from shop
        function refreshCartData() {
            console.log('🔄 Refreshing cart data...');
            console.log('🔍 Checkbox state before refresh:', checkbox.checked);
            
            // Add loading state
            document.body.classList.add('loading');
            
            fetch('{% url "calculate_shop_discount" tournament_pk=registration.tournament.pk|default:0 %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('✅ Cart data refreshed:', data);
                    console.log('🔍 Checkbox state after refresh:', checkbox.checked);
                    
                    // Update display if checkbox is checked
                    if (checkbox.checked) {
                        updateDisplay();
                    }
                    
                    // Show success message
                    showToast('Giỏ hàng đã được cập nhật!', 'success');
                } else {
                    console.error('❌ Failed to refresh cart data');
                    showToast('Không thể cập nhật giỏ hàng', 'error');
                }
            })
            .catch(error => {
                console.error('❌ Error refreshing cart:', error);
                showToast('Lỗi khi cập nhật giỏ hàng', 'error');
            })
            .finally(() => {
                // Remove loading state
                document.body.classList.remove('loading');
                console.log('🔍 Checkbox state after refresh complete:', checkbox.checked);
            });
        }
        
        // Simple toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'info'} position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
            `;
            
            document.body.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // Auto-refresh when returning from shop
        if (window.location.search.includes('shop_return=true')) {
            setTimeout(() => {
                console.log('🔄 Auto-refreshing cart data...');
                refreshCartData();
            }, 1000);
        }
        
        // Refresh on focus (when returning from shop) - only if checkbox is checked
        let hasLeftPage = false;
        window.addEventListener('blur', () => hasLeftPage = true);
        window.addEventListener('focus', () => {
            if (hasLeftPage && checkbox.checked) {
                console.log('🔄 User returned from shop, refreshing...');
                console.log('🔍 Checkbox state before focus refresh:', checkbox.checked);
                refreshCartData();
            }
        });
        
        // Monitor checkbox state changes
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'attributes' && mutation.attributeName === 'checked') {
                    console.log('🔍 Checkbox checked attribute changed:', checkbox.checked);
                }
            });
        });
        
        observer.observe(checkbox, { attributes: true, attributeFilter: ['checked'] });
        
        console.log('🎉 Shop Discount Toggle ready!');
    });
    </script>

    <style>
    .hero-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .payment-info-card {
        transition: transform 0.2s ease-in-out;
    }
    
    .payment-info-card:hover {
        transform: translateY(-2px);
    }
    
    .cart-items .bg-white {
        transition: background-color 0.2s ease-in-out;
    }
    
    .cart-items .bg-white:hover {
        background-color: #f8f9fa !important;
    }
    
    .sticky-top {
        position: sticky;
        top: 80px;
        z-index: 1010;
        transition: all 0.2s ease;
        will-change: transform;
    }
    
    @media (max-width: 768px) {
        .sticky-top {
            position: relative;
            top: auto;
            z-index: auto;
        }
        
        .payment-summary-sticky {
            position: relative !important;
            top: auto !important;
            z-index: auto !important;
        }
    }
    
    .payment-breakdown {
        font-size: 0.95rem;
    }
    
    .payment-breakdown hr {
        margin: 1rem 0;
    }
    
    .btn-lg {
        padding: 0.75rem 1.5rem;
        font-size: 1.1rem;
    }
    
    .stats-box {
        backdrop-filter: blur(10px);
    }
    
    .card {
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        transition: box-shadow 0.15s ease-in-out;
    }
    </style>
</div>


{% endblock %}