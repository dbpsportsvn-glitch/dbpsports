{% extends "base.html" %}
{% block title %}Giải đấu · DBP Sports{% endblock %}
{% block content %}
<style>
  .tour-card .card-img-top {
    height: 180px;
    object-fit: cover;
  }
  .admin-tournament-card {
    border: 2px solid #FFC107;
    box-shadow: 0 0 15px rgba(255, 193, 7, 0.5) !important;
  }
</style>

<div class="pb-3 mb-4 border-bottom d-flex justify-content-between align-items-center">
  <h1 class="h3 m-0">Giải đấu</h1>
</div>

<div class="card card-body mb-4">
  <form method="get" class="row g-3 align-items-center">
    <div class="col-md-5">
      <label for="regionFilter" class="form-label">Lọc theo Khu vực</label>
      <select name="region" id="regionFilter" class="form-select">
        <option value="">Tất cả khu vực</option>
        {% for region_value, region_name in all_regions %}
          <option value="{{ region_value }}" {% if region_value == current_region %}selected{% endif %}>{{ region_name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-5">
      <label for="orgFilter" class="form-label">Lọc theo Đơn vị Tổ chức</label>
      <select name="org" id="orgFilter" class="form-select">
        <option value="">Tất cả đơn vị</option>
        {% for org in all_organizations %}
          <option value="{{ org.id }}" {% if org.id|stringformat:"s" == current_org %}selected{% endif %}>{{ org.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2 mt-auto">
      <button type="submit" class="btn btn-primary w-100">Tìm kiếm</button>
    </div>
  </form>
</div>

{% if tournaments %}
  <div class="row row-cols-1 row-cols-md-3 g-3">
    {% for t in tournaments %}
      <div class="col">
        <div class="card h-100 shadow-sm tour-card d-flex flex-column {% if not t.organization %}admin-tournament-card{% endif %}">
          {% if t.image %}
            <img class="card-img-top" src="{{ t.image.url }}" alt="{{ t.name }}">
          {% endif %}

          <div class="card-body flex-grow-1">
            <h5 class="card-title mb-2 text-start">{{ t.name }}</h5>
            <p class="mb-2 text-muted">
              <span class="badge bg-info text-dark me-2">{{ t.get_region_display }}</span>
              <span class="d-inline-flex align-items-center gap-2">
                {% if t.organization and t.organization.logo %}
                  <img src="{{ t.organization.logo.url }}" alt="{{ t.organization.name }}" style="width: 20px; height: 20px; object-fit: contain; border-radius: 4px;">
                {% endif %}
                <span class="small badge bg-secondary px-2 py-1">
                  BTC: 
                  <span {% if not t.organization %}class="text-warning fw-bold"{% endif %}>
                    {% if t.organization %}{{ t.organization.name }}{% else %}DBP Sports{% endif %}
                  </span>
                </span>
              </span>
            </p>
            <p class="mb-2 text-muted">
              {{ t.start_date|date:"d/m/Y" }} – {{ t.end_date|date:"d/m/Y" }}
              <span class="badge bg-success ms-2">{{ t.get_status_display }}</span>
            </p>
          </div>

          <div class="card-footer bg-white border-0 pt-0 mt-auto">
            <div class="d-flex gap-2">
              <a class="btn btn-primary btn-sm" href="{% url 'tournament_detail' pk=t.pk %}">Xem chi tiết</a>
              
              {% if t.status == "REGISTRATION_OPEN" %}
                <a class="btn btn-outline-success btn-sm" href="{% url 'create_team' tournament_pk=t.pk %}">Đăng ký</a>
              {% endif %}

              {% if user.is_authenticated %}
                {% if t.id in followed_tournament_ids %}
                    <button class="btn btn-outline-success btn-sm btn-follow active" data-tournament-id="{{ t.pk }}">
                        <i class="bi bi-check-circle-fill"></i> Đang theo dõi
                    </button>
                {% else %}
                    <button class="btn btn-outline-secondary btn-sm btn-follow" data-tournament-id="{{ t.pk }}">
                        <i class="bi bi-bell"></i> Theo dõi
                    </button>
                {% endif %}
              {% else %}
                {# Nút Theo dõi cho khách, nhấn vào sẽ chuyển đến trang đăng nhập #}
                <a href="{% url 'account_login' %}?next={{ request.path }}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-bell"></i> Theo dõi
                </a>
              {% endif %}
              
              <button class="btn btn-outline-info btn-sm btn-share" data-url="{{ request.scheme }}://{{ request.get_host }}{{ t.get_absolute_url }}" data-title="{{ t.name }}">
                  <i class="bi bi-share"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <p class="text-muted">Không tìm thấy giải đấu nào phù hợp với tiêu chí của bạn.</p>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Hàm để lấy CSRF token từ cookie (cách làm an toàn và đúng chuẩn)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // --- Xử lý nút Theo dõi (chỉ dành cho người đã đăng nhập) ---
    document.querySelectorAll('.btn-follow').forEach(button => {
        button.addEventListener('click', function (event) {
            event.preventDefault(); // Ngăn hành vi mặc định của thẻ <a>
            const tournamentId = this.dataset.tournamentId;
            const csrftoken = getCookie('csrftoken');

            if (!csrftoken) {
                // Nếu không tìm thấy token (người dùng chưa đăng nhập), chuyển đến trang login
                window.location.href = "{% url 'account_login' %}?next=" + window.location.pathname;
                return;
            }

            fetch(`/tournament/${tournamentId}/toggle_follow/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            })
            .then(response => {
                if (!response.ok) { // Nếu có lỗi như 403 Forbidden
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'ok') {
                    if (data.is_following) {
                        this.classList.add('active', 'btn-outline-success');
                        this.classList.remove('btn-outline-secondary');
                        this.innerHTML = '<i class="bi bi-check-circle-fill"></i> Đang theo dõi';
                    } else {
                        this.classList.remove('active', 'btn-outline-success');
                        this.classList.add('btn-outline-secondary');
                        this.innerHTML = '<i class="bi bi-bell"></i> Theo dõi';
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Nếu có lỗi, cũng chuyển hướng đến trang đăng nhập
                window.location.href = "{% url 'account_login' %}?next=" + window.location.pathname;
            });
        });
    });

    // --- Xử lý nút Chia sẻ ---
    document.querySelectorAll('.btn-share').forEach(button => {
        button.addEventListener('click', async function () {
            const url = this.dataset.url;
            const title = this.dataset.title;

            if (navigator.share) {
                try {
                    await navigator.share({
                        title: title,
                        text: `Xem thông tin giải đấu ${title} trên DBP Sports!`,
                        url: url,
                    });
                } catch (err) {
                    console.error('Lỗi khi chia sẻ:', err);
                }
            } else {
                try {
                    await navigator.clipboard.writeText(url);
                    const originalText = this.innerHTML;
                    this.innerHTML = '<i class="bi bi-check-lg"></i> Đã sao chép!';
                    setTimeout(() => {
                        this.innerHTML = originalText;
                    }, 2000);
                } catch (err) {
                    alert('Không thể sao chép link. Vui lòng sao chép thủ công.');
                }
            }
        });
    });
});
</script>

{% endblock %}