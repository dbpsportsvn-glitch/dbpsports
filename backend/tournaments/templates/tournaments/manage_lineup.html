{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Quản lý Đội hình - {{ team.name }}{% endblock %}

{% block extra_css %}
<style>
  .lineup-builder{display:flex;gap:2rem;align-items:flex-start}

  /* Pitch */
  .pitch{
    background:#28a745;
    background-image:
      linear-gradient(to right, rgba(255,255,255,.08) 1px, transparent 1px),
      linear-gradient(to bottom, rgba(255,255,255,.08) 1px, transparent 1px);
    background-size:20px 20px;
    border:2px solid #fff;border-radius:12px;
    aspect-ratio:7/5;position:relative;flex-grow:1;
    display:grid;grid-template-rows:repeat(5,1fr);padding:10px;
    box-shadow:0 8px 24px rgba(0,0,0,.12);
    width:100%;max-width:100%;
  }
  .pitch::before{
    content:"";position:absolute;inset:0;
    background:radial-gradient(circle at 50% 50%, rgba(255,255,255,.2) 0, rgba(255,255,255,.2) 1px, transparent 2px) no-repeat;
    background-size:120px 120px;background-position:center;pointer-events:none;
  }
  .pitch-row{display:flex;justify-content:space-around;align-items:center;gap:8px}
  .position-slot{
    width:72px;height:88px;border:2px dashed rgba(255,255,255,0.45);
    border-radius:10px;display:flex;align-items:center;justify-content:center;
    position:relative;isolation:isolate;transition:transform .1s,border-color .1s;
    cursor:pointer;
  }
  .position-slot::after{
    content:attr(data-position);
    position:absolute;bottom:-22px;left:50%;transform:translateX(-50%);
    font-size:.75rem;color:#fff;opacity:.9;font-weight:700;text-shadow:0 1px 1px rgba(0,0,0,.25);
    pointer-events:none; /* không chặn click */
  }
  .position-slot.occupied{border-style:solid}
  .position-slot.slot-active{outline:3px solid #ffc107;transform:scale(1.02);border-color:#fff}

  /* Bench */
  .bench{width:320px;flex-shrink:0;background:#f8f9fa;padding:1rem;border-radius:12px;height:600px;overflow:auto;border:1px solid #eee}
  .bench-toolbar{display:flex;gap:.5rem;align-items:center;margin-bottom:.75rem}
  .bench-toolbar input{flex:1}

  /* Player token */
  .player-token{
    background:#fff;border:1px solid #e5e7eb;border-radius:10px;
    padding:.5rem .625rem;margin-bottom:.5rem;
    display:flex;align-items:center;gap:.75rem;
    box-shadow:0 2px 6px rgba(0,0,0,.08);
    position:relative;user-select:none;cursor:pointer;
  }
  .player-token.is-starter{background:#e9f5ff;border-color:#0d6efd}
  .player-token.token-active{outline:3px solid #ffc107}
  .player-token *{-webkit-user-drag:none}
  .player-avatar{width:40px;height:40px;border-radius:50%;object-fit:cover}
  .player-name{font-weight:700;line-height:1.1}
  .player-meta{font-size:.8rem;color:#6c757d}
  .jersey-number{
    position:absolute;top:-6px;left:-6px;background:#0d6efd;color:#fff;
    width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;
    font-size:.8rem;font-weight:800;border:2px solid #fff;box-shadow:0 2px 6px rgba(13,110,253,.45)
  }

  .legend{display:flex;gap:.5rem;align-items:center;color:#555}
  .legend .dot{width:10px;height:10px;border-radius:50%;display:inline-block}
  .dot-starter{background:#0d6efd}.dot-bench{background:#adb5bd}

  @media (max-width: 991px){
    .lineup-builder{flex-direction:column;gap:1rem}
    .bench{width:100%;height:auto;max-height:60vh}
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <a href="{% url 'match_detail' pk=match.pk %}" class="btn btn-link p-0 mb-3">← Về trận đấu</a>
  <h3 class="mb-1">Đăng ký đội hình thi đấu</h3>
  <p class="lead">
    <strong>Trận đấu:</strong> {{ match.team1.name }} vs {{ match.team2.name }}
    | <strong>Đội của bạn:</strong> {{ team.name }}
  </p>

  <!-- Thanh điều khiển: dropdown + Save + (Xóa đội hình) + Trả về ghế + checkbox -->
  <div class="d-flex gap-2 align-items-end flex-wrap mb-2">
    <div style="max-width:260px;">
      <label for="player-count-select" class="form-label fw-bold">Số lượng cầu thủ trên sân</label>
      <select class="form-select" id="player-count-select">
        <option value="11">11 người (Sân lớn)</option>
        <option value="10">10 người</option>
        <option value="9">9 người</option>
        <option value="8">8 người</option>
        <option value="7" selected>7 người (Phổ biến)</option>
        <option value="6">6 người</option>
      </select>
    </div>

    <div class="d-flex gap-2">
      <button id="save-lineup-btn" class="btn btn-primary"><i class="bi bi-save-fill"></i> Lưu đội hình</button>
      <!-- Đã đổi vị trí: đưa XÓA ĐỘI HÌNH lên đây -->
      <button id="clear-lineup" class="btn btn-outline-secondary">Xóa đội hình</button>
      <button id="send-to-bench-btn" class="btn btn-outline-secondary" disabled>Trả về ghế</button>
    </div>

    <div class="form-check ms-2">
      <input class="form-check-input" type="checkbox" id="include-bench-as-subs">
      <label class="form-check-label" for="include-bench-as-subs">Lưu cầu thủ còn lại làm dự bị</label>
    </div>

    <div class="legend ms-auto">
      <span class="badge text-bg-light">Đá chính: <span id="starter-count">0</span>/<span id="starter-max">7</span></span>
      <span class="dot dot-starter"></span> đá chính
      <span class="dot dot-bench"></span> dự bị
    </div>
  </div>

  <p class="text-muted">Nhấp chọn cầu thủ, rồi nhấp ô trên sân để đặt (nhấp vào ô đã có người để đổi chỗ). Không cần kéo-thả.</p>

  <div class="lineup-builder mt-2">
    <!-- Sân đảo ngược: FW trên cùng, GK dưới cùng -->
    <div class="pitch shadow">
      <div class="pitch-row"><div id="slot-11" class="position-slot" data-position="FW"></div></div>
      <div class="pitch-row">
        <div id="slot-9" class="position-slot" data-position="FW"></div>
        <div id="slot-10" class="position-slot" data-position="FW"></div>
      </div>
      <div class="pitch-row">
        <div id="slot-6" class="position-slot" data-position="MF"></div>
        <div id="slot-7" class="position-slot" data-position="MF"></div>
        <div id="slot-8" class="position-slot" data-position="MF"></div>
      </div>
      <div class="pitch-row">
        <div id="slot-2" class="position-slot" data-position="DF"></div>
        <div id="slot-3" class="position-slot" data-position="DF"></div>
        <div id="slot-4" class="position-slot" data-position="DF"></div>
        <div id="slot-5" class="position-slot" data-position="DF"></div>
      </div>
      <div class="pitch-row"><div id="slot-1" class="position-slot" data-position="GK"></div></div>
    </div>

    <!-- Bench -->
    <div class="bench shadow-sm">
      <div class="bench-toolbar">
        <input id="search-player" class="form-control" placeholder="Tìm theo tên / vị trí...">
        <!-- Đã đổi vị trí: BỎ LỌC chuyển xuống đây -->
        <button id="clear-bench-filters" class="btn btn-light btn-sm" type="button">Bỏ lọc</button>
      </div>
      <h6 class="mb-2">Danh sách cầu thủ (<span id="player-count">{{ team.players.all|length }}</span>)</h6>
      <div id="bench-list">
        {% for player in team.players.all %}
        <div class="player-token"
             data-player-id="{{ player.pk }}"
             data-pos="{{ player.position|default_if_none:'' }}">
          <div class="jersey-number">{{ player.jersey_number }}</div>
          <img src="{% if player.avatar %}{{ player.avatar.url }}{% else %}https://via.placeholder.com/40{% endif %}"
               alt="{{ player.full_name }}" class="player-avatar">
          <div>
            <div class="player-name">{{ player.full_name }}</div>
            <div class="player-meta">{{ player.get_position_display }}</div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- form submit ẩn -->
  <form id="lineup-form" method="post" class="d-none">
    {% csrf_token %}
    <input type="hidden" name="starters" id="starters-input">
    <input type="hidden" name="substitutes" id="substitutes-input">
  </form>
</div>

<!-- JSON preload an toàn -->
<script id="existing-lineup-json" type="application/json">{{ existing_lineup_json|safe }}</script>

<!-- JS: click-to-place với event delegation + lưu đúng starters/substitutes -->
<script>
(function(){
  const $  = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));

  const playerCountSelect = $('#player-count-select');
  const benchList         = $('#bench-list');
  const pitch             = $('.pitch');
  const saveBtn           = $('#save-lineup-btn');
  const startersInput     = $('#starters-input');
  const substitutesInput  = $('#substitutes-input');
  const lineupForm        = $('#lineup-form');
  const starterCountEl    = $('#starter-count');
  const starterMaxEl      = $('#starter-max');
  const clearLineupBtn    = $('#clear-lineup');
  const searchInput       = $('#search-player');
  const clearBenchBtn     = $('#clear-bench-filters');
  const sendToBenchBtn    = $('#send-to-bench-btn');
  const includeBenchCbx   = $('#include-bench-as-subs');

  // slot theo thứ tự slot-1..slot-11 (không phụ thuộc DOM order)
  const allSlots = $$('.position-slot')
    .sort((a,b)=>parseInt(a.id.split('-')[1]) - parseInt(b.id.split('-')[1]));

  function readJSON(id){
    try{ return JSON.parse($(id).textContent||'{}'); }
    catch{ return {starters:[], substitutes:[]} }
  }
  const existing = readJSON('#existing-lineup-json');

  let selectedToken = null; // cầu thủ đang chọn
  let activeSlot    = null; // slot được chọn làm đích

  function setTokenActive(t,on){
    if(!t) return;
    t.classList.toggle('token-active', !!on);
    // bật nút "Trả về ghế" khi đang chọn cầu thủ ở trên sân
    sendToBenchBtn && (sendToBenchBtn.disabled = !(on && t.parentElement?.classList.contains('position-slot')));
  }
  function setSlotActive(s,on){
    if(!s) return;
    s.classList.toggle('slot-active', !!on);
  }
  function deselectAll(){
    setTokenActive(selectedToken,false); selectedToken=null;
    setSlotActive(activeSlot,false);     activeSlot=null;
    if(sendToBenchBtn) sendToBenchBtn.disabled = true;
  }
  function updateStarterClass(token){
    if(!token) return;
    const onPitch = token.parentElement?.classList.contains('position-slot') &&
                    token.parentElement.style.display !== 'none';
    token.classList.toggle('is-starter', onPitch);
  }
  function updateCounters(){
    const starters = allSlots.filter(s=>s.style.display !== 'none' && s.firstElementChild);
    starterCountEl.textContent = starters.length;
    starterMaxEl.textContent   = parseInt(playerCountSelect.value,10);
    allSlots.forEach(s=>s.classList.toggle('occupied', !!s.firstElementChild));
  }
  function moveToBench(token){
    if(!token) return;
    benchList.appendChild(token);
    updateStarterClass(token);
    updateCounters();
  }
  function placeTokenInSlot(token, slot){
    if(!token || !slot) return;
    const fromSlot = token.parentElement?.classList.contains('position-slot') ? token.parentElement : null;
    if(!slot.firstElementChild){
      slot.appendChild(token);
    }else{
      const other = slot.firstElementChild;
      if(fromSlot) fromSlot.appendChild(other); else benchList.appendChild(other);
      slot.appendChild(token);
    }
    updateStarterClass(token);
    updateStarterClass(slot.firstElementChild);
    updateCounters();
  }

  // ------- BENCH: event delegation -------
  benchList.addEventListener('click', (e)=>{
    const token = e.target.closest('.player-token');
    if(!token) return;

    // Nếu đang chọn 1 cầu thủ trên SÂN và bấm 1 cầu thủ GHẾ => HOÁN ĐỔI
    if (selectedToken && selectedToken.parentElement?.classList.contains('position-slot')) {
      const fromSlot = selectedToken.parentElement;
      placeTokenInSlot(token, fromSlot); // selectedToken sẽ tự về bench trong placeTokenInSlot
      deselectAll();
      return;
    }

    // Chỉ chọn token ở ghế
    if(selectedToken === token){ deselectAll(); return; }
    setTokenActive(selectedToken,false);
    selectedToken = token;
    setTokenActive(selectedToken,true);

    // Nếu đã đánh dấu sẵn 1 slot đích -> đặt luôn
    if(activeSlot){
      placeTokenInSlot(selectedToken, activeSlot);
      deselectAll();
    }
  });

  // ------- PITCH: event delegation -------
  pitch.addEventListener('click', (e)=>{
    const slot = e.target.closest('.position-slot');
    if(!slot) return;

    // Nếu đã chọn 1 cầu thủ (từ ghế hoặc slot khác) -> coi slot này là ĐÍCH, hoán đổi nếu có người
    if (selectedToken){
      placeTokenInSlot(selectedToken, slot);
      deselectAll();
      return;
    }

    // Chưa chọn ai:
    if (slot.firstElementChild){ // chọn người trong slot để đổi chỗ/trả ghế
      setTokenActive(selectedToken,false);
      selectedToken = slot.firstElementChild;
      setTokenActive(selectedToken,true);
      setSlotActive(activeSlot,false); activeSlot = null;
    } else { // slot trống -> đánh dấu làm đích chờ chọn cầu thủ
      if(activeSlot === slot){ setSlotActive(activeSlot,false); activeSlot=null; }
      else { setSlotActive(activeSlot,false); activeSlot=slot; setSlotActive(activeSlot,true); }
    }
  });

  // ------- Nút "Trả về ghế" -------
  sendToBenchBtn?.addEventListener('click', ()=>{
    if(selectedToken && selectedToken.parentElement?.classList.contains('position-slot')){
      moveToBench(selectedToken);
      deselectAll();
    }
  });

  // ------- Tìm kiếm bench -------
  function applySearch(){
    const q = (searchInput?.value||'').trim().toLowerCase();
    benchList.querySelectorAll('.player-token').forEach(t=>{
      const name = t.querySelector('.player-name')?.textContent?.toLowerCase()||'';
      const pos  = (t.dataset.pos||'').toLowerCase();
      t.style.display = (!q || name.includes(q) || pos.includes(q)) ? '' : 'none';
    });
  }
  searchInput?.addEventListener('input', applySearch);
  clearBenchBtn?.addEventListener('click', ()=>{ searchInput.value=''; applySearch(); });

  // ------- Xóa đội hình (đưa hết về ghế) -------
  clearLineupBtn?.addEventListener('click', ()=>{
    allSlots.forEach(s=>{ if(s.firstElementChild) benchList.appendChild(s.firstElementChild); });
    deselectAll(); updateCounters();
  });

  // ------- Đổi số người -> ẩn/hiện slot theo slot-1↑ -------
  function updatePitchLayout(){
    const maxPlayers = parseInt(playerCountSelect.value,10);
    allSlots.forEach((slot, idx)=>{
      if(idx >= maxPlayers && slot.firstElementChild) moveToBench(slot.firstElementChild);
    });
    allSlots.forEach((slot, idx)=>{ slot.style.display = idx < maxPlayers ? '' : 'none'; });
    starterMaxEl.textContent = maxPlayers;
    updateCounters();
  }
  playerCountSelect.addEventListener('change', ()=>{ updatePitchLayout(); deselectAll(); });

  // ------- Lưu đội hình -------
  saveBtn?.addEventListener('click', ()=>{
    const starters    = [];
    const substitutes = [];

    // gom đá chính: chỉ các slot đang HIỆN và có người
    allSlots.forEach(slot=>{
      if(slot.style.display !== 'none' && slot.firstElementChild){
        starters.push(slot.firstElementChild.dataset.playerId);
      }
    });

    // chỉ gom dự bị khi người dùng tick
    if (includeBenchCbx && includeBenchCbx.checked){
      benchList.querySelectorAll('.player-token').forEach(t=>{
        substitutes.push(t.dataset.playerId);
      });
    }

    // loại trùng
    const uniq = arr => Array.from(new Set(arr.map(String)));
    const starterIds    = uniq(starters);
    const substituteIds = uniq(substitutes);

    const maxStarters = parseInt(playerCountSelect.value,10);
    if(starterIds.length > maxStarters){
      alert(`Lỗi: đã chọn ${starterIds.length} cầu thủ, tối đa ${maxStarters}.`);
      return;
    }
    if($('#slot-1').style.display !== 'none' && !$('#slot-1').firstElementChild){
      if(!confirm('Chưa có thủ môn ở Slot 1. Bạn vẫn muốn lưu?')) return;
    }

    startersInput.value    = starterIds.join(',');
    substitutesInput.value = substituteIds.join(','); // có thể rỗng
    lineupForm.submit();
  });

  // ------- Khởi tạo + preload -------
  function preload(){
    const maxPlayers = parseInt(playerCountSelect.value,10);
    const visible    = allSlots.slice(0, maxPlayers);
    if(existing && Array.isArray(existing.starters)){
      existing.starters.map(String).forEach(pid=>{
        const t = benchList.querySelector(`.player-token[data-player-id="${pid}"]`);
        const empty = visible.find(s=>!s.firstElementChild);
        if(t && empty){ empty.appendChild(t); updateStarterClass(t); }
      });
    }
    updateCounters();
  }
  updatePitchLayout();
  preload();
  applySearch();
})();
</script>
{% endblock %}
