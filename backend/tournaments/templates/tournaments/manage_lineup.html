{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Quản lý Đội hình - {{ team.name }}{% endblock %}

{% block extra_css %}
<style>
  .lineup-builder{display:flex;gap:2rem;align-items:flex-start}

  /* Pitch */
  .pitch{
    background:#28a745;
    background-image:
      linear-gradient(to right, rgba(255,255,255,.08) 1px, transparent 1px),
      linear-gradient(to bottom, rgba(255,255,255,.08) 1px, transparent 1px);
    background-size:20px 20px;
    border:2px solid #fff;border-radius:12px;
    aspect-ratio:7/5;position:relative;flex-grow:1;
    display:flex; flex-direction: column; /* THAY ĐỔI: Dùng flexbox dọc */
    padding:10px;
    box-shadow:0 8px 24px rgba(0,0,0,.12);
    width:100%;max-width:100%;
  }
  .pitch::before{
    content:"";position:absolute;inset:0;
    background:radial-gradient(circle at 50% 50%, rgba(255,255,255,.2) 0, rgba(255,255,255,.2) 1px, transparent 2px) no-repeat;
    background-size:120px 120px;background-position:center;pointer-events:none;
  }
  .pitch-row{
    flex-grow: 1; /* Các hàng chia đều không gian */
    display:flex;
    justify-content:space-around;
    align-items:center;
    gap:8px;
  }
  .position-slot{
    width:72px;height:88px;border:2px dashed rgba(255,255,255,0.45);
    border-radius:10px;display:flex;align-items:center;justify-content:center;
    position:relative;isolation:isolate;transition:transform .1s,border-color .1s, background-color 0.2s;
    cursor:pointer;
  }
  .position-slot::after{
    content:attr(data-position);
    position:absolute;bottom:-22px;left:50%;transform:translateX(-50%);
    font-size:.75rem;color:#fff;opacity:.9;font-weight:700;text-shadow:0 1px 1px rgba(0,0,0,.25);
    pointer-events:none;
  }
  /* === DÒNG CSS QUAN TRỌNG ĐỂ ẨN NHÃN VỊ TRÍ === */
  .position-slot.occupied::after {
      opacity: 0;
  }
  .position-slot.occupied{border-style:solid}
  .position-slot.slot-active{outline:3px solid #ffc107;transform:scale(1.02);border-color:#fff}
  .position-slot.is-droppable {
      background-color: rgba(255, 255, 255, 0.25);
      border-color: #fff;
  }

  /* Bench */
  .bench{
    width:320px;
    flex-shrink:0;
    background:#f8f9fa;
    padding:1rem;
    border-radius:12px;
    border:1px solid #eee;
    display: flex;
    flex-direction: column;
  }
  .bench-toolbar{flex-shrink:0; display:flex;gap:.5rem;align-items:center;margin-bottom:.75rem}
  .bench-toolbar input{flex:1}
  
  #bench-list-wrapper {
      flex-grow: 1;
      overflow-y: auto;
  }

  #bench-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      gap: 0.75rem;
  }

  .player-token {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 0.75rem 0.5rem;
      box-shadow: 0 2px 6px rgba(0,0,0,.08);
      position: relative;
      user-select: none;
      cursor: pointer;
      transition: background-color 0.2s ease, border-color 0.2s ease;
  }
  .player-token.is-starter { background: #e9f5ff; border-color: #0d6efd; }
  .player-token.token-active { outline: 3px solid #ffc107; }
  
  .player-token.was-substituted {
      background-color: #fff3cd;
      border-color: #ffc107;
  }

  .player-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 0.5rem;
  }
  .player-info-wrapper { line-height: 1.2; }
  .player-name { font-weight: 600; font-size: 0.8rem; }
  .player-meta { font-size: 0.75rem; color: #6c757d; }
  .jersey-number {
      position: absolute;
      top: 0px;
      right: 0px;
      background: #0d6efd;
      color: #fff;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: .8rem;
      font-weight: 800;
      border: 2px solid #fff;
      box-shadow: 0 2px 6px rgba(13,110,253,.45);
  }
  .player-token.is-starter .jersey-number { background-color: #0a58ca; }

  .legend{display:flex;gap:.5rem;align-items:center;color:#555}
  .legend .dot{width:10px;height:10px;border-radius:50%;display:inline-block}
  .dot-starter{background:#0d6efd}.dot-bench{background:#adb5bd}
  
  /* === CSS MỚI: Giao diện cho bộ chọn sơ đồ === */
  .formation-controls {
    display: flex;
    gap: 1rem;
    align-items: flex-end;
  }
  .custom-formation-inputs {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }
  .custom-formation-inputs input {
    width: 60px;
    text-align: center;
  }
  .custom-formation-inputs label {
    font-weight: 500;
  }

  @media (max-width: 991px){
    .lineup-builder{flex-direction:column;gap:1rem}
    .bench{width:100%;height:auto;max-height:60vh}
    .formation-controls {flex-direction: column; align-items: stretch;}
    /* Tắt aspect-ratio trên mobile để chiều cao tự động co giãn */
    .pitch {
        aspect-ratio: auto;
        min-height: 500px; /* Thêm chiều cao tối thiểu để không bị quá lùn */
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <a href="{% url 'match_detail' pk=match.pk %}" class="btn btn-outline-secondary btn-sm mb-3">
      <i class="bi bi-arrow-left"></i> Về trận đấu
  </a>
  <h3 class="mb-1">Đăng ký đội hình thi đấu</h3>
  <p class="lead">
    <strong>Trận đấu:</strong> {{ match.team1.name }} vs {{ match.team2.name }}
    | <strong>Đội của bạn:</strong> {{ team.name }}
  </p>

  <div class="d-flex gap-2 align-items-end flex-wrap mb-2">
    <div class="formation-controls">
        <div>
            <label for="formation-select" class="form-label fw-bold">Sơ đồ chiến thuật</label>
            <select class="form-select" id="formation-select">
                <optgroup label="Sân 7 người">
                    <option value="3-2-1" data-size="7" selected>3-2-1 (Phổ biến)</option>
                    <option value="2-3-1" data-size="7">2-3-1</option>
                    <option value="3-1-2" data-size="7">3-1-2</option>
                </optgroup>
                <optgroup label="Sân 5 người">
                    <option value="2-1-1" data-size="5">2-1-1</option>
                    <option value="1-2-1" data-size="5">1-2-1</option>
                </optgroup>
                <optgroup label="Sân 11 người">
                    <option value="4-4-2" data-size="11">4-4-2</option>
                    <option value="4-3-3" data-size="11">4-3-3</option>
                </optgroup>
                <option value="custom">Tùy chỉnh...</option>
            </select>
        </div>
        <div id="custom-formation-wrapper" class="custom-formation-inputs" style="display: none;">
            <div>
                <label for="df-count" class="form-label">DF</label>
                <input type="number" id="df-count" class="form-control form-control-sm" min="0" max="5" value="3">
            </div>
            <div>
                <label for="mf-count" class="form-label">MF</label>
                <input type="number" id="mf-count" class="form-control form-control-sm" min="0" max="5" value="2">
            </div>
            <div>
                <label for="fw-count" class="form-label">FW</label>
                <input type="number" id="fw-count" class="form-control form-control-sm" min="0" max="5" value="1">
            </div>
        </div>
    </div>

    <div class="d-flex gap-2 mt-2">
      <button id="save-lineup-btn" class="btn btn-primary"><i class="bi bi-save-fill"></i> Lưu đội hình</button>
      <button id="clear-lineup" class="btn btn-outline-danger">Xóa đội hình</button>
      <button id="send-to-bench-btn" class="btn btn-outline-secondary" disabled>Trả về ghế</button>
    </div>

    <div class="form-check ms-2">
      <input class="form-check-input" type="checkbox" id="include-bench-as-subs">
      <label class="form-check-label" for="include-bench-as-subs">Lưu cầu thủ còn lại làm dự bị</label>
    </div>

    <div class="legend ms-auto">
      <span class="badge text-bg-light">Đá chính: <span id="starter-count">0</span>/<span id="starter-max">7</span></span>
      <span class="dot dot-starter"></span> đá chính
      <span class="dot dot-bench"></span> dự bị
    </div>
  </div>
  <p class="text-muted mt-2">Nhấp chọn cầu thủ, rồi nhấp vào ô trên sân để đặt. Nhấp vào cầu thủ khác trên sân hoặc ghế dự bị để hoán đổi.</p>

  <div class="lineup-builder mt-2">
    <div class="pitch shadow">
        <div class="pitch-row" data-row-index="4"></div> <div class="pitch-row" data-row-index="3"></div> <div class="pitch-row" data-row-index="2"></div> <div class="pitch-row" data-row-index="1"></div> <div class="pitch-row" data-row-index="0"></div> </div>
    <div class="bench shadow-sm">
      <div class="bench-toolbar">
        <input id="search-player" class="form-control" placeholder="Tìm theo tên / vị trí...">
        <button id="clear-bench-filters" class="btn btn-light btn-sm" type="button">Bỏ lọc</button>
      </div>
      <h6 class="mb-2">Danh sách cầu thủ (<span id="player-count">{{ team.players.all|length }}</span>)</h6>
      <div id="bench-list-wrapper">
          <div id="bench-list">
            {% for player in team.players.all %}
            <div class="player-token"
                 data-player-id="{{ player.pk }}"
                 data-pos="{{ player.position|default_if_none:'' }}">
              <img src="{% if player.avatar %}{{ player.avatar.url }}{% else %}https://via.placeholder.com/48{% endif %}"
                   alt="{{ player.full_name }}" class="player-avatar">
              <div class="player-info-wrapper">
                  <div class="player-name">
                      {{ player.full_name }}
                      {# === THÊM ĐOẠN NÀY VÀO === #}
                      {% if player.user and team.captain == player.user %}
                          <span class="captain-indicator">(C)</span>
                      {% endif %}
                      {# === KẾT THÚC === #}
                  </div>
                  <div class="player-meta">{{ player.get_position_display }}</div>
              </div>
              <div class="jersey-number">{{ player.jersey_number }}</div>
            </div>
            {% endfor %}
          </div>
      </div>
    </div>
  </div>

  <form id="lineup-form" method="post" class="d-none">
    {% csrf_token %}
    <input type="hidden" name="starters" id="starters-input">
    <input type="hidden" name="substitutes" id="substitutes-input">
  </form>
</div>

<script id="existing-lineup-json" type="application/json">{{ existing_lineup_json|safe }}</script>

<script>
(function(){
  const $  = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));

  // --- Lấy các thành phần DOM ---
  const formationSelect = $('#formation-select');
  const customFormationWrapper = $('#custom-formation-wrapper');
  const dfInput = $('#df-count');
  const mfInput = $('#mf-count');
  const fwInput = $('#fw-count');
  const pitch = $('.pitch');
  const benchList = $('#bench-list');
  const saveBtn = $('#save-lineup-btn');
  const startersInput = $('#starters-input');
  const substitutesInput = $('#substitutes-input');
  const lineupForm = $('#lineup-form');
  const starterCountEl = $('#starter-count');
  const starterMaxEl = $('#starter-max');
  const clearLineupBtn = $('#clear-lineup');
  const searchInput = $('#search-player');
  const clearBenchBtn = $('#clear-bench-filters');
  const sendToBenchBtn = $('#send-to-bench-btn');
  const includeBenchCbx = $('#include-bench-as-subs');
  const bench = $('.bench');
  const existing = JSON.parse($('#existing-lineup-json').textContent || '{}');

  let selectedToken = null;
  let allSlots = []; // Sẽ được cập nhật động

  // --- HÀM VẼ SÂN BÓNG ---
  function drawPitch(df, mf, fw) {
      pitch.innerHTML = ''; // Xóa sân cũ
      allSlots = [];

      const formation = [fw, mf, df]; // Mảng sơ đồ: [tiền đạo, tiền vệ, hậu vệ]
      
      // Tạo 5 hàng trống
      const rows = Array.from({ length: 5 }, (_, i) => {
          const row = document.createElement('div');
          row.className = 'pitch-row';
          row.dataset.rowIndex = 4 - i;
          return row;
      });

      // Hàng thủ (DF)
      const dfRow = rows[3];
      for(let i=0; i<formation[2]; i++) dfRow.appendChild(createSlot('DF'));
      
      // Hàng tiền vệ (MF)
      const mfRow = rows[1];
      for(let i=0; i<formation[1]; i++) mfRow.appendChild(createSlot('MF'));
      
      // Hàng tiền đạo (FW)
      const fwRow = rows[0];
      for(let i=0; i<formation[0]; i++) fwRow.appendChild(createSlot('FW'));

      // Hàng thủ môn (GK)
      rows[4].appendChild(createSlot('GK'));

      // Thêm các hàng vào sân
      rows.forEach(row => pitch.appendChild(row));
  }

  function createSlot(position) {
      const slot = document.createElement('div');
      slot.className = 'position-slot';
      slot.dataset.position = position;
      allSlots.push(slot); // Thêm ô vào danh sách quản lý
      return slot;
  }
  
  // --- Các hàm xử lý logic cũ đã được điều chỉnh ---
  
  function setTokenActive(token, isActive) {
      $$('.player-token.token-active').forEach(t => t.classList.remove('token-active'));
      $$('.position-slot.is-droppable').forEach(s => s.classList.remove('is-droppable'));
      sendToBenchBtn.disabled = true;

      selectedToken = isActive ? token : null;
      if (selectedToken) {
          selectedToken.classList.add('token-active');
          const onPitch = selectedToken.parentElement?.classList.contains('position-slot');
          sendToBenchBtn.disabled = !onPitch;
          
          allSlots.forEach(slot => {
              if (slot.style.display !== 'none' && !slot.firstElementChild) {
                  slot.classList.add('is-droppable');
              }
          });
      }
  }

  function updateCountersAndClasses() {
      const starters = allSlots.filter(s => s.firstElementChild);
      starterCountEl.textContent = starters.length;
      
      const formationText = formationSelect.value;
      if (formationText !== 'custom') {
          starterMaxEl.textContent = formationSelect.options[formationSelect.selectedIndex].dataset.size || 0;
      } else {
          const total = 1 + parseInt(dfInput.value) + parseInt(mfInput.value) + parseInt(fwInput.value);
          starterMaxEl.textContent = total;
      }
      
      $$('.player-token').forEach(t => {
          const onPitch = t.parentElement?.classList.contains('position-slot');
          t.classList.toggle('is-starter', onPitch);
      });
      allSlots.forEach(s => s.classList.toggle('occupied', !!s.firstElementChild));
  }
  
  function moveToBench(token) {
      if (!token) return;
      token.classList.add('was-substituted');
      benchList.appendChild(token);
      updateCountersAndClasses();
  }

  function handleInteraction(clickedElement) {
      const clickedToken = clickedElement.closest('.player-token');
      const clickedSlot = clickedElement.closest('.position-slot');

      if (!selectedToken) {
          if (clickedToken) setTokenActive(clickedToken, true);
          return;
      }
      const originContainer = selectedToken.parentElement;
      if (selectedToken === clickedToken) {
          setTokenActive(null, false);
          return;
      }
      if (clickedSlot && !clickedSlot.firstElementChild) {
          selectedToken.classList.remove('was-substituted');
          clickedSlot.appendChild(selectedToken);
          setTokenActive(null, false);
          updateCountersAndClasses();
          return;
      }
      if (clickedToken) {
          const targetContainer = clickedToken.parentElement;
          targetContainer.appendChild(selectedToken);
          originContainer.appendChild(clickedToken);
          const selectedIsBenched = targetContainer.id === 'bench-list';
          const clickedIsBenched = originContainer.id === 'bench-list';
          if (selectedIsBenched) selectedToken.classList.add('was-substituted');
          else selectedToken.classList.remove('was-substituted');
          if (clickedIsBenched) clickedToken.classList.add('was-substituted');
          else clickedToken.classList.remove('was-substituted');
          setTokenActive(null, false);
          updateCountersAndClasses();
          return;
      }
  }
  
  // --- Lắng nghe sự kiện ---
  
  function updateFormation() {
    // Chuyển tất cả cầu thủ về ghế trước khi vẽ lại sân
    allSlots.forEach(slot => {
        if(slot.firstElementChild) {
            benchList.appendChild(slot.firstElementChild);
        }
    });

    const formationValue = formationSelect.value;
    if (formationValue === 'custom') {
        customFormationWrapper.style.display = 'flex';
        const df = parseInt(dfInput.value) || 0;
        const mf = parseInt(mfInput.value) || 0;
        const fw = parseInt(fwInput.value) || 0;
        drawPitch(df, mf, fw);
    } else {
        customFormationWrapper.style.display = 'none';
        const [df, mf, fw] = formationValue.split('-').map(Number);
        drawPitch(df, mf, fw);
    }
    updateCountersAndClasses();
  }

  formationSelect.addEventListener('change', updateFormation);
  dfInput.addEventListener('input', updateFormation);
  mfInput.addEventListener('input', updateFormation);
  fwInput.addEventListener('input', updateFormation);

  document.querySelector('.lineup-builder').addEventListener('click', e => handleInteraction(e.target));
  document.addEventListener('click', e => {
      if (!e.target.closest('.lineup-builder, .btn')) setTokenActive(null, false);
  });
  
  sendToBenchBtn?.addEventListener('click', () => {
      if (selectedToken) {
          moveToBench(selectedToken);
          setTokenActive(null, false);
      }
  });

  searchInput?.addEventListener('input', () => {
      const q = (searchInput.value || '').trim().toLowerCase();
      benchList.querySelectorAll('.player-token').forEach(t => {
          const name = t.querySelector('.player-name')?.textContent?.toLowerCase() || '';
          const pos  = (t.dataset.pos || '').toLowerCase();
          t.style.display = (!q || name.includes(q) || pos.includes(q)) ? '' : 'none';
      });
  });
  
  clearBenchBtn?.addEventListener('click', () => { searchInput.value=''; searchInput.dispatchEvent(new Event('input')); });

  clearLineupBtn?.addEventListener('click', () => {
      if (!confirm('Bạn có chắc muốn xóa toàn bộ đội hình trên sân không?')) return;
      $$('.player-token.was-substituted').forEach(t => t.classList.remove('was-substituted'));
      allSlots.forEach(s => { 
          if(s.firstElementChild) benchList.appendChild(s.firstElementChild);
      });
      setTokenActive(null, false);
      updateCountersAndClasses();
  });
  
  saveBtn?.addEventListener('click', () => {
      const starters = [];
      const substitutes = [];
      const maxStarters = parseInt(starterMaxEl.textContent, 10);

      allSlots.forEach(slot => {
          if (slot.firstElementChild) {
              starters.push(slot.firstElementChild.dataset.playerId);
          }
      });

      if (includeBenchCbx?.checked) {
          benchList.querySelectorAll('.player-token').forEach(t => {
              if (t.style.display !== 'none') substitutes.push(t.dataset.playerId);
          });
      }

      if (starters.length !== maxStarters) {
          alert(`Lỗi: Sơ đồ yêu cầu ${maxStarters} cầu thủ, nhưng bạn đã chọn ${starters.length}.`);
          return;
      }
      
      // Kiểm tra thủ môn
      const gkSlot = pitch.querySelector('[data-position="GK"]');
      if (gkSlot && !gkSlot.firstElementChild) {
          if(!confirm('Chưa có thủ môn ở vị trí GK. Bạn vẫn muốn lưu?')) return;
      }

      startersInput.value = Array.from(new Set(starters)).join(',');
      substitutesInput.value = Array.from(new Set(substitutes)).join(',');
      lineupForm.submit();
  });
  
  function preload() {
      const starterIds = new Set((existing.starters || []).map(String));
      const playersToPlace = Array.from(starterIds);
      
      playersToPlace.forEach(pid => {
          const token = benchList.querySelector(`.player-token[data-player-id="${pid}"]`);
          const emptySlot = allSlots.find(s => !s.firstElementChild);
          if (token && emptySlot) {
              emptySlot.appendChild(token);
          }
      });
      updateCountersAndClasses();
  }
  
  function adjustBenchHeight() {
      if (window.innerWidth > 991) {
          const pitchHeight = pitch.offsetHeight;
          bench.style.height = `${pitchHeight}px`;
      } else {
          bench.style.height = '';
      }
  }

  // --- KHỞI TẠO ---
  window.addEventListener('resize', adjustBenchHeight);
  updateFormation(); // Vẽ sân lần đầu
  preload();
  adjustBenchHeight();

})();
</script>
{% endblock %}