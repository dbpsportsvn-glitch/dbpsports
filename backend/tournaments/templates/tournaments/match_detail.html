{% extends 'base.html' %}
{% load static %}

{% block title %}{{ match.team1.name }} vs {{ match.team2.name }}{% endblock %}

{% block extra_css %}
<style>

    /* Dán vào trong block extra_css */
    .countdown-timer {
        background-color: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    .countdown-box {
        text-align: center;
    }
    .countdown-box .number {
        font-size: 2.5rem;
        font-weight: 700;
        color: #f59e0b; /* Màu vàng */
        line-height: 1;
    }
    .countdown-box .label {
        font-size: 0.8rem;
        text-transform: uppercase;
        color: #cbd5e1; /* Màu chữ sáng hơn */
    }    
    /* CSS cho trang chi tiết trận đấu mới */
    .scoreboard {
        background: linear-gradient(rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.9)), url("{% static 'images/hero-1.jpg' %}");
        background-size: cover;
        background-position: center;
        color: white;
        padding: 2rem;
        border-radius: 0.75rem;
        text-align: center;
    }
    .scoreboard .team-logo {
        max-height: 100px;
        max-width: 100px;
        object-fit: contain;
        margin-bottom: 1rem;
    }
    .scoreboard .team-name {
        font-size: 1.5rem;
        font-weight: 700;
        color: #FFD700;
    }
    .scoreboard .score {
        font-size: 4rem;
        font-weight: 800;
        line-height: 1;
    }
    .scoreboard .match-info {
        font-size: 0.9rem;
        opacity: 0.8;
    }
    .section-title {
        font-weight: 700;
        color: #0d6efd;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 0.5rem;
        margin-bottom: 1.5rem;
    }
    /* === THÊM LẠI CÁC STYLE ĐÃ MẤT === */
    .lineup-title { 
        color: #006400; 
        font-weight: bold;
    }
    .events-title { 
        color: red;
        text-align: center;
    }
    .sub-heading {
        text-decoration: underline;
        text-underline-offset: 4px;
    }
    /* === KẾT THÚC THÊM LẠI === */
    .player-card {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        border-bottom: 1px solid #f0f0f0;
    }
    .player-card:last-child {
        border-bottom: none;
    }
    .player-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 1rem;
    }
    .player-info {
        flex-grow: 1;
    }
    .player-name {
        font-weight: 600;
    }
    .player-details {
        font-size: 0.85rem;
        color: #6c757d;
    }
    .player-stats {
        display: flex;
        gap: 0.75rem;
        font-size: 1rem;
    }
    .event-timeline {
        list-style: none;
        padding-left: 0;
    }
    .event-item {
        display: flex;
        align-items: baseline;
        margin-bottom: 1rem;
    }
    .event-minute {
        font-weight: 700;
        color: #0d6efd;
        width: 40px;
        text-align: center;
    }
    .event-icon {
        margin: 0 1rem;
        font-size: 1.2rem;
    }
    .event-details {
        flex-grow: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <a href="{% url 'tournament_detail' pk=match.tournament.pk %}?tab=schedule#schedule" class="btn btn-outline-secondary btn-sm mb-3">
        <i class="bi bi-arrow-left"></i> Về Lịch thi đấu
    </a>

    <div class="scoreboard shadow mb-4">
        <div class="row align-items-center">
            <div class="col-md-4">
                {% if match.team1.logo %}
                    <img src="{{ match.team1.logo.url }}" alt="{{ match.team1.name }} logo" class="team-logo">
                {% endif %}
                <div class="team-name">{{ match.team1.name }}</div>
            </div>
            <div class="col-md-4">
                {% if match.team1_score is not None %}
                    <div class="score">{{ match.team1_score }} - {{ match.team2_score }}</div>
                    {% if match.team1_penalty_score is not None %}
                        <div class="match-info">(Pen: {{ match.team1_penalty_score }} - {{ match.team2_penalty_score }})</div>
                    {% endif %}
                {% else %}
                    <div class="score">VS</div>
                {% endif %}
                <div class="match-info mt-2">
                    {{ match.get_match_round_display }} - {{ match.tournament.name }}<br>
                    {{ match.match_time|date:"H:i, d/m/Y" }} - Sân {{ match.location }}
                </div>
            </div>
            <div class="col-md-4">
                {% if match.team2.logo %}
                    <img src="{{ match.team2.logo.url }}" alt="{{ match.team2.name }} logo" class="team-logo">
                {% endif %}
                <div class="team-name">{{ match.team2.name }}</div>
            </div>
        </div>
    </div>

    {% if match.team1_score is None and not match.is_live %}
    <div id="countdown-wrapper" class="countdown-timer text-white">
        <h4 class="text-center mb-3">Trận đấu sẽ bắt đầu sau</h4>
        <div class="row" id="countdown">
            <div class="col-3 countdown-box"><span class="number" id="days">00</span><span class="label">Ngày</span></div>
            <div class="col-3 countdown-box"><span class="number" id="hours">00</span><span class="label">Giờ</span></div>
            <div class="col-3 countdown-box"><span class="number" id="minutes">00</span><span class="label">Phút</span></div>
            <div class="col-3 countdown-box"><span class="number" id="seconds">00</span><span class="label">Giây</span></div>
        </div>
    </div>
    <span id="match-start-time" data-datetime="{{ match.match_time.isoformat }}"></span>
    {% endif %}

    {% if captain_team %}
    <div class="text-center mb-4">
        <a href="{% url 'manage_lineup' match_pk=match.pk team_pk=captain_team.pk %}" class="btn btn-primary btn-lg">
            <i class="bi bi-list-check"></i> Quản lý Đội hình thi đấu
        </a>
    </div>
    {% endif %}

    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h4 class="section-title">{{ match.team1.name }}</h4>

                    <h5 class="lineup-title sub-heading">Đá chính</h5>
                    {% for p_data in team1_starters %}
                        <div class="player-card">
                            <img src="{% if p_data.player.avatar %}{{ p_data.player.avatar.url }}{% else %}https://via.placeholder.com/48{% endif %}" class="player-avatar">
                            <div class="player-info">
                                <div class="player-name">
                                    <a href="{% url 'player_detail' pk=p_data.player.pk %}" class="text-decoration-none text-dark">
                                        #{{ p_data.player.jersey_number }} - {{ p_data.player.full_name }}
                                    </a>
                                    {% if p_data.player.user and p_data.player.team.captain == p_data.player.user %}
                                        <span class="captain-indicator">(C)</span>
                                    {% endif %}
                                </div>
                                <div class="player-details">{{ p_data.player.get_position_display }}</div>
                            </div>
                            <div class="player-stats">
                                {% if p_data.goals > 0 %}<span title="Bàn thắng">⚽ {{ p_data.goals }}</span>{% endif %}
                                {% if p_data.yellow_cards > 0 %}<span class="badge bg-warning text-dark" title="Thẻ vàng">{{ p_data.yellow_cards }}</span>{% endif %}
                                {% if p_data.red_cards > 0 %}<span class="badge bg-danger" title="Thẻ đỏ">{{ p_data.red_cards }}</span>{% endif %}
                            </div>
                        </div>
                    {% empty %}
                        <p class="text-muted small">Chưa có cầu thủ đá chính.</p>
                    {% endfor %}

                    <h5 class="mt-4 sub-heading">Dự bị</h5>
                    {% for p_data in team1_substitutes %}
                        <div class="player-card">
                            <img src="{% if p_data.player.avatar %}{{ p_data.player.avatar.url }}{% else %}https://via.placeholder.com/48{% endif %}" class="player-avatar">
                            <div class="player-info">
                                <div class="player-name">
                                    <a href="{% url 'player_detail' pk=p_data.player.pk %}" class="text-decoration-none text-dark">
                                        #{{ p_data.player.jersey_number }} - {{ p_data.player.full_name }}
                                    </a>
                                    {% if p_data.player.user and p_data.player.team.captain == p_data.player.user %}
                                        <span class="captain-indicator">(C)</span>
                                    {% endif %}
                                </div>
                                <div class="player-details">{{ p_data.player.get_position_display }}</div>
                            </div>
                            <div class="player-stats">
                                {% if p_data.goals > 0 %}<span title="Bàn thắng">⚽ {{ p_data.goals }}</span>{% endif %}
                                {% if p_data.yellow_cards > 0 %}<span class="badge bg-warning text-dark" title="Thẻ vàng">{{ p_data.yellow_cards }}</span>{% endif %}
                                {% if p_data.red_cards > 0 %}<span class="badge bg-danger" title="Thẻ đỏ">{{ p_data.red_cards }}</span>{% endif %}
                            </div>
                        </div>
                    {% empty %}
                        <p class="text-muted small">Không có cầu thủ dự bị.</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h4 class="section-title events-title">Diễn biến chính</h4>
                    <ul class="event-timeline">
                        {% for event in events %}
                        <li class="event-item">
                            <div class="event-minute">{{ event.minute|default:"-" }}'</div>
                            <div class="event-icon">
                                {% if event.is_own_goal %}
                                    <i class="bi bi- futbol" style="color: red;" title="Phản lưới nhà"></i>
                                {% elif event.minute is not None %}
                                    <i class="bi bi-futbol" title="Bàn thắng"></i>
                                {% elif event.card_type == 'YELLOW' %}
                                    <span class="badge bg-warning text-dark" style="width: 1rem; height: 1.2rem; display: inline-block; border: 1px solid #666;" title="Thẻ vàng"></span>
                                {% elif event.card_type == 'RED' %}
                                    <span class="badge bg-danger" style="width: 1rem; height: 1.2rem; display: inline-block; border: 1px solid #666;" title="Thẻ đỏ"></span>
                                {% endif %}
                            </div>
                            <div class="event-details">
                                <strong>
                                    <a href="{% url 'player_detail' pk=event.player.pk %}" class="text-decoration-none text-dark">
                                        {{ event.player.full_name }}
                                    </a>
                                    {% if event.player.user and event.player.team.captain == event.player.user %}
                                        <span class="captain-indicator">(C)</span>
                                    {% endif %}
                                </strong> ({{ event.team.name }})
                            </div>
                        </li>
                        {% empty %}
                        <p class="text-muted">Chưa có diễn biến nào nổi bật.</p>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h4 class="section-title">{{ match.team2.name }}</h4>

                    <h5 class="lineup-title sub-heading">Đá chính</h5>
                    {% for p_data in team2_starters %}
                        <div class="player-card">
                            <img src="{% if p_data.player.avatar %}{{ p_data.player.avatar.url }}{% else %}https://via.placeholder.com/48{% endif %}" class="player-avatar">
                            <div class="player-info">
                                <div class="player-name">
                                   <a href="{% url 'player_detail' pk=p_data.player.pk %}" class="text-decoration-none text-dark">
                                        #{{ p_data.player.jersey_number }} - {{ p_data.player.full_name }}
                                    </a>
                                    {% if p_data.player.user and p_data.player.team.captain == p_data.player.user %}
                                        <span class="captain-indicator">(C)</span>
                                    {% endif %}
                                </div>
                                <div class="player-details">{{ p_data.player.get_position_display }}</div>
                            </div>
                            <div class="player-stats">
                                {% if p_data.goals > 0 %}<span title="Bàn thắng">⚽ {{ p_data.goals }}</span>{% endif %}
                                {% if p_data.yellow_cards > 0 %}<span class="badge bg-warning text-dark" title="Thẻ vàng">{{ p_data.yellow_cards }}</span>{% endif %}
                                {% if p_data.red_cards > 0 %}<span class="badge bg-danger" title="Thẻ đỏ">{{ p_data.red_cards }}</span>{% endif %}
                            </div>
                        </div>
                    {% empty %}
                        <p class="text-muted small">Chưa có cầu thủ đá chính.</p>
                    {% endfor %}

                    <h5 class="mt-4 sub-heading">Dự bị</h5>
                    {% for p_data in team2_substitutes %}
                        <div class="player-card">
                            <img src="{% if p_data.player.avatar %}{{ p_data.player.avatar.url }}{% else %}https://via.placeholder.com/48{% endif %}" class="player-avatar">
                            <div class="player-info">
                                <div class="player-name">
                                   <a href="{% url 'player_detail' pk=p_data.player.pk %}" class="text-decoration-none text-dark">
                                        #{{ p_data.player.jersey_number }} - {{ p_data.player.full_name }}
                                    </a>
                                    {% if p_data.player.user and p_data.player.team.captain == p_data.player.user %}
                                        <span class="captain-indicator">(C)</span>
                                    {% endif %}
                                </div>
                                <div class="player-details">{{ p_data.player.get_position_display }}</div>
                            </div>
                            <div class="player-stats">
                                {% if p_data.goals > 0 %}<span title="Bàn thắng">⚽ {{ p_data.goals }}</span>{% endif %}
                                {% if p_data.yellow_cards > 0 %}<span class="badge bg-warning text-dark" title="Thẻ vàng">{{ p_data.yellow_cards }}</span>{% endif %}
                                {% if p_data.red_cards > 0 %}<span class="badge bg-danger" title="Thẻ đỏ">{{ p_data.red_cards }}</span>{% endif %}
                            </div>
                        </div>
                    {% empty %}
                        <p class="text-muted small">Không có cầu thủ dự bị.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const countdownElement = document.getElementById('countdown');
    const timeElement = document.getElementById('match-start-time');

    if (countdownElement && timeElement) {
        const countDownDate = new Date(timeElement.dataset.datetime).getTime();

        const interval = setInterval(function() {
            const now = new Date().getTime();
            const distance = countDownDate - now;

            if (distance < 0) {
                clearInterval(interval);
                document.getElementById('countdown-wrapper').style.display = 'none';
                return;
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            document.getElementById('days').innerText = String(days).padStart(2, '0');
            document.getElementById('hours').innerText = String(hours).padStart(2, '0');
            document.getElementById('minutes').innerText = String(minutes).padStart(2, '0');
            document.getElementById('seconds').innerText = String(seconds).padStart(2, '0');
        }, 1000);
    }
});
</script>
{% endblock %}
{% endblock %}