{% extends 'base.html' %}
{% load static %}

{% block title %}{{ match.team1.name }} vs {{ match.team2.name }}{% endblock %}

{% block extra_css %}
<!-- Bootstrap Icons (nếu base.html chưa nhúng) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<style>
    /* Weather info */
    .weather-info {
        font-size: 0.85rem;
        opacity: 0.9;
        margin-top: 0.5rem; /* giảm khoảng cách trên */
        display: flex;
        align-items: center;
        justify-content: center;
        column-gap: 1rem;    /* khoảng cách ngang */
        row-gap: 0.35rem;    /* khoảng cách dọc nhỏ lại */
        flex-wrap: wrap;
    }
    .weather-info-item {
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }
    .weather-info-item .bi { font-size: 1.1rem; }
    .weather-info-item span { white-space: nowrap; }

    /* Scoreboard */
    .scoreboard {
        background: linear-gradient(rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.9)), url("{% static 'images/hero-1.jpg' %}");
        background-size: cover;
        background-position: center;
        color: white;
        padding: 2rem;
        border-radius: 0.75rem;
        text-align: center;
    }
    .scoreboard .team-logo {
        max-height: 100px;
        max-width: 100px;
        object-fit: contain;
        margin-bottom: 1rem;
    }
    .scoreboard .team-name {
        font-size: 1.5rem;
        font-weight: 700;
        color: #FFD700;
    }
    .scoreboard .score {
        font-size: 4rem;
        font-weight: 800;
        line-height: 1;
    }
    .scoreboard .match-info { font-size: 0.9rem; opacity: 0.8; }

    .section-title { font-weight: 700; color: #0d6efd; border-bottom: 2px solid #e9ecef; padding-bottom: 0.5rem; margin-bottom: 1rem; }

    /* Titles giữ lại */
    .lineup-title { color: #006400; font-weight: bold; }
    .events-title { color: red; text-align: center; }
    .sub-heading { text-decoration: underline; text-underline-offset: 4px; }

    /* Players */
    .player-card { display: flex; align-items: center; padding: 0.75rem; border-bottom: 1px solid #f0f0f0; }
    .player-card:last-child { border-bottom: none; }
    .player-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; margin-right: 1rem; }
    .player-info { flex-grow: 1; }
    .player-name { font-weight: 600; }
    .player-details { font-size: 0.85rem; color: #6c757d; }
    .player-stats { display: flex; gap: 0.75rem; font-size: 1rem; }

    /* Events */
    .event-timeline { list-style: none; padding-left: 0; }
    .event-item { display: flex; align-items: baseline; margin-bottom: 1rem; }
    .event-minute { font-weight: 700; color: #0d6efd; width: 40px; text-align: center; }
    .event-icon { margin: 0 1rem; font-size: 1.2rem; }
    .event-details { flex-grow: 1; }

    /* Mobile tweaks */
    @media (max-width: 576px) {
        .scoreboard .score { font-size: 3rem; }
        .scoreboard .team-name { font-size: 1.25rem; }
    }

    /* ================== COUNTDOWN (gọn hơn, đúng bề rộng card trung tâm) ================== */
    :root{
        --wc-bg: rgba(15, 23, 42, 0.65);
        --wc-border: rgba(148, 163, 184, 0.25);
        --wc-glow-1: #22d3ee;
        --wc-glow-2: #a78bfa;
        --wc-text: #e5e7eb;
        --wc-accent: #f59e0b;
    }

    .wow-countdown{
        position: relative;
        overflow: hidden;
        border-radius: .75rem;
        padding: .75rem .6rem; /* gọn hơn */
        color: var(--wc-text);
        background: linear-gradient(180deg, rgba(2,6,23,.75), rgba(2,6,23,.6)),
                    radial-gradient(1200px 300px at 10% -10%, rgba(34,211,238,.25), transparent 60%),
                    radial-gradient(1200px 300px at 90% -20%, rgba(167,139,250,.25), transparent 60%);
        border: 1px solid var(--wc-border);
        backdrop-filter: blur(6px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, .35), 0 0 0 1px rgba(255,255,255, .02) inset;
        margin: 0 0 1rem 0; /* sát tiêu đề, tiết kiệm không gian */
        width: 100%; /* đúng bề rộng card trung tâm */
    }
    .wow-countdown::after{
        content: ""; position:absolute; inset:-2px; border-radius: .75rem; pointer-events:none;
        background: conic-gradient(from 0deg, var(--wc-glow-1), var(--wc-glow-2), var(--wc-glow-1));
        -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
        -webkit-mask-composite: xor; mask-composite: exclude;
        padding:2px; opacity:.2; filter: blur(2px);
        animation: wc-rotate 10s linear infinite;
    }
    @keyframes wc-rotate{ to{ transform: rotate(360deg); } }

    .wc-header{ display:flex; align-items:center; justify-content:center; gap:.5rem; font-weight:700; letter-spacing:.3px; margin-bottom:.4rem; font-size:.85rem; }
    .wc-header .bi{ font-size:1.1rem; color: var(--wc-accent); }

    .wc-grid{ display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: .55rem; align-items:stretch; }
    @media (max-width: 576px){ .wc-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }

    .wc-unit{ position:relative; background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); border-radius: .65rem; padding: .55rem .45rem; text-align:center; box-shadow: 0 3px 10px rgba(0,0,0,.2); }
    .wc-label{ font-size:.65rem; text-transform:uppercase; letter-spacing:.08em; color:#cbd5e1; margin-top:.35rem; }

    /* Flip digits - thu nhỏ ~15% và căn giữa số chuẩn */
    .digits{ display:flex; justify-content:center; gap:.2rem; }
    .flip{
        position:relative; width:30px; height:38px; perspective: 900px; border-radius:.55rem; overflow: hidden;
        background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.04));
        border: 1px solid rgba(255,255,255,.08);
        box-shadow: 0 2px 8px rgba(0,0,0,.25) inset, 0 10px 20px rgba(0,0,0,.15);
        font-weight: 800; font-size: 1.2rem; color:#fff;
    }
    @media (max-width: 576px){ .flip{ width:28px; height:34px; font-size:1.05rem; } }

    .flip .card-top, .flip .card-bottom, .flip .top-flip, .flip .bottom-flip{
        position:absolute; left:0; right:0; height:50%; overflow:hidden; backface-visibility: hidden; display:flex; align-items:center; justify-content:center; text-align:center;
    }
    .flip .card-top{ top:0; border-bottom:1px solid rgba(255,255,255,.15); }
    .flip .card-bottom{ bottom:0; }

    .flip .top-flip{ top:0; transform-origin: bottom; background: linear-gradient(180deg, rgba(0,0,0,.08), rgba(255,255,255,.08)); animation: flipDown .7s cubic-bezier(.37,.01,.2,1) forwards; }
    .flip .bottom-flip{ bottom:0; transform-origin: top; background: linear-gradient(0deg, rgba(0,0,0,.08), rgba(255,255,255,.08)); animation: flipUp .7s cubic-bezier(.37,.01,.2,1) forwards; }

    @keyframes flipDown{ 0%{ transform: rotateX(0deg); } 100%{ transform: rotateX(-90deg); } }
    @keyframes flipUp{ 0%{ transform: rotateX(90deg); } 100%{ transform: rotateX(0deg); } }

    .confetti-holder{ pointer-events:none; position:absolute; inset:0; overflow:hidden; }
    .confetti{ position:absolute; top:-10px; width:8px; height:14px; opacity:.9; transform: translateY(-100%); animation: fall linear forwards; }
    @keyframes fall{ to{ transform: translateY(110vh) rotate(720deg); } }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Thanh điều hướng: Trái + Phải cùng hàng -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <a href="{% url 'tournament_detail' pk=match.tournament.pk %}?tab=schedule#schedule" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left"></i> Về Lịch thi đấu
        </a>
        {% if captain_team %}
        <a href="{% url 'manage_lineup' match_pk=match.pk team_pk=captain_team.pk %}" class="btn btn-primary btn-sm d-flex align-items-center gap-1">
            <i class="bi bi-list-check"></i>
            <span>Quản lý Đội hình</span>
        </a>
        {% endif %}
    </div>

    <div class="scoreboard shadow mb-4">
        <div class="row align-items-center">
            <div class="col-md-4">
                {% if match.team1.logo %}
                    <img src="{{ match.team1.logo.url }}" alt="{{ match.team1.name }} logo" class="team-logo" loading="lazy">
                {% endif %}
                <div class="team-name">{{ match.team1.name }}</div>
            </div>
            <div class="col-md-4">
                {% if match.team1_score is not None %}
                    <div class="score">{{ match.team1_score }} - {{ match.team2_score }}</div>
                    {% if match.team1_penalty_score is not None %}
                        <div class="match-info">(Pen: {{ match.team1_penalty_score }} - {{ match.team2_penalty_score }})</div>
                    {% endif %}
                {% else %}
                    <div class="score">VS</div>
                {% endif %}
                <div class="match-info mt-2">
                    {{ match.get_match_round_display }} - {{ match.tournament.name }}<br>
                    {{ match.match_time|date:"H:i, d/m/Y" }} - Sân {{ match.location }}
                </div>

                {# Weather block #}
                {% if weather_data %}
                <div class="weather-info">
                    <div class="weather-info-item" title="Nhiệt độ">
                        <i class="bi bi-thermometer-half"></i>
                        <span>{{ weather_data.temp|default:"--" }}</span>
                    </div>
                    <div class="weather-info-item" title="Tình trạng">
                        <i class="bi {{ weather_data.icon|default:'bi-question-circle' }}"></i>
                        <span>{{ weather_data.condition|default:"—" }}</span>
                    </div>
                    <div class="weather-info-item" title="Khả năng mưa">
                        <i class="bi bi-umbrella-fill"></i>
                        {% with rp=weather_data.rain_prob|default_if_none:"0"|stringformat:"s" %}
                        <span>{% if "%" in rp %}{{ rp }}{% else %}{{ rp }}%{% endif %}</span>
                        {% endwith %}
                    </div>
                    <div class="weather-info-item" title="Độ ẩm">
                        <i class="bi bi-droplet-half"></i>
                        {% with h=weather_data.humidity|default_if_none:"0"|stringformat:"s" %}
                        <span>{% if "%" in h %}{{ h }}{% else %}{{ h }}%{% endif %}</span>
                        {% endwith %}
                    </div>
                    <div class="weather-info-item" title="Sức gió">
                        <i class="bi bi-wind"></i>
                        {% with w=weather_data.wind_kmh|default_if_none:"0"|stringformat:"s" %}
                        <span>{% if "km/h" in w %}{{ w }}{% else %}{{ w }} km/h{% endif %}</span>
                        {% endwith %}
                    </div>
                    {% if weather_data.rain_mm is not None %}
                    <div class="weather-info-item" title="Lượng mưa ước tính">
                        <i class="bi bi-cloud-rain"></i>
                        <span>{{ weather_data.rain_mm }} mm</span>
                    </div>
                    {% endif %}
                </div>
                {% if weather_data.matched_time %}
                <div class="text-muted small mt-1">Khớp giờ dự báo: {{ weather_data.matched_time }}</div>
                {% endif %}
                {% endif %}
            </div>
            <div class="col-md-4">
                {% if match.team2.logo %}
                    <img src="{{ match.team2.logo.url }}" alt="{{ match.team2.name }} logo" class="team-logo" loading="lazy">
                {% endif %}
                <div class="team-name">{{ match.team2.name }}</div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h4 class="section-title">{{ match.team1.name }}</h4>

                    <h5 class="lineup-title sub-heading">Đá chính</h5>
                    {% for p_data in team1_starters %}
                        <div class="player-card">
                            <img src="{% if p_data.player.avatar %}{{ p_data.player.avatar.url }}{% else %}https://via.placeholder.com/48{% endif %}" class="player-avatar" loading="lazy" alt="{{ p_data.player.full_name }}">
                            <div class="player-info">
                                <div class="player-name">
                                    <a href="{% url 'player_detail' pk=p_data.player.pk %}" class="text-decoration-none text-dark">
                                        #{{ p_data.player.jersey_number }} - {{ p_data.player.full_name }}
                                    </a>
                                    {% if p_data.player.user and p_data.player.team.captain == p_data.player.user %}
                                        <span class="captain-indicator">(C)</span>
                                    {% endif %}
                                </div>
                                <div class="player-details">{{ p_data.player.get_position_display }}</div>
                            </div>
                            <div class="player-stats">
                                {% if p_data.goals > 0 %}<span title="Bàn thắng">⚽ {{ p_data.goals }}</span>{% endif %}
                                {% if p_data.yellow_cards > 0 %}<span class="badge bg-warning text-dark" title="Thẻ vàng">{{ p_data.yellow_cards }}</span>{% endif %}
                                {% if p_data.red_cards > 0 %}<span class="badge bg-danger" title="Thẻ đỏ">{{ p_data.red_cards }}</span>{% endif %}
                            </div>
                        </div>
                    {% empty %}
                        <p class="text-muted small">Chưa có cầu thủ đá chính.</p>
                    {% endfor %}

                    <h5 class="mt-4 sub-heading">Dự bị</h5>
                    {% for p_data in team1_substitutes %}
                        <div class="player-card">
                            <img src="{% if p_data.player.avatar %}{{ p_data.player.avatar.url }}{% else %}https://via.placeholder.com/48{% endif %}" class="player-avatar" loading="lazy" alt="{{ p_data.player.full_name }}">
                            <div class="player-info">
                                <div class="player-name">
                                    <a href="{% url 'player_detail' pk=p_data.player.pk %}" class="text-decoration-none text-dark">
                                        #{{ p_data.player.jersey_number }} - {{ p_data.player.full_name }}
                                    </a>
                                    {% if p_data.player.user and p_data.player.team.captain == p_data.player.user %}
                                        <span class="captain-indicator">(C)</span>
                                    {% endif %}
                                </div>
                                <div class="player-details">{{ p_data.player.get_position_display }}</div>
                            </div>
                            <div class="player-stats">
                                {% if p_data.goals > 0 %}<span title="Bàn thắng">⚽ {{ p_data.goals }}</span>{% endif %}
                                {% if p_data.yellow_cards > 0 %}<span class="badge bg-warning text-dark" title="Thẻ vàng">{{ p_data.yellow_cards }}</span>{% endif %}
                                {% if p_data.red_cards > 0 %}<span class="badge bg-danger" title="Thẻ đỏ">{{ p_data.red_cards }}</span>{% endif %}
                            </div>
                        </div>
                    {% empty %}
                        <p class="text-muted small">Không có cầu thủ dự bị.</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    {% if match.team1_score is None and not match.is_live %}
                    <!-- Đồng hồ đếm ngược gọn, đúng bề rộng card trung tâm -->
                    <div id="wow-countdown" class="wow-countdown" data-datetime="{{ match.match_time|date:'c' }}">
                        <div class="wc-header"><i class="bi bi-stopwatch"></i> Trận đấu sẽ bắt đầu sau</div>
                        <div class="wc-grid">
                            <div class="wc-unit">
                                <div class="digits" data-unit="days">
                                    <div class="flip"><div class="card-top">0</div><div class="card-bottom">0</div></div>
                                    <div class="flip"><div class="card-top">0</div><div class="card-bottom">0</div></div>
                                </div>
                                <div class="wc-label">Ngày</div>
                            </div>
                            <div class="wc-unit">
                                <div class="digits" data-unit="hours">
                                    <div class="flip"><div class="card-top">0</div><div class="card-bottom">0</div></div>
                                    <div class="flip"><div class="card-top">0</div><div class="card-bottom">0</div></div>
                                </div>
                                <div class="wc-label">Giờ</div>
                            </div>
                            <div class="wc-unit">
                                <div class="digits" data-unit="minutes">
                                    <div class="flip"><div class="card-top">0</div><div class="card-bottom">0</div></div>
                                    <div class="flip"><div class="card-top">0</div><div class="card-bottom">0</div></div>
                                </div>
                                <div class="wc-label">Phút</div>
                            </div>
                            <div class="wc-unit">
                                <div class="digits" data-unit="seconds">
                                    <div class="flip"><div class="card-top">0</div><div class="card-bottom">0</div></div>
                                    <div class="flip"><div class="card-top">0</div><div class="card-bottom">0</div></div>
                                </div>
                                <div class="wc-label">Giây</div>
                            </div>
                        </div>
                        <div class="confetti-holder" aria-hidden="true"></div>
                    </div>
                    {% endif %}

                    <h4 class="section-title events-title">Diễn biến chính</h4>
                    <ul class="event-timeline">
                        {% for event in events %}
                        <li class="event-item">
                            <div class="event-minute">{{ event.minute|default:"-" }}'</div>
                            <div class="event-icon">
                                {% if event.is_own_goal %}
                                    <span title="Phản lưới nhà">⚽️</span>
                                {% elif event.event_type == 'GOAL' %}
                                    <span title="Bàn thắng">⚽️</span>
                                {% elif event.card_type == 'YELLOW' %}
                                    <span class="badge bg-warning text-dark" style="width: 1rem; height: 1.2rem; display: inline-block; border: 1px solid #666;" title="Thẻ vàng"></span>
                                {% elif event.card_type == 'RED' %}
                                    <span class="badge bg-danger" style="width: 1rem; height: 1.2rem; display: inline-block; border: 1px solid #666;" title="Thẻ đỏ"></span>
                                {% elif event.event_type == 'SUBSTITUTION' %}
                                    <i class="bi bi-arrow-left-right" title="Thay người"></i>
                                {% else %}
                                    <i class="bi bi-info-circle" title="Sự kiện"></i>
                                {% endif %}
                            </div>
                            <div class="event-details">
                                <strong>
                                    <a href="{% url 'player_detail' pk=event.player.pk %}" class="text-decoration-none text-dark">
                                        {{ event.player.full_name }}
                                    </a>
                                    {% if event.player.user and event.player.team.captain == event.player.user %}
                                        <span class="captain-indicator">(C)</span>
                                    {% endif %}
                                </strong> ({{ event.team.name }})
                            </div>
                        </li>
                        {% empty %}
                        <li class="text-muted">Chưa có diễn biến nào nổi bật.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h4 class="section-title">{{ match.team2.name }}</h4>

                    <h5 class="lineup-title sub-heading">Đá chính</h5>
                    {% for p_data in team2_starters %}
                        <div class="player-card">
                            <img src="{% if p_data.player.avatar %}{{ p_data.player.avatar.url }}{% else %}https://via.placeholder.com/48{% endif %}" class="player-avatar" loading="lazy" alt="{{ p_data.player.full_name }}">
                            <div class="player-info">
                                <div class="player-name">
                                   <a href="{% url 'player_detail' pk=p_data.player.pk %}" class="text-decoration-none text-dark">
                                        #{{ p_data.player.jersey_number }} - {{ p_data.player.full_name }}
                                    </a>
                                    {% if p_data.player.user and p_data.player.team.captain == p_data.player.user %}
                                        <span class="captain-indicator">(C)</span>
                                    {% endif %}
                                </div>
                                <div class="player-details">{{ p_data.player.get_position_display }}</div>
                            </div>
                            <div class="player-stats">
                                {% if p_data.goals > 0 %}<span title="Bàn thắng">⚽ {{ p_data.goals }}</span>{% endif %}
                                {% if p_data.yellow_cards > 0 %}<span class="badge bg-warning text-dark" title="Thẻ vàng">{{ p_data.yellow_cards }}</span>{% endif %}
                                {% if p_data.red_cards > 0 %}<span class="badge bg-danger" title="Thẻ đỏ">{{ p_data.red_cards }}</span>{% endif %}
                            </div>
                        </div>
                    {% empty %}
                        <p class="text-muted small">Chưa có cầu thủ đá chính.</p>
                    {% endfor %}

                    <h5 class="mt-4 sub-heading">Dự bị</h5>
                    {% for p_data in team2_substitutes %}
                        <div class="player-card">
                            <img src="{% if p_data.player.avatar %}{{ p_data.player.avatar.url }}{% else %}https://via.placeholder.com/48{% endif %}" class="player-avatar" loading="lazy" alt="{{ p_data.player.full_name }}">
                            <div class="player-info">
                                <div class="player-name">
                                   <a href="{% url 'player_detail' pk=p_data.player.pk %}" class="text-decoration-none text-dark">
                                        #{{ p_data.player.jersey_number }} - {{ p_data.player.full_name }}
                                    </a>
                                    {% if p_data.player.user and p_data.player.team.captain == p_data.player.user %}
                                        <span class="captain-indicator">(C)</span>
                                    {% endif %}
                                </div>
                                <div class="player-details">{{ p_data.player.get_position_display }}</div>
                            </div>
                            <div class="player-stats">
                                {% if p_data.goals > 0 %}<span title="Bàn thắng">⚽ {{ p_data.goals }}</span>{% endif %}
                                {% if p_data.yellow_cards > 0 %}<span class="badge bg-warning text-dark" title="Thẻ vàng">{{ p_data.yellow_cards }}</span>{% endif %}
                                {% if p_data.red_cards > 0 %}<span class="badge bg-danger" title="Thẻ đỏ">{{ p_data.red_cards }}</span>{% endif %}
                            </div>
                        </div>
                    {% empty %}
                        <p class="text-muted small">Không có cầu thủ dự bị.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
(function(){
  const root = document.getElementById('wow-countdown');
  if(!root) return;
  const targetISO = root.dataset.datetime; // ISO 8601 (server)
  const target = new Date(targetISO);
  const confettiHolder = root.querySelector('.confetti-holder');

  function pad2(n){ return String(n).padStart(2,'0'); }
  function setDigits(unitSel, str){
      const digits = root.querySelector(`[data-unit="${unitSel}"]`).querySelectorAll('.flip');
      const [d1, d2] = str.split('');
      flipTo(digits[0], d1);
      flipTo(digits[1], d2);
  }

  function flipTo(flipEl, newNumber){
      const top = flipEl.querySelector('.card-top');
      const bottom = flipEl.querySelector('.card-bottom');
      const current = top.textContent;
      if(current === newNumber) return;

      const topFlip = document.createElement('div');
      topFlip.className = 'top-flip';
      topFlip.textContent = current;

      const bottomFlip = document.createElement('div');
      bottomFlip.className = 'bottom-flip';
      bottomFlip.textContent = newNumber;

      topFlip.addEventListener('animationend', () => {
        top.textContent = newNumber;
        topFlip.remove();
      });
      bottomFlip.addEventListener('animationend', () => {
        bottom.textContent = newNumber;
        bottomFlip.remove();
      });

      flipEl.append(topFlip, bottomFlip);
  }

  let last = {d:'--', h:'--', m:'--', s:'--'};
  function tick(){
      const now = new Date();
      const diff = target - now;
      if(diff <= 0){
        setDigits('days', '00'); setDigits('hours','00'); setDigits('minutes','00'); setDigits('seconds','00');
        root.querySelector('.wc-header').innerHTML = '<i class="bi bi-trophy"></i> Trận đấu bắt đầu!';
        launchConfetti();
        clearInterval(loop);
        return;
      }
      const d = Math.floor(diff / (1000*60*60*24));
      const h = Math.floor((diff % (1000*60*60*24))/(1000*60*60));
      const m = Math.floor((diff % (1000*60*60))/(1000*60));
      const s = Math.floor((diff % (1000*60))/1000);

      const ds = pad2(Math.min(d,99));
      const hs = pad2(h), ms = pad2(m), ss = pad2(s);

      if(ds !== last.d){ setDigits('days', ds); last.d = ds; }
      if(hs !== last.h){ setDigits('hours', hs); last.h = hs; }
      if(ms !== last.m){ setDigits('minutes', ms); last.m = ms; }
      if(ss !== last.s){ setDigits('seconds', ss); last.s = ss; }
  }

  function launchConfetti(){
      const colors = ['#22d3ee','#a78bfa','#f472b6','#f59e0b','#34d399','#60a5fa'];
      for(let i=0;i<100;i++){
        const c = document.createElement('div');
        c.className='confetti';
        c.style.left = (Math.random()*100)+'%';
        c.style.background = colors[Math.floor(Math.random()*colors.length)];
        const dur = 4 + Math.random()*2;
        c.style.animationDuration = dur+'s';
        c.style.transform = `translateY(-100%) rotate(${Math.random()*360}deg)`;
        c.style.opacity = 0.6 + Math.random()*0.4;
        confettiHolder.appendChild(c);
        setTimeout(()=>c.remove(), dur*1000+500);
      }
  }

  const loop = setInterval(tick, 1000);
  tick();
})();
</script>

<!-- JSON-LD (tuỳ chọn cho SEO) -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "SportsEvent",
  "name": "{{ match.team1.name|escapejs }} vs {{ match.team2.name|escapejs }}",
  "sport": "Soccer",
  "startDate": "{{ match.match_time|date:'c' }}",
  "location": {
    "@type": "Place",
    "name": "{{ match.location|escapejs }}",
    "address": {"@type": "PostalAddress", "addressLocality": "Việt Nam"}
  },
  "competitor": [
    {"@type": "SportsTeam", "name": "{{ match.team1.name|escapejs }}"},
    {"@type": "SportsTeam", "name": "{{ match.team2.name|escapejs }}"}
  ]
}
</script>
{% endblock %}
{% endblock %}
