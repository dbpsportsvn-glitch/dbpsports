{% extends 'base.html' %}
{% load static humanize custom_filters %}

{% block title %}Thị trường Chuyển nhượng{% endblock %}

{% block extra_css %}
<style>
  /* ====== CARD FUT & THEME ====== */
  .card-fut{position:relative;border-radius:24px;overflow:hidden;background:rgba(2,6,23,.6);border:1px solid rgba(148,163,184,.18);transition:transform .25s ease, box-shadow .25s ease}
  .card-fut:hover{transform:translateY(-8px);box-shadow:0 20px 40px rgba(2,6,23,.4)}
  .card-fut:before{content:"";position:absolute;inset:0;z-index:4;padding:2px;border-radius:24px;background:linear-gradient(135deg,var(--accent),var(--glow));-webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none}
  .card-fut:after{content:"";position:absolute;top:-50%;left:-50%;right:-50%;z-index:2;height:75%;background:radial-gradient(ellipse at center,var(--accent) 0%,transparent 60%);opacity:.3;filter:blur(20px);pointer-events:none;transition:opacity .3s ease}
  .card-fut:hover:after{opacity:.5}
  .card-fut .plate{position:absolute;inset:1px;z-index:1;border-radius:21px;pointer-events:none;background:linear-gradient(170deg,#475569,#1e293b)}
  .t-bronze .plate{background:linear-gradient(170deg,#8c5a2b,#4a2f12)}
  .t-silver .plate{background:linear-gradient(170deg,#a8a8b2,#5f5f6e)}
  .t-gold .plate{background:linear-gradient(170deg,#d4af37,#8b6f0a)}
  .t-elite .plate{background:linear-gradient(170deg,#00b8d4,#005a6f)}
  .t-legend .plate{background:linear-gradient(170deg,#9c27b0,#4c005a)}
  .t-bronze{--accent:#CD7F32}
  .t-silver{--accent:#C0C0C0}
  .t-gold{--accent:#FFD700}
  .t-elite{--accent:#00BCD4}
  .t-legend{--accent:#9C27B0}

  .card-fut .topbar,.card-fut .head,.card-fut .value-sheet,.card-fut .tier-progress-wrapper,.card-fut .actions{position:relative;z-index:3;color:#e2e8f0}
  .card-fut .topbar{display:flex;align-items:center;justify-content:space-between;padding:.75rem .85rem .25rem}
  .rank-badge,.jersey-chip{font-weight:700;padding:.25rem .6rem;border-radius:999px;background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.2);backdrop-filter:blur(5px)}
  .player-avatar{width:96px;height:96px;border-radius:50%;object-fit:cover;border:4px solid rgba(255,255,255,.4);box-shadow:0 8px 20px rgba(0,0,0,.4);margin-bottom:.5rem}
  .card-fut .head{text-align:center;padding:.5rem 1rem}
  .player-name{color:#fff;font-weight:800;font-size:1.1rem;text-shadow:0 1px 3px rgba(0,0,0,.5)}
  .team-line{display:inline-flex;gap:.5rem;align-items:center;color:#cbd5e1;font-size:.9rem}
  .team-line img{width:22px;height:22px;object-fit:contain}
  .value-sheet{display:grid;gap:.35rem;padding:.75rem 1rem 0;font-size:.9rem}
  .value-row{display:flex;align-items:center;justify-content:space-between;color:#cbd5e1}
  .value-row b{color:#fff;font-weight:700}

  /* ====== TIER PROGRESS ====== */
  .tier-progress-wrapper{padding:.75rem 1rem}
  .tier-next-text{color:rgba(255,255,255,.7)!important;font-size:.8rem;text-shadow:0 1px 2px rgba(0,0,0,.7)}
  .tier-track{position:relative;height:10px;border-radius:999px;overflow:hidden;border:1px solid rgba(0,0,0,.3);background:rgba(0,0,0,.35)}
  .tier-slice{height:100%;display:inline-block;background:repeating-linear-gradient(90deg, rgba(255,255,255,.08), rgba(255,255,255,.08) 6px, rgba(255,255,255,.02) 6px, rgba(255,255,255,.02) 12px)}
  .tier-marker{position:absolute;top:-3px;width:3px;height:16px;background:#fff;border-radius:2px;box-shadow:0 0 5px 2px rgba(255,255,255,.5)}
  .tier-tag{display:inline-flex;gap:.4rem;align-items:center;font-weight:800;letter-spacing:.5px;color:#0b1220;padding:.2rem .5rem;border-radius:8px;background:linear-gradient(180deg,#fff,#e9eef3);border:1px solid #cfd8e3}

  .card-fut .actions{padding:0 1rem 1rem;margin-top:auto}
  .btn-action{border-radius:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;padding:.7rem;font-size:.9rem;transition:all .2s ease;box-shadow:0 4px 15px rgba(0,0,0,.2)}
  .btn-action:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.3)}

  /* ====== HIGHLIGHT SECTIONS ====== */
  .highlight-section{background:linear-gradient(135deg,#1e293b,#0f172a);padding:2rem;border-radius:1rem;margin-bottom:2rem;border:1px solid #334155}
  .highlight-title{color:#f59e0b;font-weight:700;text-align:center;margin-bottom:1.5rem}
  .highlight-item{display:flex;align-items:center;background-color:rgba(255,255,255,.05);padding:.75rem;border-radius:.5rem;margin-bottom:.75rem;transition:background-color .2s ease}
  .highlight-item:hover{background-color:rgba(255,255,255,.1)}
  .highlight-rank{font-size:1.5rem;font-weight:800;color:#94a3b8;width:40px;text-align:center}
  .highlight-avatar{width:40px;height:40px;border-radius:50%;object-fit:cover;margin-left:1rem;margin-right:1rem}
  .highlight-info{flex-grow:1;min-width:0}
  .highlight-name{font-weight:600;color:#e2e8f0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .highlight-team{font-size:.8rem;color:#94a3b8}
  .highlight-value{font-weight:700;font-size:1.1rem;color:#f59e0b;text-align:right;min-width:120px}

  /* ====== A11Y / PREFERS REDUCED MOTION ====== */
  @media (prefers-reduced-motion: reduce){
    .card-fut:hover{transform:none}
    .card-fut:after{opacity:.15;filter:none}
    .btn-action:hover:not(:disabled){transform:none}
  }
  /* === no-wrap & spacing for tier header === */
  .tier-progress-wrapper .d-flex{flex-wrap:nowrap}
  .tier-tag{margin-right:.5rem}
  .tier-next-text{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  /* === force same-line & spacing for tier header (override) === */
  .tier-progress-wrapper .d-flex{flex-wrap:nowrap !important; align-items:flex-start}
  .tier-tag{margin-right:.5rem; flex:0 0 auto}
  .tier-next-text{white-space:normal; overflow:visible; text-overflow:clip; flex:1 1 auto; margin-left:.5rem; line-height:1.25}
  /* === restore hover lift effect (strong override) === */
  .card-fut{will-change: transform}
  .card-fut:hover{transform: translateY(-8px) !important; box-shadow: 0 20px 40px rgba(2,6,23,.4) !important}

/* ========================================
   MODERN TRANSFER MARKET HEADER
   ======================================== */
.transfer-market-hero {
  background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
  border-radius: 20px;
  padding: 3rem 2rem;
  margin-bottom: 2rem;
  position: relative;
  overflow: hidden;
}

.transfer-market-hero::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -20%;
  width: 60%;
  height: 200%;
  background: radial-gradient(ellipse at center, rgba(255,255,255,0.1) 0%, transparent 70%);
  transform: rotate(15deg);
  pointer-events: none;
}

.transfer-market-title {
  font-size: 2.8rem;
  font-weight: 800;
  color: white;
  margin: 0;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  line-height: 1.2;
}

.transfer-market-subtitle {
  color: rgba(255, 255, 255, 0.9);
  font-size: 1.1rem;
  margin-top: 1rem;
  font-weight: 400;
}

.transfer-market-icon {
  font-size: 2.5rem;
  margin-right: 1rem;
  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
}

/* ========================================
   ACTION BUTTONS
   ======================================== */
.action-btn {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  border: none;
  border-radius: 12px;
  padding: 0.75rem 1.5rem;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
  color: white;
}

.action-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
  color: white;
}

/* ========================================
   MODERN FILTER CARD
   ======================================== */
.filter-card {
  background: white;
  border-radius: 15px;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  border: 1px solid #e2e8f0;
  transition: all 0.3s ease;
}

.filter-card:hover {
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
  transform: translateY(-2px);
}

.filter-label {
  font-size: 0.9rem;
  font-weight: 600;
  color: #374151;
  margin-bottom: 0.5rem;
  display: block;
}

.filter-input {
  border: 1px solid #d1d5db;
  border-radius: 8px;
  padding: 0.75rem 1rem;
  font-size: 0.95rem;
  transition: all 0.3s ease;
  background: white;
}

.filter-input:focus {
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  outline: none;
}

.filter-select {
  appearance: none;
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
  background-position: right 0.75rem center;
  background-repeat: no-repeat;
  background-size: 1rem;
  padding-right: 2.5rem;
}

.filter-btn {
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  border: none;
  border-radius: 8px;
  padding: 0.75rem 1.5rem;
  font-weight: 600;
  font-size: 0.95rem;
  color: white;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.filter-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
  color: white;
}

.results-text {
  color: #6b7280;
  font-size: 0.9rem;
  font-weight: 500;
  margin-bottom: 1rem;
}

/* ========================================
   HERO TITLE WITH ACTION BUTTON
   ======================================== */
.transfer-market-hero {
  position: relative;
}

.action-btn-corner {
  position: absolute;
  bottom: 1rem;
  right: 1rem;
  background: rgba(255, 255, 255, 0.9);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 8px;
  padding: 0.5rem 1rem;
  font-weight: 600;
  font-size: 0.85rem;
  color: #6366f1;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  backdrop-filter: blur(10px);
}

.action-btn-corner:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
  color: #4f46e5;
  background: rgba(255, 255, 255, 1);
}

/* ========================================
   FORM SECTIONS (for invite form)
   ======================================== */
.form-section {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
}

.section-title {
  color: #495057;
  font-weight: 600;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.form-check-input:checked {
  background-color: #6366f1;
  border-color: #6366f1;
}

.form-check-input:focus {
  box-shadow: 0 0 0 0.25rem rgba(99, 102, 241, 0.25);
}

/* ========================================
   RESPONSIVE
   ======================================== */
@media (max-width: 768px) {
  .transfer-market-hero {
    padding: 2rem 1.5rem;
    text-align: center;
  }
  
  .transfer-market-title {
    font-size: 2.2rem;
  }
  
  .transfer-market-icon {
    font-size: 2rem;
    margin-right: 0.5rem;
  }
}

@media (max-width: 576px) {
  .transfer-market-title {
    font-size: 1.8rem;
  }
  
  .transfer-market-subtitle {
    font-size: 1rem;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
  <!-- Modern Hero Header -->
  <div class="transfer-market-hero">
    <div class="row align-items-center">
      <div class="col-12">
        <div class="hero-title-container">
          <h1 class="transfer-market-title">
            <i class="bi bi-shop transfer-market-icon"></i>
            Thị trường Chuyển nhượng
          </h1>
          <p class="transfer-market-subtitle">
            Khám phá và tìm kiếm những tài năng hàng đầu từ tất cả các giải đấu
          </p>
        </div>
      </div>
    </div>
    <a href="{% url 'transfer_history' %}" class="action-btn-corner">
      <i class="bi bi-clock-history me-1"></i>Lịch sử
    </a>
  </div>

  <div class="row g-4 mb-4">
    <div class="col-lg-6">
      <div class="highlight-section h-100">
        <h3 class="highlight-title"><i class="bi bi-stars"></i> Top Cầu Thủ</h3>
        {% if top_players %}
          <ol class="list-unstyled m-0">
            {% for player in top_players %}
            <li>
              <a href="{% url 'player_detail' pk=player.pk %}" class="text-decoration-none d-block">
                <div class="highlight-item">
                  <div class="highlight-rank">#{{ forloop.counter }}</div>
                  <img src="{% if player.avatar %}{{ player.avatar.url }}{% else %}{% static 'images/placeholder_avatar.png' %}{% endif %}"
                       alt="{{ player.full_name }}" class="highlight-avatar" loading="lazy" width="40" height="40">
                  <div class="highlight-info">
                    <div class="highlight-name">{{ player.full_name }}</div>
                    <div class="highlight-team">{{ player.team.name|default:"Tự do" }}</div>
                  </div>
                  <div class="highlight-value">{{ player.market_value|vnd_format }}</div>
                </div>
              </a>
            </li>
            {% endfor %}
          </ol>
        {% else %}
          <p class="text-center text-muted">Không có cầu thủ nào trong bảng xếp hạng.</p>
        {% endif %}
      </div>
    </div>

    <div class="col-lg-6">
      <div class="highlight-section h-100">
        <h3 class="highlight-title"><i class="bi bi-person-plus-fill"></i> Đang Tìm CLB</h3>
        {% if looking_for_club_players %}
          <div>
            {% for player in looking_for_club_players %}
            <a href="{% url 'player_detail' pk=player.pk %}" class="text-decoration-none d-block">
              <div class="highlight-item">
                <img src="{% if player.avatar %}{{ player.avatar.url }}{% else %}{% static 'images/placeholder_avatar.png' %}{% endif %}"
                     alt="{{ player.full_name }}" class="highlight-avatar" loading="lazy" width="40" height="40">
                <div class="highlight-info">
                  <div class="highlight-name">{{ player.full_name }}</div>
                  <div class="highlight-team">{{ player.team.name|default:"Tự do" }} - {{ player.location_detail|default:player.get_region_display }}</div>
                </div>
                <div class="highlight-value">{{ player.market_value|vnd_format }}</div>
              </div>
            </a>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-center text-muted">Hiện không có cầu thủ nào đang tìm CLB mới trong khu vực này.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Modern Filter Card -->
  <div class="filter-card">
    <form method="get" class="row g-3 align-items-end">
      <div class="col-md-3">
        <label for="region" class="filter-label">Khu vực</label>
        <select name="region" id="region" class="form-control filter-input filter-select">
          <option value="">Tất cả khu vực</option>
          <option value="NORTH" {% if request.GET.region == 'NORTH' %}selected{% endif %}>Miền Bắc</option>
          <option value="CENTRAL" {% if request.GET.region == 'CENTRAL' %}selected{% endif %}>Miền Trung</option>
          <option value="SOUTH" {% if request.GET.region == 'SOUTH' %}selected{% endif %}>Miền Nam</option>
        </select>
      </div>
      <div class="col-md-3">
        <label for="location" class="filter-label">Tỉnh/Thành phố</label>
        <input type="text" class="form-control filter-input" id="location" name="location" 
               placeholder="VD: Hà Nội, Điện Biên..." value="{{ request.GET.location }}">
      </div>
      <div class="col-md-3">
        <label for="position" class="filter-label">Vị trí</label>
        <select name="position" id="position" class="form-control filter-input filter-select">
          <option value="">Tất cả vị trí</option>
          <option value="GK" {% if request.GET.position == 'GK' %}selected{% endif %}>Thủ môn</option>
          <option value="DEF" {% if request.GET.position == 'DEF' %}selected{% endif %}>Hậu vệ</option>
          <option value="MID" {% if request.GET.position == 'MID' %}selected{% endif %}>Tiền vệ</option>
          <option value="FWD" {% if request.GET.position == 'FWD' %}selected{% endif %}>Tiền đạo</option>
        </select>
      </div>
      <div class="col-md-3">
        <button type="submit" class="btn filter-btn w-100">
          <i class="bi bi-funnel me-1"></i>Lọc Cầu thủ
        </button>
      </div>
    </form>
  </div>

  <!-- Results Text -->
  <div class="results-text">
    Tìm thấy <strong>{{ players|length|default:0 }}</strong> kết quả phù hợp.
  </div>

  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4" id="player-list-container">
    {% for player in players %}
    <div class="col player-card-wrapper" data-player data-market="{{ player.market_value|default:0 }}">
      <div class="card card-fut h-100">
        <div class="plate"></div>
        <div class="topbar">
          <span class="rank-badge"><i class="bi bi-trophy"></i> #<span class="rank-number">{{ forloop.counter }}</span></span>
          {% if player.jersey_number %}<span class="jersey-chip">#{{ player.jersey_number }}</span>{% endif %}
        </div>
        <div class="head">
          <a href="{% url 'player_detail' pk=player.pk %}" target="_blank" rel="noopener noreferrer">
            <img class="player-avatar" src="{% if player.avatar %}{{ player.avatar.url }}{% else %}{% static 'images/placeholder_avatar.png' %}{% endif %}" alt="{{ player.full_name }}" loading="lazy" width="96" height="96">
          </a>
          <div class="player-name"><a href="{% url 'player_detail' pk=player.pk %}" class="text-decoration-none text-white">{{ player.full_name }}</a></div>
          <div class="team-line mt-1">
            {% if player.team and player.team.logo %}
              <img src="{{ player.team.logo.url }}" alt="{{ player.team.name }}" loading="lazy" width="22" height="22">
            {% endif %}
            <span>{{ player.team.name|default:"Cầu thủ tự do" }}</span>
          </div>
        </div>
        <div class="value-sheet">
          <div class="value-row"><span>Giá trị gốc</span><b>{{ player.transfer_value|vnd_format }}</b></div>
          <div class="value-row"><span>Phiếu bầu</span><b>{{ player.votes|intcomma }}</b></div>
          <div class="value-row"><span>Giá trị TT</span><b>{{ player.market_value|vnd_format }}</b></div>
        </div>
        <div class="tier-progress-wrapper"></div>

        {% include "tournaments/partials/_player_card_actions.html" %}
      </div>
    </div>
    {% endfor %}
  </div>

  {% if not players %}
    <div class="alert alert-info mt-4">Không tìm thấy cầu thủ nào phù hợp với bộ lọc của bạn.</div>
  {% endif %}
</div>

{# Giữ nguyên modal mỗi cầu thủ để không thay đổi logic của _invite_form #}
{% for player in players %}
  {% if captained_teams and player.team and player.team not in captained_teams %}
  <div class="modal fade" id="inviteModal-{{ player.pk }}" tabindex="-1" aria-labelledby="inviteModalLabel-{{ player.pk }}" data-market-value="{{ player.market_value|floatformat:'0' }}">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="inviteModalLabel-{{ player.pk }}">Gửi lời mời cho {{ player.full_name }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
        </div>
        <div class="modal-body">
          {% include "tournaments/partials/_invite_form.html" %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}
{% endfor %}

{% endblock %}

{% block extra_js %}
<script>
  // ====== CONSTANTS & HELPERS ======
  const TIERS = [
    { key:'bronze', label:'BRONZE', color:'#CD7F32', min:0, max:1_000_000 },
    { key:'silver', label:'SILVER', color:'#C0C0C0', min:1_000_000, max:5_000_000 },
    { key:'gold',   label:'GOLD',   color:'#FFD700', min:5_000_000, max:10_000_000 },
    { key:'elite',  label:'ELITE',  color:'#00BCD4', min:10_000_000, max:20_000_000 },
    { key:'legend', label:'LEGEND', color:'#9C27B0', min:20_000_000, max:Infinity },
  ];
  const plainNF = new Intl.NumberFormat('vi-VN');

  function getTier(v){
    for(const t of TIERS){ if(v >= t.min && v < t.max) return t; }
    return TIERS[0];
  }
  function markerPercent(v){
    const span = TIERS[TIERS.length-2].max; // cap ở ngưỡng ELITE
    const cap = Math.max(0, Math.min(v, span));
    return (cap / span) * 100;
  }
  function slicePerc(t){
    const span = TIERS[TIERS.length-2].max;
    const width = (Math.min(t.max, span) - t.min) / span * 100;
    return Math.max(0, width);
  }

  document.addEventListener('DOMContentLoaded', () => {
    // Decorate each card by tier + build progress bar
    document.querySelectorAll('[data-player]').forEach(card => {
      const mv = Number(card.dataset.market || 0);
      const tier = getTier(mv);
      const fut = card.querySelector('.card-fut');
      fut.classList.add(`t-${tier.key}`);

      const wrap = card.querySelector('.tier-progress-wrapper');
      if(wrap){
        const idx  = TIERS.findIndex(t => t.key === tier.key);
        const next = TIERS[idx + 1];
        const topText = next
          ? `Tiến tới ${next.label}:<br>còn ${plainNF.format(Math.max(0, next.min - mv))} VNĐ`
          : `Đã đạt cấp cao nhất`;

        wrap.innerHTML = `
          <div class=\"d-flex align-items-center gap-2 flex-wrap mb-2\">
            <span class=\"tier-tag me-1\"><i class=\"bi bi-gem\"></i> ${tier.label}</span>
            <span class=\"tier-next-text\">${topText}</span>
          </div>
          <div class="tier-track">
            ${TIERS.slice(0, TIERS.length-1).map(t => `<span class=\"tier-slice\" style=\"width:${slicePerc(t)}%\"></span>`).join('')}
            <span class="tier-marker" style="left:${markerPercent(mv)}%"></span>
          </div>`;
      }
    });

    // Modal handlers: tự động gợi ý phí theo loại chuyển nhượng
    document.querySelectorAll('.modal').forEach(modal => {
      const form = modal.querySelector('form');
      const teamSelect = modal.querySelector('select[id^="team-select-"]');

      if(teamSelect){
        teamSelect.addEventListener('change', function(){
          if(form) form.action = this.value;
        });
      }

      modal.addEventListener('change', e => {
        if(!e.target.classList.contains('transfer-type-radio')) return;
        const containerForm = e.target.closest('form');
        const loanOptions   = containerForm?.querySelector('.loan-options');
        const loanDateInput = containerForm?.querySelector('input[name="loan_end_date"]');
        const offerInput    = containerForm?.querySelector('input[name="offer_amount"]');
        const feeSuggestion = containerForm?.querySelector('small[id^="fee-suggestion-"]');

        const marketValue = parseFloat(modal.dataset.marketValue || '0');
        const isLoan = e.target.value === 'LOAN' && e.target.checked;

        if(loanOptions) loanOptions.style.display = isLoan ? 'block' : 'none';
        if(loanDateInput) loanDateInput.required = isLoan;

        if(offerInput){
          if(isLoan){
            const loanFee = Math.round(marketValue * 0.2);
            offerInput.value = loanFee;
            if(feeSuggestion) feeSuggestion.textContent = `Phí gợi ý: 20% giá trị TT (${plainNF.format(loanFee)} VNĐ).`;
          } else {
            offerInput.value = marketValue;
            if(feeSuggestion) feeSuggestion.textContent = 'Giá đề nghị bằng giá trị thị trường.';
          }
        }
      });
    });
  });
</script>
{% endblock %}
