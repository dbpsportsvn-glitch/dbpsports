{% extends 'base.html' %}
{% load static %}

{% block title %}Chiêu mộ Huấn luyện viên - {{ team.name }}{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'team_detail' team.pk %}">{{ team.name }}</a></li>
                    <li class="breadcrumb-item active">Chiêu mộ HLV</li>
                </ol>
            </nav>
            
            <h2><i class="bi bi-search"></i> Tìm Huấn luyện viên</h2>
            <p class="text-muted">Tìm kiếm và gửi lời mời cho HLV phù hợp với đội bóng {{ team.name }}</p>
        </div>
    </div>
    
    {# Filters #}
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label"><i class="bi bi-geo-alt"></i> Khu vực</label>
                            <select name="region" class="form-select">
                                <option value="">Tất cả</option>
                                {% for value, label in region_choices %}
                                <option value="{{ value }}" {% if current_region == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-3">
                            <label class="form-label"><i class="bi bi-graph-up"></i> Kinh nghiệm</label>
                            <select name="experience" class="form-select">
                                <option value="">Tất cả</option>
                                <option value="5+" {% if current_exp == '5+' %}selected{% endif %}>Từ 5 năm</option>
                                <option value="10+" {% if current_exp == '10+' %}selected{% endif %}>Từ 10 năm</option>
                            </select>
                        </div>
                        
                        <div class="col-md-4">
                            <label class="form-label"><i class="bi bi-search"></i> Tìm kiếm</label>
                            <input type="text" name="q" class="form-control" placeholder="Tên, chứng chỉ, chuyên môn..." value="{{ search_query }}">
                        </div>
                        
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-funnel"></i> Lọc
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    {# Danh sách HLV #}
    <div class="row">
        {% if coaches %}
            {% for coach in coaches %}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            {% if coach.avatar %}
                            <img src="{{ coach.avatar.url }}" class="rounded-circle me-3" width="70" height="70" style="object-fit: cover;">
                            {% else %}
                            <div class="rounded-circle me-3 bg-secondary d-flex align-items-center justify-content-center" style="width: 70px; height: 70px;">
                                <i class="bi bi-person-badge text-white fs-3"></i>
                            </div>
                            {% endif %}
                            
                            <div>
                                <h6 class="mb-0">{{ coach.full_name }}</h6>
                                <small class="text-muted">{{ coach.get_region_display }}</small>
                                {% if coach.location_detail %}
                                <br><small class="text-muted">{{ coach.location_detail }}</small>
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if coach.coaching_license %}
                        <p class="mb-1">
                            <i class="bi bi-award text-warning"></i>
                            <strong>{{ coach.coaching_license }}</strong>
                        </p>
                        {% endif %}
                        
                        {% if coach.years_of_experience %}
                        <p class="mb-1">
                            <i class="bi bi-calendar-check text-info"></i>
                            {{ coach.years_of_experience }} năm kinh nghiệm
                        </p>
                        {% endif %}
                        
                        {% if coach.specialization %}
                        <p class="mb-2 text-muted small">
                            <i class="bi bi-star"></i>
                            {{ coach.specialization }}
                        </p>
                        {% endif %}
                        
                        {% if coach.bio %}
                        <p class="text-muted small mb-3" style="line-height: 1.4;">
                            {{ coach.bio|truncatewords:20 }}
                        </p>
                        {% endif %}
                        
                        <div class="d-flex gap-2 mt-3">
                            <a href="{% url 'coach_profile_detail' coach.pk %}" class="btn btn-sm btn-outline-primary flex-grow-1" target="_blank">
                                <i class="bi bi-eye"></i> Xem hồ sơ
                            </a>
                            
                            {% if coach.id in sent_offers %}
                            <button class="btn btn-sm btn-secondary flex-grow-1" disabled>
                                <i class="bi bi-check-circle"></i> Đã gửi
                            </button>
                            {% else %}
                            <button class="btn btn-sm btn-success flex-grow-1" onclick="sendOffer({{ coach.pk }}, '{{ coach.full_name|escapejs }}')">
                                <i class="bi bi-envelope"></i> Gửi lời mời
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="alert alert-info text-center py-5">
                    <i class="bi bi-info-circle fs-1 d-block mb-3"></i>
                    <h5>Không tìm thấy HLV phù hợp</h5>
                    <p class="mb-0">Thử thay đổi bộ lọc hoặc quay lại sau.</p>
                </div>
            </div>
        {% endif %}
    </div>
    
    <div class="text-center mt-4">
        <a href="{% url 'team_detail' team.pk %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Quay lại đội
        </a>
    </div>
</div>

{# Modal gửi lời mời #}
<div class="modal fade" id="offerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-envelope"></i> Gửi lời mời chiêu mộ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    Bạn đang gửi lời mời cho HLV <strong id="coachNameDisplay"></strong>
                </div>
                
                <form id="offerForm">
                    {% csrf_token %}
                    <input type="hidden" id="coachId" name="coach_id">
                    
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-cash-coin"></i> Mức lương đề nghị (VNĐ)
                        </label>
                        <input type="number" name="salary_offer" class="form-control" 
                               placeholder="Ví dụ: 5000000" min="0">
                        <div class="form-text">Để trống nếu muốn thỏa thuận sau</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-calendar-range"></i> Thời hạn hợp đồng
                        </label>
                        <input type="text" name="contract_duration" class="form-control" 
                               placeholder="Ví dụ: 1 năm, 6 tháng, theo giải đấu...">
                        <div class="form-text">Mô tả thời gian hợp tác</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-chat-left-text"></i> Lời nhắn *
                        </label>
                        <textarea name="message" class="form-control" rows="5" required
                                  placeholder="Giới thiệu về đội bóng, kế hoạch phát triển, lý do muốn mời HLV này..."></textarea>
                        <div class="form-text">Lời nhắn càng chân thành càng thu hút HLV</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Hủy
                </button>
                <button type="button" class="btn btn-success" onclick="submitOffer()">
                    <i class="bi bi-send"></i> Gửi lời mời
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentCoachId = null;
let offerModal = null;

document.addEventListener('DOMContentLoaded', function() {
    offerModal = new bootstrap.Modal(document.getElementById('offerModal'));
});

function sendOffer(coachId, coachName) {
    currentCoachId = coachId;
    document.getElementById('coachId').value = coachId;
    document.getElementById('coachNameDisplay').textContent = coachName;
    
    // Reset form
    document.getElementById('offerForm').reset();
    document.getElementById('coachId').value = coachId; // Set lại sau khi reset
    
    offerModal.show();
}

function submitOffer() {
    const formData = new FormData(document.getElementById('offerForm'));
    
    // Validate
    const message = formData.get('message');
    if (!message || message.trim() === '') {
        alert('Vui lòng nhập lời nhắn!');
        return;
    }
    
    fetch(`/team/{{ team.pk }}/coach/${currentCoachId}/send-offer/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            offerModal.hide();
            alert('Đã gửi lời mời thành công! HLV sẽ nhận được thông báo.');
            location.reload();
        } else {
            alert(data.error || 'Có lỗi xảy ra. Vui lòng thử lại.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Có lỗi xảy ra. Vui lòng thử lại.');
    });
}
</script>
{% endblock %}

