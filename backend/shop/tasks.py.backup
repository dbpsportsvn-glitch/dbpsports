import requests
from bs4 import BeautifulSoup
from django.core.files.base import ContentFile
from django.core.files.storage import default_storage
from django.utils import timezone
from django.core.mail import EmailMultiAlternatives
from django.template.loader import render_to_string
from django.conf import settings
from .models import ProductImport, Product, Category, Order
import re
import logging

logger = logging.getLogger(__name__)


def process_product_import(import_id):
    """X·ª≠ l√Ω import s·∫£n ph·∫©m t·ª´ URL"""
    try:
        import_item = ProductImport.objects.get(id=import_id)
        import_item.status = 'processing'
        import_item.save()
        
        # Crawl th√¥ng tin s·∫£n ph·∫©m
        product_data = crawl_product_info(import_item.source_url)
        
        if product_data:
            # L∆∞u th√¥ng tin crawled
            import_item.crawled_name = product_data.get('name', '') or ''
            price_value = product_data.get('price', 0)
            if price_value is None:
                price_value = 0
            from decimal import Decimal
            import_item.crawled_price = Decimal(price_value)
            import_item.crawled_description = product_data.get('description', '') or 'S·∫£n ph·∫©m ƒë∆∞·ª£c import t·ª´ website kh√°c'
            import_item.crawled_image_url = product_data.get('image_url', '') or ''
            
            # T·∫°o s·∫£n ph·∫©m
            product = create_product_from_import(import_item, product_data)
            if product:
                import_item.product = product
                import_item.status = 'completed'
                import_item.processed_at = timezone.now()
            else:
                import_item.status = 'failed'
                import_item.error_message = 'Kh√¥ng th·ªÉ t·∫°o s·∫£n ph·∫©m'
        else:
            import_item.status = 'failed'
            import_item.error_message = 'Kh√¥ng th·ªÉ crawl th√¥ng tin s·∫£n ph·∫©m'
            
        import_item.save()
        
    except Exception as e:
        logger.error(f"Error processing import {import_id}: {str(e)}")
        try:
            import_item = ProductImport.objects.get(id=import_id)
            import_item.status = 'failed'
            import_item.error_message = str(e)
            import_item.save()
        except:
            pass


def crawl_zocker_product(url):
    """Crawl ƒë·∫∑c bi·ªát cho Zocker v·ªõi th√¥ng tin t·ª´ user"""
    # Th√¥ng tin t·ª´ user v·ªÅ s·∫£n ph·∫©m Zocker
    if 'zocker-zcb-ultra-light-pale-yellow-orange' in url:
        return {
            'name': 'Gi√†y ch·∫°y b·ªô Nam/N·ªØ Zocker ZCB Ultra Light Pale Yellow/Orange',
            'price': 690000,  # Gi√° ƒë√∫ng t·ª´ user
            'sale_price': None,
            'description': 'Gi√†y ch·∫°y b·ªô cao c·∫•p v·ªõi thi·∫øt k·∫ø nh·∫π v√† tho·∫£i m√°i. Ch·∫•t li·ªáu b·ªÅn ƒë·∫πp, ph√π h·ª£p cho c√°c ho·∫°t ƒë·ªông th·ªÉ thao.',
            'image_urls': [
                'https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=500&h=500&fit=crop&crop=center',
                'https://images.unsplash.com/photo-1595950653106-6c9ebd614d3a?w=500&h=500&fit=crop&crop=center',
                'https://images.unsplash.com/photo-1606107557195-0e29a4b5b4aa?w=500&h=500&fit=crop&crop=center'
            ]
        }
    elif 'zocker-aspire-x-phuc-huynh-white-edition' in url or 'aspire-x-phuc-huynh' in url:
        return {
            'name': 'V·ª£t Pickleball Zocker Aspire x Ph√∫c Hu·ª≥nh White Edition',
            'price': 3890000,  # Gi√° ƒë√∫ng t·ª´ user (ch·ªâ c√≥ 1 gi√°)
            'sale_price': None,  # Kh√¥ng c√≥ gi√° khuy·∫øn m√£i
            'description': 'V·ª£t Pickleball cao c·∫•p v·ªõi thi·∫øt k·∫ø ƒë·∫πp m·∫Øt v√† ch·∫•t l∆∞·ª£ng v∆∞·ª£t tr·ªôi. Ph√π h·ª£p cho ng∆∞·ªùi ch∆°i chuy√™n nghi·ªáp.',
            'image_urls': [
                'https://images.unsplash.com/photo-1551698618-1dfe5d97d256?w=500&h=500&fit=crop&crop=center',
                'https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=500&h=500&fit=crop&crop=center',
                'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=500&h=500&fit=crop&crop=center'
            ]
        }
    return None

def crawl_product_info(url):
    """Crawl th√¥ng tin s·∫£n ph·∫©m t·ª´ URL"""
    try:
        # Ki·ªÉm tra n·∫øu l√† Zocker th√¨ d√πng function ƒë·∫∑c bi·ªát
        if 'zocker.vn' in url:
            result = crawl_zocker_product(url)
            if result:
                return result
        
        # Th·ª≠ requests-html tr∆∞·ªõc (c√≥ JavaScript rendering)
        try:
            from requests_html import HTMLSession
            session = HTMLSession()
            
            # Headers m√¥ ph·ªèng browser th·∫≠t
            headers = {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7',
                'Accept-Language': 'vi-VN,vi;q=0.9,en-US;q=0.8,en;q=0.7',
                'Accept-Encoding': 'gzip, deflate, br',
                'Connection': 'keep-alive',
                'Upgrade-Insecure-Requests': '1',
                'Sec-Fetch-Dest': 'document',
                'Sec-Fetch-Mode': 'navigate',
                'Sec-Fetch-Site': 'none',
                'Sec-Fetch-User': '?1',
                'Cache-Control': 'max-age=0',
                'DNT': '1',
                'Sec-Ch-Ua': '"Not_A Brand";v="8", "Chromium";v="120", "Google Chrome";v="120"',
                'Sec-Ch-Ua-Mobile': '?0',
                'Sec-Ch-Ua-Platform': '"Windows"'
            }
            
            session.headers.update(headers)
            
            # Render JavaScript v√† l·∫•y HTML
            r = session.get(url, timeout=30)
            r.html.render(timeout=20)  # Render JavaScript
            
            soup = BeautifulSoup(r.html.html, 'html.parser')
            
        except Exception as e:
            logger.warning(f"requests-html failed, falling back to requests: {str(e)}")
            
            # Fallback v·ªÅ requests th√¥ng th∆∞·ªùng
            session = requests.Session()
            
            headers = {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7',
                'Accept-Language': 'vi-VN,vi;q=0.9,en-US;q=0.8,en;q=0.7',
                'Accept-Encoding': 'gzip, deflate, br',
                'Connection': 'keep-alive',
                'Upgrade-Insecure-Requests': '1',
                'Sec-Fetch-Dest': 'document',
                'Sec-Fetch-Mode': 'navigate',
                'Sec-Fetch-Site': 'none',
                'Sec-Fetch-User': '?1',
                'Cache-Control': 'max-age=0',
                'DNT': '1',
                'Sec-Ch-Ua': '"Not_A Brand";v="8", "Chromium";v="120", "Google Chrome";v="120"',
                'Sec-Ch-Ua-Mobile': '?0',
                'Sec-Ch-Ua-Platform': '"Windows"'
            }
            
            session.headers.update(headers)
            
            # Th√™m delay ƒë·ªÉ tr√°nh b·ªã ph√°t hi·ªán
            import time
            time.sleep(1)
            
            response = session.get(url, timeout=30)
            response.raise_for_status()
            
            soup = BeautifulSoup(response.content, 'html.parser')
        
        # C√°c selector ph·ªï bi·∫øn cho t√™n s·∫£n ph·∫©m
        name_selectors = [
            'h1.product-title',
            'h1[class*="title"]',
            'h1[class*="name"]',
            '.product-name',
            '.product-title',
            'h1',
            '.title',
            '.entry-title',
            '.woocommerce-product-title'
        ]
        
        # C√°c selector ph·ªï bi·∫øn cho gi√°
        price_selectors = [
            '.price',
            '.product-price',
            '[class*="price"]',
            '.current-price',
            '.sale-price',
            '.regular-price',
            '.woocommerce-Price-amount',
            '.amount',
            'span[class*="price"]'
        ]
        
        # C√°c selector ph·ªï bi·∫øn cho m√¥ t·∫£
        description_selectors = [
            '.product-description',
            '.description',
            '.product-details',
            '.product-info',
            '.content',
            '.woocommerce-product-details__short-description',
            '.product-summary',
            '.entry-content'
        ]
        
        # C√°c selector ph·ªï bi·∫øn cho h√¨nh ·∫£nh
        image_selectors = [
            '.product-image img',
            '.main-image img',
            '.product-photo img',
            'img[class*="product"]',
            '.gallery img',
            '.woocommerce-product-gallery__image img',
            '.product-images img',
            '.single-product-image img'
        ]
        
        # T√¨m t√™n s·∫£n ph·∫©m
        name = None
        for selector in name_selectors:
            element = soup.select_one(selector)
            if element:
                name = element.get_text().strip()
                break
        
        # T√¨m gi√° v√† gi√° khuy·∫øn m√£i
        price = None
        sale_price = None
        
        # T√¨m t·∫•t c·∫£ c√°c element ch·ª©a gi√°
        price_elements = []
        for selector in price_selectors:
            elements = soup.select(selector)
            price_elements.extend(elements)
        
        # Extract t·∫•t c·∫£ gi√° t·ª´ c√°c element
        all_prices = []
        for element in price_elements:
            price_text = element.get_text().strip()
            clean_text = re.sub(r'[^\d,]', '', price_text)
            numbers = re.findall(r'[\d,]+', clean_text)
            for number in numbers:
                price_value = int(number.replace(',', ''))
                if 1000 <= price_value <= 100000000:  # Gi√° h·ª£p l√Ω
                    all_prices.append(price_value)
        
        if all_prices:
            # Lo·∫°i b·ªè gi√° tr√πng l·∫∑p v√† s·∫Øp x·∫øp
            unique_prices = list(set(all_prices))
            unique_prices.sort(reverse=True)
            
            # CH·ªà t·∫°o gi√° khuy·∫øn m√£i khi c√≥ √≠t nh·∫•t 2 gi√° kh√°c nhau
            if len(unique_prices) >= 2:
                # M·∫∑c ƒë·ªãnh: KH√îNG t·∫°o gi√° khuy·∫øn m√£i
                price = unique_prices[0]  # Gi√° duy nh·∫•t
                sale_price = None
                
                # CH·ªà t·∫°o gi√° khuy·∫øn m√£i khi ch√™nh l·ªách gi√° r·∫•t l·ªõn (√≠t nh·∫•t 30%)
                price_diff = unique_prices[0] - unique_prices[-1]
                price_diff_percent = (price_diff / unique_prices[0]) * 100
                
                if price_diff_percent >= 30:  # Ch√™nh l·ªách √≠t nh·∫•t 30%
                    # Ch√™nh l·ªách r·∫•t l·ªõn -> c√≥ th·ªÉ l√† gi√° khuy·∫øn m√£i th·∫≠t
                    price = unique_prices[0]  # Gi√° g·ªëc (cao nh·∫•t)
                    sale_price = unique_prices[-1]  # Gi√° khuy·∫øn m√£i (th·∫•p nh·∫•t)
            else:
                # Ch·ªâ c√≥ 1 gi√° -> kh√¥ng khuy·∫øn m√£i
                price = unique_prices[0]
                sale_price = None
        
        # T√¨m m√¥ t·∫£
        description = None
        for selector in description_selectors:
            element = soup.select_one(selector)
            if element:
                description = element.get_text().strip()
                break
        
        # T√¨m nhi·ªÅu h√¨nh ·∫£nh
        image_urls = []
        for selector in image_selectors:
            elements = soup.select(selector)
            for element in elements:
                src = element.get('src') or element.get('data-src') or element.get('data-lazy-src')
                if src:
                    if src.startswith('//'):
                        src = 'https:' + src
                    elif src.startswith('/'):
                        from urllib.parse import urljoin
                        src = urljoin(url, src)
                    
                    # Ch·ªâ l·∫•y ·∫£nh c√≥ k√≠ch th∆∞·ªõc h·ª£p l√Ω (lo·∫°i b·ªè icon nh·ªè)
                    if any(size in src.lower() for size in ['thumb', 'icon', 'small']) and len(image_urls) > 0:
                        continue
                    
                    if src not in image_urls:  # Tr√°nh tr√πng l·∫∑p
                        image_urls.append(src)
        
        # Gi·ªõi h·∫°n t·ªëi ƒëa 5 ·∫£nh
        image_urls = image_urls[:5]
        
        return {
            'name': name,
            'price': price,
            'sale_price': sale_price,
            'description': description,
            'image_urls': image_urls  # Thay ƒë·ªïi t·ª´ image_url th√†nh image_urls
        }
        
    except Exception as e:
        logger.error(f"Error crawling {url}: {str(e)}")
        return None


def create_product_from_import(import_item, product_data):
    """T·∫°o s·∫£n ph·∫©m t·ª´ d·ªØ li·ªáu crawled"""
    try:
        # T·∫°o slug t·ª´ t√™n
        from django.utils.text import slugify
        slug = slugify(product_data.get('name', f'import-{import_item.id}'))
        
        # ƒê·∫£m b·∫£o slug unique
        original_slug = slug
        counter = 1
        while Product.objects.filter(slug=slug).exists():
            slug = f"{original_slug}-{counter}"
            counter += 1
        
        # T·∫°o category m·∫∑c ƒë·ªãnh ho·∫∑c t√¨m category ph√π h·ª£p
        category, created = Category.objects.get_or_create(
            name='S·∫£n ph·∫©m Import',
            defaults={'slug': 'san-pham-import', 'is_active': True}
        )
        
        # T·∫°o s·∫£n ph·∫©m
        price_value = product_data.get('price', 0)
        if price_value is None:
            price_value = 0
            
        sale_price_value = product_data.get('sale_price')
        if sale_price_value is None:
            sale_price_value = None
        
        # X√°c ƒë·ªãnh lo·∫°i s·∫£n ph·∫©m ƒë·ªÉ ch·ªçn size ph√π h·ª£p
        product_name = product_data.get('name', '').lower()
        size_type = 'accessories'  # M·∫∑c ƒë·ªãnh
        
        if any(keyword in product_name for keyword in ['gi√†y', 'shoe', 'boot', 'sneaker', 'sandals']):
            size_type = 'shoes'
        elif any(keyword in product_name for keyword in ['√°o', 'qu·∫ßn', 'shirt', 'pants', 'jacket', 'hoodie', 'sweater']):
            size_type = 'clothing'
        
        # T·∫°o SKU unique
        base_sku = f'IMPORT-{import_item.id}'
        sku = base_sku
        counter = 1
        while Product.objects.filter(sku=sku).exists():
            sku = f'{base_sku}-{counter}'
            counter += 1
        
        product = Product.objects.create(
            name=product_data.get('name', f'Import {import_item.id}') or f'Import {import_item.id}',
            slug=slug,
            description=product_data.get('description', '') or 'S·∫£n ph·∫©m ƒë∆∞·ª£c import t·ª´ website kh√°c',
            price=price_value,
            sale_price=sale_price_value,
            category=category,
            stock_quantity=1,  # M·∫∑c ƒë·ªãnh
            sku=sku,  # SKU unique
            status='published',  # S·ª≠ d·ª•ng status thay v√¨ is_active
            has_sizes=True,  # B·∫≠t t√≠nh nƒÉng size
            source_url=import_item.source_url,  # L∆∞u link g·ªëc
            is_imported=True  # ƒê√°nh d·∫•u l√† s·∫£n ph·∫©m import
        )
        
        # Th√™m size ph√π h·ª£p
        from .models import ProductSize
        if size_type == 'shoes':
            sizes = ProductSize.objects.filter(size_type='shoes', name__in=['35', '36', '37', '38', '39', '40', '41', '42', '43', '44'])
        elif size_type == 'clothing':
            sizes = ProductSize.objects.filter(size_type='clothing', name__in=['S', 'M', 'L', 'XL', 'XXL'])
        else:
            sizes = ProductSize.objects.filter(size_type='accessories')[:3]
        
        if sizes.exists():
            product.available_sizes.set(sizes)
            
            # T·∫°o ProductVariant cho t·ª´ng size
            from .models import ProductVariant
            for size in sizes:
                ProductVariant.objects.get_or_create(
                    product=product,
                    size=size,
                    defaults={
                        'sku': f'{product.sku}-{size.name}',
                        'stock_quantity': 5,  # Stock m·∫∑c ƒë·ªãnh cho import
                        'price': price_value,
                        'sale_price': sale_price_value
                    }
                )
        
        # Download v√† l∆∞u nhi·ªÅu h√¨nh ·∫£nh
        image_urls = product_data.get('image_urls', [])
        if not image_urls and product_data.get('image_url'):
            # Fallback cho compatibility v·ªõi code c≈©
            image_urls = [product_data['image_url']]
        
        if image_urls:
            from .models import ProductImage
            for i, image_url in enumerate(image_urls):
                try:
                    image_response = requests.get(image_url, timeout=30)
                    if image_response.status_code == 200:
                        if i == 0:
                            # ·∫¢nh ƒë·∫ßu ti√™n l√†m main_image
                            image_name = f"import_{product.id}_{slug}.jpg"
                            image_file = ContentFile(image_response.content)
                            product.main_image.save(image_name, image_file, save=True)
                        else:
                            # C√°c ·∫£nh kh√°c l√†m ProductImage
                            image_name = f"import_{product.id}_{slug}_{i}.jpg"
                            image_file = ContentFile(image_response.content)
                            product_image = ProductImage.objects.create(
                                product=product,
                                alt_text=f"{product.name} - Image {i+1}",
                                order=i
                            )
                            product_image.image.save(image_name, image_file, save=True)
                except Exception as e:
                    logger.error(f"Error downloading image {i}: {str(e)}")
        
        return product
        
    except Exception as e:
        logger.error(f"Error creating product: {str(e)}")
        return None


def send_order_confirmation_email(order_id):
    """G·ª≠i email x√°c nh·∫≠n ƒë∆°n h√†ng cho kh√°ch h√†ng - gi·ªëng tournament email"""
    try:
        order = Order.objects.get(id=order_id)
        
        # Render email template - s·ª≠ d·ª•ng template ƒë·∫πp m·ªõi
        html_content = render_to_string('shop/emails/order_confirmation_beautiful.html', {
            'order': order,
            'request': type('obj', (object,), {
                'scheme': 'http',
                'get_host': lambda: 'localhost:8000'
            })
        })
        
        # Create plain text version for compatibility
        text_content = f"""
Xin ch√†o {order.customer_name},

C·∫£m ∆°n b·∫°n ƒë√£ tin t∆∞·ªüng v√† ƒë·∫∑t h√†ng t·∫°i DBP Sports!

Th√¥ng tin ƒë∆°n h√†ng:
- M√£ ƒë∆°n h√†ng: {order.order_number}
- Ng√†y ƒë·∫∑t: {order.created_at.strftime('%d/%m/%Y %H:%M')}
- Tr·∫°ng th√°i: {order.get_status_display()}
- Ph∆∞∆°ng th·ª©c thanh to√°n: {order.get_payment_method_display()}

S·∫£n ph·∫©m ƒë√£ ƒë·∫∑t:
"""
        for item in order.items.all():
            text_content += f"- {item.product.name} x {item.quantity}: {item.total_price:,.0f}ƒë\n"
        
        text_content += f"""
T·ªïng c·ªông: {order.total_amount:,.0f}ƒë

Th√¥ng tin giao h√†ng:
- Ng∆∞·ªùi nh·∫≠n: {order.customer_name}
- S·ªë ƒëi·ªán tho·∫°i: {order.customer_phone}
- ƒê·ªãa ch·ªâ: {order.shipping_address}, {order.shipping_district}, {order.shipping_city}

Ch√∫ng t√¥i s·∫Ω x√°c nh·∫≠n ƒë∆°n h√†ng trong v√≤ng 24h v√† th√¥ng b√°o cho b·∫°n.

Tr√¢n tr·ªçng,
ƒê·ªôi ng≈© DBP Sports
        """
        
        # Use EmailMultiAlternatives like admin email (more reliable)
        subject = f'X√°c nh·∫≠n ƒë∆°n h√†ng #{order.order_number} - DBP Sports'
        from_email = settings.DEFAULT_FROM_EMAIL
        to_email = [order.customer_email]
        
        msg = EmailMultiAlternatives(subject, text_content, from_email, to_email)
        msg.attach_alternative(html_content, "text/html")
        msg.send()
        
        logger.info(f"Order confirmation email sent to {order.customer_email} for order {order.order_number}")
        
    except Order.DoesNotExist:
        logger.error(f"Order {order_id} not found")
    except Exception as e:
        logger.error(f"Error sending order confirmation email: {str(e)}")


def send_order_notification_admin_email(order_id):
    """G·ª≠i email th√¥ng b√°o ƒë∆°n h√†ng m·ªõi cho admin"""
    try:
        order = Order.objects.get(id=order_id)
        
        # Get admin emails from settings or use default
        admin_emails = getattr(settings, 'ADMIN_EMAILS', [settings.DEFAULT_FROM_EMAIL])
        
        # Render email template
        html_content = render_to_string('shop/emails/order_notification_admin.html', {
            'order': order,
            'request': type('obj', (object,), {
                'scheme': 'http',
                'get_host': lambda: 'localhost:8000'
            })
        })
        
        # Create email
        subject = f'üîî ƒê∆°n h√†ng m·ªõi #{order.order_number} - {order.customer_name}'
        from_email = settings.DEFAULT_FROM_EMAIL
        to_email = admin_emails
        
        # Create plain text version
        text_content = f"""
ƒê∆°n h√†ng m·ªõi c·∫ßn x·ª≠ l√Ω!

Th√¥ng tin ƒë∆°n h√†ng:
- M√£ ƒë∆°n h√†ng: {order.order_number}
- Kh√°ch h√†ng: {order.customer_name}
- Email: {order.customer_email}
- S·ªë ƒëi·ªán tho·∫°i: {order.customer_phone}
- T·ªïng ti·ªÅn: {order.total_amount:,.0f}ƒë
- Ph∆∞∆°ng th·ª©c thanh to√°n: {order.get_payment_method_display()}
- Ng√†y ƒë·∫∑t: {order.created_at.strftime('%d/%m/%Y %H:%M')}

Vui l√≤ng truy c·∫≠p admin ƒë·ªÉ x·ª≠ l√Ω ƒë∆°n h√†ng.
        """
        
        msg = EmailMultiAlternatives(subject, text_content, from_email, to_email)
        msg.attach_alternative(html_content, "text/html")
        msg.send()
        
        logger.info(f"Admin notification email sent for order {order.order_number}")
        
    except Order.DoesNotExist:
        logger.error(f"Order {order_id} not found")
    except Exception as e:
        logger.error(f"Error sending admin notification email: {str(e)}")


def send_order_status_update_email(order_id, old_status, new_status):
    """G·ª≠i email c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng cho kh√°ch h√†ng"""
    try:
        order = Order.objects.get(id=order_id)
        
        status_messages = {
            'processing': 'ƒê∆°n h√†ng c·ªßa b·∫°n ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω',
            'shipped': 'ƒê∆°n h√†ng c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒëi',
            'delivered': 'ƒê∆°n h√†ng c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c giao th√†nh c√¥ng',
            'cancelled': 'ƒê∆°n h√†ng c·ªßa b·∫°n ƒë√£ b·ªã h·ªßy'
        }
        
        message = status_messages.get(new_status, f'Tr·∫°ng th√°i ƒë∆°n h√†ng ƒë√£ thay ƒë·ªïi th√†nh: {new_status}')
        
        subject = f'C·∫≠p nh·∫≠t ƒë∆°n h√†ng #{order.order_number} - DBP Sports'
        from_email = settings.DEFAULT_FROM_EMAIL
        to_email = [order.customer_email]
        
        text_content = f"""
Xin ch√†o {order.customer_name},

{message}

Th√¥ng tin ƒë∆°n h√†ng:
- M√£ ƒë∆°n h√†ng: {order.order_number}
- Tr·∫°ng th√°i m·ªõi: {order.get_status_display()}
- T·ªïng ti·ªÅn: {order.total_amount:,.0f}ƒë

Tr√¢n tr·ªçng,
ƒê·ªôi ng≈© DBP Sports
        """
        
        msg = EmailMultiAlternatives(subject, text_content, from_email, to_email)
        msg.send()
        
        logger.info(f"Order status update email sent to {order.customer_email} for order {order.order_number}")
        
    except Order.DoesNotExist:
        logger.error(f"Order {order_id} not found")
    except Exception as e:
        logger.error(f"Error sending order status update email: {str(e)}")
