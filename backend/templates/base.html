{% load static %}
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}DBP Sports{% endblock %}</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="{% static 'css/custom.css' %}">
  <link rel="stylesheet" href="{% static 'css/site.css' %}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css"/>

  <style>
    /* Style này chỉ để hiển thị avatar chữ cái cho người dùng chưa có ảnh đại diện */
    .avatar-ph{display:inline-grid;place-items:center;width:28px;height:28px;border-radius:50%;
               background:#6f42c1;color:#fff;font-weight:700;font-size:.9rem}
  </style>
  {% block extra_css %}{% endblock %}
</head>

<body>

{% comment %} File: backend/templates/base.html - Sửa lại Header và Offcanvas {% endcomment %}

<header class="site-header sticky-top">
    <nav class="navbar container">
        <div class="nav-left">
            <a class="brand" href="{% url 'home' %}">
                <img src="{% static 'images/logo.png' %}" alt="DBP Sports">
                <span class="brand-text">DBP Sports</span>
            </a>
            <button class="mobile-menu-toggle" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileMenu">
                <i class="bi bi-list"></i>
            </button>
        </div>

        <div class="nav-center">
            <div class="main-menu">
                <a class="nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}" href="{% url 'home' %}">Trang chủ</a>
                <a class="nav-link {% if request.resolver_match.url_name == 'tournaments_active' %}active{% endif %}" href="{% url 'tournaments_active' %}">Giải đấu</a>
                <a class="nav-link {% if request.resolver_match.url_name == 'livestream' %}active{% endif %}" href="{% url 'livestream' %}">Livestream</a>
                <a class="nav-link {% if request.resolver_match.url_name == 'archive' %}active{% endif %}" href="{% url 'archive' %}">Lưu trữ</a>
                <a class="nav-link {% if request.resolver_match.url_name == 'shop' %}active{% endif %}" href="{% url 'shop' %}">Shop</a>
            </div>
        </div>

        <div class="nav-right">
            {% if user.is_authenticated %}
                <div class="d-flex align-items-center gap-2">
                    {% if user.organizations.all.first %}
                    <a href="{% url 'organizations:dashboard' %}" class="btn btn-sm btn-outline-warning d-none d-lg-flex" title="Quản lý Đơn vị Tổ chức">
                        <i class="bi bi-shield-check"></i> <span>QL. BTC</span>
                    </a>
                    {% endif %}
    
                    <div class="dropdown user-dropdown">
                        <button class="user-chip" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                             {% with acct=user.socialaccount_set.first %}
                                {% if acct and acct.get_avatar_url %}
                                <img src="{{ acct.get_avatar_url }}" alt="Avatar" class="avatar">
                                {% else %}
                                <span class="avatar-ph">{{ user.email|default:user.username|first|upper }}</span>
                                {% endif %}
                            {% endwith %}
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="{% url 'dashboard' %}"><i class="bi bi-toggles"></i> Tài Khoản</a></li>
                            <li><a class="dropdown-item" href="{% url 'organizations:dashboard' %}"><i class="bi bi-building"></i> Khu vực BTC</a></li>
                            
                            {# === BẮT ĐẦU CẬP NHẬT TỪ ĐÂY === #}
                            <li>
                                <a class="dropdown-item d-flex justify-content-between align-items-center" href="{% url 'announcement_dashboard' %}">
                                    <span><i class="bi bi-megaphone"></i> Bảng tin BTC</span>
                                    {% if unread_announcements_count > 0 %}
                                    <span class="badge bg-info rounded-pill">{{ unread_announcements_count }}</span>
                                    {% endif %}
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item d-flex justify-content-between align-items-center" href="{% url 'notification_list' %}">
                                    <span><i class="bi bi-bell"></i> Thông báo</span>
                                    {% if unread_notifications_count > 0 %}
                                    <span class="badge bg-danger rounded-pill">{{ unread_notifications_count }}</span>
                                    {% endif %}
                                </a>
                            </li>
                            {# === KẾT THÚC CẬP NHẬT === #}

                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{% url 'account_email' %}"><i class="bi bi-envelope"></i> Đổi email</a></li>
                            <li><a class="dropdown-item" href="{% url 'account_change_password' %}"><i class="bi bi-key"></i> Đổi mật khẩu</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="{% url 'account_logout' %}"><i class="bi bi-box-arrow-right"></i> Đăng xuất</a></li>
                        </ul>
                    </div>
                </div>
            {% else %}
                <div class="d-flex align-items-center gap-2">
                    <a class="btn btn-outline-light btn-sm" href="{% url 'account_login' %}">Đăng nhập</a>
                    <a class="btn btn-warning btn-sm d-none d-md-inline-block" href="{% url 'account_signup' %}">Đăng ký</a>
                </div>
            {% endif %}
        </div>
    </nav>
</header>

<div class="offcanvas offcanvas-start" tabindex="-1" id="mobileMenu">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Menu</h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <nav class="mobile-nav">
        <a class="nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}" href="{% url 'home' %}">Trang chủ</a>
        <a class="nav-link {% if request.resolver_match.url_name == 'tournaments_active' %}active{% endif %}" href="{% url 'tournaments_active' %}">Giải đấu</a>
        <a class="nav-link {% if request.resolver_match.url_name == 'livestream' %}active{% endif %}" href="{% url 'livestream' %}">Livestream</a>
        <a class="nav-link {% if request.resolver_match.url_name == 'archive' %}active{% endif %}" href="{% url 'archive' %}">Lưu trữ</a>
        <a class="nav-link {% if request.resolver_match.url_name == 'shop' %}active{% endif %}" href="{% url 'shop' %}">Shop</a>
        {% if not user.is_authenticated %}
        <hr class="border-light">
        <a class="nav-link" href="{% url 'account_signup' %}">Đăng ký</a>
        {% endif %}
    </nav>
  </div>
</div>

{% block hero %}{% endblock %}

<div class="container mt-4 content-wrapper mb-5">
  <main>
    {% block content %}{% endblock %}
  </main>
</div>

{% comment %} File: backend/templates/base.html - PHẦN FOOTER ĐÃ SỬA {% endcomment %}
<footer class="site-footer">
    <div class="container">
        <div class="footer-content">
            <div class="footer-about">
                <a href="{% url 'home' %}" class="footer-brand">
                    <img src="{% static 'images/logo.png' %}" alt="DBP Sports">
                    <span>DBP Sports</span>
                </a>
                <p class="text-muted">Nền tảng tổ chức và quản lý giải đấu bóng đá phong trào độc quyền Phủi Điện Biên.</p>
                
                <p class="footer-copyright">&copy; {% now "Y" %} DBP Sports. All Rights Reserved.</p>
            </div>
            <div class="footer-links">
                <h6>Về DBP Sports</h6>
                <ul>
                    <li><a href="{% url 'home' %}">Trang chủ</a></li>
                    <li><a href="{% url 'tournaments_active' %}">Giải đấu</a></li>
                    <li><a href="{% url 'faq' %}">Hướng dẫn</a></li>
                </ul>
            </div>
            <div class="footer-links">
                <h6>Pháp lý</h6>
                <ul>
                    <li><a href="{% url 'terms_of_service' %}">Điều khoản dịch vụ</a></li>
                    <li><a href="{% url 'privacy_policy' %}">Chính sách bảo mật</a></li>
                    <li><a href="{% url 'data_deletion' %}">Xóa dữ liệu</a></li>
                </ul>
            </div>
            <div class="footer-links">
                <h6>Theo dõi chúng tôi</h6>
                <div class="social-icons">
                    <a href="https://www.facebook.com/Phuidienbien/" title="Facebook" target="_blank"><i class="bi bi-facebook"></i></a>
                    <a href="https://www.youtube.com/@PhuiDienBien" title="YouTube" target="_blank"><i class="bi bi-youtube"></i></a>
                    <a href="#" title="TikTok"><i class="bi bi-tiktok"></i></a>
                </div>
            </div>
        </div>
        </div>
</footer>

{# VÙNG THÔNG BÁO TOAST #}
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="toastTemplate" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto">Thông báo</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"></script>
<script>
  (function(){
    // Tìm hàm này trong file backend/templates/base.html
    function attachImageCompression(form) {
        // === BẮT ĐẦU THAY THẾ TẠI ĐÂY ===
        if (!form || form.classList.contains('no-compress')) {
            // Nếu form không tồn tại, hoặc có class 'no-compress', thì bỏ qua
            return;
        }
        // === KẾT THÚC THAY THẾ ===

        const inputFile = form.querySelector('input[type="file"][name="logo"], input[type="file"][name="avatar"], input[type="file"][name="payment_proof"]');
        if (!inputFile) return;

        form.addEventListener('submit', function(event) {
            event.preventDefault();
            const file = inputFile.files[0];
            if (!file) {
                form.submit();
                return;
            }
            new Compressor(file, {
                quality: 0.8, maxWidth: 1280, maxHeight: 1280,
                success(result) {
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(new File([result], result.name, { type: result.type }));
                    inputFile.files = dataTransfer.files;
                    form.submit();
                },
                error(err) {
                    console.error(err.message);
                    form.submit();
                },
            });
        });
    }

    document.querySelectorAll('form[enctype="multipart/form-data"]').forEach(attachImageCompression);

  function setupPasswordToggle(buttonId, inputName) {
    const toggleButton = document.getElementById(buttonId);
    if (!toggleButton) return;
    const passwordInput = document.querySelector(`input[name="${inputName}"]`);
    if (!passwordInput) return;
    toggleButton.addEventListener('click', function () {
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);
      const icon = this.querySelector('i');
      icon.classList.toggle('bi-eye');
      icon.classList.toggle('bi-eye-slash');
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    setupPasswordToggle('togglePassword', 'password');
    setupPasswordToggle('togglePassword1', 'password1');
    setupPasswordToggle('togglePassword2', 'password2');
  });

  })();
</script>

{% if messages %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const toastTemplate = document.getElementById('toastTemplate');
    const toastContainer = document.querySelector('.toast-container');
    if (toastTemplate && toastContainer) {
      {% for message in messages %}
        const newToastEl = toastTemplate.cloneNode(true);
        newToastEl.removeAttribute('id');
        newToastEl.querySelector('.toast-body').textContent = '{{ message }}';
        const header = newToastEl.querySelector('.toast-header');
        if ('{{ message.tags }}'.includes('success')) {
            header.classList.add('bg-success', 'text-white');
        } else if ('{{ message.tags }}'.includes('error')) {
            header.classList.add('bg-danger', 'text-white');
        } else if ('{{ message.tags }}'.includes('warning')) {
            header.classList.add('bg-warning', 'text-dark');
        }
        toastContainer.appendChild(newToastEl);
        const newToast = new bootstrap.Toast(newToastEl);
        newToast.show();
      {% endfor %}
    }
  });
</script>
{% endif %}

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      Fancybox.bind("[data-fancybox]", {});
    });
  </script>

</body>
</html>