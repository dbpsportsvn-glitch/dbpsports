{% load static %}
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}DBP Sports{% endblock %}</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="{% static 'css/custom.css' %}">
  <link rel="stylesheet" href="{% static 'css/site.css' %}">

  <style>
    .avatar-ph{display:inline-grid;place-items:center;width:28px;height:28px;border-radius:50%;
               background:#6f42c1;color:#fff;font-weight:700;font-size:.9rem}
  </style>
  {% block extra_css %}{% endblock %}
</head>

<body>

<header class="site-header">
  <div class="navbar">
    <a class="brand" href="{% url 'home' %}">
      <img src="{% static 'images/logo.png' %}" alt="DBP Sports"> DBP Sports
    </a>

    <nav class="nav nav-primary">
      <a class="nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}" href="{% url 'home' %}">Trang chủ</a>
      <a class="nav-link {% if request.resolver_match.url_name == 'tournaments_active' %}active{% endif %}" href="{% url 'tournaments_active' %}">Giải đấu</a>
      <a class="nav-link {% if request.resolver_match.url_name == 'livestream' %}active{% endif %}" href="{% url 'livestream' %}">Livestream</a>
      <a class="nav-link {% if request.resolver_match.url_name == 'archive' %}active{% endif %}" href="{% url 'archive' %}">Lưu trữ</a>
      <a class="nav-link {% if request.resolver_match.url_name == 'shop' %}active{% endif %}" href="{% url 'shop' %}">Shop</a>
    </nav>

    <button class="menu-toggle" type="button" aria-label="Toggle navigation">
      <i class="bi bi-list fs-4"></i>
    </button>

    <div class="nav-user">
      {% if user.is_authenticated %}
        <div class="dropdown">
          <a href="#" class="d-flex align-items-center gap-2 text-decoration-none dropdown-toggle text-light" data-bs-toggle="dropdown" aria-expanded="false">
            {% with acct=user.socialaccount_set.first %}
              {% if acct and acct.get_avatar_url %}
                <img src="{{ acct.get_avatar_url }}" alt="" class="rounded-circle" style="width:28px;height:28px;object-fit:cover">
              {% else %}
                <span class="avatar-ph">{{ user.email|default:user.username|first|upper }}</span>
              {% endif %}
            {% endwith %}
          </a>
          <ul class="dropdown-menu dropdown-menu-end shadow">
            <li><a class="dropdown-item" href="{% url 'dashboard' %}">QL Đội Bóng</a></li>           
            <li>
                <a class="dropdown-item d-flex justify-content-between align-items-center" href="{% url 'announcement_dashboard' %}">
                    Bảng tin BTC
                    {% if unread_announcements_count > 0 %}
                        <span class="badge bg-danger rounded-pill">{{ unread_announcements_count }}</span>
                    {% endif %}
                </a>
            </li>            
            <li><a class="dropdown-item" href="{% url 'account_email' %}">Đổi email</a></li>
            <li><a class="dropdown-item" href="{% url 'account_change_password' %}">Đổi mật khẩu</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{% url 'account_logout' %}">Đăng xuất</a></li>
          </ul>
        </div>
      {% else %}
        <div class="d-flex align-items-center gap-2">
          <a class="nav-link text-light small" href="{% url 'account_login' %}">Đăng nhập</a>
          <a class="nav-link text-light small" href="{% url 'account_signup' %}">Đăng ký</a>
        </div>
      {% endif %}
    </div>
  </div>
</header>

{% block hero %}{% endblock %}
<div class="container mt-4">
  <main>
    {% block content %}{% endblock %}
  </main>

  <footer class="py-4 my-4 border-top">
    <div class="row align-items-center">
      <div class="col-md-6 mb-2 mb-md-0">
        <a href="{% url 'home' %}" class="d-inline-flex align-items-center gap-2 text-muted text-decoration-none">
          <img src="{% static 'images/logo.png' %}" alt="DBP Sports" style="height: 24px;">
          <span>&copy; {% now "Y" %} DBP Sports</span>
        </a>
      </div>

      <div class="col-md-6 text-md-end">
        <ul class="list-inline mb-0">
          <li class="list-inline-item"><a href="{% url 'home' %}" class="text-muted text-decoration-none">Trang chủ</a></li>
          <li class="list-inline-item"><a href="{% url 'tournaments_active' %}" class="text-muted text-decoration-none">Giải đấu</a></li>
          
          <li class="list-inline-item"><a href="{% url 'faq' %}" class="text-muted text-decoration-none">Hướng dẫn</a></li>

        </ul>
      </div>
    </div>
  </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>
<script>
  (function(){
    const toggle = document.querySelector('.menu-toggle');
    const nav = document.querySelector('.site-header .nav-primary');
    if (toggle && nav) {
      toggle.addEventListener('click', function() {
        nav.classList.toggle('open');
      });
    }

    // --- BẮT ĐẦU: MÃ TỐI ƯU HÓA UPLOAD ẢNH ---
    function attachImageCompression(form) {
      if (!form) return;
      const inputFile = form.querySelector('input[type="file"][name="logo"], input[type="file"][name="avatar"], input[type="file"][name="payment_proof"]');
      if (!inputFile) return;

      form.addEventListener('submit', function(event) {
        event.preventDefault(); // Ngăn form submit ngay lập-tức

        const file = inputFile.files[0];
        if (!file) {
          form.submit(); // Nếu không có file, submit bình-thường
          return;
        }

        new Compressor(file, {
          quality: 0.8, // Chất-lượng ảnh (0-1)
          maxWidth: 1280, // Chiều rộng tối-đa
          maxHeight: 1280, // Chiều cao tối-đa
          success(result) {
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(new File([result], result.name, { type: result.type }));
            inputFile.files = dataTransfer.files;

            // Submit form sau khi đã thay-thế file
            form.submit();
          },
          error(err) {
            console.error(err.message);
            // Nếu có lỗi, vẫn submit file gốc
            form.submit();
          },
        });
      });
    }

    // Áp dụng cho tất cả các form trong trang
    document.querySelectorAll('form[enctype="multipart/form-data"]').forEach(attachImageCompression);
    // --- KẾT THÚC: MÃ TỐI ƯU HÓA UPLOAD ẢNH ---

  // --- BẮT ĐẦU: MÃ HIỂN THỊ MẬT KHẨU ---
  function setupPasswordToggle(buttonId, inputName) {
    const toggleButton = document.getElementById(buttonId);
    if (!toggleButton) return;

    const passwordInput = document.querySelector(`input[name="${inputName}"]`);
    if (!passwordInput) return;

    toggleButton.addEventListener('click', function () {
      // Toggle the type attribute
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);

      // Toggle the icon
      const icon = this.querySelector('i');
      icon.classList.toggle('bi-eye');
      icon.classList.toggle('bi-eye-slash');
    });
  }

  // Áp dụng cho các trang
  document.addEventListener('DOMContentLoaded', function() {
    setupPasswordToggle('togglePassword', 'password');
    setupPasswordToggle('togglePassword1', 'password1');
    setupPasswordToggle('togglePassword2', 'password2');
  });
  // --- KẾT THÚC: MÃ HIỂN THỊ MẬT KHẨU ---

  })();
</script>

{# === BẮT ĐẦU THÊM MỚI: SCRIPT HIỂN THỊ POPUP TỪ MESSAGES === #}
{% if messages %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    let messages = '';
    {% for message in messages %}
      // Nối các message lại với nhau, xuống dòng nếu có nhiều message
      messages += `{{ message }}\\n`;
    {% endfor %}
    
    if (messages) {
      alert(messages.trim());
    }
  });
</script>
{% endif %}
{# === KẾT THÚC THÊM MỚI === #}

</body>
</html>