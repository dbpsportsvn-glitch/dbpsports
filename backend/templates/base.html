{% load static %}
{% load role_tags %}
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes, viewport-fit=cover">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https: data: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://code.jquery.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://www.googletagmanager.com https://unpkg.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com; img-src 'self' data: https: blob:; connect-src 'self' https:;">
  <title>{% block title %}DBP Sports{% endblock %}</title>

  <!-- Favicon -->
  <link rel="icon" href="{% static 'images/logo.png' %}" type="image/png">
  <link rel="shortcut icon" href="{% static 'images/logo.png' %}" type="image/png">
  <meta name="csrf-token" content="{{ csrf_token }}">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{% static 'css/custom.css' %}">
  <link rel="stylesheet" href="{% static 'css/site.css' %}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css"/>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    /* === CSS MỚI CHO KÝ HIỆU ĐỘI TRƯỞNG === */
    .captain-indicator{color:#f59e0b;font-weight:700;margin-left:4px}

    /* Avatar chữ cái khi chưa có ảnh */
    .avatar-ph{display:inline-grid;place-items:center;width:28px;height:28px;border-radius:50%;background:#6f42c1;color:#fff;font-weight:700;font-size:.9rem}

    /* === ICON THÔNG BÁO === */
    .notification-icon{position:relative;color:#cbd5e1;font-size:1.4rem;text-decoration:none;display:flex;align-items:center;padding:0 .5rem;transition:color .2s ease}
    .notification-icon:hover{color:#fff}
    .notification-badge{position:absolute;top:-5px;right:0;font-size:.65rem;font-weight:700;background:#ef4444;color:#fff;border-radius:50%;padding:2px 5px;line-height:1;border:2px solid #0f172a}
    .notification-badge.info{background:#3b82f6}
    
    /* Desktop: Gap nhỏ hơn để icon gần nhau */
    @media (min-width: 769px) {
      .nav-right .d-flex {
        gap: 0.5rem !important;
      }
    }
    
    /* Mobile: Tăng size icon và giãn cách */
    @media (max-width: 768px) {
      .notification-icon {
        font-size: 1.6rem;
        padding: 0 .35rem;
      }
      .nav-right .d-flex {
        gap: 0.75rem !important;
      }
    }

    /* === NAV / DROPDOWN TINH CHỈNH === */
    .main-menu .nav-link{display:inline-flex;align-items:center}
    .main-menu .dropdown>.nav-link{gap:.35rem}
    .main-menu .dropdown-menu{min-width:14rem}
    /* Nếu header là nền tối, dùng menu tối cho đồng nhất */
    .main-menu .dropdown-menu{--bs-dropdown-bg:#0b1220;--bs-dropdown-color:#e2e8f0;--bs-dropdown-link-color:#e2e8f0;--bs-dropdown-link-hover-bg:#111827;--bs-dropdown-link-hover-color:#fff;--bs-dropdown-border-color:#243044}
    .main-menu .dropdown-item.active{background:linear-gradient(90deg,#0ea5e9,#6366f1);color:#fff}

    /* Mobile nested list */
    .mobile-submenu{padding-left:1rem}
    .mobile-submenu .nav-link{padding:.35rem 0}
    
    /* === TĂNG KHOẢNG CÁCH MENU TRÊN HEADER === */
    .navbar-nav.mx-auto .nav-item {
      margin: 0 0.75rem; /* Tăng khoảng cách giữa các menu item */
    }
    
    .navbar-nav.mx-auto .nav-link {
      padding: 0.5rem 1rem; /* Tăng padding trong mỗi menu item */
    }
    
    /* === HIỆU ỨNG MENU MOBILE ĐẸP HỠN === */
    /* Nút hamburger menu */
    .mobile-menu-toggle {
      position: relative;
      padding: 0.5rem;
      border-radius: 0.5rem;
      transition: all 0.3s ease;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(99, 102, 241, 0.15)) !important;
      border: 1px solid rgba(99, 102, 241, 0.2);
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
    }
    
    .mobile-menu-toggle:hover {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(99, 102, 241, 0.25)) !important;
      border-color: rgba(99, 102, 241, 0.3);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
      transform: scale(1.05);
    }
    
    .mobile-menu-toggle:active {
      transform: scale(0.95);
    }
    
    .mobile-menu-toggle i {
      transition: transform 0.3s ease;
      color: #93c5fd;
    }
    
    .mobile-menu-toggle:hover i {
      transform: rotate(90deg);
      color: #bfdbfe;
    }
    
    /* Offcanvas mobile menu styling */
    #mobileMenu .offcanvas-header {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      padding: 1.5rem 1rem;
      border-bottom: 2px solid rgba(99, 102, 241, 0.3);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    #mobileMenu .offcanvas-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #e2e8f0;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      letter-spacing: 1px;
    }
    
    #mobileMenu .offcanvas-body {
      padding: 1rem;
      background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
    }
    
    /* Mobile nav links */
    .mobile-nav .nav-link {
      position: relative;
      padding: 1rem 1.25rem !important;
      font-size: 1.05rem !important;
      border-radius: 0.75rem !important;
      margin-bottom: 0.5rem;
      transition: all 0.3s ease;
      color: #cbd5e1 !important;
      font-weight: 500;
      border: 2px solid transparent;
      background: rgba(255, 255, 255, 0.03);
      overflow: hidden;
    }
    
    /* Hiệu ứng gradient hover */
    .mobile-nav .nav-link::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(14, 165, 233, 0.2), transparent);
      transition: left 0.5s ease;
    }
    
    .mobile-nav .nav-link:hover::before {
      left: 100%;
    }
    
    .mobile-nav .nav-link:hover {
      color: #fff !important;
      background: rgba(14, 165, 233, 0.15);
      border-color: rgba(14, 165, 233, 0.3);
      transform: translateX(8px);
      box-shadow: 0 4px 12px rgba(14, 165, 233, 0.2);
    }
    
    /* Active state với gradient đẹp */
    .mobile-nav .nav-link.active {
      color: #fff !important;
      background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%);
      border-color: rgba(255, 255, 255, 0.2);
      font-weight: 600;
      box-shadow: 0 4px 16px rgba(14, 165, 233, 0.4);
      transform: translateX(8px);
    }
    
    .mobile-nav .nav-link.active::after {
      content: '';
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      width: 8px;
      height: 8px;
      background: #fbbf24;
      border-radius: 50%;
      box-shadow: 0 0 12px #fbbf24;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
        box-shadow: 0 0 12px #fbbf24;
      }
      50% {
        opacity: 0.6;
        box-shadow: 0 0 20px #fbbf24;
      }
    }
    
    /* Icon styling */
    .mobile-nav .nav-link i {
      margin-right: 0.75rem;
      font-size: 1.1rem;
      transition: transform 0.3s ease;
    }
    
    .mobile-nav .nav-link:hover i {
      transform: scale(1.2) rotate(5deg);
    }
    
    .mobile-nav .nav-link.active i {
      transform: scale(1.1);
      color: #fbbf24;
    }
    
    /* Submenu styling */
    .mobile-submenu {
      margin-top: 0.5rem;
      padding-left: 2rem !important;
      border-left: 3px solid rgba(14, 165, 233, 0.3);
      margin-left: 1rem;
    }
    
    .mobile-submenu .nav-link {
      padding: 0.75rem 1rem !important;
      font-size: 0.95rem !important;
      background: rgba(255, 255, 255, 0.02);
    }
    
    .mobile-submenu .nav-link:hover {
      transform: translateX(5px);
    }
    
    .mobile-submenu .nav-link.active {
      background: linear-gradient(90deg, rgba(14, 165, 233, 0.3) 0%, rgba(99, 102, 241, 0.3) 100%);
    }
    
    /* Collapse arrow animation */
    .mobile-nav .bi-caret-down-fill {
      transition: transform 0.3s ease;
    }
    
    .mobile-nav [aria-expanded="true"] .bi-caret-down-fill {
      transform: rotate(180deg);
    }
    
    /* Divider styling */
    .mobile-nav hr {
      margin: 1rem 0;
      opacity: 0.2;
      border-color: rgba(255, 255, 255, 0.3) !important;
    }
    
    /* Mobile User Info */
    .mobile-user-info {
      animation: slideInDown 0.3s ease-out;
      overflow: hidden;
    }
    
    .mobile-user-info .flex-grow-1 {
      min-width: 0;
      overflow: hidden;
    }
    
    .mobile-user-info .text-light {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Logout button special styling */
    .mobile-nav .nav-link.text-danger {
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .mobile-nav .nav-link.text-danger:hover {
      background: rgba(239, 68, 68, 0.2) !important;
      border-color: rgba(239, 68, 68, 0.5) !important;
      transform: translateX(8px);
    }
    
    /* Brand Logo & Text Responsive */
    .brand-logo {
      width: 40px;
      height: 40px;
      transition: all 0.3s ease;
    }
    
    .brand-title {
      font-size: 1.4rem;
      transition: all 0.3s ease;
    }
    
    .brand-subtitle {
      font-size: 0.875rem;
      transition: all 0.3s ease;
    }
    
    /* Mobile Icons Styling */
    @media (max-width: 991px) {
      .brand-logo {
        width: 34px;
        height: 34px;
      }
      
      .brand-title {
        font-size: 1.2rem;
      }
      
      .brand-subtitle {
        font-size: 0.75rem;
      }
      
      /* Đảm bảo container của mobile icons hiển thị */
      .d-lg-none.d-flex {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      
      .d-lg-none .btn-outline-light {
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 0.4rem 0.5rem !important;
        display: flex !important;
        align-items: center;
        justify-content: center;
      }
      
      .d-lg-none .btn-outline-light i {
        font-size: 1.1rem;
        display: inline-block;
      }
      
      .d-lg-none .badge {
        font-size: 0.55rem !important;
        padding: 2px 4px !important;
        min-width: 16px;
        display: inline-block !important;
      }
      
      /* Mobile login button */
      .d-lg-none .btn-primary {
        white-space: nowrap;
        font-weight: 500;
      }
    }
    
    /* Mobile navigation spacing */
    @media (max-width: 767px) {
      .brand-logo {
        width: 32px;
        height: 32px;
      }
      
      .brand-title {
        font-size: 1.1rem;
      }
      
      .brand-subtitle {
        font-size: 0.7rem;
      }
      
      .navbar-brand {
        margin-right: 0.5rem !important;
      }
      
      .d-lg-none {
        gap: 0.4rem !important;
      }
      .d-lg-none .btn-outline-light {
        padding: 0.35rem 0.45rem !important;
      }
      .d-lg-none .btn-outline-light i {
        font-size: 1rem;
      }
      .nav-right .d-flex {
        gap: 0.5rem !important;
      }
      .notification-icon {
        padding: 0.2rem !important;
        font-size: 1.1rem !important;
      }
      .notification-badge {
        font-size: 0.55rem !important;
        padding: 1px 3px !important;
        min-width: 14px !important;
        height: 14px !important;
      }
      .user-chip {
        width: 32px !important;
        height: 32px !important;
      }
      .avatar, .avatar-ph {
        width: 32px !important;
        height: 32px !important;
        font-size: 0.8rem !important;
      }
    }
    
    /* Extra small screens */
    @media (max-width: 576px) {
      .brand-logo {
        width: 28px;
        height: 28px;
      }
      
      .brand-title {
        font-size: 1rem;
      }
      
      .brand-subtitle {
        font-size: 0.65rem;
      }
      
      .navbar-brand {
        margin-right: 0.3rem !important;
      }
      
      .brand-text-wrapper {
        max-width: 120px;
      }
      
      .d-lg-none {
        gap: 0.3rem !important;
      }
      .d-lg-none .btn-outline-light {
        padding: 0.3rem 0.4rem !important;
      }
      .d-lg-none .btn-outline-light i {
        font-size: 0.95rem;
      }
      .d-lg-none .btn-primary {
        padding: 0.35rem 0.65rem !important;
        font-size: 0.8rem !important;
      }
      .nav-right .d-flex {
        gap: 0.3rem !important;
      }
      .notification-icon {
        padding: 0.15rem !important;
        font-size: 1rem !important;
      }
    }
    
    /* Very small screens (iPhone SE, small Android) */
    @media (max-width: 390px) {
      .navbar .container {
        padding-left: 0.75rem;
        padding-right: 0.75rem;
      }
      
      .brand-logo {
        width: 26px;
        height: 26px;
      }
      
      .brand-title {
        font-size: 0.95rem;
      }
      
      .brand-subtitle {
        font-size: 0.6rem;
      }
      
      .brand-text-wrapper {
        max-width: 100px;
      }
      
      .d-lg-none .btn-outline-light {
        padding: 0.25rem 0.35rem !important;
      }
      
      .d-lg-none .btn-outline-light i {
        font-size: 0.9rem;
      }
      
      .d-lg-none .btn-primary {
        padding: 0.3rem 0.5rem !important;
        font-size: 0.75rem !important;
      }
      
      .d-lg-none .btn-primary i {
        font-size: 0.85rem;
      }
      
      .mobile-menu-toggle {
        padding: 0.35rem 0.4rem !important;
      }
      
      .mobile-menu-toggle i {
        font-size: 1.5rem !important;
      }
    }
    
    /* Ensure navbar doesn't wrap on mobile */
    @media (max-width: 991px) {
      .navbar .container {
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
        flex-wrap: nowrap !important;
      }
      
      .navbar-brand {
        flex-shrink: 0;
      }
      
      .mobile-menu-toggle {
        flex-shrink: 0;
      }
    }
    
    @media (max-width: 767px) {
      .navbar .container {
        padding-left: 1rem;
        padding-right: 1rem;
      }
    }
  </style>
  {% block extra_css %}{% endblock %}

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-032YMBB5G5"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-032YMBB5G5');
  </script>
</head>

<body data-user-authenticated="{% if user.is_authenticated %}True{% else %}False{% endif %}">
<header class="site-header sticky-top">
  <nav class="navbar navbar-expand-lg" style="background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.95) 100%); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(59, 130, 246, 0.2);">
    <div class="container">
      <!-- Brand -->
      <a class="navbar-brand d-flex align-items-center" href="{% url 'home' %}">
        <img src="{% static 'images/logo.png' %}" alt="DBP Sports" class="brand-logo me-2 rounded" style="box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);">
        <div class="brand-text-wrapper">
          <span class="fw-bold text-warning brand-title" style="text-shadow: 0 2px 4px rgba(251, 191, 36, 0.3);">DBP Sports</span>
          <div class="brand-subtitle text-light opacity-75">Phủi Điện Biên</div>
        </div>
      </a>

      <!-- Mobile Icons (visible only on mobile) -->
      <div class="d-lg-none d-flex align-items-center gap-2 ms-auto me-2">
        {% if user.is_authenticated %}
          <!-- Announcements -->
          <a href="{% url 'announcement_dashboard' %}" class="btn btn-sm btn-outline-light position-relative p-2" title="Bảng tin từ BTC">
            <i class="bi bi-megaphone-fill"></i>
            {% if unread_announcements_count > 0 %}
              <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-info" style="font-size: 0.6rem; padding: 2px 4px;">{{ unread_announcements_count }}</span>
            {% endif %}
          </a>

          <!-- Notifications -->
          <a href="{% url 'notification_list' %}" class="btn btn-sm btn-outline-light position-relative p-2" title="Thông báo của bạn">
            <i class="bi bi-bell-fill"></i>
            {% if unread_notifications_count > 0 %}
              <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.6rem; padding: 2px 4px;">{{ unread_notifications_count }}</span>
            {% endif %}
          </a>

          <!-- Cart -->
          <a href="#" class="btn btn-sm btn-outline-light position-relative p-2" title="Giỏ hàng" data-bs-toggle="offcanvas" data-bs-target="#cartPopup">
            <i class="bi bi-cart-fill"></i>
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success cart-count" style="font-size: 0.6rem; padding: 2px 4px;">{{ user_cart.total_items|default:0 }}</span>
          </a>
        {% else %}
          <!-- Login button for guests -->
          <a href="{% url 'account_login' %}" class="btn btn-sm btn-primary" style="padding: 0.4rem 0.75rem; font-size: 0.875rem;">
            <i class="bi bi-box-arrow-in-right me-1"></i>Đăng nhập
          </a>
        {% endif %}
      </div>

      <!-- Mobile toggle -->
      <button class="navbar-toggler mobile-menu-toggle border-0" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileMenu">
        <i class="bi bi-list" style="color: #93c5fd; font-size: 1.8rem;"></i>
      </button>

      <!-- Desktop Navigation -->
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav mx-auto">
          <li class="nav-item">
            <a class="nav-link text-light {% if request.resolver_match.url_name == 'home' and 'blog' not in request.resolver_match.namespace and 'shop' not in request.resolver_match.namespace %}active{% endif %}" href="{% url 'home' %}">
              <i class="bi bi-house me-1"></i>Trang chủ
            </a>
          </li>

          <!-- Football Dropdown -->
          {% with urln=request.resolver_match.url_name %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle text-light {% if urln == 'tournaments_active' or 'transfer' in urln or urln == 'livestream' or urln == 'archive' %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown">
              <i class="bi bi-trophy me-1"></i>Bóng Đá
            </a>
            <ul class="dropdown-menu" style="background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(20px); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 12px;">
              <li><a class="dropdown-item text-light {% if urln == 'tournaments_active' %}active{% endif %}" href="{% url 'tournaments_active' %}"><i class="bi bi-flag me-2"></i>Giải đấu</a></li>
              <li><a class="dropdown-item text-light {% if 'transfer' in urln %}active{% endif %}" href="{% url 'transfer_market' %}"><i class="bi bi-arrow-left-right me-2"></i>Chuyển nhượng</a></li>
              <li><a class="dropdown-item text-light {% if urln == 'livestream' %}active{% endif %}" href="{% url 'livestream' %}"><i class="bi bi-broadcast me-2"></i>Livestream</a></li>
              <li><a class="dropdown-item text-light {% if urln == 'archive' %}active{% endif %}" href="{% url 'archive' %}"><i class="bi bi-archive me-2"></i>Lưu trữ</a></li>
              <li><hr class="dropdown-divider"></li>
              <li class="px-3 py-2 text-warning small"><i class="bi bi-lightning me-1"></i>Sắp có: Pickleball, FIFA Online</li>
            </ul>
          </li>
          {% endwith %}

          <!-- Shop Dropdown -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle text-light {% if 'shop' in request.resolver_match.namespace %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown">
              <i class="bi bi-shop me-1"></i>Shop
            </a>
            <ul class="dropdown-menu" style="background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(20px); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 12px; padding: 8px 4px; overflow: hidden;">
              <li><a class="dropdown-item text-light {% if request.resolver_match.url_name == 'shop:home' %}active{% endif %}" href="{% url 'shop:home' %}" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-weight: 600; border-radius: 8px; margin: 2px 4px; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); transition: all 0.3s ease; overflow: hidden;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)'; this.style.setProperty('color', '#FFD700', 'important'); this.querySelector('i').style.setProperty('color', '#FFD700', 'important')" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(102, 126, 234, 0.3)'; this.style.setProperty('color', 'white', 'important'); this.querySelector('i').style.setProperty('color', 'white', 'important')"><i class="bi bi-star-fill me-2"></i>Shop Chính</a></li>
              <li><a class="dropdown-item text-light {% if request.resolver_match.url_name == 'shop:btc_shops_search' %}active{% endif %}" href="{% url 'shop:btc_shops_search' %}"><i class="bi bi-building me-2"></i>Shop BTC</a></li>
            </ul>
          </li>
          <li class="nav-item">
            <a class="nav-link text-light {% if request.resolver_match.url_name == 'job_market' %}active{% endif %}" href="{% url 'job_market' %}">
              <i class="bi bi-briefcase me-1"></i>Việc làm
            </a>
          </li>
        </ul>

        <!-- Right Section -->
        <div class="d-flex align-items-center gap-3">
          {% if user.is_authenticated %}
            <!-- Organizer Button -->
            {% if is_organizer_role %}
              {% if user.organizations.all.first %}
                <a href="{% url 'organizations:dashboard' %}" class="btn btn-warning btn-sm d-none d-lg-flex" title="Quản lý Đơn vị Tổ chức">
                  <i class="bi bi-shield-check"></i> <span class="ms-1">BTC</span>
                </a>
              {% else %}
                <a href="{% url 'organizations:create' %}" class="btn btn-warning btn-sm d-none d-lg-flex" title="Trở thành Ban tổ chức">
                  <i class="bi bi-shield-plus"></i> <span class="ms-1">Đăng ký BTC</span>
                </a>
              {% endif %}
            {% endif %}

            <!-- Notifications -->
            <a href="{% url 'announcement_dashboard' %}" class="btn btn-outline-light btn-sm position-relative" title="Bảng tin từ BTC">
              <i class="bi bi-megaphone-fill"></i>
              {% if unread_announcements_count > 0 %}
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-info">{{ unread_announcements_count }}</span>
              {% endif %}
            </a>

            <a href="{% url 'notification_list' %}" class="btn btn-outline-light btn-sm position-relative" title="Thông báo của bạn">
              <i class="bi bi-bell-fill"></i>
              {% if unread_notifications_count > 0 %}
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">{{ unread_notifications_count }}</span>
              {% endif %}
            </a>

            <!-- Cart -->
            <a href="#" class="btn btn-outline-light btn-sm position-relative" id="cart-icon" title="Giỏ hàng" data-bs-toggle="offcanvas" data-bs-target="#cartPopup">
              <i class="bi bi-cart-fill"></i>
              {% if user.is_authenticated %}
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success" id="cart-count">{{ user_cart.total_items|default:0 }}</span>
              {% else %}
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success" id="cart-count">0</span>
              {% endif %}
            </a>

            <!-- User Dropdown -->
            <div class="dropdown">
              <button class="btn btn-outline-light btn-sm dropdown-toggle d-flex align-items-center" type="button" data-bs-toggle="dropdown">
                {% with acct=user.socialaccount_set.first %}
                  {% if user.profile.avatar %}
                    <img src="{{ user.profile.avatar.url }}" alt="Avatar" class="rounded-circle me-2" width="24" height="24">
                  {% elif acct and acct.get_avatar_url %}
                    <img src="{{ acct.get_avatar_url }}" alt="Avatar" class="rounded-circle me-2" width="24" height="24">
                  {% else %}
                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 24px; height: 24px;">
                      <span class="text-white small fw-bold">{{ user.email|default:user.username|first|upper }}</span>
                    </div>
                  {% endif %}
                {% endwith %}
                <span class="d-none d-lg-inline">{{ user.get_full_name|default:user.username|truncatechars:15 }}</span>
              </button>
              <ul class="dropdown-menu dropdown-menu-end" style="background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(20px); border: 1px solid rgba(59, 130, 246, 0.2);">
                <li><a class="dropdown-item text-light" href="{% url 'dashboard' %}"><i class="bi bi-person-circle me-2"></i>Tài Khoản</a></li>
                <li><a class="dropdown-item text-light" href="{% url 'public_profile' username=user.email %}"><i class="bi bi-person-vcard me-2"></i>Hồ sơ Công khai</a></li>
                
                {% if user.is_staff %}
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-light" href="{% url 'shop:admin_dashboard' %}"><i class="fas fa-chart-line me-2"></i>Shop Dashboard</a></li>
                <li><a class="dropdown-item text-light" href="/admin/"><i class="bi bi-gear me-2"></i>Django Admin</a></li>
                {% endif %}

                {% if user.player_profile %}
                <li><a class="dropdown-item text-light" href="{% url 'player_detail' pk=user.player_profile.pk %}"><i class="bi bi-person-bounding-box me-2"></i>Xem Hồ sơ Cầu thủ</a></li>
                {% endif %}


                {% if is_player_role %}
                <li><a class="dropdown-item text-light" href="{% url 'create_standalone_team' %}"><i class="bi bi-shield-plus me-2"></i>Tạo Đội bóng</a></li>
                {% endif %}

                {% if is_organizer_role %}
                  {% if user.organizations.all.first %}
                    <li><a class="dropdown-item text-light" href="{% url 'organizations:dashboard' %}"><i class="bi bi-shield-check me-2"></i>Khu vực BTC</a></li>
                  {% else %}
                    <li><a class="dropdown-item text-light" href="{% url 'organizations:create' %}"><i class="bi bi-shield-plus me-2"></i>Đăng ký làm BTC</a></li>
                  {% endif %}
                {% endif %}

                {# Dashboard links cho HLV và Sân bóng #}
                {% if user|has_role:'COACH' %}
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-light" href="{% url 'coach_dashboard' %}"><i class="bi bi-speedometer2 me-2"></i>Dashboard HLV</a></li>
                {% endif %}

                {% if user|has_role:'STADIUM' %}
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-light" href="{% url 'stadium_dashboard' %}"><i class="bi bi-speedometer2 me-2"></i>Dashboard Sân bóng</a></li>
                {% endif %}
                
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-light" href="{% url 'account_email' %}"><i class="bi bi-envelope me-2"></i>Quản lý Email</a></li>
                <li><a class="dropdown-item text-light" href="{% url 'account_change_password' %}"><i class="bi bi-key me-2"></i>Đổi mật khẩu</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger" href="{% url 'account_logout' %}"><i class="bi bi-box-arrow-right me-2"></i>Đăng xuất</a></li>
              </ul>
            </div>
          {% else %}
            <!-- Guest Actions -->
            <a href="{% url 'account_login' %}" class="btn btn-outline-light btn-sm">
              <i class="bi bi-box-arrow-in-right me-1"></i>Đăng nhập
            </a>
            <a href="{% url 'account_signup' %}" class="btn btn-primary btn-sm">
              <i class="bi bi-person-plus me-1"></i>Đăng ký
            </a>
          {% endif %}
        </div>
      </div>
    </div>
  </nav>
</header>

<!-- Header Enhancements -->
<style>
  /* Khi khóa nghe nhạc: vô hiệu hóa click/links trên header để không điều hướng */
  body.listening-locked header.site-header a,
  body.listening-locked header.site-header button,
  body.listening-locked header.site-header .navbar-toggler,
  body.listening-locked header.site-header [data-bs-toggle] {
    pointer-events: none !important;
  }
  body.listening-locked header.site-header {
    opacity: 0.7;
  }

  /* Ngăn cuộn trang nền khi đang khóa nghe nhạc */
  html.listening-locked,
  body.listening-locked {
    overflow: hidden !important;
    overscroll-behavior: contain;
    height: 100%;
  }
.navbar-brand:hover {
  transform: translateY(-1px);
}

.nav-link:hover {
  color: #3b82f6 !important;
  background: rgba(59, 130, 246, 0.1);
}

.dropdown-item:hover {
  background: rgba(59, 130, 246, 0.1) !important;
  color: #3b82f6 !important;
}

.btn:hover {
  transform: translateY(-1px);
}

/* Mobile responsive for notification icons */
@media (max-width: 768px) {
  .navbar .d-flex.gap-3 {
    gap: 0.5rem !important;
  }
  
  .navbar .btn-sm {
    padding: 0.375rem 0.5rem;
    font-size: 0.875rem;
  }
}

@media (max-width: 576px) {
  .navbar .btn-outline-light {
    padding: 0.25rem 0.5rem;
  }
  
  .navbar .btn-outline-light i {
    font-size: 1rem;
  }
}
</style>

<div class="offcanvas offcanvas-start" tabindex="-1" id="mobileMenu" aria-labelledby="mobileMenuLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="mobileMenuLabel">Menu</h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Đóng"></button>
  </div>
  <div class="offcanvas-body">
    <!-- User Info Section (if authenticated) -->
    {% if user.is_authenticated %}
    <div class="mobile-user-info mb-3 p-3" style="background: rgba(59, 130, 246, 0.1); border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.2);">
      <div class="d-flex align-items-center gap-3">
        {% with acct=user.socialaccount_set.first %}
          {% if user.profile.avatar %}
            <img src="{{ user.profile.avatar.url }}" alt="Avatar" class="rounded-circle" width="48" height="48" style="object-fit: cover; border: 2px solid rgba(59, 130, 246, 0.5);">
          {% elif acct and acct.get_avatar_url %}
            <img src="{{ acct.get_avatar_url }}" alt="Avatar" class="rounded-circle" width="48" height="48" style="object-fit: cover; border: 2px solid rgba(59, 130, 246, 0.5);">
          {% else %}
            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px; border: 2px solid rgba(59, 130, 246, 0.5);">
              <span class="text-white fw-bold" style="font-size: 1.2rem;">{{ user.email|default:user.username|first|upper }}</span>
            </div>
          {% endif %}
        {% endwith %}
        <div class="flex-grow-1" style="min-width: 0;">
          <div class="text-light fw-bold" style="font-size: 1rem; word-break: break-word; overflow-wrap: break-word;">{{ user.get_full_name|default:user.username|truncatechars:20 }}</div>
          <div class="text-light opacity-75 small" style="word-break: break-all; overflow-wrap: break-word;">{{ user.email|truncatechars:20 }}</div>
        </div>
      </div>
    </div>
    {% endif %}

    <nav class="mobile-nav">
      <a class="nav-link {% if request.resolver_match.url_name == 'home' and 'blog' not in request.resolver_match.namespace and 'shop' not in request.resolver_match.namespace %}active{% endif %}" href="{% url 'home' %}"><i class="bi bi-house"></i> Trang chủ</a>

      {# --- Mobile: Bóng Đá (collapse) --- #}
      {% with urln=request.resolver_match.url_name %}
            <a class="nav-link d-flex justify-content-between align-items-center {% if urln == 'tournaments_active' or 'transfer' in urln or urln == 'livestream' or urln == 'archive' %}active{% endif %}"
         data-bs-toggle="collapse" href="#mobileSoccerMenu" role="button" aria-expanded="{% if urln == 'tournaments_active' or 'transfer' in urln or urln == 'livestream' or urln == 'archive' %}true{% else %}false{% endif %}" aria-controls="mobileSoccerMenu">
        <span><i class="bi bi-trophy"></i> Bóng Đá</span>
        <i class="bi bi-caret-down-fill small"></i>
      </a>
      <div class="collapse {% if urln == 'tournaments_active' or 'transfer' in urln or urln == 'livestream' or urln == 'archive' %}show{% endif %}" id="mobileSoccerMenu">
        <div class="mobile-submenu">
          <a class="nav-link {% if urln == 'tournaments_active' %}active{% endif %}" href="{% url 'tournaments_active' %}"><i class="bi bi-flag"></i> Giải đấu</a>
          <a class="nav-link {% if 'transfer' in urln %}active{% endif %}" href="{% url 'transfer_market' %}"><i class="bi bi-arrow-left-right"></i> Chuyển nhượng</a>
          <a class="nav-link {% if urln == 'livestream' %}active{% endif %}" href="{% url 'livestream' %}"><i class="bi bi-broadcast"></i> Livestream</a>
          <a class="nav-link {% if urln == 'archive' %}active{% endif %}" href="{% url 'archive' %}"><i class="bi bi-archive"></i> Lưu trữ</a>
        </div>
      </div>
      {% endwith %}

      <!-- Shop Dropdown Mobile -->
      <div class="dropdown">
        <a class="nav-link dropdown-toggle {% if 'shop' in request.resolver_match.namespace %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown">
          <i class="bi bi-shop"></i> Shop
        </a>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item {% if request.resolver_match.url_name == 'shop:home' %}active{% endif %}" href="{% url 'shop:home' %}" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600; border-radius: 8px; margin: 2px 4px; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); transition: all 0.3s ease; overflow: hidden;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)'; this.style.setProperty('color', '#FFD700', 'important'); this.querySelector('i').style.setProperty('color', '#FFD700', 'important')" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(102, 126, 234, 0.3)'; this.style.setProperty('color', 'white', 'important'); this.querySelector('i').style.setProperty('color', 'white', 'important')"><i class="bi bi-star-fill me-2"></i>Shop Chính</a></li>
          <li><a class="dropdown-item {% if request.resolver_match.url_name == 'shop:btc_shops_search' %}active{% endif %}" href="{% url 'shop:btc_shops_search' %}"><i class="bi bi-building me-2"></i>Shop BTC</a></li>
        </ul>
      </div>
      <a class="nav-link {% if request.resolver_match.url_name == 'job_market' %}active{% endif %}" href="{% url 'job_market' %}"><i class="bi bi-briefcase"></i> Việc làm</a>

      {% if user.is_authenticated %}
      <hr class="border-light">
      
      <!-- User Menu Items -->
      <a class="nav-link" href="{% url 'dashboard' %}"><i class="bi bi-person-circle"></i> Tài khoản</a>
      <a class="nav-link" href="{% url 'public_profile' username=user.email %}"><i class="bi bi-person-vcard"></i> Hồ sơ công khai</a>
      
      {% if user.player_profile %}
      <a class="nav-link" href="{% url 'player_detail' pk=user.player_profile.pk %}"><i class="bi bi-person-bounding-box"></i> Hồ sơ cầu thủ</a>
      {% endif %}


      {% if is_organizer_role %}
        {% if user.organizations.all.first %}
          <a class="nav-link" href="{% url 'organizations:dashboard' %}"><i class="bi bi-shield-check"></i> Khu vực BTC</a>
        {% else %}
          <a class="nav-link" href="{% url 'organizations:create' %}"><i class="bi bi-shield-plus"></i> Đăng ký BTC</a>
        {% endif %}
      {% endif %}

      {# Dashboard links cho HLV và Sân bóng #}
      {% if user|has_role:'COACH' %}
      <a class="nav-link" href="{% url 'coach_dashboard' %}"><i class="bi bi-speedometer2"></i> Dashboard HLV</a>
      {% endif %}

      {% if user|has_role:'STADIUM' %}
      <a class="nav-link" href="{% url 'stadium_dashboard' %}"><i class="bi bi-speedometer2"></i> Dashboard Sân bóng</a>
      {% endif %}

      {% if user.is_staff %}
      <hr class="border-light">
      <a class="nav-link" href="{% url 'shop:admin_dashboard' %}"><i class="fas fa-chart-line"></i> Shop Dashboard</a>
      <a class="nav-link" href="/admin/"><i class="bi bi-gear"></i> Django Admin</a>
      {% endif %}
      
      <hr class="border-light">
      
      <!-- Logout Button -->
      <a class="nav-link text-danger" href="{% url 'account_logout' %}" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3);">
        <i class="bi bi-box-arrow-right"></i> Đăng xuất
      </a>
      {% else %}
      <hr class="border-light">
      <a class="nav-link" href="{% url 'account_signup' %}"><i class="bi bi-person-plus"></i> Đăng ký</a>
      {% endif %}
    </nav>
  </div>
</div>

{% block hero %}{% endblock %}

<div class="container mt-4 content-wrapper mb-5">
  <main>
    {% block content %}{% endblock %}
  </main>
</div>

<footer class="modern-footer">
  <div class="footer-wave">
    <svg viewBox="0 0 1200 120" preserveAspectRatio="none">
      <path d="M321.39,56.44c58-10.79,114.16-30.13,172-41.86,82.39-16.72,168.19-17.73,250.45-.39C823.78,31,906.67,72,985.66,92.83c70.05,18.48,146.53,26.09,214.34,3V0H0V27.35A600.21,600.21,0,0,0,321.39,56.44Z" fill="rgba(59, 130, 246, 0.1)"></path>
    </svg>
  </div>
  
  <div class="container">
    <div class="footer-content">
      <!-- Brand Section -->
      <div class="footer-brand-section">
        <a href="{% url 'home' %}" class="footer-brand">
          <img src="{% static 'images/logo.png' %}" alt="DBP Sports" class="footer-logo">
          <span class="footer-brand-text">DBP Sports</span>
        </a>
        <p class="footer-description">
          Nền tảng tổ chức và quản lý giải đấu bóng đá phong trào hàng đầu Việt Nam. 
          Kết nối cộng đồng, tạo ra những trải nghiệm thể thao tuyệt vời.
        </p>
        <div class="footer-contact">
          <div class="contact-item">
            <i class="bi bi-envelope-fill"></i>
            <span>dbpsportsvn@gmail.com</span>
          </div>
          <div class="contact-item">
            <i class="bi bi-geo-alt-fill"></i>
            <span>Điện Biên, Việt Nam</span>
          </div>
        </div>
      </div>

      <!-- Quick Links -->
      <div class="footer-section">
        <h4 class="footer-title">
          <i class="bi bi-compass"></i>
          Khám Phá
        </h4>
        <ul class="footer-links">
          <li><a href="{% url 'home' %}"><i class="bi bi-house"></i>Trang chủ</a></li>
          <li><a href="{% url 'tournaments_active' %}"><i class="bi bi-trophy"></i>Giải đấu</a></li>
          <li><a href="{% url 'shop:home' %}"><i class="bi bi-shop"></i>Shop thể thao</a></li>
          <li><a href="{% url 'job_market' %}"><i class="bi bi-briefcase"></i>Việc làm</a></li>
          <li><a href="{% url 'transfer_market' %}"><i class="bi bi-arrow-left-right"></i>Chuyển nhượng</a></li>
          <li><a href="{% url 'livestream' %}"><i class="bi bi-broadcast"></i>Livestream</a></li>
        </ul>
      </div>

      <!-- Support & Legal -->
      <div class="footer-section">
        <h4 class="footer-title">
          <i class="bi bi-question-circle"></i>
          Hỗ Trợ & Pháp Lý
        </h4>
        <ul class="footer-links">
          <li><a href="{% url 'faq' %}"><i class="bi bi-book"></i>Hướng dẫn sử dụng</a></li>
          <li><a href="{% url 'terms_of_service' %}"><i class="bi bi-shield-check"></i>Điều khoản dịch vụ</a></li>
          <li><a href="{% url 'privacy_policy' %}"><i class="bi bi-lock"></i>Chính sách bảo mật</a></li>
          <li><a href="{% url 'data_deletion' %}"><i class="bi bi-trash"></i>Xóa dữ liệu</a></li>
          <li><a href="{% url 'archive' %}"><i class="bi bi-archive"></i>Lưu trữ giải đấu</a></li>
        </ul>
      </div>

      <!-- Social & Newsletter -->
      <div class="footer-section">
        <h4 class="footer-title">
          <i class="bi bi-heart"></i>
          Kết Nối
        </h4>
        <p class="footer-subtitle">Theo dõi chúng tôi để cập nhật tin tức mới nhất</p>
        
        <div class="social-links">
          <a href="https://www.facebook.com/Phuidienbien/" class="social-link facebook" target="_blank" rel="noopener">
            <i class="bi bi-facebook"></i>
            <span>Facebook</span>
          </a>
          <a href="https://www.youtube.com/@PhuiDienBien" class="social-link youtube" target="_blank" rel="noopener">
            <i class="bi bi-youtube"></i>
            <span>YouTube</span>
          </a>
          <a href="#" class="social-link tiktok" target="_blank" rel="noopener">
            <i class="bi bi-tiktok"></i>
            <span>TikTok</span>
          </a>
        </div>

        <div class="newsletter-section">
          <h5>Nhận thông báo mới</h5>
          <p class="newsletter-text">Đăng ký để nhận thông báo về giải đấu mới và ưu đãi đặc biệt</p>
          <div class="newsletter-form">
            <input type="email" placeholder="Nhập email của bạn..." class="newsletter-input">
            <button type="button" class="newsletter-btn">
              <i class="bi bi-send"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer Bottom -->
    <div class="footer-bottom">
      <div class="footer-bottom-content">
        <div class="copyright">
          <p>&copy; {% now "Y" %} DBP Sports. Tất cả quyền được bảo lưu.</p>
        </div>
        <div class="footer-badges">
          <span class="badge">
            <i class="bi bi-shield-check"></i>
            An toàn & Bảo mật
          </span>
          <span class="badge">
            <i class="bi bi-heart-fill"></i>
            Made with ❤️ in Điện Biên
          </span>
        </div>
      </div>
    </div>
  </div>
</footer>

<!-- Modern Footer CSS -->
<style>
/* ========================================
   MODERN FOOTER STYLES
   ======================================== */
.modern-footer {
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
  color: #e2e8f0;
  position: relative;
  margin-top: 4rem;
  overflow: hidden;
}

.footer-wave {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 60px;
  overflow: hidden;
  line-height: 0;
  transform: rotate(180deg);
}

.footer-wave svg {
  position: relative;
  display: block;
  width: calc(100% + 1.3px);
  height: 60px;
}

.footer-content {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr 1.5fr;
  gap: 3rem;
  padding: 3rem 0 2rem;
  position: relative;
  z-index: 2;
}

/* Brand Section */
.footer-brand-section {
  max-width: 400px;
}

.footer-brand {
  display: flex;
  align-items: center;
  gap: 1rem;
  text-decoration: none;
  margin-bottom: 1.5rem;
}

.footer-logo {
  width: 50px;
  height: 50px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.footer-brand-text {
  font-size: 1.8rem;
  font-weight: 800;
  color: #fbbf24;
  text-shadow: 0 2px 8px rgba(251, 191, 36, 0.3);
}

.footer-description {
  color: #94a3b8;
  line-height: 1.6;
  margin-bottom: 2rem;
  font-size: 0.95rem;
}

.footer-contact {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.contact-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  color: #cbd5e1;
  font-size: 0.9rem;
}

.contact-item i {
  color: #3b82f6;
  width: 16px;
}

/* Footer Sections */
.footer-section {
  display: flex;
  flex-direction: column;
}

.footer-title {
  font-size: 1.1rem;
  font-weight: 700;
  color: #fbbf24;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.footer-title i {
  font-size: 1.2rem;
}

.footer-subtitle {
  color: #94a3b8;
  font-size: 0.9rem;
  margin-bottom: 1.5rem;
  line-height: 1.5;
}

.footer-links {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.footer-links li a {
  color: #cbd5e1;
  text-decoration: none;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.3s ease;
  padding: 0.25rem 0;
}

.footer-links li a:hover {
  color: #3b82f6;
  transform: translateX(5px);
}

.footer-links li a i {
  width: 16px;
  font-size: 0.85rem;
}

/* Social Links */
.social-links {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  margin-bottom: 2rem;
}

.social-link {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 1rem;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
  text-decoration: none;
  color: #cbd5e1;
  transition: all 0.3s ease;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.social-link:hover {
  background: rgba(255, 255, 255, 0.1);
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.social-link.facebook:hover {
  border-color: #1877f2;
  box-shadow: 0 4px 12px rgba(24, 119, 242, 0.3);
}

.social-link.youtube:hover {
  border-color: #ff0000;
  box-shadow: 0 4px 12px rgba(255, 0, 0, 0.3);
}

.social-link.tiktok:hover {
  border-color: #000000;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.social-link i {
  font-size: 1.2rem;
  width: 20px;
  text-align: center;
}

/* Newsletter */
.newsletter-section h5 {
  color: #fbbf24;
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.newsletter-text {
  color: #94a3b8;
  font-size: 0.85rem;
  margin-bottom: 1rem;
  line-height: 1.4;
}

.newsletter-form {
  display: flex;
  gap: 0.5rem;
}

.newsletter-input {
  flex: 1;
  padding: 0.75rem 1rem;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.05);
  color: #e2e8f0;
  font-size: 0.9rem;
  transition: all 0.3s ease;
}

.newsletter-input::placeholder {
  color: #64748b;
}

.newsletter-input:focus {
  outline: none;
  border-color: #3b82f6;
  background: rgba(255, 255, 255, 0.1);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.newsletter-btn {
  padding: 0.75rem 1rem;
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  border: none;
  border-radius: 8px;
  color: white;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.newsletter-btn:hover {
  background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

/* Footer Bottom */
.footer-bottom {
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  padding: 2rem 0;
  margin-top: 2rem;
}

.footer-bottom-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 1rem;
}

.copyright p {
  color: #94a3b8;
  font-size: 0.9rem;
  margin: 0;
}

.footer-badges {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.footer-badges .badge {
  background: rgba(255, 255, 255, 0.1);
  color: #cbd5e1;
  padding: 0.5rem 1rem;
  border-radius: 50px;
  font-size: 0.8rem;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.footer-badges .badge i {
  color: #fbbf24;
}

/* ========================================
   RESPONSIVE DESIGN
   ======================================== */
@media (max-width: 1200px) {
  .footer-content {
    grid-template-columns: 2fr 1fr 1fr 1.5fr;
    gap: 2rem;
  }
}

@media (max-width: 992px) {
  .footer-content {
    grid-template-columns: 1fr 1fr;
    gap: 2.5rem;
  }
  
  .footer-brand-section {
    grid-column: 1 / -1;
    max-width: none;
  }
}

@media (max-width: 768px) {
  .footer-content {
    grid-template-columns: 1fr;
    gap: 2rem;
    padding: 2rem 0 1rem;
  }
  
  .footer-bottom-content {
    flex-direction: column;
    text-align: center;
    gap: 1.5rem;
  }
  
  .newsletter-form {
    flex-direction: column;
  }
  
  .social-links {
    flex-direction: row;
    flex-wrap: wrap;
  }
  
  .social-link {
    flex: 1;
    min-width: 120px;
    justify-content: center;
  }
}

@media (max-width: 480px) {
  .footer-brand {
    flex-direction: column;
    text-align: center;
    gap: 0.5rem;
  }
  
  .footer-brand-text {
    font-size: 1.5rem;
  }
  
  .footer-badges {
    flex-direction: column;
    width: 100%;
  }
  
  .footer-badges .badge {
    justify-content: center;
  }
}

/* ========================================
   ANIMATIONS
   ======================================== */
.footer-links li a {
  position: relative;
}

.footer-links li a::before {
  content: '';
  position: absolute;
  left: -10px;
  top: 50%;
  transform: translateY(-50%);
  width: 0;
  height: 2px;
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  transition: width 0.3s ease;
}

.footer-links li a:hover::before {
  width: 8px;
}

.social-link {
  position: relative;
  overflow: hidden;
}

.social-link::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
  transition: left 0.5s ease;
}

.social-link:hover::before {
  left: 100%;
}

/* ========================================
   HIDE OLD STYLES
   ======================================== */
.site-footer {
  display: none;
}
</style>

{# TOAST ZONE #}
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index:1100;">
  <div id="toastTemplate" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto">Thông báo</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Đóng"></button>
    </div>
    <div class="toast-body"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"></script>

<script>
  // --- BẮT ĐẦU KHỐI SCRIPT TỔNG HỢP ---
  function showToast(message, type='info'){
    const toastTemplate=document.getElementById('toastTemplate');
    const toastContainer=document.querySelector('.toast-container');
    if(!toastTemplate||!toastContainer){console.error('Toast elements not found!');alert(message);return}
    const el=toastTemplate.cloneNode(true);el.removeAttribute('id');el.querySelector('.toast-body').innerHTML=message;const header=el.querySelector('.toast-header');header.classList.remove('bg-success','bg-danger','bg-warning','text-white','text-dark');
    if(type.includes('success')) header.classList.add('bg-success','text-white');
    else if(type.includes('error')) header.classList.add('bg-danger','text-white');
    else if(type.includes('warning')) header.classList.add('bg-warning','text-dark');
    toastContainer.appendChild(el);const t=new bootstrap.Toast(el,{delay:5000});t.show();el.addEventListener('hidden.bs.toast',()=>el.remove());
  }

  function attachImageCompression(form){
    if(!form||form.classList.contains('no-compress')) return;
    const inputFile=form.querySelector('input[type="file"][name="logo"], input[type="file"][name="avatar"], input[type="file"][name="payment_proof"]');
    if(!inputFile) return;
    form.addEventListener('submit',function(event){
      event.preventDefault();
      const file=inputFile.files[0];
      if(!file){form.submit();return}
      new Compressor(file,{quality:.8,maxWidth:1280,maxHeight:1280,success(result){
        const dt=new DataTransfer();dt.items.add(new File([result],result.name,{type:result.type}));inputFile.files=dt.files;form.submit();},error(err){console.error(err.message);form.submit();}});
    });
  }

  function setupPasswordToggle(buttonId,inputName){
    const btn=document.getElementById(buttonId);if(!btn) return;const input=document.querySelector(`input[name="${inputName}"]`);if(!input) return;
    btn.addEventListener('click',function(){const type=input.getAttribute('type')==='password'?'text':'password';input.setAttribute('type',type);const icon=this.querySelector('i');icon.classList.toggle('bi-eye');icon.classList.toggle('bi-eye-slash');});
  }

  // Global error handler để bỏ qua lỗi từ extensions
  window.addEventListener('error', function(e) {
    // Bỏ qua lỗi từ wallet extensions
    if (e.message && (
      e.message.includes('wallet') || 
      e.message.includes('account') ||
      e.message.includes('4001') ||
      e.filename && (
        e.filename.includes('metadata.js') ||
        e.filename.includes('content.js') ||
        e.filename.includes('inpage.js')
      )
    )) {
      e.preventDefault();
      return false;
    }
  });

  // Bỏ qua unhandled promise rejections từ extensions
  window.addEventListener('unhandledrejection', function(e) {
    if (e.reason && (
      e.reason.message && (
        e.reason.message.includes('wallet') ||
        e.reason.message.includes('account') ||
        e.reason.code === 4001
      )
    )) {
      e.preventDefault();
      return false;
    }
  });

  document.addEventListener('DOMContentLoaded',function(){
    {% if messages %}
      {% for message in messages %}
        showToast('{{ message|escapejs }}','{{ message.tags }}');
      {% endfor %}
    {% endif %}
    document.querySelectorAll('form[enctype="multipart/form-data"]').forEach(attachImageCompression);
    setupPasswordToggle('togglePassword','password');
    setupPasswordToggle('togglePassword1','password1');
    setupPasswordToggle('togglePassword2','password2');
    Fancybox.bind('[data-fancybox]',{});
  });
  // --- KẾT THÚC KHỐI SCRIPT TỔNG HỢP ---
</script>

<!-- Cart Popup -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="cartPopup" aria-labelledby="cartPopupLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="cartPopupLabel">
      <i class="bi bi-cart-fill me-2"></i>
      Giỏ hàng (<span id="cart-popup-count">0</span>)
    </h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Đóng"></button>
  </div>
  <div class="offcanvas-body p-0">
    <div id="cart-content">
      <!-- Cart items will be loaded here -->
      <div class="text-center p-4">
        <i class="bi bi-cart-x text-muted" style="font-size: 3rem;"></i>
        <p class="text-muted mt-2">Giỏ hàng trống</p>
        <a href="{% url 'shop:home' %}" class="btn btn-primary">Tiếp tục mua sắm</a>
      </div>
    </div>
    
    <!-- Cart Footer -->
    <div class="cart-footer p-3 border-top bg-light">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <strong>Tổng cộng:</strong>
        <strong id="cart-total">0 VNĐ</strong>
      </div>
      <div class="d-grid gap-2">
        <button type="button" class="btn btn-danger" id="clear-cart-btn" onclick="clearAllCart()">
          <i class="bi bi-trash me-2"></i>
          Xóa tất cả
        </button>
        <a href="{% url 'shop:cart' %}" class="btn btn-primary">
          <i class="bi bi-bag-check me-2"></i>
          Xem giỏ hàng chi tiết
        </a>
        <a href="{% url 'shop:checkout' %}" class="btn btn-success">
          <i class="bi bi-credit-card me-2"></i>
          Thanh toán
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Cart Popup CSS -->
<style>
.offcanvas-end {
  width: 400px !important;
  transition: transform 0.3s ease-out !important;
}

/* Làm dấu X dễ nhìn hơn - sát góc phải, không nền */
#cartPopup .offcanvas-header {
  position: relative;
  padding-right: 3.5rem !important;
}

#cartPopup .btn-close {
  position: absolute !important;
  right: 0.5rem !important;
  top: 50% !important;
  transform: translateY(-50%) !important;
  width: 32px !important;
  height: 32px !important;
  background: transparent !important;
  border: none !important;
  opacity: 1 !important;
  padding: 0 !important;
  margin: 0 !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  transition: all 0.3s ease !important;
  background-image: none !important;
}

#cartPopup .btn-close:hover {
  transform: translateY(-50%) rotate(90deg) scale(1.15) !important;
}

#cartPopup .btn-close:focus {
  box-shadow: none !important;
  outline: none !important;
}

#cartPopup .btn-close::before {
  content: '✕' !important;
  color: #dc2626 !important;
  font-size: 28px !important;
  font-weight: bold !important;
  line-height: 1 !important;
}

#cartPopup .btn-close:hover::before {
  color: #b91c1c !important;
}

.cart-item {
  border-bottom: 1px solid #eee;
  padding: 15px;
  display: flex;
  align-items: center;
  gap: 15px;
}

.cart-item:last-child {
  border-bottom: none;
}

.cart-item-image {
  width: 60px;
  height: 60px;
  object-fit: cover;
  border-radius: 8px;
  transition: transform 0.2s ease;
}

.cart-item-link {
  text-decoration: none;
  display: block;
}

.cart-item-link:hover .cart-item-image {
  transform: scale(1.05);
}

.cart-item-details {
  flex: 1;
}

.cart-item-name-link {
  text-decoration: none;
  color: inherit;
}

.cart-item-name {
  font-weight: 600;
  margin-bottom: 5px;
  font-size: 14px;
  color: #fff;
  transition: color 0.2s ease;
}

.cart-item-name-link:hover .cart-item-name {
  color: #60a5fa;
}

.cart-item-size {
  font-size: 12px;
  color: #cbd5e1;
  margin-bottom: 5px;
}

.cart-item-price {
  font-weight: 600;
  color: #dc3545;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.price-per-item {
  font-size: 12px;
  color: #cbd5e1;
  font-weight: 400;
}

.price-total {
  font-size: 14px;
  color: #dc3545;
  font-weight: 600;
}

.cart-item-controls {
  display: flex;
  align-items: center;
  gap: 10px;
}

.quantity-controls {
  display: flex;
  align-items: center;
  gap: 5px;
}

.quantity-btn {
  width: 25px;
  height: 25px;
  border: 1px solid #ddd;
  background: white;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  cursor: pointer;
}

.quantity-btn:hover {
  background: #f8f9fa;
}

.quantity-input {
  width: 40px;
  text-align: center;
  border: 1px solid #ddd;
  border-radius: 4px;
  padding: 2px;
  font-size: 12px;
}

.remove-item-btn {
  color: #dc3545;
  border: none;
  background: none;
  font-size: 18px;
  cursor: pointer;
  padding: 0;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.cart-footer {
  position: sticky;
  bottom: 0;
  background: white;
}

@media (max-width: 768px) {
  .offcanvas-end {
    width: 100% !important;
  }
}
</style>

<!-- Cart Popup JavaScript -->
<script>
// Load cart content when popup opens
document.getElementById('cartPopup').addEventListener('shown.bs.offcanvas', function() {
  loadCartContent();
});

// Thêm tính năng vuốt sang phải để đóng popup
(function() {
  const cartPopup = document.getElementById('cartPopup');
  let touchStartX = 0;
  let touchStartY = 0;
  let touchCurrentX = 0;
  let touchCurrentY = 0;
  let isSwiping = false;
  
  cartPopup.addEventListener('touchstart', function(e) {
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
    isSwiping = true;
  }, { passive: true });
  
  cartPopup.addEventListener('touchmove', function(e) {
    if (!isSwiping) return;
    
    touchCurrentX = e.touches[0].clientX;
    touchCurrentY = e.touches[0].clientY;
    
    const diffX = touchCurrentX - touchStartX;
    const diffY = Math.abs(touchCurrentY - touchStartY);
    
    // Chỉ xử lý khi vuốt ngang (không phải vuốt dọc để scroll)
    if (Math.abs(diffX) > diffY && diffX > 0) {
      // Vuốt sang phải
      const translateX = Math.min(diffX, 400);
      cartPopup.style.transform = `translateX(${translateX}px)`;
      cartPopup.style.transition = 'none';
    }
  }, { passive: true });
  
  cartPopup.addEventListener('touchend', function(e) {
    if (!isSwiping) return;
    
    const diffX = touchCurrentX - touchStartX;
    const diffY = Math.abs(touchCurrentY - touchStartY);
    
    isSwiping = false;
    
    // Nếu vuốt quá 100px sang phải thì đóng popup
    if (Math.abs(diffX) > diffY && diffX > 100) {
      // Đóng popup
      const bsOffcanvas = bootstrap.Offcanvas.getInstance(cartPopup);
      if (bsOffcanvas) {
        bsOffcanvas.hide();
      }
    }
    
    // Reset transform
    cartPopup.style.transform = '';
    cartPopup.style.transition = '';
  }, { passive: true });
  
  // Reset khi popup bị đóng
  cartPopup.addEventListener('hidden.bs.offcanvas', function() {
    cartPopup.style.transform = '';
    cartPopup.style.transition = '';
  });
})();

// Load cart content
function loadCartContent() {
  fetch('{% url "shop:cart_api" %}?t=' + Date.now(), {
    method: 'GET',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
      'Cache-Control': 'no-cache',
      'Pragma': 'no-cache'
    },
    cache: 'no-cache'
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    return response.json();
  })
  .then(data => {
    updateCartPopup(data);
  })
  .catch(error => {
    console.error('Error loading cart:', error);
  });
}

// Update cart popup content
function updateCartPopup(cartData) {
  const cartContent = document.getElementById('cart-content');
  const cartCount = document.getElementById('cart-popup-count');
  const cartTotal = document.getElementById('cart-total');
  const clearCartBtn = document.getElementById('clear-cart-btn');
  
  if (cartData.items && cartData.items.length > 0) {
    let html = '';
    cartData.items.forEach(item => {
      // Tính tổng tiền cho từng sản phẩm
      const itemTotal = item.price * item.quantity;
      
      html += `
        <div class="cart-item">
          <a href="/shop/products/${item.slug || ''}" class="cart-item-link">
            <img src="${item.image || '/static/images/no-image.png'}" alt="${item.name}" class="cart-item-image">
          </a>
          <div class="cart-item-details">
            <a href="/shop/products/${item.slug || ''}" class="cart-item-name-link">
              <div class="cart-item-name">${item.name}</div>
            </a>
            ${item.size ? `<div class="cart-item-size">Size: ${item.size}</div>` : ''}
            <div class="cart-item-price">
              <span class="price-per-item">${item.price.toLocaleString()} VNĐ</span>
              <span class="price-total">× ${item.quantity} = ${itemTotal.toLocaleString()} VNĐ</span>
            </div>
          </div>
          <div class="cart-item-controls">
            <div class="quantity-controls">
              <button class="quantity-btn" onclick="updateCartItem(${item.id}, ${item.quantity - 1})">-</button>
              <input type="number" class="quantity-input" value="${item.quantity}" min="1" max="${item.stock}" onchange="updateCartItem(${item.id}, this.value)">
              <button class="quantity-btn" onclick="updateCartItem(${item.id}, ${item.quantity + 1})">+</button>
            </div>
            <button class="remove-item-btn" onclick="removeCartItem(${item.id})" title="Xóa">
              <i class="bi bi-x"></i>
            </button>
          </div>
        </div>
      `;
    });
    cartContent.innerHTML = html;
    clearCartBtn.style.display = 'block';
  } else {
    cartContent.innerHTML = `
      <div class="text-center p-4">
        <i class="bi bi-cart-x text-muted" style="font-size: 3rem;"></i>
        <p class="text-muted mt-2">Giỏ hàng trống</p>
        <a href="/shop/" class="btn btn-primary">Tiếp tục mua sắm</a>
      </div>
    `;
    clearCartBtn.style.display = 'none';
  }
  
  cartCount.textContent = cartData.total_items || 0;
  cartTotal.textContent = (cartData.total_price || 0).toLocaleString() + ' VNĐ';
  
  // Update cart count everywhere
  updateMainCartCount(cartData.total_items || 0);
}

// Update cart item quantity
function updateCartItem(itemId, quantity) {
  if (quantity < 1) {
    removeCartItem(itemId);
    return;
  }
  
  fetch('{% url "shop:update_cart_item" item_id=0 %}'.replace('0', itemId), {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: JSON.stringify({ quantity: parseInt(quantity) }),
    cache: 'no-cache'
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Load cart content (gets fresh count)
      loadCartContent();
      
      // Cart count will be updated by loadCartContent -> updateCartPopup -> updateCartCount
    } else {
      alert(data.message || 'Có lỗi xảy ra');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Có lỗi xảy ra');
  });
}

// Remove cart item
function removeCartItem(itemId) {
  if (!confirm('Bạn có chắc muốn xóa sản phẩm này?')) {
    return;
  }
  
  fetch('{% url "shop:remove_from_cart" item_id=0 %}'.replace('0', itemId), {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}'
    },
    cache: 'no-cache'
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Load cart content first (gets fresh count)
      loadCartContent();
      
      // Show success message
      showNotification(data.message, 'success');
      
      // Cart count will be updated by loadCartContent -> updateCartPopup -> updateCartCount
    } else {
      alert(data.message || 'Có lỗi xảy ra');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Có lỗi xảy ra');
  });
}

// Clear all cart
function clearAllCart() {
  if (!confirm('Bạn có chắc muốn xóa tất cả sản phẩm trong giỏ hàng?')) {
    return;
  }
  
  // Immediately update UI to 0 (optimistic update)
  updateCartCount(0);
  
  fetch('{% url "shop:clear_cart" %}?t=' + Date.now(), {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
      'Cache-Control': 'no-cache',
      'Pragma': 'no-cache'
    },
    cache: 'no-cache'
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      // Force refresh cart count from server
      forceRefreshCartCount();
      
      // Load cart content (will show empty cart)
      loadCartContent();
      
      // Show success message
      showNotification(data.message, 'success');
    } else {
      alert(data.message || 'Có lỗi xảy ra');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Có lỗi xảy ra');
  });
}

// Global notification function
function showNotification(message, type) {
  // Tạo thông báo
  const notification = document.createElement('div');
  notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
  notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
  notification.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  document.body.appendChild(notification);
  
  // Tự động ẩn sau 3 giây
  setTimeout(() => {
    if (notification.parentNode) {
      notification.remove();
    }
  }, 3000);
}

// Global function to update cart count everywhere
function updateMainCartCount(count) {
  // Update main navigation cart count
  const mainCartCount = document.getElementById('cart-count');
  if (mainCartCount) {
    mainCartCount.textContent = count;
  }
  
  // Update all cart count elements
  document.querySelectorAll('.cart-count, #cart-count').forEach(el => {
    el.textContent = count;
  });
  
  // Update cart popup count if it exists
  const cartPopupCount = document.getElementById('cart-popup-count');
  if (cartPopupCount) {
    cartPopupCount.textContent = count;
  }
}

// Force refresh cart count from server
function forceRefreshCartCount() {
  fetch('{% url "shop:cart_api" %}?t=' + Date.now(), {
    method: 'GET',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
      'Cache-Control': 'no-cache',
      'Pragma': 'no-cache'
    },
    cache: 'no-cache'
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      updateMainCartCount(data.total_items || 0);
    }
  })
  .catch(error => {
    console.error('Error refreshing cart count:', error);
  });
}
</script>

<!-- Add to Cart Popup -->
<div class="modal fade" id="addToCartModal" tabindex="-1" aria-labelledby="addToCartModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addToCartModalLabel">
          <i class="fas fa-shopping-cart me-2"></i>
          Thêm vào giỏ hàng
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>
      <div class="modal-body">
        <div id="product-info" class="product-info-popup">
          <!-- Product info will be loaded here -->
        </div>
        
        <div class="size-selection" id="size-selection" style="display: none;">
          <h6 class="mb-3">Chọn size:</h6>
          <div class="size-options" id="size-options">
            <!-- Size options will be loaded here -->
          </div>
        </div>
        
        <div class="quantity-selection mt-4">
          <h6 class="mb-3">Số lượng:</h6>
          <div class="quantity-controls-popup">
            <button type="button" class="btn btn-outline-secondary" id="decrease-qty">-</button>
            <input type="number" class="form-control text-center" id="quantity-input" value="1" min="1" max="10">
            <button type="button" class="btn btn-outline-secondary" id="increase-qty">+</button>
          </div>
          <div class="stock-info mt-2">
            <small class="text-muted" id="stock-info">Còn hàng</small>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
        <button type="button" class="btn btn-primary" id="confirm-add-to-cart">
          <i class="fas fa-shopping-cart me-2"></i>
          Thêm vào giỏ
        </button>
      </div>
    </div>
  </div>
</div>

<style>
/* Add to Cart Popup Styles */
.product-info-popup {
  display: flex;
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.product-image-popup {
  width: 80px;
  height: 80px;
  object-fit: cover;
  border-radius: 8px;
  flex-shrink: 0;
}

.product-details-popup {
  flex: 1;
}

.product-name-popup {
  font-weight: 600;
  margin-bottom: 0.5rem;
  color: #333;
}

.product-price-popup {
  font-size: 1.1rem;
  font-weight: 700;
  color: #dc3545;
}

.product-price-popup .original-price {
  font-size: 0.9rem;
  color: #6c757d;
  text-decoration: line-through;
  margin-left: 0.5rem;
}

.size-options {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.size-option {
  padding: 0.5rem 1rem;
  border: 2px solid #e9ecef;
  border-radius: 8px;
  background: white;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 500;
  min-width: 60px;
  text-align: center;
}

.size-option:hover {
  border-color: #dc3545;
  background: #fff5f5;
}

.size-option.selected {
  border-color: #dc3545;
  background: #dc3545;
  color: white;
}

.size-option.out-of-stock {
  opacity: 0.5;
  cursor: not-allowed;
  background: #f8f9fa;
}

.quantity-controls-popup {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  max-width: 150px;
}

.quantity-controls-popup button {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
}

.quantity-controls-popup input {
  width: 60px;
  height: 40px;
  border-radius: 8px;
  font-weight: 600;
}

.stock-info {
  font-size: 0.9rem;
}

.stock-info.low-stock {
  color: #f59e0b;
}

.stock-info.out-of-stock {
  color: #dc3545;
}

/* Responsive */
@media (max-width: 576px) {
  .product-info-popup {
    flex-direction: column;
    text-align: center;
  }
  
  .product-image-popup {
    width: 100px;
    height: 100px;
    margin: 0 auto;
  }
  
  .size-options {
    justify-content: center;
  }
  
  .quantity-controls-popup {
    margin: 0 auto;
  }
}
</style>

{% block extra_js %}{% endblock %}

<!-- Music Player -->
{% include 'music_player/music_player.html' %}
<link rel="stylesheet" href="{% static 'music_player/css/music_player.css' %}">
<script src="{% static 'music_player/js/music_player.js' %}"></script>
<script src="{% static 'music_player/js/user_music.js' %}"></script>
</body>
</html>
