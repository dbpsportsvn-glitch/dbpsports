{% load static %}
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}DBP Sports{% endblock %}</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{% static 'css/custom.css' %}">
  <link rel="stylesheet" href="{% static 'css/site.css' %}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css"/>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    /* === CSS MỚI CHO KÝ HIỆU ĐỘI TRƯỞNG === */
    .captain-indicator{color:#f59e0b;font-weight:700;margin-left:4px}

    /* Avatar chữ cái khi chưa có ảnh */
    .avatar-ph{display:inline-grid;place-items:center;width:28px;height:28px;border-radius:50%;background:#6f42c1;color:#fff;font-weight:700;font-size:.9rem}

    /* === ICON THÔNG BÁO === */
    .notification-icon{position:relative;color:#cbd5e1;font-size:1.4rem;text-decoration:none;display:flex;align-items:center;padding:0 .5rem;transition:color .2s ease}
    .notification-icon:hover{color:#fff}
    .notification-badge{position:absolute;top:-5px;right:0;font-size:.65rem;font-weight:700;background:#ef4444;color:#fff;border-radius:50%;padding:2px 5px;line-height:1;border:2px solid #0f172a}
    .notification-badge.info{background:#3b82f6}

    /* === NAV / DROPDOWN TINH CHỈNH === */
    .main-menu .nav-link{display:inline-flex;align-items:center}
    .main-menu .dropdown>.nav-link{gap:.35rem}
    .main-menu .dropdown-menu{min-width:14rem}
    /* Nếu header là nền tối, dùng menu tối cho đồng nhất */
    .main-menu .dropdown-menu{--bs-dropdown-bg:#0b1220;--bs-dropdown-color:#e2e8f0;--bs-dropdown-link-color:#e2e8f0;--bs-dropdown-link-hover-bg:#111827;--bs-dropdown-link-hover-color:#fff;--bs-dropdown-border-color:#243044}
    .main-menu .dropdown-item.active{background:linear-gradient(90deg,#0ea5e9,#6366f1);color:#fff}

    /* Mobile nested list */
    .mobile-submenu{padding-left:1rem}
    .mobile-submenu .nav-link{padding:.35rem 0}
    
    /* Mobile navigation spacing */
    @media (max-width: 767px) {
      .nav-right .d-flex {
        gap: 0.5rem !important;
      }
      .notification-icon {
        padding: 0.2rem !important;
        font-size: 1.1rem !important;
      }
      .notification-badge {
        font-size: 0.55rem !important;
        padding: 1px 3px !important;
        min-width: 14px !important;
        height: 14px !important;
      }
      .user-chip {
        width: 32px !important;
        height: 32px !important;
      }
      .avatar, .avatar-ph {
        width: 32px !important;
        height: 32px !important;
        font-size: 0.8rem !important;
      }
    }
    
    /* Extra small screens */
    @media (max-width: 576px) {
      .nav-right .d-flex {
        gap: 0.3rem !important;
      }
      .notification-icon {
        padding: 0.15rem !important;
        font-size: 1rem !important;
      }
    }
  </style>
  {% block extra_css %}{% endblock %}

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-032YMBB5G5"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-032YMBB5G5');
  </script>
</head>

<body>
<header class="site-header sticky-top">
  <nav class="navbar container" data-bs-theme="dark">
    <div class="nav-left">
      <a class="brand" href="{% url 'home' %}">
        <img src="{% static 'images/logo.png' %}" alt="DBP Sports">
        <span class="brand-text">DBP Sports</span>
      </a>
      <button class="mobile-menu-toggle" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileMenu" aria-controls="mobileMenu" aria-label="Mở menu">
        <i class="bi bi-list"></i>
      </button>
    </div>

    <div class="nav-center">
      <div class="main-menu d-flex align-items-center gap-2">
        <a class="nav-link {% if request.resolver_match.url_name == 'home' and 'blog' not in request.resolver_match.namespace and 'shop' not in request.resolver_match.namespace %}active{% endif %}" href="{% url 'home' %}">Trang chủ</a>

        {# === DROPDOWN BÓNG ĐÁ === #}
        {% with urln=request.resolver_match.url_name %}
                <div class="dropdown">
          <a href="#" class="nav-link dropdown-toggle {% if urln == 'tournaments_active' or 'transfer' in urln or urln == 'livestream' or urln == 'archive' %}active{% endif %}" id="soccerDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-trophy"></i> Bóng Đá
          </a>
          <ul class="dropdown-menu" aria-labelledby="soccerDropdown">
            <li><a class="dropdown-item {% if urln == 'tournaments_active' %}active{% endif %}" href="{% url 'tournaments_active' %}"><i class="bi bi-flag"></i> Giải đấu</a></li>
            <li><a class="dropdown-item {% if 'transfer' in urln %}active{% endif %}" href="{% url 'transfer_market' %}"><i class="bi bi-arrow-left-right"></i> Chuyển nhượng</a></li>
            <li><a class="dropdown-item {% if urln == 'livestream' %}active{% endif %}" href="{% url 'livestream' %}"><i class="bi bi-broadcast"></i> Livestream</a></li>
            <li><a class="dropdown-item {% if urln == 'archive' %}active{% endif %}" href="{% url 'archive' %}"><i class="bi bi-archive"></i> Lưu trữ</a></li>
            <li><hr class="dropdown-divider"></li>
            <li class="px-3 text-secondary small">Sắp có: Pickleball, Fifa Online…</li>
          </ul>
        </div>
        {% endwith %}

        <a class="nav-link {% if 'shop' in request.resolver_match.namespace %}active{% endif %}" href="{% url 'shop:home' %}">Shop</a>
        <a class="nav-link {% if request.resolver_match.url_name == 'job_market' %}active{% endif %}" href="{% url 'job_market' %}">Việc làm</a>
      </div>
    </div>

    <div class="nav-right">
      {% if user.is_authenticated %}
      <div class="d-flex align-items-center gap-3">
        {% if is_organizer_role %}
          {% if user.organizations.all.first %}
            <a href="{% url 'organizations:dashboard' %}" class="btn btn-sm btn-outline-warning d-none d-lg-flex" title="Quản lý Đơn vị Tổ chức">
              <i class="bi bi-shield-check"></i> <span>. BTC</span>
            </a>
          {% else %}
            <a href="{% url 'organizations:create' %}" class="btn btn-sm btn-outline-warning d-none d-lg-flex" title="Trở thành Ban tổ chức">
              <i class="bi bi-shield-plus"></i> <span>. Đăng ký BTC</span>
            </a>
          {% endif %}
        {% endif %}

        <a href="{% url 'announcement_dashboard' %}" class="notification-icon" title="Bảng tin từ BTC">
          <i class="bi bi-megaphone-fill"></i>
          {% if unread_announcements_count > 0 %}
            <span class="notification-badge info">{{ unread_announcements_count }}</span>
          {% endif %}
        </a>

        <a href="{% url 'notification_list' %}" class="notification-icon" title="Thông báo của bạn">
          <i class="bi bi-bell-fill"></i>
          {% if unread_notifications_count > 0 %}
            <span class="notification-badge">{{ unread_notifications_count }}</span>
          {% endif %}
        </a>

        <!-- Cart Icon -->
        <a href="#" class="notification-icon" id="cart-icon" title="Giỏ hàng" data-bs-toggle="offcanvas" data-bs-target="#cartPopup" aria-controls="cartPopup">
          <i class="bi bi-cart-fill"></i>
          {% if user.is_authenticated %}
            <span class="notification-badge" id="cart-count">{{ user.cart.total_items|default:0 }}</span>
          {% else %}
            <span class="notification-badge" id="cart-count">0</span>
          {% endif %}
        </a>

        <div class="dropdown user-dropdown">
          <button class="user-chip" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            {% with acct=user.socialaccount_set.first %}
              {% if user.profile.avatar %}
                <img src="{{ user.profile.avatar.url }}" alt="Avatar" class="avatar">
              {% elif acct and acct.get_avatar_url %}
                <img src="{{ acct.get_avatar_url }}" alt="Avatar" class="avatar">
              {% else %}
                <span class="avatar-ph">{{ user.email|default:user.username|first|upper }}</span>
              {% endif %}
            {% endwith %}
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="{% url 'dashboard' %}"><i class="bi bi-person-circle"></i> Tài Khoản</a></li>
            <li><a class="dropdown-item" href="{% url 'public_profile' username=user.email %}"><i class="bi bi-person-vcard"></i> Hồ sơ Công khai</a></li>
            
            {% if user.is_staff %}
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{% url 'shop:admin_dashboard' %}"><i class="fas fa-chart-line"></i> Shop Dashboard</a></li>
            <li><a class="dropdown-item" href="/admin/"><i class="bi bi-gear"></i> Django Admin</a></li>
            {% endif %}
        
            {% if user.player_profile %}
            <li><a class="dropdown-item" href="{% url 'player_detail' pk=user.player_profile.pk %}"><i class="bi bi-person-bounding-box"></i> Xem Hồ sơ Cầu thủ</a></li>
            {% endif %}

            {% if request.user.sponsor_profile %}
            <li><a class="dropdown-item" href="{% url 'sponsors:profile_detail' pk=request.user.sponsor_profile.pk %}"><i class="bi bi-gem"></i> Hồ sơ Nhà tài trợ</a></li>
            {% endif %}            

            {% if is_player_role %}
            <li><a class="dropdown-item" href="{% url 'create_standalone_team' %}"><i class="bi bi-shield-plus"></i> Tạo Đội bóng</a></li>
            {% endif %}
   
            {% if is_organizer_role %}
              {% if user.organizations.all.first %}
                <li><a class="dropdown-item" href="{% url 'organizations:dashboard' %}"><i class="bi bi-shield-check"></i> Khu vực BTC</a></li>
              {% else %}
                <li><a class="dropdown-item" href="{% url 'organizations:create' %}"><i class="bi bi-shield-plus"></i> Đăng ký làm BTC</a></li>
              {% endif %}
            {% endif %}
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{% url 'account_email' %}"><i class="bi bi-envelope"></i> Quản lý Email</a></li>
            <li><a class="dropdown-item" href="{% url 'account_change_password' %}"><i class="bi bi-key"></i> Đổi mật khẩu</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item text-danger" href="{% url 'account_logout' %}"><i class="bi bi-box-arrow-right"></i> Đăng xuất</a></li>
          </ul>
        </div>
      </div>
      {% else %}
      <div class="d-flex align-items-center gap-2">
        <a class="btn btn-outline-light btn-sm" href="{% url 'account_login' %}">Đăng nhập</a>
        <a class="btn btn-warning btn-sm d-none d-md-inline-block" href="{% url 'account_signup' %}">Đăng ký</a>
      </div>
      {% endif %}
    </div>
  </nav>
</header>

<div class="offcanvas offcanvas-start" tabindex="-1" id="mobileMenu" aria-labelledby="mobileMenuLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="mobileMenuLabel">Menu</h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Đóng"></button>
  </div>
  <div class="offcanvas-body">
    <nav class="mobile-nav">
      <a class="nav-link {% if request.resolver_match.url_name == 'home' and 'blog' not in request.resolver_match.namespace and 'shop' not in request.resolver_match.namespace %}active{% endif %}" href="{% url 'home' %}">Trang chủ</a>

      {# --- Mobile: Bóng Đá (collapse) --- #}
      {% with urln=request.resolver_match.url_name %}
            <a class="nav-link d-flex justify-content-between align-items-center {% if urln == 'tournaments_active' or 'transfer' in urln or urln == 'livestream' or urln == 'archive' %}active{% endif %}"
         data-bs-toggle="collapse" href="#mobileSoccerMenu" role="button" aria-expanded="{% if urln == 'tournaments_active' or 'transfer' in urln or urln == 'livestream' or urln == 'archive' %}true{% else %}false{% endif %}" aria-controls="mobileSoccerMenu">
        <span><i class="bi bi-trophy"></i> Bóng Đá</span>
        <i class="bi bi-caret-down-fill small"></i>
      </a>
      <div class="collapse {% if urln == 'tournaments_active' or 'transfer' in urln or urln == 'livestream' or urln == 'archive' %}show{% endif %}" id="mobileSoccerMenu">
        <div class="mobile-submenu">
          <a class="nav-link {% if urln == 'tournaments_active' %}active{% endif %}" href="{% url 'tournaments_active' %}">Giải đấu</a>
          <a class="nav-link {% if 'transfer' in urln %}active{% endif %}" href="{% url 'transfer_market' %}">Chuyển nhượng</a>
          <a class="nav-link {% if urln == 'livestream' %}active{% endif %}" href="{% url 'livestream' %}">Livestream</a>
          <a class="nav-link {% if urln == 'archive' %}active{% endif %}" href="{% url 'archive' %}">Lưu trữ</a>
        </div>
      </div>
      {% endwith %}

      <a class="nav-link {% if 'shop' in request.resolver_match.namespace %}active{% endif %}" href="{% url 'shop:home' %}">Shop</a>
      <a class="nav-link {% if request.resolver_match.url_name == 'job_market' %}active{% endif %}" href="{% url 'job_market' %}">Việc làm</a>

      {% if not user.is_authenticated %}
      <hr class="border-light">
      <a class="nav-link" href="{% url 'account_signup' %}">Đăng ký</a>
      {% endif %}
    </nav>
  </div>
</div>

{% block hero %}{% endblock %}

<div class="container mt-4 content-wrapper mb-5">
  <main>
    {% block content %}{% endblock %}
  </main>
</div>

<footer class="site-footer">
  <div class="container">
    <div class="footer-content">
      <div class="footer-about">
        <a href="{% url 'home' %}" class="footer-brand">
          <img src="{% static 'images/logo.png' %}" alt="DBP Sports">
          <span>DBP Sports</span>
        </a>
        <p class="text-muted">Nền tảng tổ chức và quản lý giải đấu bóng đá phong trào độc quyền Phủi Điện Biên.</p>
        <p class="footer-copyright">&copy; {% now "Y" %} DBP Sports. All Rights Reserved.</p>
      </div>
      <div class="footer-links">
        <h6>Về DBP Sports</h6>
        <ul>
          <li><a href="{% url 'home' %}">Trang chủ</a></li>
          <li><a href="{% url 'tournaments_active' %}">Giải đấu</a></li>
          <li><a href="{% url 'faq' %}">Hướng dẫn</a></li>
        </ul>
      </div>
      <div class="footer-links">
        <h6>Pháp lý</h6>
        <ul>
          <li><a href="{% url 'terms_of_service' %}">Điều khoản dịch vụ</a></li>
          <li><a href="{% url 'privacy_policy' %}">Chính sách bảo mật</a></li>
          <li><a href="{% url 'data_deletion' %}">Xóa dữ liệu</a></li>
        </ul>
      </div>
      <div class="footer-links">
        <h6>Theo dõi chúng tôi</h6>
        <div class="social-icons">
          <a href="https://www.facebook.com/Phuidienbien/" title="Facebook" target="_blank" rel="noopener"><i class="bi bi-facebook"></i></a>
          <a href="https://www.youtube.com/@PhuiDienBien" title="YouTube" target="_blank" rel="noopener"><i class="bi bi-youtube"></i></a>
          <a href="#" title="TikTok"><i class="bi bi-tiktok"></i></a>
        </div>
      </div>
    </div>
  </div>
</footer>

{# TOAST ZONE #}
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index:1100;">
  <div id="toastTemplate" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto">Thông báo</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Đóng"></button>
    </div>
    <div class="toast-body"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJ+Y7B1dGmJRAkycuHAHRg32OmU5r9X3z7hE0=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"></script>

<script>
  // --- BẮT ĐẦU KHỐI SCRIPT TỔNG HỢP ---
  function showToast(message, type='info'){
    const toastTemplate=document.getElementById('toastTemplate');
    const toastContainer=document.querySelector('.toast-container');
    if(!toastTemplate||!toastContainer){console.error('Toast elements not found!');alert(message);return}
    const el=toastTemplate.cloneNode(true);el.removeAttribute('id');el.querySelector('.toast-body').innerHTML=message;const header=el.querySelector('.toast-header');header.classList.remove('bg-success','bg-danger','bg-warning','text-white','text-dark');
    if(type.includes('success')) header.classList.add('bg-success','text-white');
    else if(type.includes('error')) header.classList.add('bg-danger','text-white');
    else if(type.includes('warning')) header.classList.add('bg-warning','text-dark');
    toastContainer.appendChild(el);const t=new bootstrap.Toast(el,{delay:5000});t.show();el.addEventListener('hidden.bs.toast',()=>el.remove());
  }

  function attachImageCompression(form){
    if(!form||form.classList.contains('no-compress')) return;
    const inputFile=form.querySelector('input[type="file"][name="logo"], input[type="file"][name="avatar"], input[type="file"][name="payment_proof"]');
    if(!inputFile) return;
    form.addEventListener('submit',function(event){
      event.preventDefault();
      const file=inputFile.files[0];
      if(!file){form.submit();return}
      new Compressor(file,{quality:.8,maxWidth:1280,maxHeight:1280,success(result){
        const dt=new DataTransfer();dt.items.add(new File([result],result.name,{type:result.type}));inputFile.files=dt.files;form.submit();},error(err){console.error(err.message);form.submit();}});
    });
  }

  function setupPasswordToggle(buttonId,inputName){
    const btn=document.getElementById(buttonId);if(!btn) return;const input=document.querySelector(`input[name="${inputName}"]`);if(!input) return;
    btn.addEventListener('click',function(){const type=input.getAttribute('type')==='password'?'text':'password';input.setAttribute('type',type);const icon=this.querySelector('i');icon.classList.toggle('bi-eye');icon.classList.toggle('bi-eye-slash');});
  }

  document.addEventListener('DOMContentLoaded',function(){
    {% if messages %}
      {% for message in messages %}
        showToast('{{ message|escapejs }}','{{ message.tags }}');
      {% endfor %}
    {% endif %}
    document.querySelectorAll('form[enctype="multipart/form-data"]').forEach(attachImageCompression);
    setupPasswordToggle('togglePassword','password');
    setupPasswordToggle('togglePassword1','password1');
    setupPasswordToggle('togglePassword2','password2');
    Fancybox.bind('[data-fancybox]',{});
  });
  // --- KẾT THÚC KHỐI SCRIPT TỔNG HỢP ---
</script>

<!-- Cart Popup -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="cartPopup" aria-labelledby="cartPopupLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="cartPopupLabel">
      <i class="bi bi-cart-fill me-2"></i>
      Giỏ hàng (<span id="cart-popup-count">0</span>)
    </h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Đóng"></button>
  </div>
  <div class="offcanvas-body p-0">
    <div id="cart-content">
      <!-- Cart items will be loaded here -->
      <div class="text-center p-4">
        <i class="bi bi-cart-x text-muted" style="font-size: 3rem;"></i>
        <p class="text-muted mt-2">Giỏ hàng trống</p>
        <a href="{% url 'shop:home' %}" class="btn btn-primary">Tiếp tục mua sắm</a>
      </div>
    </div>
    
    <!-- Cart Footer -->
    <div class="cart-footer p-3 border-top bg-light">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <strong>Tổng cộng:</strong>
        <strong id="cart-total">0 VNĐ</strong>
      </div>
      <div class="d-grid gap-2">
        <button type="button" class="btn btn-danger" id="clear-cart-btn" onclick="clearAllCart()">
          <i class="bi bi-trash me-2"></i>
          Xóa tất cả
        </button>
        <a href="{% url 'shop:cart' %}" class="btn btn-primary">
          <i class="bi bi-bag-check me-2"></i>
          Xem giỏ hàng chi tiết
        </a>
        <a href="{% url 'shop:checkout' %}" class="btn btn-success">
          <i class="bi bi-credit-card me-2"></i>
          Thanh toán
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Cart Popup CSS -->
<style>
.offcanvas-end {
  width: 400px !important;
}

.cart-item {
  border-bottom: 1px solid #eee;
  padding: 15px;
  display: flex;
  align-items: center;
  gap: 15px;
}

.cart-item:last-child {
  border-bottom: none;
}

.cart-item-image {
  width: 60px;
  height: 60px;
  object-fit: cover;
  border-radius: 8px;
}

.cart-item-details {
  flex: 1;
}

.cart-item-name {
  font-weight: 600;
  margin-bottom: 5px;
  font-size: 14px;
}

.cart-item-size {
  font-size: 12px;
  color: #666;
  margin-bottom: 5px;
}

.cart-item-price {
  font-weight: 600;
  color: #dc3545;
}

.cart-item-controls {
  display: flex;
  align-items: center;
  gap: 10px;
}

.quantity-controls {
  display: flex;
  align-items: center;
  gap: 5px;
}

.quantity-btn {
  width: 25px;
  height: 25px;
  border: 1px solid #ddd;
  background: white;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  cursor: pointer;
}

.quantity-btn:hover {
  background: #f8f9fa;
}

.quantity-input {
  width: 40px;
  text-align: center;
  border: 1px solid #ddd;
  border-radius: 4px;
  padding: 2px;
  font-size: 12px;
}

.remove-item-btn {
  color: #dc3545;
  border: none;
  background: none;
  font-size: 18px;
  cursor: pointer;
  padding: 0;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.cart-footer {
  position: sticky;
  bottom: 0;
  background: white;
}

@media (max-width: 768px) {
  .offcanvas-end {
    width: 100% !important;
  }
}
</style>

<!-- Cart Popup JavaScript -->
<script>
// Load cart content when popup opens
document.getElementById('cartPopup').addEventListener('shown.bs.offcanvas', function() {
  loadCartContent();
});

// Load cart content
function loadCartContent() {
  fetch('{% url "shop:cart_api" %}?t=' + Date.now(), {
    method: 'GET',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
      'Cache-Control': 'no-cache',
      'Pragma': 'no-cache'
    },
    cache: 'no-cache'
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    return response.json();
  })
  .then(data => {
    updateCartPopup(data);
  })
  .catch(error => {
    console.error('Error loading cart:', error);
  });
}

// Update cart popup content
function updateCartPopup(cartData) {
  const cartContent = document.getElementById('cart-content');
  const cartCount = document.getElementById('cart-popup-count');
  const cartTotal = document.getElementById('cart-total');
  const clearCartBtn = document.getElementById('clear-cart-btn');
  
  if (cartData.items && cartData.items.length > 0) {
    let html = '';
    cartData.items.forEach(item => {
      html += `
        <div class="cart-item">
          <img src="${item.image || '/static/images/no-image.png'}" alt="${item.name}" class="cart-item-image">
          <div class="cart-item-details">
            <div class="cart-item-name">${item.name}</div>
            ${item.size ? `<div class="cart-item-size">Size: ${item.size}</div>` : ''}
            <div class="cart-item-price">${item.price.toLocaleString()} VNĐ</div>
          </div>
          <div class="cart-item-controls">
            <div class="quantity-controls">
              <button class="quantity-btn" onclick="updateCartItem(${item.id}, ${item.quantity - 1})">-</button>
              <input type="number" class="quantity-input" value="${item.quantity}" min="1" max="${item.stock}" onchange="updateCartItem(${item.id}, this.value)">
              <button class="quantity-btn" onclick="updateCartItem(${item.id}, ${item.quantity + 1})">+</button>
            </div>
            <button class="remove-item-btn" onclick="removeCartItem(${item.id})" title="Xóa">
              <i class="bi bi-x"></i>
            </button>
          </div>
        </div>
      `;
    });
    cartContent.innerHTML = html;
    clearCartBtn.style.display = 'block';
  } else {
    cartContent.innerHTML = `
      <div class="text-center p-4">
        <i class="bi bi-cart-x text-muted" style="font-size: 3rem;"></i>
        <p class="text-muted mt-2">Giỏ hàng trống</p>
        <a href="{% url 'shop:home' %}" class="btn btn-primary">Tiếp tục mua sắm</a>
      </div>
    `;
    clearCartBtn.style.display = 'none';
  }
  
  cartCount.textContent = cartData.total_items || 0;
  cartTotal.textContent = (cartData.total_price || 0).toLocaleString() + ' VNĐ';
  
  // Update cart count everywhere
  updateCartCount(cartData.total_items || 0);
}

// Update cart item quantity
function updateCartItem(itemId, quantity) {
  if (quantity < 1) {
    removeCartItem(itemId);
    return;
  }
  
  fetch('{% url "shop:update_cart_item" item_id=0 %}'.replace('0', itemId), {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: JSON.stringify({ quantity: parseInt(quantity) }),
    cache: 'no-cache'
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Load cart content (gets fresh count)
      loadCartContent();
      
      // Cart count will be updated by loadCartContent -> updateCartPopup -> updateCartCount
    } else {
      alert(data.message || 'Có lỗi xảy ra');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Có lỗi xảy ra');
  });
}

// Remove cart item
function removeCartItem(itemId) {
  if (!confirm('Bạn có chắc muốn xóa sản phẩm này?')) {
    return;
  }
  
  fetch('{% url "shop:remove_from_cart" item_id=0 %}'.replace('0', itemId), {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}'
    },
    cache: 'no-cache'
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Load cart content first (gets fresh count)
      loadCartContent();
      
      // Show success message
      showNotification(data.message, 'success');
      
      // Cart count will be updated by loadCartContent -> updateCartPopup -> updateCartCount
    } else {
      alert(data.message || 'Có lỗi xảy ra');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Có lỗi xảy ra');
  });
}

// Clear all cart
function clearAllCart() {
  if (!confirm('Bạn có chắc muốn xóa tất cả sản phẩm trong giỏ hàng?')) {
    return;
  }
  
  // Immediately update UI to 0 (optimistic update)
  updateCartCount(0);
  
  fetch('{% url "shop:clear_cart" %}?t=' + Date.now(), {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
      'Cache-Control': 'no-cache',
      'Pragma': 'no-cache'
    },
    cache: 'no-cache'
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      // Force refresh cart count from server
      forceRefreshCartCount();
      
      // Load cart content (will show empty cart)
      loadCartContent();
      
      // Show success message
      showNotification(data.message, 'success');
    } else {
      alert(data.message || 'Có lỗi xảy ra');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Có lỗi xảy ra');
  });
}

// Global function to update cart count everywhere
function updateCartCount(count) {
  // Update main navigation cart count
  const mainCartCount = document.getElementById('cart-count');
  if (mainCartCount) {
    mainCartCount.textContent = count;
  }
  
  // Update all cart count elements
  document.querySelectorAll('.cart-count, #cart-count').forEach(el => {
    el.textContent = count;
  });
  
  // Update cart popup count if it exists
  const cartPopupCount = document.getElementById('cart-popup-count');
  if (cartPopupCount) {
    cartPopupCount.textContent = count;
  }
}

// Force refresh cart count from server
function forceRefreshCartCount() {
  fetch('{% url "shop:cart_api" %}?t=' + Date.now(), {
    method: 'GET',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
      'Cache-Control': 'no-cache',
      'Pragma': 'no-cache'
    },
    cache: 'no-cache'
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      updateCartCount(data.total_items || 0);
    }
  })
  .catch(error => {
    console.error('Error refreshing cart count:', error);
  });
}
</script>

{% block extra_js %}{% endblock %}
</body>
</html>
