{% load static %}
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}DBP Sports{% endblock %}</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="{% static 'css/custom.css' %}">
  <link rel="stylesheet" href="{% static 'css/site.css' %}">

  <style>
    .avatar-ph{display:inline-grid;place-items:center;width:28px;height:28px;border-radius:50%;
               background:#6f42c1;color:#fff;font-weight:700;font-size:.9rem}
  </style>
  {% block extra_css %}{% endblock %}
</head>

<body>

<header class="site-header">
  <div class="navbar">
    <a class="brand" href="{% url 'home' %}">
      <img src="{% static 'images/logo.png' %}" alt="DBP Sports"> DBP Sports
    </a>

    <nav class="nav nav-primary">
      <a class="nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}" href="{% url 'home' %}">Trang chủ</a>
      <a class="nav-link {% if request.resolver_match.url_name == 'tournaments_active' %}active{% endif %}" href="{% url 'tournaments_active' %}">Giải đấu</a>
      <a class="nav-link {% if request.resolver_match.url_name == 'livestream' %}active{% endif %}" href="{% url 'livestream' %}">Livestream</a>
      <a class="nav-link {% if request.resolver_match.url_name == 'archive' %}active{% endif %}" href="{% url 'archive' %}">Lưu trữ</a>
      <a class="nav-link {% if request.resolver_match.url_name == 'shop' %}active{% endif %}" href="{% url 'shop' %}">Shop</a>
    </nav>

    <button class="menu-toggle" type="button" aria-label="Toggle navigation">
      <i class="bi bi-list fs-4"></i>
    </button>

    <div class="nav-user">
      {% if user.is_authenticated %}
        <div class="d-flex align-items-center gap-2">
          
          {# === BẮT ĐẦU NÚT MỚI CHO BAN TỔ CHỨC === #}
          {% if user.organizations.all.first %}
          <a href="{% url 'organizations:dashboard' %}" class="btn btn-sm btn-outline-warning" title="Quản lý Đơn vị Tổ chức">
              <i class="bi bi-shield-check"></i> QL. BTC
          </a>
          {% endif %}
          {# === KẾT THÚC NÚT MỚI CHO BAN TỔ CHỨC === #}

          {# Dropdown tài khoản #}
          <div class="dropdown">
            <a href="#" class="d-flex align-items-center gap-2 text-decoration-none dropdown-toggle text-light" data-bs-toggle="dropdown" aria-expanded="false">
              {% with acct=user.socialaccount_set.first %}
                {% if acct and acct.get_avatar_url %}
                  <img src="{{ acct.get_avatar_url }}" alt="" class="rounded-circle" style="width:28px;height:28px;object-fit:cover">
                {% else %}
                  <span class="avatar-ph">{{ user.email|default:user.username|first|upper }}</span>
                {% endif %}
              {% endwith %}
            </a>
            <ul class="dropdown-menu dropdown-menu-end shadow">
                {# === BẮT ĐẦU THÊM MỚI TẠI ĐÂY === #}
                <li><a class="dropdown-item" href="{% url 'organizations:dashboard' %}">Khu vực BTC</a></li>
                {# === KẾT THÚC THÊM MỚI === #}
                
                <li><a class="dropdown-item" href="{% url 'dashboard' %}">QL Đội Bóng</a></li>           
              <li>
                  <a class="dropdown-item d-flex justify-content-between align-items-center" href="{% url 'announcement_dashboard' %}">
                      Bảng tin BTC
                      {% if unread_announcements_count > 0 %}
                          <span class="badge bg-danger rounded-pill">{{ unread_announcements_count }}</span>
                      {% endif %}
                  </a>
              </li>            
              <li><a class="dropdown-item" href="{% url 'account_email' %}">Đổi email</a></li>
              <li><a class="dropdown-item" href="{% url 'account_change_password' %}">Đổi mật khẩu</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="{% url 'account_logout' %}">Đăng xuất</a></li>
            </ul>
          </div>
        </div>
      {% else %}
        <div class="d-flex align-items-center gap-2">
          <a class="nav-link text-light small" href="{% url 'account_login' %}">Đăng nhập</a>
          <a class="nav-link text-light small" href="{% url 'account_signup' %}">Đăng ký</a>
        </div>
      {% endif %}
    </div>
  </div>
</header>

{% block hero %}{% endblock %}
<div class="container mt-4">
  <main>
    {% block content %}{% endblock %}
  </main>

  <footer class="py-4 my-4 border-top">
    <div class="row align-items-center">
      <div class="col-md-6 mb-2 mb-md-0">
        <a href="{% url 'home' %}" class="d-inline-flex align-items-center gap-2 text-muted text-decoration-none">
          <img src="{% static 'images/logo.png' %}" alt="DBP Sports" style="height: 24px;">
          <span>&copy; {% now "Y" %} DBP Sports</span>
        </a>
      </div>
      <div class="col-md-6 text-md-end">
        <ul class="list-inline mb-0">
          <li class="list-inline-item"><a href="{% url 'home' %}" class="text-muted text-decoration-none">Trang chủ</a></li>
          <li class="list-inline-item"><a href="{% url 'tournaments_active' %}" class="text-muted text-decoration-none">Giải đấu</a></li>
          <li class="list-inline-item"><a href="{% url 'faq' %}" class="text-muted text-decoration-none">Hướng dẫn</a></li>
        </ul>
      </div>
    </div>
  </footer>
</div>

{# VÙNG THÔNG BÁO TOAST #}
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="toastTemplate" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto">Thông báo</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>
<script>
  (function(){
    const toggle = document.querySelector('.menu-toggle');
    const nav = document.querySelector('.site-header .nav-primary');
    if (toggle && nav) {
      toggle.addEventListener('click', function() {
        nav.classList.toggle('open');
      });
    }

    function attachImageCompression(form) {
      if (!form) return;
      const inputFile = form.querySelector('input[type="file"][name="logo"], input[type="file"][name="avatar"], input[type="file"][name="payment_proof"]');
      if (!inputFile) return;

      form.addEventListener('submit', function(event) {
        event.preventDefault();
        const file = inputFile.files[0];
        if (!file) {
          form.submit();
          return;
        }
        new Compressor(file, {
          quality: 0.8, maxWidth: 1280, maxHeight: 1280,
          success(result) {
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(new File([result], result.name, { type: result.type }));
            inputFile.files = dataTransfer.files;
            form.submit();
          },
          error(err) {
            console.error(err.message);
            form.submit();
          },
        });
      });
    }

    document.querySelectorAll('form[enctype="multipart/form-data"]').forEach(attachImageCompression);

  function setupPasswordToggle(buttonId, inputName) {
    const toggleButton = document.getElementById(buttonId);
    if (!toggleButton) return;
    const passwordInput = document.querySelector(`input[name="${inputName}"]`);
    if (!passwordInput) return;
    toggleButton.addEventListener('click', function () {
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);
      const icon = this.querySelector('i');
      icon.classList.toggle('bi-eye');
      icon.classList.toggle('bi-eye-slash');
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    setupPasswordToggle('togglePassword', 'password');
    setupPasswordToggle('togglePassword1', 'password1');
    setupPasswordToggle('togglePassword2', 'password2');
  });

  })();
</script>

{% if messages %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const toastTemplate = document.getElementById('toastTemplate');
    const toastContainer = document.querySelector('.toast-container');
    if (toastTemplate && toastContainer) {
      {% for message in messages %}
        const newToastEl = toastTemplate.cloneNode(true);
        newToastEl.removeAttribute('id');
        newToastEl.querySelector('.toast-body').textContent = '{{ message }}';
        const header = newToastEl.querySelector('.toast-header');
        if ('{{ message.tags }}'.includes('success')) {
            header.classList.add('bg-success', 'text-white');
        } else if ('{{ message.tags }}'.includes('error')) {
            header.classList.add('bg-danger', 'text-white');
        } else if ('{{ message.tags }}'.includes('warning')) {
            header.classList.add('bg-warning', 'text-dark');
        }
        toastContainer.appendChild(newToastEl);
        const newToast = new bootstrap.Toast(newToastEl);
        newToast.show();
      {% endfor %}
    }
  });
</script>
{% endif %}

</body>
</html>