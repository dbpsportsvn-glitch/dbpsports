<!-- Music Player Popup -->
<div id="music-player-popup" class="music-player-popup hidden">
    <!-- Full Player -->
    <div id="full-player" class="full-player">
        <div class="player-header">
            <div class="header-left">
                <!-- User Avatar Button (Settings) -->
                {% if user.is_authenticated %}
                <button id="settings-btn" class="control-btn user-avatar-btn" title="Cài đặt cá nhân">
                    {% if user.profile.avatar %}
                    <img src="{{ user.profile.avatar.url }}" alt="{{ user.get_full_name }}" class="user-avatar-img">
                    {% else %}
                    <div class="user-avatar-placeholder">
                        {{ user.first_name.0|default:user.username.0|upper }}
                    </div>
                    {% endif %}
                </button>
                {% else %}
                <button id="settings-btn" class="control-btn" title="Đăng nhập để cài đặt">
                    <i class="bi bi-person-circle"></i>
                </button>
                {% endif %}
                <h5 class="player-title">Trình Phát Nhạc</h5>
            </div>
            <div class="header-controls">
                <!-- ✅ Keyboard Shortcuts Help Button -->
                <button id="keyboard-shortcuts-btn" class="control-btn" title="Phím tắt (Shift+?)">
                    <i class="bi bi-keyboard"></i>
                </button>
                
                <!-- Sleep Timer -->
                <div class="sleep-timer-container">
                    <button id="sleep-timer-btn" class="control-btn" title="Hẹn giờ tắt nhạc">
                        <i class="bi bi-alarm"></i>
                    </button>
                    <div id="sleep-timer-menu" class="sleep-timer-menu hidden">
                        <div class="sleep-timer-header">Hẹn giờ tắt nhạc</div>
                        <button class="sleep-timer-option" data-minutes="15">15 phút</button>
                        <button class="sleep-timer-option" data-minutes="30">30 phút</button>
                        <button class="sleep-timer-option" data-minutes="60">1 giờ</button>
                        <button class="sleep-timer-option" data-minutes="120">2 giờ</button>
                        <div class="sleep-timer-status hidden" id="sleep-timer-status">
                            <div class="timer-remaining" id="timer-remaining">Còn lại: --:--</div>
                            <button class="cancel-timer-btn" id="cancel-timer-btn">Hủy</button>
                        </div>
                    </div>
                </div>
                <button id="player-close" class="close-btn">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        </div>

        <div class="player-content">
            <!-- Player Controls - Now on TOP -->
            <div class="player-controls">
                <!-- Current Track Info & Progress -->
                <div class="current-track-section">
                    <div class="current-track">
                        <div class="track-info">
                            <div class="track-title" id="current-track-title">Chọn bài hát</div>
                            <div class="track-artist" id="current-track-artist"></div>
                        </div>
                    </div>

                    <div class="progress-section">
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-fill"></div>
                                <div class="progress-handle" id="progress-handle"></div>
                            </div>
                        </div>
                        <div class="time-display">
                            <span id="current-time">0:00</span>
                            <span id="total-time">0:00</span>
                        </div>
                    </div>
                </div>

                <!-- Control Buttons & Volume on same row -->
                <div class="controls-row">
                    <div class="control-buttons">
                        <button id="shuffle-btn" class="control-btn" title="Phát ngẫu nhiên">
                            <i class="bi bi-shuffle"></i>
                        </button>
                        <button id="prev-btn" class="control-btn" title="Bài trước">
                            <i class="bi bi-skip-start-fill"></i>
                        </button>
                        <button id="play-pause-btn" class="control-btn play-pause-btn" title="Phát/Tạm dừng">
                            <i class="bi bi-play-fill"></i>
                        </button>
                        <button id="next-btn" class="control-btn" title="Bài tiếp">
                            <i class="bi bi-skip-end-fill"></i>
                        </button>
                        <button id="repeat-btn" class="control-btn" title="Lặp lại">
                            <i class="bi bi-arrow-repeat"></i>
                        </button>
                    </div>

                    <div class="volume-section">
                        <button id="mute-btn" class="control-btn volume-btn" title="Tắt tiếng">
                            <i class="bi bi-volume-up-fill"></i>
                        </button>
                        <div class="volume-container">
                            <div class="volume-bar">
                                <div class="volume-fill" id="volume-fill"></div>
                                <div class="volume-handle" id="volume-handle"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab System - Modern Design -->
            <div class="tabs-section">
                <!-- Tab Headers -->
                <div class="tab-headers">
                    <button class="tab-header active" data-tab="tracks">
                        <i class="bi bi-music-note-list"></i>
                        Danh sách bài hát
                    </button>
                    <button class="tab-header" data-tab="playlists">
                        <i class="bi bi-collection-play"></i>
                        Playlist
                    </button>
                </div>

                <!-- Tab Contents -->
                <div class="tab-contents">
                    <!-- Tracks Tab -->
                    <div class="tab-content active" id="tab-tracks">
                        <div id="track-list" class="track-list">
                            <div class="empty-state">
                                <i class="bi bi-music-note"></i>
                                <p>Chưa có bài hát nào</p>
                            </div>
                        </div>
                    </div>

                    <!-- Playlists Tab -->
                    <div class="tab-content" id="tab-playlists">
                        <!-- Playlist Type Toggle -->
                        <div class="playlist-type-toggle">
                            <button class="playlist-type-btn active" data-type="admin">
                                <i class="bi bi-globe"></i>
                                Admin Playlists
                            </button>
                            <button class="playlist-type-btn" data-type="personal">
                                <i class="bi bi-person-fill"></i>
                                Playlist Của Tôi
                            </button>
                        </div>
                        
                        <!-- Admin Playlists Grid -->
                        <div class="playlist-grid" id="playlist-grid">
                            <!-- Playlists will be populated here -->
                            <div class="empty-state">
                                <i class="bi bi-collection-play"></i>
                                <p>Đang tải playlists...</p>
                            </div>
                        </div>
                        
                        <!-- User Playlists Grid -->
                        <div class="playlist-grid hidden" id="user-playlist-grid">
                            <div class="empty-state">
                                <i class="bi bi-music-note"></i>
                                <p>Chưa có playlist cá nhân. Vào Cài đặt để tạo!</p>
                            </div>
                        </div>
                        
                        <!-- Hidden select for backward compatibility -->
                        <select id="playlist-select" class="form-select" style="display: none;">
                            <option value="">Chọn playlist...</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Audio Element -->
    <audio id="audio-player" preload="auto"></audio>
</div>

<!-- Music Player Toggle Button -->
<div id="music-player-toggle" class="music-player-toggle">
    <i class="bi bi-music-note-beamed"></i>
</div>

<!-- Include Settings Modal -->
{% include 'music_player/settings_modal.html' %}
